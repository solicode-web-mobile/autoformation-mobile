---
title: 2. Seeders & jeux test
layout: home
nav_order: 2
parent: 2.1. Schéma & Eloquent
permalink: /schema-eloquent-bases/seeders-jeux-de-donnees/
---

# 📘 Chapitre 2.1.2 — Seeders & jeux de données de test

## 📒 Glossaire minute
- **Seeder** : script qui **insère** des données de test/démo en base.
- **Factory** : générateur d’objets **fictifs** et cohérents (via Faker).
- **Fixture** : **jeu de données** déterministe (souvent depuis un fichier JSON).
- **Idempotent** : exécutable **plusieurs fois** sans effet indésirable.

## 🎯 Objectif pédagogique
Savoir créer des **factories** et **seeders** pour produire un **jeu de données reproductible**, peuplé avec des **relations** (1-n, n-n), et exécuter l’ensemble via `DatabaseSeeder`.

## 🧠 Définition théorique
- Les **factories** décrivent **comment** générer un enregistrement plausible (titres, slugs, dates…).
- Les **seeders** orchestrent l’**insertion** : ordre, volumes, relations, lecture éventuelle d’un **JSON**.
- `DatabaseSeeder` est le **point d’entrée** unique pour composer plusieurs seeders.

### Exemple
```php
// database/seeders/DatabaseSeeder.php
public function run(): void
{
    $this->call([
        TagSeeder::class,
        ArticleSeeder::class,
        PivotArticleTagSeeder::class,
    ]);
}
````

## 🔍 Exemple appliqué au fil rouge

Blog Laravel : créer **tags** puis **articles**, et lier `articles ↔ tags` via la table **pivot** `article_tag`.

---

## 🛠 Tutoriel pratique

**Arborescence :**

```
database/
├─ factories/
│  ├─ ArticleFactory.php
│  └─ TagFactory.php
├─ seeders/
│  ├─ DatabaseSeeder.php
│  ├─ TagSeeder.php
│  ├─ ArticleSeeder.php
│  └─ PivotArticleTagSeeder.php
└─ seeders/data/
   ├─ tags.seed.json
   └─ articles.seed.json
```

### Étape 1 — Créer factories & seeders

```bash
php artisan make:factory TagFactory --model=Tag
php artisan make:factory ArticleFactory --model=Article

php artisan make:seeder TagSeeder
php artisan make:seeder ArticleSeeder
php artisan make:seeder PivotArticleTagSeeder

# Variante module (nWidart)
php artisan module:make-seeder TagSeeder PkgBlog
php artisan module:make-seeder ArticleSeeder PkgBlog
php artisan module:make-seeder PivotArticleTagSeeder PkgBlog
```

### Étape 2 — Définir les **factories**

```php
<?php
// database/factories/TagFactory.php
namespace Database\Factories;

use Illuminate\Database\Eloquent\Factories\Factory;
use Illuminate\Support\Str;
use App\Models\Tag; // ⚠️ adaptez au namespace réel de votre modèle

class TagFactory extends Factory
{
    protected $model = Tag::class;

    public function definition(): array
    {
        $name = $this->faker->unique()->words(rand(1,2), true);
        return [
            'name' => ucfirst($name),
            'slug' => Str::slug($name).'-'.Str::random(5),
        ];
    }
}
```

```php
<?php
// database/factories/ArticleFactory.php
namespace Database\Factories;

use Illuminate\Database\Eloquent\Factories\Factory;
use Illuminate\Support\Str;
use App\Models\Article; // ⚠️ adaptez au namespace réel
use App\Models\User;

class ArticleFactory extends Factory
{
    protected $model = Article::class;

    public function definition(): array
    {
        $title = $this->faker->unique()->sentence(4);
        return [
            'user_id'   => User::query()->inRandomOrder()->value('id') ?? 1,
            'title'     => $title,
            'slug'      => Str::slug($title).'-'.Str::random(6),
            'excerpt'   => $this->faker->sentence(12),
            'content'   => $this->faker->paragraphs(3, true),
            'created_at'=> now(),
            'updated_at'=> now(),
        ];
    }
}
```

> Assurez-vous que vos modèles `Article` et `Tag` utilisent le trait `HasFactory`.

### Étape 3 — **TagSeeder** (JSON ou factories)

```php
<?php
// database/seeders/TagSeeder.php
namespace Database\Seeders;

use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\File;
use App\Models\Tag;

class TagSeeder extends Seeder
{
    public function run(): void
    {
        $jsonPath = database_path('seeders/data/tags.seed.json');

        if (File::exists($jsonPath)) {
            $items = json_decode(File::get($jsonPath), true);
            foreach ($items as $it) {
                Tag::firstOrCreate(
                    ['slug' => $it['slug']],
                    ['name' => $it['name']]
                );
            }
        } else {
            Tag::factory()->count(12)->create();
        }
    }
}
```

### Étape 4 — **ArticleSeeder** (JSON ou factories)

```php
<?php
// database/seeders/ArticleSeeder.php
namespace Database\Seeders;

use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\File;
use App\Models\Article;

class ArticleSeeder extends Seeder
{
    public function run(): void
    {
        $jsonPath = database_path('seeders/data/articles.seed.json');

        if (File::exists($jsonPath)) {
            $items = json_decode(File::get($jsonPath), true);
            foreach ($items as $it) {
                Article::firstOrCreate(
                    ['slug' => $it['slug']],
                    [
                        'user_id' => $it['user_id'] ?? 1,
                        'title'   => $it['title'],
                        'excerpt' => $it['excerpt'] ?? null,
                        'content' => $it['content'] ?? '',
                        'created_at' => now(),
                        'updated_at' => now(),
                    ]
                );
            }
        } else {
            Article::factory()->count(20)->create();
        }
    }
}
```

### Étape 5 — Lier `articles ↔ tags` (pivot)

```php
<?php
// database/seeders/PivotArticleTagSeeder.php
namespace Database\Seeders;

use Illuminate\Database\Seeder;
use App\Models\Article;
use App\Models\Tag;

class PivotArticleTagSeeder extends Seeder
{
    public function run(): void
    {
        $tagIds = Tag::query()->pluck('id');

        Article::query()->each(function ($article) use ($tagIds) {
            $attach = $tagIds->shuffle()->take(rand(1, 4))->all();
            $article->tags()->syncWithoutDetaching($attach);
        });
    }
}
```

### Étape 6 — Orchestration avec **DatabaseSeeder**

```php
<?php
// database/seeders/DatabaseSeeder.php
namespace Database\Seeders;

use Illuminate\Database\Seeder;

class DatabaseSeeder extends Seeder
{
    public function run(): void
    {
        $this->call([
            TagSeeder::class,
            ArticleSeeder::class,
            PivotArticleTagSeeder::class,
        ]);
    }
}
```

### Étape 7 — Exécuter

```bash
php artisan db:seed
# ou pour repartir de zéro :
php artisan migrate:fresh --seed
```

---

## 🔎 Vérification rapide (Tinker)

```bash
php artisan tinker
```

```php
Tag::count();                   // >= 12
Article::count();               // ~20
Article::first()->tags->pluck('name'); // 1 à 4 tags
Tag::first()->articles()->count();     // > 0 si pivot OK
```

---

## 🧾 Résumé et points-clés

* **Factories** = patron de génération ; **Seeders** = orchestration et ordre.
* Préférez des **slugs uniques** et `firstOrCreate` pour éviter les doublons.
* Les **pivots** se peuplent via `syncWithoutDetaching`.
* `migrate:fresh --seed` garantit une base **propre et reproductible**.

---

## 🩺 Dépannage (fréquents)

| Problème                                  | Cause                    | Solution                                                            |
| ----------------------------------------- | ------------------------ | ------------------------------------------------------------------- |
| `Integrity constraint violation (unique)` | Slug dupliqué            | Ajouter suffixe aléatoire/`unique()` Faker, ou `firstOrCreate`      |
| `Cannot add or update a child row`        | FK inexistante           | Ordonner seeders (parents puis enfants), créer d’abord `users/tags` |
| `MassAssignmentException`                 | `$fillable` manquant     | Définir `$fillable` ou utiliser `$guarded = []` pour les tests      |
| `Class not found` (factory)               | Mauvais namespace modèle | Vérifier `use App\Models\...` (ou namespace module) dans la factory |

