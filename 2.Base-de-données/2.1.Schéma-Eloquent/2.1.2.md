---
title: 2. Seeders & jeux test
layout: home
nav_order: 2
parent: 2.1. SchÃ©ma & Eloquent
permalink: /schema-eloquent-bases/seeders-jeux-de-donnees/
---

# ğŸ“˜ Chapitre 2.1.2 â€” Seeders & jeux de donnÃ©es de test

## ğŸ“’ Glossaire minute
- **Seeder** : script qui **insÃ¨re** des donnÃ©es de test/dÃ©mo en base.
- **Factory** : gÃ©nÃ©rateur dâ€™objets **fictifs** et cohÃ©rents (via Faker).
- **Fixture** : **jeu de donnÃ©es** dÃ©terministe (souvent depuis un fichier JSON).
- **Idempotent** : exÃ©cutable **plusieurs fois** sans effet indÃ©sirable.

## ğŸ¯ Objectif pÃ©dagogique
Savoir crÃ©er des **factories** et **seeders** pour produire un **jeu de donnÃ©es reproductible**, peuplÃ© avec des **relations** (1-n, n-n), et exÃ©cuter lâ€™ensemble via `DatabaseSeeder`.

## ğŸ§  DÃ©finition thÃ©orique
- Les **factories** dÃ©crivent **comment** gÃ©nÃ©rer un enregistrement plausible (titres, slugs, datesâ€¦).
- Les **seeders** orchestrent lâ€™**insertion** : ordre, volumes, relations, lecture Ã©ventuelle dâ€™un **JSON**.
- `DatabaseSeeder` est le **point dâ€™entrÃ©e** unique pour composer plusieurs seeders.

### Exemple
```php
// database/seeders/DatabaseSeeder.php
public function run(): void
{
    $this->call([
        TagSeeder::class,
        ArticleSeeder::class,
        PivotArticleTagSeeder::class,
    ]);
}
````

## ğŸ” Exemple appliquÃ© au fil rouge

Blog Laravel : crÃ©er **tags** puis **articles**, et lier `articles â†” tags` via la table **pivot** `article_tag`.

---

## ğŸ›  Tutoriel pratique

**Arborescence :**

```
database/
â”œâ”€ factories/
â”‚  â”œâ”€ ArticleFactory.php
â”‚  â””â”€ TagFactory.php
â”œâ”€ seeders/
â”‚  â”œâ”€ DatabaseSeeder.php
â”‚  â”œâ”€ TagSeeder.php
â”‚  â”œâ”€ ArticleSeeder.php
â”‚  â””â”€ PivotArticleTagSeeder.php
â””â”€ seeders/data/
   â”œâ”€ tags.seed.json
   â””â”€ articles.seed.json
```

### Ã‰tape 1 â€” CrÃ©er factories & seeders

```bash
php artisan make:factory TagFactory --model=Tag
php artisan make:factory ArticleFactory --model=Article

php artisan make:seeder TagSeeder
php artisan make:seeder ArticleSeeder
php artisan make:seeder PivotArticleTagSeeder

# Variante module (nWidart)
php artisan module:make-seeder TagSeeder PkgBlog
php artisan module:make-seeder ArticleSeeder PkgBlog
php artisan module:make-seeder PivotArticleTagSeeder PkgBlog
```

### Ã‰tape 2 â€” DÃ©finir les **factories**

```php
<?php
// database/factories/TagFactory.php
namespace Database\Factories;

use Illuminate\Database\Eloquent\Factories\Factory;
use Illuminate\Support\Str;
use App\Models\Tag; // âš ï¸ adaptez au namespace rÃ©el de votre modÃ¨le

class TagFactory extends Factory
{
    protected $model = Tag::class;

    public function definition(): array
    {
        $name = $this->faker->unique()->words(rand(1,2), true);
        return [
            'name' => ucfirst($name),
            'slug' => Str::slug($name).'-'.Str::random(5),
        ];
    }
}
```

```php
<?php
// database/factories/ArticleFactory.php
namespace Database\Factories;

use Illuminate\Database\Eloquent\Factories\Factory;
use Illuminate\Support\Str;
use App\Models\Article; // âš ï¸ adaptez au namespace rÃ©el
use App\Models\User;

class ArticleFactory extends Factory
{
    protected $model = Article::class;

    public function definition(): array
    {
        $title = $this->faker->unique()->sentence(4);
        return [
            'user_id'   => User::query()->inRandomOrder()->value('id') ?? 1,
            'title'     => $title,
            'slug'      => Str::slug($title).'-'.Str::random(6),
            'excerpt'   => $this->faker->sentence(12),
            'content'   => $this->faker->paragraphs(3, true),
            'created_at'=> now(),
            'updated_at'=> now(),
        ];
    }
}
```

> Assurez-vous que vos modÃ¨les `Article` et `Tag` utilisent le trait `HasFactory`.

### Ã‰tape 3 â€” **TagSeeder** (JSON ou factories)

```php
<?php
// database/seeders/TagSeeder.php
namespace Database\Seeders;

use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\File;
use App\Models\Tag;

class TagSeeder extends Seeder
{
    public function run(): void
    {
        $jsonPath = database_path('seeders/data/tags.seed.json');

        if (File::exists($jsonPath)) {
            $items = json_decode(File::get($jsonPath), true);
            foreach ($items as $it) {
                Tag::firstOrCreate(
                    ['slug' => $it['slug']],
                    ['name' => $it['name']]
                );
            }
        } else {
            Tag::factory()->count(12)->create();
        }
    }
}
```

### Ã‰tape 4 â€” **ArticleSeeder** (JSON ou factories)

```php
<?php
// database/seeders/ArticleSeeder.php
namespace Database\Seeders;

use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\File;
use App\Models\Article;

class ArticleSeeder extends Seeder
{
    public function run(): void
    {
        $jsonPath = database_path('seeders/data/articles.seed.json');

        if (File::exists($jsonPath)) {
            $items = json_decode(File::get($jsonPath), true);
            foreach ($items as $it) {
                Article::firstOrCreate(
                    ['slug' => $it['slug']],
                    [
                        'user_id' => $it['user_id'] ?? 1,
                        'title'   => $it['title'],
                        'excerpt' => $it['excerpt'] ?? null,
                        'content' => $it['content'] ?? '',
                        'created_at' => now(),
                        'updated_at' => now(),
                    ]
                );
            }
        } else {
            Article::factory()->count(20)->create();
        }
    }
}
```

### Ã‰tape 5 â€” Lier `articles â†” tags` (pivot)

```php
<?php
// database/seeders/PivotArticleTagSeeder.php
namespace Database\Seeders;

use Illuminate\Database\Seeder;
use App\Models\Article;
use App\Models\Tag;

class PivotArticleTagSeeder extends Seeder
{
    public function run(): void
    {
        $tagIds = Tag::query()->pluck('id');

        Article::query()->each(function ($article) use ($tagIds) {
            $attach = $tagIds->shuffle()->take(rand(1, 4))->all();
            $article->tags()->syncWithoutDetaching($attach);
        });
    }
}
```

### Ã‰tape 6 â€” Orchestration avec **DatabaseSeeder**

```php
<?php
// database/seeders/DatabaseSeeder.php
namespace Database\Seeders;

use Illuminate\Database\Seeder;

class DatabaseSeeder extends Seeder
{
    public function run(): void
    {
        $this->call([
            TagSeeder::class,
            ArticleSeeder::class,
            PivotArticleTagSeeder::class,
        ]);
    }
}
```

### Ã‰tape 7 â€” ExÃ©cuter

```bash
php artisan db:seed
# ou pour repartir de zÃ©ro :
php artisan migrate:fresh --seed
```

---

## ğŸ” VÃ©rification rapide (Tinker)

```bash
php artisan tinker
```

```php
Tag::count();                   // >= 12
Article::count();               // ~20
Article::first()->tags->pluck('name'); // 1 Ã  4 tags
Tag::first()->articles()->count();     // > 0 si pivot OK
```

---

## ğŸ§¾ RÃ©sumÃ© et points-clÃ©s

* **Factories** = patron de gÃ©nÃ©ration ; **Seeders** = orchestration et ordre.
* PrÃ©fÃ©rez des **slugs uniques** et `firstOrCreate` pour Ã©viter les doublons.
* Les **pivots** se peuplent via `syncWithoutDetaching`.
* `migrate:fresh --seed` garantit une base **propre et reproductible**.

---

## ğŸ©º DÃ©pannage (frÃ©quents)

| ProblÃ¨me                                  | Cause                    | Solution                                                            |
| ----------------------------------------- | ------------------------ | ------------------------------------------------------------------- |
| `Integrity constraint violation (unique)` | Slug dupliquÃ©            | Ajouter suffixe alÃ©atoire/`unique()` Faker, ou `firstOrCreate`      |
| `Cannot add or update a child row`        | FK inexistante           | Ordonner seeders (parents puis enfants), crÃ©er dâ€™abord `users/tags` |
| `MassAssignmentException`                 | `$fillable` manquant     | DÃ©finir `$fillable` ou utiliser `$guarded = []` pour les tests      |
| `Class not found` (factory)               | Mauvais namespace modÃ¨le | VÃ©rifier `use App\Models\...` (ou namespace module) dans la factory |

