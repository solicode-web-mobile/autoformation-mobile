---
title: 4. Requêtes CRUD avec Eloquent
layout: home
nav_order: 4
parent: 2.1. Schéma & Eloquent
permalink: /schema-eloquent/crud-eloquent/
code: 2.1.4
competence: C2
autoformation: "C2.1"
ua: "2.1.U2"
duree_h: 3
objectif: "Savoir manipuler les données avec Eloquent : créer, lire, mettre à jour et supprimer des enregistrements (CRUD) directement depuis Tinker."
notions_nouvelles: ["CRUD", "Query Builder", "Tinker", "Scope", "Query chaining"]
fil_rouge: "Blog Laravel : manipulation directe des articles, tags et utilisateurs en base."
livrable_chapitre: "Requêtes CRUD exécutées et vérifiées dans Tinker (capture d’écran des opérations)."
alimentation_prototype: "Base maîtrisée et prête pour l’intégration API (tutoriels suivants)."
alimentation_miniprojet: "Capacité à manipuler les données du projet depuis Eloquent."
---

# 📘 2.1.4 — Requêtes CRUD avec Eloquent

> ℹ️ **Prérequis :** la base de données doit déjà être remplie avec les seeders du chapitre **2.1.3**.  
> Vous allez maintenant apprendre à **manipuler les données directement** à travers Eloquent, sans passer par d’interface graphique.

---

## 📒 Glossaire minute

- **CRUD** : opérations de base sur une ressource (*Create, Read, Update, Delete*).  
- **Eloquent** : ORM (Object Relational Mapper) de Laravel permettant d’interagir avec la base de données via des objets PHP.  
- **Tinker** : console interactive pour exécuter des commandes Laravel.  
- **Scope** : filtre réutilisable sur un modèle.  
- **Query chaining** : enchaînement fluide de méthodes (`where()->orderBy()->get()`).

---

## 🎯 Objectif pédagogique

Savoir manipuler la base de données du Blog Laravel à partir de **Tinker** en utilisant les méthodes Eloquent :  
1. Créer (`create`, `save`)  
2. Lire (`all`, `find`, `where`, `with`)  
3. Mettre à jour (`update`, `save`)  
4. Supprimer (`delete`)  
5. Gérer les **relations** et les **requêtes chaînées**

---

## 🧠 Définition théorique

Eloquent agit comme une couche intermédiaire entre **PHP** et **MySQL** :  
chaque **modèle** représente une **table**, et chaque **instance** correspond à une ligne de cette table.

| Action | SQL classique | Équivalent Eloquent |
|--------|----------------|---------------------|
| Lire | `SELECT * FROM articles;` | `Article::all();` |
| Filtrer | `WHERE user_id = 1;` | `Article::where('user_id', 1)->get();` |
| Insérer | `INSERT INTO articles ...` | `Article::create([...]);` |
| Modifier | `UPDATE articles ...` | `$article->update([...]);` |
| Supprimer | `DELETE FROM articles ...` | `$article->delete();` |

---

## 🛠 Tutoriel pratique

### Étape 1 : Lancer Tinker

> Tinker permet d’exécuter du code Laravel sans passer par un fichier PHP.

```bash
php artisan tinker
````

---

### Étape 2 : Créer des données (Create)

> On peut insérer une nouvelle donnée avec `create()` ou en instanciant un objet puis en appelant `save()`.

#### 🧩 Méthode 1 — Avec `create()`

```php
>>> use App\Models\Article;
>>> $article = Article::create([
... 'user_id' => 1,
... 'title' => 'Premier article manuel',
... 'slug' => 'premier-article',
... 'excerpt' => 'Introduction à Eloquent CRUD',
... 'content' => 'Ceci est un test d’ajout via Tinker.'
... ]);
```

💡 Les champs utilisés doivent être déclarés dans `$fillable` du modèle.

#### 🧩 Méthode 2 — Avec `new` et `save()`

```php
>>> $a = new Article;
>>> $a->user_id = 1;
>>> $a->title = 'Deuxième article';
>>> $a->slug = 'deuxieme-article';
>>> $a->save();
```

✅ Vérification :

```php
>>> Article::count();
```

---

### Étape 3 : Lire les données (Read)

> On peut lire toutes les données, filtrer ou charger des relations.

#### 📋 Lister tous les articles

```php
>>> Article::all();
```

#### 🔍 Trouver un article précis

```php
>>> Article::find(1);
```

#### 🎯 Filtrer par mot-clé

```php
>>> Article::where('title', 'like', '%article%')->get();
```

#### 🔗 Lire avec les relations (user, tags)

```php
>>> Article::with(['user','tags'])->first();
```

#### 📊 Compter les articles par utilisateur

```php
>>> \App\Models\User::withCount('articles')->get();
```

---

### Étape 4 : Modifier des données (Update)

> Eloquent permet de modifier directement un ou plusieurs enregistrements.

#### 🧩 Exemple simple

```php
>>> $article = Article::find(1);
>>> $article->update(['title' => 'Titre modifié']);
```

#### Variante :

```php
>>> $article->title = 'Nouveau titre modifié';
>>> $article->save();
```

✅ Vérifiez que la mise à jour a bien été prise en compte :

```php
>>> Article::find(1)->title;
```

---

### Étape 5 : Supprimer des données (Delete)

> Une simple méthode `delete()` supprime l’enregistrement courant.

```php
>>> $article = Article::find(1);
>>> $article->delete();
```

💡 Vérification :

```php
>>> Article::find(1);
null
```

---

### Étape 6 : Manipuler les relations

#### 🧩 Ajouter un tag à un article

```php
>>> $a = Article::first();
>>> $a->tags()->attach(1);
```

#### 🧩 Retirer un tag

```php
>>> $a->tags()->detach(1);
```

#### 🧩 Remplacer tous les tags

```php
>>> $a->tags()->sync([2,3,4]);
```

---

### Étape 7 : Filtrer et trier (Query Builder)

> Eloquent permet d’enchaîner plusieurs conditions facilement.

#### 🔽 Trier par date

```php
>>> Article::orderBy('created_at','desc')->take(5)->get();
```

#### 🎯 Sélectionner certains champs

```php
>>> Article::select('id','title','slug')->get();
```

#### 🔗 Combiner plusieurs conditions

```php
>>> Article::where('user_id',1)->orderBy('title')->limit(3)->get();
```

---

### Étape 8 : Créer un *scope* personnalisé (optionnel)

> Un *scope* permet de créer une requête réutilisable dans le modèle.

**Dans `app/Models/Article.php` :**
{% raw %}

```php
public function scopeRecent($query)
{
    return $query->orderBy('created_at', 'desc')->take(5);
}
```

{% endraw %}

**Dans Tinker :**

```php
>>> Article::recent()->get();
```

---

## 📘 Bonus — Combiner Eloquent et Query Builder

> Vous pouvez exécuter des requêtes avancées directement sur Eloquent.

```php
>>> Article::where('title','like','%laravel%')
... ->selectRaw('user_id, count(*) as total')
... ->groupBy('user_id')
... ->get();
```

---

## 🧾 Résumé et points-clés

| Action            | Méthode Eloquent               | Exemple                              |
| ----------------- | ------------------------------ | ------------------------------------ |
| **Créer**         | `create()` / `save()`          | `Article::create([...])`             |
| **Lire**          | `all()`, `find()`, `where()`   | `Article::where('user_id',1)->get()` |
| **Mettre à jour** | `update()`                     | `$article->update([...])`            |
| **Supprimer**     | `delete()`                     | `$article->delete()`                 |
| **Relations**     | `with()`, `attach()`, `sync()` | `$a->tags()->sync([1,2])`            |
| **Scopes**        | `scopeNom()`                   | `Article::recent()->get()`           |

