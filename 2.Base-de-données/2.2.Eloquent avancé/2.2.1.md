---
title: 1. Scopes & requÃªtes
layout: home
nav_order: 1
parent: 2.2. Eloquent avancÃ©
permalink: /eloquent-avance/scopes-requetes/
code: 2.2.1
competence: C2
autoformation: "C2.2"
ua: "2.2.U1"
duree_h: 1.5
objectif: "Structurer des requÃªtes maintenables avec scopes, filtres conditionnels et sous-requÃªtes/EXISTS."
notions_nouvelles: ["Scope local", "Scope global", "when()", "Sous-requÃªte", "EXISTS/NOT EXISTS"]
fil_rouge: "Blog Laravel + App Mobile (lecture & ranking)"
livrable_chapitre: "MÃ©thodes Article::search(), Article::filter() et withLastCommentDate() + liste paginÃ©e fonctionnelle"
alimentation_prototype: "N2 : recherche/tri multi-critÃ¨res cÃ´tÃ© /api/articles"
alimentation_miniprojet: "N3 : page Liste avec tri/filtre + ordre par derniÃ¨re activitÃ©"
---


# ğŸ“˜ Chapitre 2.2.1 â€” Scopes & requÃªtes complexes

## ğŸ“’ Glossaire minute
- **Scope local** : mÃ©thode `scopeXxx()` dans un modÃ¨le qui **rÃ©utilise** un filtre (`Article::published()->search('laravel')`).
- **Scope global** : rÃ¨gle appliquÃ©e **automatiquement** Ã  toutes les requÃªtes dâ€™un modÃ¨le (ex. `published = 1`).
- **when()** : applique **conditionnellement** un morceau de requÃªte selon une valeur dâ€™entrÃ©e.
- **Sous-requÃªte (subquery)** : requÃªte imbriquÃ©e dans un `SELECT`/`ORDER BY` via `selectSub()` / `addSelect()`.
- **EXISTS / NOT EXISTS** : filtre performant basÃ© sur lâ€™**existence** de lignes associÃ©es.

## ğŸ¯ Objectif pÃ©dagogique
Structurer des **requÃªtes expressives et maintenables** : crÃ©er des **scopes locaux** rÃ©utilisables, enchaÃ®ner des **filtres conditionnels**, et intÃ©grer des **sous-requÃªtes** / `EXISTS` pour rÃ©soudre des cas mÃ©tiers sans multiplier les contrÃ´leurs.

---

## ğŸ” Exemple appliquÃ© au fil rouge
Dans le **Blog Laravel**, on veut :
- Lister les articles **publiÃ©s** uniquement.
- Rechercher par **titre**/**extrait**/**contenu**.
- Filtrer par **auteur**, **pÃ©riode**, **statut**.
- Trier selon une **liste blanche** de colonnes (`created_at`, `title`, etc.).
- (Bonus) Pour lâ€™ordre, utiliser la **date du dernier commentaire** via sous-requÃªte.

---

## ğŸ›  Tutoriel pratique

**Arborescence ciblÃ©e :**
```

app/Models/Article.php
app/Models/Scopes/PublishedScope.php         (optionnel)
app/Http/Controllers/ArticleController.php   (index avec filtres)

````

### Ã‰tape 1 â€” Scopes locaux de base (`Article`)

```php
<?php
// app/Models/Article.php
namespace App\Models;

use Illuminate\Database\Eloquent\Builder;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Support\Arr;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\DB;

class Article extends Model
{
    use HasFactory;

    protected $fillable = ['user_id','title','slug','excerpt','content','is_published','published_at'];

    /* ---------- SCOPES LOCAUX ---------- */

    // 1) PubliÃ©s (ET publiÃ©s dans le passÃ© si date fournie)
    public function scopePublished(Builder $q): Builder
    {
        return $q->where('is_published', true)
                 ->when($this->getConnection()->getDriverName() === 'mysql', fn($qq) =>
                     $qq->where(function ($qqq) {
                         $qqq->whereNull('published_at')->orWhere('published_at', '<=', now());
                     })
                 );
    }

    // 2) Recherche plein-texte "simple" (LIKE) sur plusieurs colonnes
    public function scopeSearch(Builder $q, ?string $term): Builder
    {
        $term = trim((string) $term);
        if ($term === '') return $q;

        $like = '%'.str_replace(['%','_'], ['\%','\_'], $term).'%';
        return $q->where(function ($qq) use ($like) {
            $qq->where('title', 'like', $like)
               ->orWhere('excerpt', 'like', $like)
               ->orWhere('content', 'like', $like);
        });
    }

    // 3) Filtre "combinÃ©" & tri (liste blanche)
    public function scopeFilter(Builder $q, array $filters): Builder
    {
        $authorId = Arr::get($filters, 'author');
        $status   = Arr::get($filters, 'status');    // 'published' | 'draft' | null
        $from     = Arr::get($filters, 'from');      // 'YYYY-mm-dd'
        $to       = Arr::get($filters, 'to');
        $sort     = Arr::get($filters, 'sort', '-created_at'); // ex: "-created_at", "title"

        $q->when($authorId, fn($qq) => $qq->where('user_id', $authorId));

        $q->when($status === 'published', fn($qq) => $qq->where('is_published', true))
          ->when($status === 'draft',     fn($qq) => $qq->where('is_published', false));

        $q->when($from, fn($qq) => $qq->whereDate('created_at', '>=', $from))
          ->when($to,   fn($qq) => $qq->whereDate('created_at', '<=', $to));

        // Tri sÃ©curisÃ© (liste blanche)
        $allowed = ['created_at','title','published_at'];
        $dir = Str::startsWith($sort, '-') ? 'desc' : 'asc';
        $col = ltrim($sort, '-');

        if (! in_array($col, $allowed, true)) {
            $col = 'created_at'; $dir = 'desc';
        }

        return $q->orderBy($col, $dir);
    }

    // 4) Sous-requÃªte : date du dernier commentaire (si table comments existe)
    public function scopeWithLastCommentDate(Builder $q): Builder
    {
        return $q->addSelect([
            'last_comment_at' => DB::table('comments')
                ->selectRaw('MAX(comments.created_at)')
                ->whereColumn('comments.article_id', 'articles.id')
        ]);
    }
}
````

> Astuce : prÃ©fÃ©rez `scopeFilter()` pour centraliser les rÃ¨gles de tri/filtre, vos contrÃ´leurs restent **fins**.

---

### Ã‰tape 2 â€” ContrÃ´leur : combiner les scopes

```php
<?php
// app/Http/Controllers/ArticleController.php (extrait index)
namespace App\Http\Controllers;

use App\Models\Article;
use Illuminate\Http\Request;

class ArticleController extends Controller
{
    public function index(Request $request)
    {
        $filters = $request->only(['q','author','status','from','to','sort']);

        $articles = Article::query()
            ->when($filters['q'] ?? null, fn($q, $term) => $q->search($term))
            ->filter($filters)
            ->withLastCommentDate()        // bonus : sous-requÃªte
            ->paginate(12)
            ->appends($filters);           // conserve les paramÃ¨tres dans la pagination

        return view('articles.index', compact('articles','filters'));
    }
}
```

---

### Ã‰tape 3 â€” Scope global (optionnel)

```php
<?php
// app/Models/Scopes/PublishedScope.php
namespace App\Models\Scopes;

use Illuminate\Database\Eloquent\Builder;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Scope;

class PublishedScope implements Scope
{
    public function apply(Builder $builder, Model $model): void
    {
        $builder->where('is_published', true);
    }
}
```

```php
// app/Models/Article.php (dans class Article)
protected static function booted(): void
{
    // Applique le filtre "publiÃ©" partout (dÃ©sactivable au besoin)
    // static::addGlobalScope(new \App\Models\Scopes\PublishedScope);
}
```

> Pour **dÃ©sactiver temporairement** : `Article::withoutGlobalScopes()->get()` ou `->withoutGlobalScope(PublishedScope::class)`.

---

### Ã‰tape 4 â€” EXISTS / NOT EXISTS (exemples ciblÃ©s)

```php
use Illuminate\Support\Facades\DB;

// Articles qui ont au moins un commentaire
$withComments = \App\Models\Article::whereExists(function ($q) {
    $q->select(DB::raw(1))
      ->from('comments')
      ->whereColumn('comments.article_id', 'articles.id');
});

// Articles sans commentaire
$withoutComments = \App\Models\Article::whereNotExists(function ($q) {
    $q->select(DB::raw(1))
      ->from('comments')
      ->whereColumn('comments.article_id', 'articles.id');
});
```

---

## ğŸ§ª VÃ©rifications rapides (Tinker)

```bash
php artisan tinker
```

```php
// 1) Recherche + tri
App\Models\Article::search('laravel')->filter(['sort' => '-title'])->limit(3)->get(['id','title']);

// 2) PÃ©riode + auteur
App\Models\Article::filter(['author'=>1,'from'=>'2025-01-01','to'=>'2025-12-31'])->count();

// 3) Dernier commentaire en colonne calculÃ©e
App\Models\Article::withLastCommentDate()->orderByDesc('last_comment_at')->take(3)->get(['id','title','last_comment_at']);

// 4) DÃ©sactiver le global scope (si activÃ©)
App\Models\Article::withoutGlobalScopes()->where('is_published', false)->count();
```

---

## ğŸ§¾ RÃ©sumÃ© et points-clÃ©s

* Les **scopes locaux** rendent les requÃªtes **lisibles et DRY** (`search`, `filter`, etc.).
* `when()` permet dâ€™ajouter un filtre **seulement si** une valeur est fournie.
* Les **listes blanches** sÃ©curisent le **tri** (Ã©vite lâ€™injection via `orderBy`).
* Les **sous-requÃªtes** et **EXISTS** rÃ©solvent des besoins avancÃ©s sans surcharger lâ€™Eloquent des relations.

---

## ğŸ©º DÃ©pannage (frÃ©quents)

| ProblÃ¨me                                                | Cause                                      | Solution                                                                    |
| ------------------------------------------------------- | ------------------------------------------ | --------------------------------------------------------------------------- |
| Tri non pris en compte                                  | Colonne non whitelisteÌe                   | VÃ©rifier la **liste blanche** dans `scopeFilter()`                          |
| SQL ambigu (`column 'id' in where clause is ambiguous`) | Jointures/sous-requÃªtes sans qualification | Utiliser des prÃ©fixes (`articles.id`) et `select('articles.*')`             |
| Recherche lente                                         | LIKE sur plusieurs colonnes non indexÃ©es   | Ajouter index sur les colonnes utiles ou basculer vers **FULLTEXT** (MySQL) |
| Global scope gÃªnant                                     | Filtre appliquÃ© partout                    | `withoutGlobalScope()` / **dÃ©sactiver** au besoin                           |

---

## âœ… Checklist dâ€™acceptation

* [ ] `scopeSearch()` et `scopeFilter()` **chainables** et testÃ©s.
* [ ] Tri **sÃ©curisÃ©** par **liste blanche**.
* [ ] `withLastCommentDate()` **ajoute** une colonne calculÃ©e exploitable (`ORDER BY`).
* [ ] Page index fonctionnelle avec filtres via query string (`?q=&author=&status=&from=&to=&sort=`).

