---
title: 6. Comptes & privil√®ges
layout: home
nav_order: 6
parent: 2.2. Eloquent avanc√©
permalink: /eloquent-avance/2-2-6-comptes-privileges/
---

# üìò Chapitre 2.2.6 ‚Äî Comptes & privil√®ges (GRANT/REVOKE)

## üìí Glossaire minute
- **Compte** : couple `user@host` autoris√© √† se connecter (ex. `'blog_app'@'%'`).
- **Privil√®ge** : droit accord√© sur une **port√©e** (GLOBAL, BDD, TABLE, COLONNE).
- **GRANT** : accorder des privil√®ges/roles √† un compte.
- **REVOKE** : retirer des privil√®ges/roles.
- **R√¥le (ROLE)** : groupe de privil√®ges attribuable √† plusieurs comptes.
- **Principe du moindre privil√®ge** : ne donner **que** le n√©cessaire.
- **REQUIRE SSL** : oblige la connexion chiffr√©e.

## üéØ Objectif p√©dagogique
Cr√©er des **r√¥les** et des **comptes** MySQL pour s√©parer :
1) l‚Äôutilisateur **applicatif** (lecture/√©criture basique),  
2) l‚Äôutilisateur **migrations** (DDL),  
3) l‚Äôutilisateur **lecture seule** (reporting).  
Savoir **auditer**, **r√©voquer** et **s√©curiser** ces acc√®s.

---

## üîç Exemple appliqu√© au fil rouge
Pour le **Blog Laravel** (base `blog_db`) :
- `blog_app` (runtime Laravel) : `SELECT, INSERT, UPDATE, DELETE` sur `blog_db.*`.
- `blog_migrator` (artisan migrate) : `CREATE, ALTER, DROP, INDEX` sur `blog_db.*`.
- `blog_read` (reporting/dashboard) : `SELECT` uniquement.

---

## üõ† Tutoriel pratique

> Connexion administrateur (ex. `root@localhost`) dans le client MySQL.

### √âtape 1 ‚Äî Cr√©er les **r√¥les**
```sql
CREATE ROLE IF NOT EXISTS 'role_app_rw', 'role_migrator', 'role_reader';

-- Droits par r√¥le
GRANT SELECT, INSERT, UPDATE, DELETE ON blog_db.* TO 'role_app_rw';
GRANT CREATE, ALTER, DROP, INDEX        ON blog_db.* TO 'role_migrator';
GRANT SELECT                            ON blog_db.* TO 'role_reader';
````

### √âtape 2 ‚Äî Cr√©er les **comptes**

```sql
-- Compte applicatif (depuis n'importe quelle IP) + SSL recommand√©
CREATE USER IF NOT EXISTS 'blog_app'@'%' IDENTIFIED BY 'MotDePasseFort!';
ALTER USER 'blog_app'@'%' REQUIRE SSL;

-- Compte migrations (uniquement en local)
CREATE USER IF NOT EXISTS 'blog_migrator'@'localhost' IDENTIFIED BY 'MotDePasseFort!';

-- Compte lecture seule (pour dataviz/exports)
CREATE USER IF NOT EXISTS 'blog_read'@'%' IDENTIFIED BY 'MotDePasseFort!';
```

### √âtape 3 ‚Äî Attribuer les **r√¥les** aux comptes

```sql
GRANT 'role_app_rw'   TO 'blog_app'@'%';
GRANT 'role_migrator' TO 'blog_migrator'@'localhost';
GRANT 'role_reader'   TO 'blog_read'@'%';

-- Rendre les r√¥les actifs par d√©faut
SET DEFAULT ROLE 'role_app_rw'   TO 'blog_app'@'%';
SET DEFAULT ROLE 'role_migrator' TO 'blog_migrator'@'localhost';
SET DEFAULT ROLE 'role_reader'   TO 'blog_read'@'%';
```

> Variante sans r√¥les (direct) :
> `GRANT SELECT, INSERT, UPDATE, DELETE ON blog_db.* TO 'blog_app'@'%';`

### √âtape 4 ‚Äî Auditer les droits

```sql
SHOW GRANTS FOR 'blog_app'@'%';
SHOW GRANTS FOR 'blog_migrator'@'localhost';
SHOW GRANTS FOR 'blog_read'@'%';
```

### √âtape 5 ‚Äî R√©voquer/ajuster

```sql
-- Retirer la capacit√© d'UPDATE √† l'app
REVOKE UPDATE ON blog_db.* FROM 'blog_app'@'%';

-- Enlever un r√¥le
REVOKE 'role_migrator' FROM 'blog_app'@'%';

-- Supprimer un compte
DROP USER IF EXISTS 'blog_read'@'%';
```

### √âtape 6 ‚Äî Bonnes pratiques suppl√©mentaires

```sql
-- Rotation p√©riodique des mots de passe
ALTER USER 'blog_app'@'%' IDENTIFIED BY 'NouveauMot2Passe++';

-- Politique d'expiration (ex. 180 jours)
ALTER USER 'blog_app'@'%' PASSWORD EXPIRE INTERVAL 180 DAY;

-- Verrouillage apr√®s tentatives infructueuses (si activ√© par votre distribution)
-- ALTER USER 'blog_app'@'%' FAILED_LOGIN_ATTEMPTS 5 PASSWORD_LOCK_TIME 2;
```

---

## üîß Int√©gration Laravel

**.env (runtime)**

```env
DB_DATABASE=blog_db
DB_USERNAME=blog_app
DB_PASSWORD=MotDePasseFort!
DB_SSL_CA=/path/ca.pem        # si REQUIRE SSL et CA disponible
```

**Ex√©cuter les migrations avec le compte d√©di√©**

```bash
# Linux/macOS
DB_USERNAME=blog_migrator DB_PASSWORD=MotDePasseFort! php artisan migrate --force
```

> √âviter d‚Äôutiliser `root` dans `.env`. S√©parer **runtime** et **migrations**.

---

## üß™ V√©rifications rapides

```sql
-- Avec 'blog_app' : doit R√âUSSIR
SELECT COUNT(*) FROM blog_db.articles;

-- Avec 'blog_app' : doit √âCHOUER (pas de DDL)
ALTER TABLE blog_db.articles ADD COLUMN tmp_test INT;

-- Avec 'blog_migrator' : doit R√âUSSIR (DDL autoris√©)
ALTER TABLE blog_db.articles ADD COLUMN tmp_test INT;
ALTER TABLE blog_db.articles DROP COLUMN tmp_test;
```

---

## üßæ R√©sum√© et points-cl√©s

* Cr√©er des **r√¥les** puis attribuer aux **comptes** : maintenance plus simple.
* **S√©parer** `blog_app` (CRUD), `blog_migrator` (DDL), `blog_read` (lecture).
* Limiter le **host** (`'localhost'` vs `'%'`) et **imposer SSL** c√¥t√© prod.
* **Auditer** r√©guli√®rement avec `SHOW GRANTS` et **r√©voquer** si besoin.
* Ne jamais donner `SUPER`, `FILE`, ou `GRANT OPTION` √† un compte applicatif.

---

## ü©∫ D√©pannage (fr√©quents)

| Probl√®me                            | Cause                                      | Solution                                                                              |
| ----------------------------------- | ------------------------------------------ | ------------------------------------------------------------------------------------- |
| `Access denied for user 'x'@'host'` | Mauvais `host` du compte (`localhost`‚â†`%`) | Cr√©er le compte avec le bon host, v√©rifier l‚ÄôIP d‚Äôorigine                             |
| `ER_TABLEACCESS_DENIED_ERROR`       | Privil√®ge manquant                         | Ajouter le privil√®ge pr√©cis sur la **bonne port√©e** (BDD/table)                       |
| Connexion SSL requise               | `REQUIRE SSL` activ√©                       | Fournir `DB_SSL_CA`/certs c√¥t√© Laravel ou retirer `REQUIRE SSL` (d√©conseill√© en prod) |
| Migrations en prod refus√©es         | Compte runtime sans DDL                    | Utiliser **`blog_migrator`** pour `php artisan migrate`                               |

---

## ‚úÖ Checklist d‚Äôacceptation

* [ ] R√¥les **cr√©√©s** (`role_app_rw`, `role_migrator`, `role_reader`).
* [ ] Comptes **cr√©√©s** et **restreints** par host (`%` / `localhost`).
* [ ] `blog_app` ‚Üí CRUD uniquement ; `blog_migrator` ‚Üí DDL ; `blog_read` ‚Üí SELECT.
* [ ] `SHOW GRANTS` v√©rifi√© pour chaque compte.
* [ ] `.env` **sans root**, SSL exig√© si disponible.
