---
title: 5. Sauvegarde & CSV
layout: home
nav_order: 5
parent: 2.2. Eloquent avanc√©
permalink: /eloquent-avance/sauvegarde-csv/
code: 2.2.5
competence: C2
autoformation: "C2.2"
ua: "2.2.U3"
duree_h: 1.5
objectif: "Sauvegarder/restaurer une base et ma√Ætriser export/import CSV (MySQL ou Laravel)."
notions_nouvelles: ["mysqldump", "Dump", "LOAD DATA [LOCAL] INFILE", "secure_file_priv", "UPSERT/Idempotence"]
fil_rouge: "Blog Laravel + App Mobile (lecture & ranking)"
livrable_chapitre: "Dump .sql(.gz) + export articles.csv + import en table staging avec int√©gration contr√¥l√©e"
alimentation_prototype: "N2 : export CSV des articles pour contr√¥le/partage"
alimentation_miniprojet: "N3 : proc√©dure backup/restore + pipeline staging‚Üíprod"
---


# üìò Chapitre 2.2.5 ‚Äî Sauvegarde/restauration (`mysqldump`), import/export CSV

## üìí Glossaire minute
- **`mysqldump`** : outil CLI pour **sauvegarder** la structure et/ou les donn√©es MySQL.
- **Dump** : fichier texte SQL (optionnellement **compress√©**) contenant `CREATE TABLE` + `INSERT`.
- **`LOAD DATA [LOCAL] INFILE`** : chargement **rapide** d‚Äôun CSV vers une table.
- **`secure_file_priv`** : r√©pertoire autoris√© pour `INTO OUTFILE` / `LOAD DATA` (s√©curit√© MySQL).
- **Idempotent** : commande relan√ßable sans cons√©quence ind√©sirable (ex. `--add-drop-table`).

## üéØ Objectif p√©dagogique
√ätre capable de :
1) **Sauvegarder** et **restaurer** une base via `mysqldump`/`mysql`.  
2) **Exporter** un tableau **en CSV** et **r√©importer** proprement (MySQL ou Laravel).

---

## üîç Exemple appliqu√© au fil rouge
Sur le **Blog Laravel** (base `blog_db`) :
- Sauvegarde **compl√®te** (`schema + data`), et **structure seule**.
- Restauration **propre** dans une base vide (ex. `blog_db_restore`).
- Export CSV des **articles** puis import CSV vers une table **staging**.

---

## üõ† Tutoriel pratique

**Arborescence conseill√©e :**
```

project/
‚îî‚îÄ storage/backups/
‚îú‚îÄ blog\_\$(date).sql.gz
‚îú‚îÄ articles\_\$(date).csv
‚îî‚îÄ README-backups.md

````

### √âtape 1 ‚Äî Pr√©parer les variables (facultatif mais utile)

```bash
# Linux/macOS (bash)
export DB_HOST=127.0.0.1 DB_NAME=blog_db DB_USER=root DB_PWD=secret
# Windows PowerShell
$env:DB_HOST="127.0.0.1"; $env:DB_NAME="blog_db"; $env:DB_USER="root"; $env:DB_PWD="secret"
````

---

### A) Sauvegarde avec **mysqldump**

**1) Dump complet (structure + donn√©es)**

```bash
# Linux/macOS (gzip)
mysqldump -h $DB_HOST -u $DB_USER -p$DB_PWD \
  --routines --triggers --single-transaction --quick \
  $DB_NAME | gzip > storage/backups/${DB_NAME}_$(date +%F_%H%M).sql.gz
```

**2) Dump structure seule**

```bash
mysqldump -h $DB_HOST -u $DB_USER -p$DB_PWD \
  --no-data $DB_NAME > storage/backups/${DB_NAME}_schema_$(date +%F).sql
```

**3) Dump donn√©es seules (sans `CREATE TABLE`)**

```bash
mysqldump -h $DB_HOST -u $DB_USER -p$DB_PWD \
  --no-create-info $DB_NAME > storage/backups/${DB_NAME}_data_$(date +%F).sql
```

> Options cl√©s :
> `--single-transaction` (consistant sur InnoDB), `--quick` (flux par lignes), `--routines/--triggers` si utilis√©s.

---

### B) Restauration avec **mysql**

**0) Cr√©er (si besoin) une base de restauration**

```bash
mysql -h $DB_HOST -u $DB_USER -p$DB_PWD -e "CREATE DATABASE IF NOT EXISTS blog_db_restore CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
```

**1) Restauration depuis un dump compress√©**

```bash
gunzip -c storage/backups/blog_db_2025-08-27_1200.sql.gz | \
  mysql -h $DB_HOST -u $DB_USER -p$DB_PWD blog_db_restore
```

**2) Restauration depuis un dump .sql**

```bash
mysql -h $DB_HOST -u $DB_USER -p$DB_PWD blog_db_restore < storage/backups/blog_db_schema_2025-08-27.sql
```

> Astuce : valider ensuite avec `mysql -e "SHOW TABLES;" blog_db_restore`.

---

### C) Export **CSV** (plusieurs m√©thodes)

**üÖ∞ MySQL `SELECT ... INTO OUTFILE` (rapide, n√©cessite `secure_file_priv`)**

```sql
-- Dans MySQL
SHOW VARIABLES LIKE 'secure_file_priv';
-- Supposons qu'il renvoie /var/lib/mysql-files/
SELECT id,user_id,title,slug,created_at
INTO OUTFILE '/var/lib/mysql-files/articles.csv'
FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
LINES TERMINATED BY '\n'
FROM articles
ORDER BY id;
```

**üÖ± CLI MySQL batch (pas de contrainte `secure_file_priv`)**

```bash
mysql -h $DB_HOST -u $DB_USER -p$DB_PWD --batch --skip-column-names \
  -e "SELECT id,user_id,title,slug,created_at FROM $DB_NAME.articles ORDER BY id" \
  | tr '\t' ',' > storage/backups/articles_$(date +%F).csv
```

**üÖ≤ Export c√¥t√© Laravel (artisan tinker ou commande)**

```php
// artisan tinker
$fp = fopen('storage/backups/articles.csv', 'w');
fputcsv($fp, ['id','user_id','title','slug','created_at']);
\App\Models\Article::orderBy('id')->chunk(100, function($rows) use ($fp){
  foreach ($rows as $r) {
    fputcsv($fp, [$r->id, $r->user_id, $r->title, $r->slug, $r->created_at]);
  }
});
fclose($fp);
```

---

### D) Import **CSV** (table staging recommand√©e)

**1) Cr√©er une table `articles_staging`**

```sql
CREATE TABLE IF NOT EXISTS articles_staging (
  id BIGINT UNSIGNED,
  user_id BIGINT UNSIGNED,
  title VARCHAR(180),
  slug VARCHAR(200),
  created_at DATETIME NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**2) `LOAD DATA [LOCAL] INFILE`**

```sql
-- Si le fichier est c√¥t√© serveur (respect de secure_file_priv)
LOAD DATA INFILE '/var/lib/mysql-files/articles.csv'
INTO TABLE articles_staging
FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
LINES TERMINATED BY '\n'
IGNORE 0 LINES
(id, user_id, title, slug, created_at);
```

```bash
# Variante "LOCAL" si le fichier est sur le poste client
mysql --local-infile=1 -h $DB_HOST -u $DB_USER -p$DB_PWD $DB_NAME \
  -e "LOAD DATA LOCAL INFILE 'storage/backups/articles_2025-08-27.csv'
      INTO TABLE articles_staging
      FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '\"'
      LINES TERMINATED BY '\n'
      IGNORE 1 LINES
      (id,user_id,title,slug,created_at)"
```

**3) Int√©grer depuis `staging` vers `articles` (avec contr√¥le)**

```sql
-- Exemple d'UPSERT contr√¥l√© (MySQL 8)
INSERT INTO articles (id,user_id,title,slug,created_at,updated_at)
SELECT s.id, s.user_id, s.title, s.slug, s.created_at, NOW()
FROM articles_staging s
ON DUPLICATE KEY UPDATE
  title = VALUES(title),
  slug  = VALUES(slug),
  updated_at = NOW();
```

> Bonnes pratiques : nettoyer/normaliser en staging (trim, slug unique), puis pousser.

---

## üß™ V√©rifications rapides (Tinker/CLI)

```bash
# V√©rifier tables apr√®s restauration
mysql -h $DB_HOST -u $DB_USER -p$DB_PWD -e "USE blog_db_restore; SHOW TABLES;"

# Compter les lignes import√©es
mysql -h $DB_HOST -u $DB_USER -p$DB_PWD -e "SELECT COUNT(*) FROM articles_staging;" $DB_NAME
```

```php
// V√©rifier c√¥t√© Laravel
\App\Models\Article::on('mysql')->count();
```

---

## üßæ R√©sum√© et points-cl√©s

* `mysqldump` + `mysql` couvrent l‚Äôessentiel **backup/restore** (penser √† **gzip**).
* `SELECT ... INTO OUTFILE` et `LOAD DATA` sont **ultra-rapides** mais soumis √† `secure_file_priv`.
* Alternatives **sans privil√®ges** : `--batch` (TSV ‚Üí CSV) ou **export Laravel** (`fputcsv` + `chunk`).
* Importer d‚Äôabord en **staging**, contr√¥ler, puis **UPSERT** vers les tables finales.

---

## ü©∫ D√©pannage (fr√©quents)

| Probl√®me                                                  | Cause                | Correctif                                                                     |
| --------------------------------------------------------- | -------------------- | ----------------------------------------------------------------------------- |
| `The MySQL server is running with the --secure-file-priv` | Dossier non autoris√© | Utiliser ce dossier, configurer MySQL, **ou** `LOAD DATA LOCAL INFILE`        |
| `Access denied for user ...`                              | Droits insuffisants  | Accorder `FILE`/`SELECT` le cas √©ch√©ant, ou passer par la m√©thode **Laravel** |
| Caract√®res accentu√©s corrompus                            | Encodage             | Forcer `utf8mb4`, v√©rifier `SET NAMES utf8mb4` (variables client)             |
| Lignes dupliqu√©es √† l‚Äôimport                              | PK/unique manquants  | Ajouter **contraintes uniques** ou utiliser **UPSERT**                        |

---

## ‚úÖ Checklist d‚Äôacceptation

* [ ] Dump **complet** g√©n√©r√© et restaur√© **sans erreur**.
* [ ] Export CSV obtenu (au moins 5 colonnes) et **lisible**.
* [ ] Import CSV via `LOAD DATA` **ou** script Laravel valid√©.
* [ ] Int√©gration via **staging** + **UPSERT** r√©alis√©e.
* [ ] Proc√©dure document√©e dans `storage/backups/README-backups.md`.
