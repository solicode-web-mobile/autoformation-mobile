---
title: 3. Handler dâ€™exceptions
layout: home
nav_order: 3
parent: 3.3. SÃ©curitÃ©
permalink: /securite/handler-exceptions/
code: 3.3.3
competence: C3
autoformation: "C3.4"
ua: "3.3.U2"
duree_h: 1.5
objectif: "Uniformiser les rÃ©ponses dâ€™erreur JSON pour lâ€™API tout en conservant des pages dâ€™erreur web lisibles."
notions_nouvelles: ["Handler", "renderable()", "expectsJson()", "ValidationException (422)", "AuthenticationException (401)", "AuthorizationException (403)", "404/429", "payload JSON"]
fil_rouge: "Blog Laravel + App Mobile (API propre)"
livrable_chapitre: "Handler.php avec dÃ©tection API, formats JSON stables (401/403/404/422/429/500) + vues 404/500 optionnelles."
alimentation_prototype: "N2 : erreurs API cohÃ©rentes consommables par le Mobile."
alimentation_miniprojet: "N3 : base pour la journalisation/observabilitÃ©."
---

# ğŸ“˜  3.3.3 - *Handler* dâ€™exceptions 

## ğŸ“’ Glossaire minute
- **`Handler`** : classe centrale (`app/Exceptions/Handler.php`) qui **intercepte** et **formate** les erreurs.
- **`renderable()`** : enregistre un **rendu personnalisÃ©** par type dâ€™exception.
- **NÃ©gociation de contenu** : `expectsJson()` / route `api/*` â†’ choisir **JSON** vs **HTML**.
- **Exceptions courantes** : `ValidationException` (422), `AuthenticationException` (401), `AuthorizationException` (403), `ModelNotFoundException`/`NotFoundHttpException` (404), `ThrottleRequestsException` (429).

---

## ğŸ¯ Objectif pÃ©dagogique
Mettre en place un **format dâ€™erreur JSON uniforme** pour lâ€™API tout en conservant de belles **pages dâ€™erreur web** :
- DÃ©tecter **API vs Web**,
- Normaliser les **payloads JSON** (code, message, dÃ©tails),
- GÃ©rer les cas frÃ©quents (401/403/404/422/429/500),
- Laisser **Laravel** servir les vues dâ€™erreur HTML en mode web.

---

## âœ… PrÃ©-requis
- Projet Laravel fonctionnel (3.1.1)
- Middlewares `auth`, `throttle`, CORS configurÃ©s (3.3.1)
- Des routes API existantes (`/api/articles`) (3.2.1/3.2.2)

---

## ğŸ§­ Ã‰tapes guidÃ©es

### 1) DÃ©tecter lâ€™API dans le `Handler`
`app/Exceptions/Handler.php`
```php
<?php

namespace App\Exceptions;

use Throwable;
use Illuminate\Auth\Access\AuthorizationException;
use Illuminate\Auth\AuthenticationException;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Illuminate\Http\Exceptions\ThrottleRequestsException;
use Illuminate\Validation\ValidationException;
use Symfony\Component\HttpKernel\Exception\NotFoundHttpException;
use Illuminate\Foundation\Exceptions\Handler as ExceptionHandler;

class Handler extends ExceptionHandler
{
    /** DÃ©termine si on doit rÃ©pondre en JSON (API) */
    protected function isApi($request): bool
    {
        return $request->expectsJson() || $request->is('api/*');
    }

    /** Convertit une exception en payload JSON + status HTTP */
    protected function toApiResponse(Throwable $e): array
    {
        $status = 500;
        $code   = 'SERVER_ERROR';
        $msg    = 'Une erreur interne est survenue.';

        if ($e instanceof ValidationException) {
            $status = 422; $code = 'VALIDATION_ERROR';
            return [
                'status'  => $status,
                'body'    => [
                    'status'  => 'error',
                    'code'    => $code,
                    'message' => 'Les donnÃ©es fournies sont invalides.',
                    'errors'  => $e->errors(),
                ],
            ];
        }
        if ($e instanceof AuthenticationException) {
            $status = 401; $code = 'AUTHENTICATION_REQUIRED'; $msg = 'Authentification requise.';
        } elseif ($e instanceof AuthorizationException) {
            $status = 403; $code = 'FORBIDDEN'; $msg = 'AccÃ¨s refusÃ©.';
        } elseif ($e instanceof ModelNotFoundException || $e instanceof NotFoundHttpException) {
            $status = 404; $code = 'NOT_FOUND'; $msg = 'Ressource introuvable.';
        } elseif ($e instanceof ThrottleRequestsException) {
            $status = 429; $code = 'RATE_LIMITED'; $msg = 'Trop de requÃªtes. RÃ©essayez plus tard.';
        }

        $body = [
            'status'  => 'error',
            'code'    => $code,
            'message' => $msg,
        ];

        // En dev, exposer un peu plus dâ€™infos (facultatif)
        if (config('app.debug')) {
            $body['exception'] = class_basename($e);
            $body['trace_id']  = substr(md5($e->getMessage().$e->getFile().$e->getLine()), 0, 8);
        }

        return ['status' => $status, 'body' => $body];
    }

    public function register(): void
    {
        // Validation â†’ JSON propre
        $this->renderable(function (ValidationException $e, $request) {
            if ($this->isApi($request)) {
                $res = $this->toApiResponse($e);
                return response()->json($res['body'], $res['status']);
            }
        });

        // 401 / 403 / 404 / 429 / 500 (gÃ©nÃ©ral)
        $this->renderable(function (Throwable $e, $request) {
            if ($this->isApi($request)) {
                $res = $this->toApiResponse($e);
                return response()->json($res['body'], $res['status']);
            }
        });
    }

    /** JSON custom pour Ã©chec dâ€™auth (redirige cÃ´tÃ© web, JSON cÃ´tÃ© API) */
    protected function unauthenticated($request, AuthenticationException $exception)
    {
        if ($this->isApi($request)) {
            return response()->json([
                'status'  => 'error',
                'code'    => 'AUTHENTICATION_REQUIRED',
                'message' => 'Authentification requise.',
            ], 401);
        }
        return redirect()->guest(route('login'));
    }
}
````

> **Principe** :
>
> * **API** â†’ rÃ©ponses **JSON** uniformes (avec `code`, `message`, `errors?`).
> * **Web** â†’ les **vues dâ€™erreur** standard (`resources/views/errors/*.blade.php`) prennent le relais.

---

### 2) (Option) Pages dâ€™erreur web lisibles

CrÃ©er des vues minimalistes :

```
resources/views/errors/404.blade.php
resources/views/errors/500.blade.php
```

`resources/views/errors/404.blade.php`

{% raw %}
```php
@extends('layouts.app')

@section('content')
  <h1>404 â€” Page introuvable</h1>
  <p>La ressource demandÃ©e nâ€™existe pas ou a Ã©tÃ© dÃ©placÃ©e.</p>
  <a href="{{ url('/') }}">â† Retour Ã  lâ€™accueil</a>
@endsection
```
{% endraw %}

---

### 3) DÃ©monstrations rapides

**A) 404 API**

```php
// routes/api.php
Route::get('/boom', fn() => abort(404));
```

`GET /api/boom` â†’

```json
{ "status":"error","code":"NOT_FOUND","message":"Ressource introuvable." }
```

**B) 401 API**

```php
// routes/api.php
Route::get('/private', fn() => ['ok' => true])->middleware('auth:api');
```

Sans token â†’

```json
{ "status":"error","code":"AUTHENTICATION_REQUIRED","message":"Authentification requise." }
```

**C) 422 Validation**
Une route POST qui valide `title` :

```php
// routes/api.php
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Route;

Route::post('/check', function (Request $r) {
    $r->validate(['title' => ['required','min:3']]);
    return ['ok' => true];
});
```

`POST /api/check` avec `{}` â†’

```json
{
  "status":"error",
  "code":"VALIDATION_ERROR",
  "message":"Les donnÃ©es fournies sont invalides.",
  "errors":{"title":["The title field is required."]}
}
```

**D) 429 Throttle**
Appliquez `->middleware('throttle:api')` et bombardez la route :

```json
{ "status":"error","code":"RATE_LIMITED","message":"Trop de requÃªtes. RÃ©essayez plus tard." }
```

---

## ğŸ” Bonnes pratiques

* **Ne divulguez pas** la trace complÃ¨te en prod (`APP_DEBUG=false`).
* **Codes dâ€™erreur stables** (`VALIDATION_ERROR`, `NOT_FOUND`, â€¦) pour le **Mobile**.
* Laissez **Laravel** gÃ©rer le HTML des erreurs cÃ´tÃ© web (page 404/500 personnalisables).
* Centralisez toute la **normalisation JSON** dans le *Handler* (Ã©vite la duplication dans les contrÃ´leurs).

---

## ğŸ§© IntÃ©gration fil rouge

* Lâ€™API `/api/articles` renverra dÃ©sormais des **erreurs standardisÃ©es**.
* Les Ã©crans web (CRUD auteur) continuent dâ€™afficher des **pages dâ€™erreur** propres.
* En 3.3.4, on **journalise** finement (canaux Monolog, niveaux, rotation).

---

## ğŸ›  Challenge (N1+)

* CrÃ©ez `App\Exceptions\ApiException` (avec `$status`, `$code`, `$context`) et un `renderable()` dÃ©diÃ©.
* Ajoutez un **trace\_id** injectÃ© dans les logs pour corrÃ©ler front â†” back.
* Internationalisez les **messages** dâ€™erreur avec `lang/fr/validation.php` et un fichier `lang/fr/errors.php`.

---

## ğŸ§¾ RÃ©sumÃ©

* Le *Handler* unifie **API** (JSON) et **Web** (HTML) sans dupliquer la logique.
* **DÃ©tection API** : `expectsJson()` / `api/*`.
* **Payloads JSON** constants : `status`, `code`, `message`, `errors?`.
* Couverture des cas clÃ©s : **401/403/404/422/429/500**.

**Livrable attendu** :

* `app/Exceptions/Handler.php` mis Ã  jour,
* (option) vues `resources/views/errors/404.blade.php` & `500.blade.php`,
* Tests Postman/cURL vÃ©rifiant les statuts et la structure JSON.
