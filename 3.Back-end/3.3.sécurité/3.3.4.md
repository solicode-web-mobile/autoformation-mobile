---
title: 4. Logs centralis√©s
layout: home
nav_order: 4
parent: 3.3. S√©curit√©
permalink: /securite/logs/
code: 3.3.4
competence: C3
autoformation: "C3.4"
ua: "3.3.U2"
duree_h: 1.5
objectif: "Centraliser et structurer les logs (niveaux, rotation, canal audit, alerte Slack) pour diagnostiquer et auditer."
notions_nouvelles: ["Monolog", "Channel/stack", "Handler", "Processor", "Level", "Rotation daily", "tap", "Slack", "Canal audit", "RGPD"]
fil_rouge: "Blog Laravel + App Mobile (diagnostic & audit)"
livrable_chapitre: "config/logging.php (stack daily+slack) + canal 'audit' (tap CustomizeAuditLogs) + extraits anonymis√©s (rotation OK)."
alimentation_prototype: "N2 : journaliser actions cl√©s et incidents applicatifs."
alimentation_miniprojet: "N3 : audit Article + alerte Slack sur incidents critiques."
---


# üìò  3.3.4 - Logs centralis√©s 

## üìí Glossaire minute
- **Monolog** : biblioth√®que de logging utilis√©e par Laravel.
- **Channel (canal)** : *pipeline* de log (ex. `single`, `daily`, `slack`, `stack`).
- **Handler** : destination des logs (fichier, Slack, Syslog‚Ä¶).
- **Processor** : enrichit automatiquement les entr√©es (ex. `uid`, IP, user).
- **Level** : gravit√© (`debug`, `info`, `notice`, `warning`, `error`, `critical`, `alert`, `emergency`).
- **Rotation** : cr√©ation d‚Äôun fichier par jour + purge au-del√† de *N* jours (`daily`).

---

## üéØ Objectifs p√©dagogiques
√Ä la fin du chapitre, vous saurez :
1. Choisir et configurer les **canaux** de logs (fichiers, Slack‚Ä¶).  
2. Appliquer des **niveaux** adapt√©s et **structurer** vos messages (contexte).  
3. Activer la **rotation** et la **r√©tention** (purge) des fichiers de log.  
4. Cr√©er un **canal custom** (ex. `audit`) et l‚Äôutiliser depuis le code.

---

## üß± Pr√©-requis
- Handler d‚Äôexceptions (chap. **3.3.3**) pr√™t √† renvoyer des erreurs uniformes.
- Projet Laravel fonctionnel avec `.env` propre.

---

## ‚öôÔ∏è R√©glages de base (env + config)

`.env`
```env
LOG_CHANNEL=stack
LOG_LEVEL=debug
# (optionnel) Slack pour alertes critiques
LOG_SLACK_WEBHOOK_URL=https://hooks.slack.com/services/XXX/YYY/ZZZ
````

`config/logging.php` (extraits ‚Äî valeurs par d√©faut Laravel adapt√©es)

```php
<?php

return [

    'default' => env('LOG_CHANNEL', 'stack'),

    'channels' => [

        'stack' => [
            'driver' => 'stack',
            'channels' => ['daily', 'slack'],   // on empile daily + slack
            'ignore_exceptions' => false,
        ],

        'single' => [
            'driver' => 'single',
            'path' => storage_path('logs/laravel.log'),
            'level' => env('LOG_LEVEL', 'debug'),
        ],

        'daily' => [
            'driver' => 'daily',
            'path' => storage_path('logs/laravel.log'),
            'level' => env('LOG_LEVEL', 'debug'),
            'days' => 14, // r√©tention de 14 jours
        ],

        'slack' => [
            'driver' => 'slack',
            'url' => env('LOG_SLACK_WEBHOOK_URL'),
            'username' => 'SoliBlog Logger',
            'emoji' => ':rotating_light:',
            'level' => 'critical', // n‚Äôenvoie que critical+ vers Slack
        ],

        // ---- Canal custom "audit" (voir plus bas) ----
        'audit' => [
            'driver' => 'daily',
            'path'   => storage_path('logs/audit/audit.log'),
            'level'  => 'info',
            'days'   => 7,
            // Ajout de processors Monolog via "tap"
            'tap'    => [App\Logging\CustomizeAuditLogs::class],
        ],
    ],
];
```

> üîé **Rotation** : le driver `daily` cr√©e `laravel-YYYY-MM-DD.log` et supprime les plus anciens apr√®s `days`.
> üí¨ **Stack** : envoie le m√™me message √† **plusieurs** canaux (ici `daily` + `slack`).

---

## üß™ Utiliser les logs c√¥t√© code

```php
use Illuminate\Support\Facades\Log;

// Niveau & contexte
Log::info('Article cr√©√©', ['slug' => $article->slug, 'user_id' => auth()->id()]);
Log::warning('Tentative d‚Äôacc√®s non autoris√©', ['route' => request()->path()]);
Log::error('√âchec d‚Äôenvoi email', ['exception' => $e->getMessage()]);

// Cibler un canal pr√©cis
Log::channel('audit')->info('Article mis √† jour', [
    'slug' => $article->slug,
    'before' => $before,
    'after'  => $after,
]);

// Utiliser un stack ad hoc (temporaire)
Log::stack(['daily', 'slack'])->critical('DB indisponible', ['dsn' => config('database.default')]);
```

### Bonnes pratiques de **niveau**

* `debug` : d√©tails techniques pendant dev (d√©sactiver en prod).
* `info` : √©v√©nements m√©tiers normaux (cr√©ation d‚Äôarticle, login).
* `warning` : anormal **r√©cup√©rable** (retry possible).
* `error` : √©chec d‚Äôune action utilisateur (exception catch√©e).
* `critical/alert/emergency` : incidents **prod** n√©cessitant alerte (Slack).

---

## üß© Canal **audit** d√©di√© (cr√©ation & enrichissement)

### 1) Cr√©er le dossier & la classe de *tap*

```
app/Logging/CustomizeAuditLogs.php
```

```php
<?php

namespace App\Logging;

use Monolog\Logger;
use Monolog\Processor\UidProcessor;
use Monolog\Processor\IntrospectionProcessor;

class CustomizeAuditLogs
{
    public function __invoke(Logger $logger): void
    {
        // Ajoute un identifiant de corr√©lation (uid) et l‚Äôorigine du log (fichier:ligne)
        $logger->pushProcessor(new UidProcessor());
        $logger->pushProcessor(new IntrospectionProcessor(Logger::DEBUG, ['Illuminate\\']));
        // Vous pouvez pousser un processor custom pour IP, user_id, request_id...
        $logger->pushProcessor(function (array $record) {
            $record['extra']['ip'] = request()?->ip();
            $record['extra']['user_id'] = auth()->id();
            $record['extra']['route'] = request()?->path();
            return $record;
        });
    }
}
```

> üß† `tap` permet d‚Äôinjecter des **processors** Monolog au moment o√π Laravel construit le canal.

### 2) Exemple d‚Äôusage c√¥t√© **CRUD Article**

```php
Log::channel('audit')->info('article.store', [
    'slug' => $article->slug,
    'title'=> $article->title,
]);

Log::channel('audit')->info('article.update', [
    'slug'   => $article->slug,
    'changes'=> ['title' => [$oldTitle, $article->title]],
]);

Log::channel('audit')->info('article.destroy', [
    'slug' => $article->slug,
    'soft' => method_exists($article, 'trashed') ? $article->trashed() : false,
]);
```

---

## üîê S√©curit√© & conformit√©

* **Attention aux donn√©es sensibles** : ne pas logger mots de passe, tokens, num√©ros carte, etc.
* **RGPD** : anonymiser/masquer si n√©cessaire (IP tronqu√©e, hash user, etc.).
* **Volume** : limiter `debug` en **prod** (utiliser `LOG_LEVEL=info`).

---

## üß™ Exercice guid√© (livrable N1)

> **But** : mettre en place un **journal d‚Äôaudit** pour `Article` + alerte Slack en cas d‚Äô√©chec critique.

**Exigences**

1. Cr√©er le canal `audit` (driver `daily`, `days=7`) et la classe `CustomizeAuditLogs`.
2. Logger dans `audit` les actions `store/update/destroy` avec `slug`, `user_id`, `ip`.
3. D√©finir `slack.level=critical` et envoyer un `critical` quand l‚Äôupdate √©choue (ex. exception DB).
4. V√©rifier que la **rotation** purge bien au-del√† de 7 jours.
5. D√©poser un extrait anonymis√© de `storage/logs/audit/audit-*.log` dans `docs/logs/`.

---

## ‚úÖ Crit√®res de r√©ussite

* `storage/logs/laravel-YYYY-MM-DD.log` et `storage/logs/audit/audit-YYYY-MM-DD.log` existent.
* Les entr√©es contiennent `uid`, `ip`, `user_id`, `route` (processors actifs).
* Les niveaux sont pertinents (`info` pour audit, `error/critical` pour incidents).
* Slack re√ßoit une alerte **uniquement** pour `critical+`.

---

## ‚ö†Ô∏è Erreurs fr√©quentes

* Oublier de cr√©er le **r√©pertoire** `storage/logs/audit` (droits insuffisants en prod).
* Spammer Slack avec des `info` ‚Üí **r√©glez** `level` sur `critical`.
* Laisser `LOG_LEVEL=debug` en prod ‚Üí volume & co√ªts.
* Logger des **donn√©es personnelles** en clair ‚Üí anonymiser.

---

## üßæ R√©sum√©

* Les logs doivent √™tre **centralis√©s**, **structur√©s** (contexte) et **rot√©s**.
* Le **stack** combine plusieurs destinations (fichier + Slack).
* Un canal **custom** `audit` isole les √©v√©nements m√©tiers sensibles.

---

## üîú Suite

Revenez au **Handler d‚Äôexceptions** (3.3.3) pour unifier **formats d‚Äôerreur** et **logguer** l√† o√π √ßa compte (erreurs 5xx, rejets 422/403) ‚Äî puis pr√©parez l‚Äô**observabilit√©** (metrics, traces) en T3.
