---
title: 1. Middlewares
layout: home
nav_order: 1
parent: 3.3. SÃ©curitÃ©
permalink: /securite/middlewares-auth-throttle-cors/
---

# ğŸ“˜  3.3.1 - Middlewares clÃ©s

## ğŸ“’ Glossaire minute
- **Middleware** : â€œintercepteurâ€ qui entoure la requÃªte HTTP pour **vÃ©rifier**, **autoriser** ou **modifier** avant dâ€™atteindre le contrÃ´leur.
- **`auth`** : vÃ©rifie quâ€™un utilisateur est **connectÃ©** (gardien `web` par dÃ©faut).
- **`throttle`** : **limite de dÃ©bit** (rate limiting) par IP/utilisateur pour prÃ©venir lâ€™abus.
- **CORS** : rÃ¨gles autorisant un **domaine externe** (ex. app mobile / front) Ã  appeler votre API.

---

## ğŸ¯ Objectif pÃ©dagogique
Configurer et utiliser 3 middlewares essentiels :
1) **`auth`** pour protÃ©ger les Ã©crans sensibles,  
2) **`throttle`** pour limiter les appels (API),  
3) **CORS** pour exposer lâ€™API Ã  votre front/app mobile **en sÃ©curitÃ©**.

---

## âœ… PrÃ©-requis
- Projet Laravel fonctionnel (3.1.1)
- CRUD `Article` opÃ©rationnel (3.1.6) â€“ utile pour tester `auth`/`throttle`
- (Optionnel) **Breeze** pour un login prÃªt Ã  lâ€™emploi

---

## 1) Middleware `auth` : protÃ©ger des routes

### A) ProtÃ©ger une page (back-office)
`routes/web.php`
```php
use Illuminate\Support\Facades\Route;

// Tableau de bord â€œauteurâ€
Route::get('/dashboard', function () {
    return view('dashboard'); // crÃ©ez resources/views/dashboard.blade.php
})->middleware('auth')->name('dashboard');
````

> Sans systÃ¨me dâ€™authentification, `auth` redirigera vers `/login`.
> **RecommandÃ©** : installer **Breeze** (auth minimal, sessions) pour ce chapitre.

### (Optionnel) Installer Breeze

```bash
composer require laravel/breeze --dev
php artisan breeze:install
php artisan migrate
npm install && npm run build   # ou: npm run dev
```

Vous obtenez `/register`, `/login`, `/logout` et un layout de base.

---

## 2) Middleware `throttle` : limiter le dÃ©bit (API)

### A) DÃ©finir votre limiteur nommÃ© (Laravel 10+ classique)

`app/Providers/RouteServiceProvider.php`

```php
use Illuminate\Cache\RateLimiting\Limit;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\RateLimiter;

public function boot(): void
{
    // Limiteur API global (dÃ©jÃ  prÃ©sent en gÃ©nÃ©ral)
    RateLimiter::for('api', function (Request $request) {
        return Limit::perMinute(60)->by($request->user()?->id ?: $request->ip());
    });

    // Limiteur spÃ©cifique â€œarticlesâ€
    RateLimiter::for('articles', function (Request $request) {
        // Exemple mixte : 60/min et 200/heure
        return [
            Limit::perMinute(60)->by($request->user()?->id ?: $request->ip()),
            Limit::perHour(200)->by($request->ip()),
        ];
    });
}
```

> ğŸ’¡ Sur Laravel 11, la dÃ©claration peut se faire dans `bootstrap/app.php` via le **builder**. Conservez la mÃªme logique `RateLimiter::for(...)`.

### B) Appliquer le limiteur sur la route

`routes/api.php`

```php
use Illuminate\Support\Facades\Route;
use App\Http\Controllers\Api\ArticleController;

Route::middleware(['throttle:articles'])->get('/articles', [ArticleController::class, 'index']);
```

> `throttle:articles` utilise le profil que vous venez de dÃ©finir.
> Sans nom, `throttle:api` applique la limite par dÃ©faut du groupe API.

---

## 3) CORS : autoriser votre front / app mobile

### A) Configurer `config/cors.php`

```php
return [
    'paths' => ['api/*', 'sanctum/csrf-cookie'],
    'allowed_methods' => ['*'],
    'allowed_origins' => [
        'http://localhost:5173',      // Vite (front local)
        'http://127.0.0.1:5173',
        // 'http://10.0.2.2:5173',     // Android emulator â†’ accÃ¨s host
    ],
    'allowed_headers' => ['*'],
    'exposed_headers' => [],
    'max_age' => 0,
    'supports_credentials' => false,   // true si cookies/Session/Sanctum cÃ´tÃ© front
];
```

> **API publique simple** : gardez `supports_credentials=false`.
> **SPA + session/cookies** : passez Ã  `true` (et listez prÃ©cisÃ©ment vos origins).
> AprÃ¨s modification : `php artisan config:clear`.

### B) VÃ©rifier le prÃ©-vol (Preflight)

* Une requÃªte **OPTIONS** est automatiquement gÃ©rÃ©e par le middleware CORS.
* Testez avec **Postman** ou votre front dev pour vÃ©rifier les en-tÃªtes de rÃ©ponse (`Access-Control-Allow-*`).

---

## ğŸ§­ Mise en pratique rapide

1. **ProtÃ©ger** le back-office :

```php
// routes/web.php
Route::middleware('auth')->group(function () {
    Route::resource('articles', \App\Http\Controllers\ArticleController::class)->except(['index']);
});
```

Gardez la liste publique :

```php
Route::get('/', fn() => redirect()->route('articles.index'));
Route::get('/articles', [\App\Http\Controllers\ArticleController::class, 'index'])->name('articles.index');
```

2. **Limiter** lâ€™API :

```php
// routes/api.php
Route::middleware('throttle:articles')->get('/articles', [\App\Http\Controllers\Api\ArticleController::class, 'index']);
```

3. **CORS** : adaptez `allowed_origins` Ã  votre front/app mobile et nettoyez la config :

```bash
php artisan config:clear
```

---

## ğŸ” Diagnostics & erreurs courantes

* **419 Page Expired** sur formulaire â†’ Oubli de `@csrf` (cf. 3.1.3).
* **401/Redirect /login** â†’ Route protÃ©gÃ©e par `auth` sans utilisateur connectÃ© (installez **Breeze**).
* **429 Too Many Requests** â†’ Limite **throttle** atteinte (vÃ©rifiez vos profils ou augmentez la fenÃªtre).
* **CORS blocked** dans la console â†’ `allowed_origins` incorrects ou `supports_credentials` mal rÃ©glÃ©.

---

## ğŸ§© IntÃ©gration fil rouge

* Back-office `Article` **protÃ©gÃ©** (`auth`) ; la **liste publique** reste ouverte.
* Endpoint `/api/articles` **limitÃ©** (`throttle:articles`) pour prÃ©venir lâ€™abus.
* **CORS** configurÃ© pour permettre Ã  lâ€™**app Mobile** de consommer lâ€™API.

---

## ğŸ§ª Challenge (N1+)

* CrÃ©ez un **middleware custom** `EnsureJsonAccepts` qui force `Accept: application/json` sur `/api/*`.
* Ajoutez un **profil throttle** plus strict pour `POST /api/articles` (ex. `10/min`).
* Activez un **logging** succinct des requÃªtes refusÃ©es pour analyse (via events/listeners ou middleware simple).

---

## ğŸ§¾ RÃ©sumÃ©

* `auth` protÃ¨ge les routes sensibles (installez **Breeze** pour tester rapidement).
* `throttle` limite le **dÃ©bit** (profils nommÃ©s via `RateLimiter::for()` + `throttle:profil`).
* **CORS** ouvre lâ€™API Ã  votre front/app mobile **de maniÃ¨re contrÃ´lÃ©e**.

**Livrable attendu** :

* Routes protÃ©gÃ©es `auth`,
* Endpoint API avec `throttle:articles`,
* `config/cors.php` ajustÃ© (origins dev),
* Tests manuels OK (login, 429, appels cross-origin).

```
```
