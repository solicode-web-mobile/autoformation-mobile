---
title: 1. Middlewares
layout: home
nav_order: 1
parent: 3.3. Sécurité
permalink: /securite/middlewares-auth-throttle-cors/
---

# 📘  3.3.1 - Middlewares clés

## 📒 Glossaire minute
- **Middleware** : “intercepteur” qui entoure la requête HTTP pour **vérifier**, **autoriser** ou **modifier** avant d’atteindre le contrôleur.
- **`auth`** : vérifie qu’un utilisateur est **connecté** (gardien `web` par défaut).
- **`throttle`** : **limite de débit** (rate limiting) par IP/utilisateur pour prévenir l’abus.
- **CORS** : règles autorisant un **domaine externe** (ex. app mobile / front) à appeler votre API.

---

## 🎯 Objectif pédagogique
Configurer et utiliser 3 middlewares essentiels :
1) **`auth`** pour protéger les écrans sensibles,  
2) **`throttle`** pour limiter les appels (API),  
3) **CORS** pour exposer l’API à votre front/app mobile **en sécurité**.

---

## ✅ Pré-requis
- Projet Laravel fonctionnel (3.1.1)
- CRUD `Article` opérationnel (3.1.6) – utile pour tester `auth`/`throttle`
- (Optionnel) **Breeze** pour un login prêt à l’emploi

---

## 1) Middleware `auth` : protéger des routes

### A) Protéger une page (back-office)
`routes/web.php`
```php
use Illuminate\Support\Facades\Route;

// Tableau de bord “auteur”
Route::get('/dashboard', function () {
    return view('dashboard'); // créez resources/views/dashboard.blade.php
})->middleware('auth')->name('dashboard');
````

> Sans système d’authentification, `auth` redirigera vers `/login`.
> **Recommandé** : installer **Breeze** (auth minimal, sessions) pour ce chapitre.

### (Optionnel) Installer Breeze

```bash
composer require laravel/breeze --dev
php artisan breeze:install
php artisan migrate
npm install && npm run build   # ou: npm run dev
```

Vous obtenez `/register`, `/login`, `/logout` et un layout de base.

---

## 2) Middleware `throttle` : limiter le débit (API)

### A) Définir votre limiteur nommé (Laravel 10+ classique)

`app/Providers/RouteServiceProvider.php`

```php
use Illuminate\Cache\RateLimiting\Limit;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\RateLimiter;

public function boot(): void
{
    // Limiteur API global (déjà présent en général)
    RateLimiter::for('api', function (Request $request) {
        return Limit::perMinute(60)->by($request->user()?->id ?: $request->ip());
    });

    // Limiteur spécifique “articles”
    RateLimiter::for('articles', function (Request $request) {
        // Exemple mixte : 60/min et 200/heure
        return [
            Limit::perMinute(60)->by($request->user()?->id ?: $request->ip()),
            Limit::perHour(200)->by($request->ip()),
        ];
    });
}
```

> 💡 Sur Laravel 11, la déclaration peut se faire dans `bootstrap/app.php` via le **builder**. Conservez la même logique `RateLimiter::for(...)`.

### B) Appliquer le limiteur sur la route

`routes/api.php`

```php
use Illuminate\Support\Facades\Route;
use App\Http\Controllers\Api\ArticleController;

Route::middleware(['throttle:articles'])->get('/articles', [ArticleController::class, 'index']);
```

> `throttle:articles` utilise le profil que vous venez de définir.
> Sans nom, `throttle:api` applique la limite par défaut du groupe API.

---

## 3) CORS : autoriser votre front / app mobile

### A) Configurer `config/cors.php`

```php
return [
    'paths' => ['api/*', 'sanctum/csrf-cookie'],
    'allowed_methods' => ['*'],
    'allowed_origins' => [
        'http://localhost:5173',      // Vite (front local)
        'http://127.0.0.1:5173',
        // 'http://10.0.2.2:5173',     // Android emulator → accès host
    ],
    'allowed_headers' => ['*'],
    'exposed_headers' => [],
    'max_age' => 0,
    'supports_credentials' => false,   // true si cookies/Session/Sanctum côté front
];
```

> **API publique simple** : gardez `supports_credentials=false`.
> **SPA + session/cookies** : passez à `true` (et listez précisément vos origins).
> Après modification : `php artisan config:clear`.

### B) Vérifier le pré-vol (Preflight)

* Une requête **OPTIONS** est automatiquement gérée par le middleware CORS.
* Testez avec **Postman** ou votre front dev pour vérifier les en-têtes de réponse (`Access-Control-Allow-*`).

---

## 🧭 Mise en pratique rapide

1. **Protéger** le back-office :

```php
// routes/web.php
Route::middleware('auth')->group(function () {
    Route::resource('articles', \App\Http\Controllers\ArticleController::class)->except(['index']);
});
```

Gardez la liste publique :

```php
Route::get('/', fn() => redirect()->route('articles.index'));
Route::get('/articles', [\App\Http\Controllers\ArticleController::class, 'index'])->name('articles.index');
```

2. **Limiter** l’API :

```php
// routes/api.php
Route::middleware('throttle:articles')->get('/articles', [\App\Http\Controllers\Api\ArticleController::class, 'index']);
```

3. **CORS** : adaptez `allowed_origins` à votre front/app mobile et nettoyez la config :

```bash
php artisan config:clear
```

---

## 🔍 Diagnostics & erreurs courantes

* **419 Page Expired** sur formulaire → Oubli de `@csrf` (cf. 3.1.3).
* **401/Redirect /login** → Route protégée par `auth` sans utilisateur connecté (installez **Breeze**).
* **429 Too Many Requests** → Limite **throttle** atteinte (vérifiez vos profils ou augmentez la fenêtre).
* **CORS blocked** dans la console → `allowed_origins` incorrects ou `supports_credentials` mal réglé.

---

## 🧩 Intégration fil rouge

* Back-office `Article` **protégé** (`auth`) ; la **liste publique** reste ouverte.
* Endpoint `/api/articles` **limité** (`throttle:articles`) pour prévenir l’abus.
* **CORS** configuré pour permettre à l’**app Mobile** de consommer l’API.

---

## 🧪 Challenge (N1+)

* Créez un **middleware custom** `EnsureJsonAccepts` qui force `Accept: application/json` sur `/api/*`.
* Ajoutez un **profil throttle** plus strict pour `POST /api/articles` (ex. `10/min`).
* Activez un **logging** succinct des requêtes refusées pour analyse (via events/listeners ou middleware simple).

---

## 🧾 Résumé

* `auth` protège les routes sensibles (installez **Breeze** pour tester rapidement).
* `throttle` limite le **débit** (profils nommés via `RateLimiter::for()` + `throttle:profil`).
* **CORS** ouvre l’API à votre front/app mobile **de manière contrôlée**.

**Livrable attendu** :

* Routes protégées `auth`,
* Endpoint API avec `throttle:articles`,
* `config/cors.php` ajusté (origins dev),
* Tests manuels OK (login, 429, appels cross-origin).

```
```
