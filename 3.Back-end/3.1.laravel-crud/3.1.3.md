---
title: 3. Formulaires & CSRF
layout: home
nav_order: 3
parent: 3.1. CRUD avec Laravel
permalink: /laravel-crud/formulaires-csrf/
code: 3.1.3
competence: C3
autoformation: "C3.2"
ua: "3.1.U2"
duree_h: 1.5
objectif: "Construire un formulaire s√©curis√© avec CSRF, validation initiale, erreurs par champ et flash."
notions_nouvelles: ["CSRF token", "$errors (MessageBag)", "old()", "flash message", "validate()"]
fil_rouge: "Blog Laravel + App Mobile (saisie d‚Äôarticles)"
livrable_chapitre: "Routes `articles.create/store`, contr√¥leur avec `validate()`, vue Blade `@csrf` + `old()` + `@error` + flash"
alimentation_prototype: "Forme la base des formulaires du prototype CRUD admin"
alimentation_miniprojet: "Saisie contr√¥l√©e dans le back-office"
---


# üìò  3.1.3 - Formulaires, CSRF, sessions

# üìò 3.1.3 ‚Äî Formulaires & CSRF

## üéØ Objectif p√©dagogique
Tu vas apprendre √† cr√©er un **formulaire s√©curis√©** dans Laravel avec :
- protection **CSRF** contre les attaques web,
- validation des donn√©es c√¥t√© serveur,
- affichage clair des **erreurs par champ**,
- conservation des valeurs saisies avec `old()`,
- affichage d‚Äôun **message flash** de confirmation.

---

## üìí Glossaire minute
- **CSRF** (*Cross-Site Request Forgery*) : protection automatique de Laravel contre les requ√™tes malveillantes, via le jeton `@csrf`.  
- **`$errors`** : objet de type **MessageBag** contenant les erreurs de validation.  
- **`old()`** : permet de r√©cup√©rer les anciennes valeurs d‚Äôun champ apr√®s validation √©chou√©e.  
- **Flash message** : message temporaire stock√© en session (`session('status')`).  
- **`validate()`** : m√©thode int√©gr√©e de Laravel qui v√©rifie les entr√©es et redirige en cas d‚Äôerreur.

---

## üß≠ √âtapes guid√©es ‚Äî Phase I : Imiter

### üß© √âtape 1 ‚Äî D√©finir les routes du formulaire

Un formulaire n√©cessite deux routes :  
une pour **afficher la page**, et une autre pour **g√©rer la soumission**.

`routes/web.php`
```php
use Illuminate\Support\Facades\Route;
use App\Http\Controllers\ArticleController;

Route::get('/articles/create', [ArticleController::class, 'create'])->name('articles.create');
Route::post('/articles',        [ArticleController::class, 'store'])->name('articles.store');
````

La premi√®re route appelle la m√©thode `create()` pour afficher la vue,
tandis que la seconde appelle `store()` pour traiter les donn√©es envoy√©es via POST.

---


Voici ta **section corrig√©e et enrichie** avec une explication compl√®te, fluide et int√©gr√©e de la ligne
`return back()->withInput()->with('status', ...)`, tout en gardant la clart√© et le style p√©dagogique du reste du tutoriel üëá

---

### üß© √âtape 2 ‚Äî Cr√©er le contr√¥leur du formulaire

Le contr√¥leur joue le r√¥le d‚Äôinterm√©diaire entre la vue et la logique de validation.
Il re√ßoit les donn√©es saisies par l‚Äôutilisateur, les v√©rifie, puis d√©cide de la r√©ponse √† renvoyer.
C‚Äôest lui qui fait le lien entre le formulaire et le comportement attendu du serveur.

Cr√©e le contr√¥leur :

```bash
php artisan make:controller ArticleController
```

`app/Http/Controllers/ArticleController.php`

```php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;

class ArticleController extends Controller
{
    public function create()
    {
        // Affiche la vue du formulaire
        return view('articles.create');
    }

    public function store(Request $request)
    {
        // √âtape 1 ‚Äî Validation des donn√©es
        // Cette m√©thode v√©rifie les champs envoy√©s selon les r√®gles d√©finies
        $validated = $request->validate([
            'title'   => ['required','string','min:3','max:150'],
            'slug'    => ['nullable','string','max:180'],
            'content' => ['nullable','string'],
            'tags'    => ['nullable','string'],
        ], [
            'title.required' => 'Le titre est obligatoire.',
            'title.min'      => 'Le titre doit contenir au moins :min caract√®res.',
            'title.max'      => 'Le titre doit contenir au plus :max caract√®res.',
        ]);

        // √âtape 2 ‚Äî Retour utilisateur
        // On redirige l‚Äôutilisateur vers le formulaire avec :
        // - les anciennes valeurs saisies (old input)
        // - un message flash de confirmation
        return back()
            ->withInput()
            ->with('status', 'Formulaire re√ßu avec succ√®s ! (La sauvegarde sera ajout√©e au chapitre 3.1.5)');
    }
}
```

La m√©thode `validate()` effectue la v√©rification des donn√©es selon les r√®gles indiqu√©es.

* Si une erreur est d√©tect√©e, Laravel **redirige automatiquement** vers la page pr√©c√©dente et envoie les messages d‚Äôerreur dans la variable `$errors`.
* Si tout est correct, le code continue et ex√©cute la ligne `return back()->withInput()->with('status', ...)`.

Voici ce que fait pr√©cis√©ment cette instruction :

* **`back()`** : redirige vers la page pr√©c√©dente (le formulaire).
* **`withInput()`** : conserve en session les valeurs saisies, ce qui permet √† `old('champ')` dans la vue Blade de pr√©remplir les champs.
* **`with('status', '...')`** : envoie un **message flash temporaire** affich√© apr√®s redirection (souvent en haut de la page), confirmant la r√©ussite de l‚Äôenvoi.

Ce m√©canisme est tr√®s utilis√© dans Laravel car il rend les formulaires **conviviaux et r√©silients** :
l‚Äôutilisateur garde ses donn√©es et re√ßoit un feedback imm√©diat apr√®s chaque soumission.





---

### üß© √âtape 3 ‚Äî Cr√©er le layout avec erreurs et flash message

Ce layout centralise l‚Äôaffichage des erreurs et messages de succ√®s pour toutes les pages.

`resources/views/layouts/app.blade.php`

{% raw %}

```php
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>{{ $title ?? 'Blog' }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  <main style="max-width:760px;margin:2rem auto;padding:1rem;">

    {{-- Message de succ√®s --}}
    @if (session('status'))
      <div style="padding:.75rem;background:#e6ffed;border:1px solid #86efac;margin-bottom:1rem;">
        {{ session('status') }}
      </div>
    @endif

    {{-- Erreurs globales --}}
    @if ($errors->any())
      <div style="padding:.75rem;background:#ffe6e6;border:1px solid #f87171;margin-bottom:1rem;">
        <strong>Veuillez corriger les erreurs suivantes :</strong>
        <ul style="margin:.5rem 0 0 1rem;">
          @foreach ($errors->all() as $error)
            <li>{{ $error }}</li>
          @endforeach
        </ul>
      </div>
    @endif

    @yield('content')
  </main>
</body>
</html>
```

{% endraw %}

Gr√¢ce √† ce layout, toutes les vues qui l‚Äô√©tendent pourront afficher automatiquement les erreurs et messages flash.

---

### üß© √âtape 4 ‚Äî Cr√©er la vue du formulaire avec CSRF, old() et erreurs cibl√©es

La vue affiche le formulaire complet et met en ≈ìuvre toutes les protections n√©cessaires.

`resources/views/articles/create.blade.php`

{% raw %}

```php
@extends('layouts.app')

@section('content')
  <h1>Cr√©er un article</h1>

  <form method="POST" action="{{ route('articles.store') }}" novalidate>
    @csrf

    <div style="margin-bottom:.75rem;">
      <label for="title">Titre *</label><br>
      <input id="title" name="title" type="text"
             value="{{ old('title') }}" required
             style="width:100%;padding:.5rem;border:1px solid #ccc;">
      @error('title')
        <div style="color:#b91c1c;font-size:.9rem;">{{ $message }}</div>
      @enderror
    </div>

    <div style="margin-bottom:.75rem;">
      <label for="slug">Slug</label><br>
      <input id="slug" name="slug" type="text"
             value="{{ old('slug') }}" placeholder="ex : mon-super-article"
             style="width:100%;padding:.5rem;border:1px solid #ccc;">
      @error('slug')
        <div style="color:#b91c1c;font-size:.9rem;">{{ $message }}</div>
      @enderror
    </div>

    <div style="margin-bottom:.75rem;">
      <label for="content">Contenu</label><br>
      <textarea id="content" name="content" rows="6"
                style="width:100%;padding:.5rem;border:1px solid #ccc;">{{ old('content') }}</textarea>
      @error('content')
        <div style="color:#b91c1c;font-size:.9rem;">{{ $message }}</div>
      @enderror
    </div>

    <div style="margin-bottom:1rem;">
      <label for="tags">Tags (s√©par√©s par des virgules)</label><br>
      <input id="tags" name="tags" type="text"
             value="{{ old('tags') }}" placeholder="php, laravel"
             style="width:100%;padding:.5rem;border:1px solid #ccc;">
      @error('tags')
        <div style="color:#b91c1c;font-size:.9rem;">{{ $message }}</div>
      @enderror
    </div>

    <button type="submit" style="padding:.6rem 1rem;background:#111;color:#fff;border:0;">
      Enregistrer (brouillon)
    </button>
  </form>
@endsection
```

{% endraw %}

Chaque champ est s√©curis√© et ergonomique :

* `@csrf` prot√®ge la requ√™te.
* `old('champ')` conserve les valeurs apr√®s redirection.
* `@error('champ')` affiche les messages cibl√©s sous les champs concern√©s.

Ce m√©canisme permet √† l‚Äôapprenant de visualiser imm√©diatement la cause de l‚Äôerreur.

---

## üß™ V√©rification pratique

1. Laisse le champ ‚ÄúTitre‚Äù vide ‚Üí une erreur s‚Äôaffiche.
2. Saisis un titre trop court ‚Üí message ‚Äúau moins 3 caract√®res‚Äù.
3. Remplis correctement le formulaire ‚Üí message vert de succ√®s.

Tu confirmes ainsi que la validation, les erreurs et les messages flash fonctionnent ensemble.

---

## üß† Diagnostic et bonnes pratiques

* Toujours inclure `@csrf` pour les requ√™tes POST.
* Utiliser `$request->validate()` pour √©viter la logique manuelle de v√©rification.
* Exploiter `withInput()` et `old()` pour une meilleure exp√©rience utilisateur.
* Pr√©parer la structure de validation d√®s maintenant pour le futur CRUD.

---

## üß© Int√©gration fil rouge

Cette √©tape pr√©pare le **CRUD Article** du blog Laravel :

* En **3.1.4**, tu externaliseras la validation via un **FormRequest**.
* En **3.1.5**, tu connecteras la base de donn√©es et effectueras la **persistance r√©elle**.
* En **3.1.6**, tu finaliseras le **CRUD complet** avec √©dition et suppression.

---

## üßæ R√©sum√©

* Formulaire s√©curis√© avec `@csrf`.
* Validation serveur automatique via `validate()`.
* Affichage clair des erreurs (`$errors`, `@error`).
* Conservation des donn√©es avec `old()`.
* Flash message pour confirmer la r√©ussite.

