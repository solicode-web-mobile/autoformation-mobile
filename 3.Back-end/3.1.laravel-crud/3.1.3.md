---
title: 3. Formulaires & CSRF
layout: home
nav_order: 3
parent: 3.1. CRUD avec Laravel
permalink: /laravel-crud/formulaires-csrf/
code: 3.1.3
competence: C3
autoformation: "C3.2"
ua: "3.2.U2"
duree_h: 1.5
objectif: "Construire un formulaire s√©curis√© avec CSRF, validation initiale, erreurs par champ et flash."
notions_nouvelles: ["CSRF token", "$errors (MessageBag)", "old()", "flash message", "validate()"]
fil_rouge: "Blog Laravel + App Mobile (saisie d‚Äôarticles)"
livrable_chapitre: "Routes `articles.create/store`, contr√¥leur avec `validate()`, vue Blade `@csrf` + `old()` + `@error` + flash"
alimentation_prototype: "Forme la base des formulaires du prototype CRUD admin"
alimentation_miniprojet: "Saisie contr√¥l√©e dans le back-office"
---


# üìò  3.1.3 - Formulaires, CSRF, sessions

## üìí Glossaire minute
- **CSRF** (*Cross-Site Request Forgery*) : protection int√©gr√©e de Laravel via un **jeton** √† inclure dans chaque formulaire `POST/PUT/PATCH/DELETE` (`@csrf`).
- **`$errors`** : **MessageBag** mis en session automatiquement apr√®s une validation √©chou√©e (`$request->validate(...)`).
- **`old()`** : r√©cup√®re les **anciennes valeurs** du formulaire, flash√©es en session.
- **Flash message** : message **temporaire** en session (ex. `session('status')`) affich√© apr√®s une redirection.

---

## üéØ Objectif p√©dagogique
Mettre en place un **formulaire s√©curis√©** avec :
- insertion du **token CSRF**,
- **validation** c√¥t√© serveur,
- affichage des **messages d‚Äôerreur** par champ et globaux,
- **conservation** des valeurs saisies (`old()`),
- **flash message** de succ√®s.

> ‚ö†Ô∏è Ici, on se concentre sur **formulaire + validation + session** (sans persistance). La sauvegarde en DB arrive au **chapitre 3.1.5**.

---

## ‚úÖ Pr√©-requis
- Projet Laravel initialis√© (cf. **3.1.1**)
- Route `/ping` OK
- Vue de layout basique (ou celle ci-dessous)

---

## üß≠ √âtapes guid√©es

### 1) Routes
`routes/web.php`
```php
use Illuminate\Support\Facades\Route;
use App\Http\Controllers\ArticleController;

Route::get('/articles/create', [ArticleController::class, 'create'])->name('articles.create');
Route::post('/articles',        [ArticleController::class, 'store'])->name('articles.store');
````

### 2) Contr√¥leur

```bash
php artisan make:controller ArticleController
```

`app/Http/Controllers/ArticleController.php`

```php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;

class ArticleController extends Controller
{
    public function create()
    {
        return view('articles.create');
    }

    public function store(Request $request)
    {
        // Validation "inline" (on passera √† FormRequest en 3.1.4)
        $validated = $request->validate([
            'title'   => ['required','string','min:3','max:150'],
            'slug'    => ['nullable','string','max:180'],
            'content' => ['nullable','string'],
            'tags'    => ['nullable','string'], // "php,laravel"
        ], [
            'title.required' => 'Le titre est obligatoire.',
            'title.min'      => 'Le titre doit contenir au moins :min caract√®res.',
            'title.max'      => 'Le titre doit contenir au plus :max caract√®res.',
        ]);

        // üëâ Pas de DB ici : on confirme juste la r√©ception/validation OK
        return back()
            ->withInput() // conserve les valeurs dans le formulaire
            ->with('status', 'Formulaire re√ßu. Validation OK ! (La sauvegarde arrive en 3.1.5)');
    }
}
```

### 3) Layout avec affichage des erreurs & flash

Cr√©e un layout minimal si besoin.

`resources/views/layouts/app.blade.php`

{% raw %}
```php
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>{{ $title ?? 'Blog' }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  @vite([]) {{-- optionnel --}}
</head>
<body>
  <main class="container" style="max-width: 760px; margin: 2rem auto;">
    {{-- Flash succ√®s --}}
    @if (session('status'))
      <div style="padding: .75rem; background:#e6ffed; border:1px solid #86efac; margin-bottom:1rem;">
        {{ session('status') }}
      </div>
    @endif

    {{-- Erreurs globales --}}
    @if ($errors->any())
      <div style="padding: .75rem; background:#ffe6e6; border:1px solid #f87171; margin-bottom:1rem;">
        <strong>Veuillez corriger les erreurs :</strong>
        <ul style="margin:.5rem 0 0 1rem;">
          @foreach ($errors->all() as $error)
            <li>{{ $error }}</li>
          @endforeach
        </ul>
      </div>
    @endif

    @yield('content')
  </main>
</body>
</html>
```
{% endraw %}

### 4) Formulaire Blade avec CSRF + `old()` + erreurs par champ

`resources/views/articles/create.blade.php`

{% raw %}
```php
@extends('layouts.app')

@section('content')
  <h1 style="margin-bottom:1rem;">Cr√©er un article</h1>

  <form method="POST" action="{{ route('articles.store') }}" novalidate>
    @csrf

    <div style="margin-bottom: .75rem;">
      <label for="title">Titre *</label><br>
      <input id="title" name="title" type="text"
             value="{{ old('title') }}" required
             style="width:100%; padding:.5rem; border:1px solid #ccc;">
      @error('title')
        <div style="color:#b91c1c; font-size:.9rem;">{{ $message }}</div>
      @enderror
    </div>

    <div style="margin-bottom: .75rem;">
      <label for="slug">Slug</label><br>
      <input id="slug" name="slug" type="text"
             value="{{ old('slug') }}"
             placeholder="ex : mon-super-article"
             style="width:100%; padding:.5rem; border:1px solid #ccc;">
      @error('slug')
        <div style="color:#b91c1c; font-size:.9rem;">{{ $message }}</div>
      @enderror
    </div>

    <div style="margin-bottom: .75rem;">
      <label for="content">Contenu</label><br>
      <textarea id="content" name="content" rows="6"
                style="width:100%; padding:.5rem; border:1px solid #ccc;">{{ old('content') }}</textarea>
      @error('content')
        <div style="color:#b91c1c; font-size:.9rem;">{{ $message }}</div>
      @enderror
    </div>

    <div style="margin-bottom: 1rem;">
      <label for="tags">Tags (s√©par√©s par des virgules)</label><br>
      <input id="tags" name="tags" type="text"
             value="{{ old('tags') }}" placeholder="php, laravel"
             style="width:100%; padding:.5rem; border:1px solid #ccc;">
      @error('tags')
        <div style="color:#b91c1c; font-size:.9rem;">{{ $message }}</div>
      @enderror
    </div>

    <button type="submit" style="padding:.6rem 1rem; border:0; background:#111; color:#fff;">
      Enregistrer (brouillon)
    </button>
  </form>
@endsection
```
{% endraw %}

---

## üîç Notes & diagnostics

* **Oubli du token CSRF** ‚Üí **HTTP 419** (*Page Expired*). Assurez-vous de mettre `@csrf` dans chaque formulaire.
* **Affichage des erreurs** : `$errors` est dispo dans toutes les vues apr√®s une redirection avec erreurs.
* **Conserver les valeurs** : `withInput()` c√¥t√© contr√¥leur ‚Üí `old('champ')` c√¥t√© vue.
* **Messages personnalis√©s** : 2·µâ argument de `validate([...], [...])` ou via **FormRequest** (chapitre 3.1.4).
* **Erreurs cibl√©es (bag)** : `return back()->withErrors(['slug' => 'D√©j√† pris'])` pour un champ pr√©cis.

---

## üõ† Tutoriel minute (r√©cap express)

```bash
php artisan make:controller ArticleController
# routes/web.php -> routes create/store
# Contr√¥leur -> $request->validate([...]) + with('status')
# Vue -> @csrf + old() + @error
```

---

## üß© Int√©gration fil rouge

* Conservez la vue **create** : elle sera r√©utilis√©e pour le CRUD complet en **3.1.6**.
* En **3.1.4**, on remplace la validation inline par un **FormRequest** (`php artisan make:request StoreArticleRequest`).
* En **3.1.5**, on branchera la **DB** (migrations/seeders) puis on activera la **persistance** r√©elle.

---

## üßæ R√©sum√©

* Les formulaires Laravel doivent inclure **`@csrf`**.
* Apr√®s validation, **les erreurs** sont accessibles via **`$errors`** et les valeurs via **`old()`**.
* Utilisez les **flash messages** (`session('status')`) pour confirmer l‚Äôaction √† l‚Äôutilisateur.

**Livrable attendu** :

* Routes `articles.create` / `articles.store`,
* Contr√¥leur avec `validate(...)` + `with('status')`,
* Vue Blade avec `@csrf`, `old()`, `@error`,
* Test manuel : validation √©choue ‚Üí messages d‚Äôerreur ; validation OK ‚Üí flash succ√®s.
