---
title: 5. ModÃ¨le & migrations
layout: home
nav_order: 5
parent: 3.1. CRUD avec Laravel
permalink: /laravel-crud/article-migrations/
code: 3.1.5
competence: C2
autoformation: "C2.1"
ua: "3.1.U3"
duree_h: 2
objectif: "CrÃ©er le modÃ¨le Article, la table `articles` et un seeder Ã  partir dâ€™un JSON."
notions_nouvelles: ["Migration", "Seeder", "Eloquent Model", "fillable/casts", "getRouteKeyName()", "updateOrCreate()", "slug unique"]
fil_rouge: "Blog Laravel + App Mobile (persistance & seed)"
livrable_chapitre: "Migration `articles`, modÃ¨le `Article`, seeder lisant `storage/seeds/articles.seed.json`"
alimentation_prototype: "Alimente la base de donnÃ©es du CRUD admin"
alimentation_miniprojet: "SchÃ©ma durable et seeds reproductibles"
---


# ğŸ“˜ 3.1.5 â€” ModÃ¨le **Article** + Import CSV

## ğŸ§  Rappel thÃ©orique

Avant dâ€™afficher ou modifier des articles, il faut quâ€™ils existent dans la base de donnÃ©es.  
Une application Laravel stocke ses donnÃ©es dans des **tables SQL**, et permet de les alimenter via des **seeders**.  

Jusquâ€™ici, on utilisait souvent un fichier JSON pour lâ€™import.  
Ici, on dÃ©couvre comment **importer les articles Ã  partir dâ€™un fichier CSV**  
(plus simple Ã  Ã©diter et compatible avec Excel ou Google Sheets).

> ğŸ¯ Objectif : disposer dâ€™une table `articles` peuplÃ©e automatiquement depuis `articles.csv`.

---

## ğŸ“’ Glossaire minute
- **Migration** : crÃ©e la structure des tables.  
- **Seeder** : insÃ¨re des donnÃ©es dans la base.  
- **CSV (Comma-Separated Values)** : format texte simple pour stocker des donnÃ©es tabulaires.  
- **Eloquent Model** : classe qui reprÃ©sente une table et permet de manipuler ses enregistrements.  
- **updateOrCreate()** : insÃ¨re une ligne ou met Ã  jour si elle existe dÃ©jÃ .

---

## ğŸ§­ Ã‰tapes guidÃ©es â€” Phase N2 : Adapter

### ğŸ§© Ã‰tape 1 â€” GÃ©nÃ©rer le modÃ¨le et la migration
```bash
php artisan make:model Article -m
````

---

### ğŸ§© Ã‰tape 2 â€” DÃ©finir le schÃ©ma de la table

`database/migrations/..._create_articles_table.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void {
        Schema::create('articles', function (Blueprint $table) {
            $table->id();
            $table->string('title');
            $table->string('slug')->unique();
            $table->text('excerpt')->nullable();
            $table->unsignedInteger('views')->default(0);
            $table->boolean('published')->default(true);
            $table->timestamps();
        });
    }

    public function down(): void {
        Schema::dropIfExists('articles');
    }
};
```

ğŸ’¡ Le champ `slug` unique permet de retrouver les articles par URL.

---

### ğŸ§© Ã‰tape 3 â€” DÃ©finir le modÃ¨le Eloquent

`app/Models/Article.php`

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Article extends Model
{
    use HasFactory;

    protected $fillable = [
        'title', 'slug', 'excerpt', 'views', 'published',
    ];

    protected $casts = [
        'views'     => 'integer',
        'published' => 'boolean',
    ];

    public function getRouteKeyName(): string
    {
        return 'slug';
    }
}
```

---

### ğŸ§© Ã‰tape 4 â€” CrÃ©er le seeder lisant un fichier CSV

```bash
php artisan make:seeder ArticleSeeder
```

`database/seeders/ArticleSeeder.php`

```php
<?php

namespace Database\Seeders;

use App\Models\Article;
use Illuminate\Database\Seeder;
use Illuminate\Support\Str;

class ArticleSeeder extends Seeder
{
    public function run(): void
    {
        $path = storage_path('seeds/articles.csv');

        if (! file_exists($path)) {
            $this->command->warn("âš ï¸  Fichier manquant : $path (seed ignorÃ©)");
            return;
        }

        if (($handle = fopen($path, 'r')) === false) {
            $this->command->error('âŒ Impossible dâ€™ouvrir le fichier CSV.');
            return;
        }

        $header = fgetcsv($handle, 1000, ';'); // lire la premiÃ¨re ligne (en-tÃªtes)

        while (($row = fgetcsv($handle, 1000, ';')) !== false) {
            $data = array_combine($header, $row);

            $title = trim($data['title'] ?? 'Sans titre');
            $slug  = $data['slug'] ?: Str::slug($title);

            Article::updateOrCreate(
                ['slug' => $slug],
                [
                    'title'     => $title,
                    'excerpt'   => $data['excerpt'] ?? null,
                    'views'     => (int)($data['views'] ?? 0),
                    'published' => filter_var($data['published'] ?? true, FILTER_VALIDATE_BOOL),
                ]
            );
        }

        fclose($handle);

        $this->command->info('âœ… Articles importÃ©s avec succÃ¨s depuis le CSV.');
    }
}
```

ğŸ’¡ Le seeder lit ligne par ligne, transforme les valeurs,
et insÃ¨re les enregistrements tout en Ã©vitant les doublons (`updateOrCreate`).

---

### ğŸ§© Ã‰tape 5 â€” Ajouter le seeder dans `DatabaseSeeder.php`

```php
public function run(): void
{
    $this->call(ArticleSeeder::class);
}
```

---

### ğŸ§© Ã‰tape 6 â€” Exemple de fichier CSV

`storage/seeds/articles.csv`

```
title;slug;excerpt;views;published
DÃ©couvrir Laravel;decouvrir-laravel;Introduction au framework PHP;120;1
Blade en pratique;blade-en-pratique;Moteur de template Laravel;90;1
Eloquent simplifiÃ©;eloquent-simplifie;ORM et modÃ¨les en action;60;1
```

> âš ï¸ Les colonnes doivent correspondre aux en-tÃªtes attendues dans le seeder.
> Tu peux ouvrir et modifier ce fichier avec Excel ou Google Sheets.

---

### ğŸ§© Ã‰tape 7 â€” Lancer la migration et lâ€™import

```bash
php artisan migrate:fresh --seed
```

ou simplement :

```bash
php artisan db:seed --class=ArticleSeeder
```

VÃ©rifie :

```bash
php artisan tinker
>>> App\Models\Article::count();
>>> App\Models\Article::first()->toArray();
```

---


## âœ… CritÃ¨res de rÃ©ussite

* Le fichier CSV est bien lu et interprÃ©tÃ©.
* La table `articles` est crÃ©Ã©e sans erreur.
* Les doublons de slug sont Ã©vitÃ©s.
* Les donnÃ©es sont visibles via Tinker ou phpMyAdmin.

---

## âš ï¸ Erreurs frÃ©quentes

* Fichier CSV mal formatÃ© (virgule au lieu de `;`).
* En-tÃªtes diffÃ©rentes du code (`title`, `slug`, etc.).
* `fillable` manquant â†’ `MassAssignmentException`.
* Oubli du `--seed` aprÃ¨s `migrate:fresh`.

---

## ğŸ§¾ RÃ©sumÃ©

Tu viens dâ€™apprendre Ã  :

* crÃ©er une table et un modÃ¨le `Article`,
* importer des donnÃ©es rÃ©elles depuis un **CSV**,
* et maintenir une base synchronisÃ©e sans duplication.

Ce chapitre conclut la phase **"persistance"** du CRUD.
Prochaine Ã©tape : **3.1.6 â€” CRUD complet (Index / Create / Edit / Delete + Pagination)** ğŸ¯

