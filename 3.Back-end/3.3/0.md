---
title: 3.3.0 Introduction â€” SÃ©curitÃ© minimale, Auth & erreurs
layout: home
nav_order: 0
parent: 3. Back-end
permalink: /c3-3-securite-auth-erreurs/introduction/
---

# ðŸ“˜ Chapitre 3.3.0 â€” Introduction

## ðŸ“’ Glossaire minute

- **Auth (Authentification)** : reconnaÃ®tre **qui** est lâ€™utilisateur (session/cookie).
- **Autorisation (Policy/Gate)** : dÃ©cider **ce que** lâ€™utilisateur **a le droit** de faire.
- **Middleware** : filtre exÃ©cutÃ© avant/aprÃ¨s une requÃªte (ex. `auth`, `throttle`, CORS).
- **Throttle / Rate limit** : limite le **nombre** de requÃªtes par pÃ©riode.
- **CORS** : autorise/refuse lâ€™accÃ¨s cross-origin (ex. App Mobile â†’ API).
- **`Handler` dâ€™exceptions** : point central de formatage des **erreurs**.
- **Monolog / Channel** : systÃ¨me de **logs** (fichiers journaux) avec niveaux (`info`, `warning`, `error`).
- **401 / 403 / 404** : non authentifiÃ© / non autorisÃ© / ressource introuvable.

## ðŸŽ¯ Objectif pÃ©dagogique

Ã€ la fin du chapitre, vous saurez :

- activer une **authentification minimale** (session) et protÃ©ger des routes avec `auth`,
- crÃ©er et brancher une **Policy** sur `Article` (`viewAny`, `create`, `update`, `delete`),
- configurer **throttle** (limitation) et **CORS** pour lâ€™API,
- **standardiser** la **rÃ©ponse dâ€™erreur JSON** (API) via le `Handler`,
- configurer des **logs** en rotation quotidienne et journaliser des Ã©vÃ©nements.

## ðŸ§  DÃ©finition thÃ©orique

La sÃ©curitÃ© minimale cÃ´tÃ© Laravel repose sur 3 couches complÃ©mentaires :

1) **AccÃ¨s**  
   - *Authentification* (session par cookie) protÃ¨ge les zones privÃ©es (ex. `/dashboard`).  
   - *Autorisation* (Policy) prÃ©cise, **au niveau mÃ©tier**, qui peut faire quoi (ex. â€œun auteur ne peut modifier **que ses** articlesâ€).

2) **Robustesse API**  
   - *Throttle* freine les abus.  
   - *CORS* ouvre le **domaine API** Ã  des clients de confiance (future app Mobile).  
   - *RÃ©ponses dâ€™erreurs cohÃ©rentes* (JSON) permettent au client dâ€™afficher des messages clairs.

3) **ObservabilitÃ©**  
   - *Logs* (niveau, canal, rotation) tracent les Ã©vÃ©nements pour diagnostiquer vite.

## ðŸ” Exemple appliquÃ© au fil rouge

- **Web (session)** : *Dashboard auteur* (`/dashboard`) rÃ©servÃ© aux utilisateurs connectÃ©s.  
- **Policy `Article`** : un auteur peut **Ã©diter/supprimer** **ses** articles, pas ceux des autres.  
- **API v1** : `/api/articles` GET public, mais POST/PUT/DELETE protÃ©gÃ©s (on y vient plus tard).  
- **Erreur JSON uniforme** :
  ```json
  {
    "ok": false,
    "error": { "code": "FORBIDDEN", "message": "Action non autorisÃ©e." }
  }
````

## ðŸ›  Tutoriel pratique

> PrÃ©requis : projet **blog-laravel** des autoformations C3.1â€“C3.2 (Articles CRUD + API GET).

**Arborescence (extrait)**

```
blog-laravel/
â”œâ”€ app/
â”‚  â”œâ”€ Exceptions/Handler.php
â”‚  â”œâ”€ Http/Controllers/AuthController.php
â”‚  â”œâ”€ Policies/ArticlePolicy.php
â”‚  â””â”€ Providers/{AuthServiceProvider.php,RouteServiceProvider.php}
â”œâ”€ config/{cors.php,logging.php}
â”œâ”€ database/seeders/UserSeeder.php
â”œâ”€ resources/views/{auth/login.blade.php,dashboard.blade.php}
â”œâ”€ routes/{web.php,api.php}
â””â”€ .env
```

### Ã‰tape 1 â€” CrÃ©er un utilisateur auteur (Seeder)

```php
// database/seeders/UserSeeder.php
<?php

namespace Database\Seeders;

use App\Models\User;
use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\Hash;

class UserSeeder extends Seeder
{
    public function run(): void
    {
        User::updateOrCreate(
            ['email' => 'auteur@example.com'],
            ['name' => 'Auteur DÃ©mo', 'password' => Hash::make('password')]
        );
    }
}
```

```bash
php artisan db:seed --class=UserSeeder
```

### Ã‰tape 2 â€” Authentification minimale (session)

**Routes & contrÃ´leur**

```php
// routes/web.php
use App\Http\Controllers\AuthController;
use Illuminate\Support\Facades\Route;

Route::get('/login', [AuthController::class, 'loginForm'])->name('login');
Route::post('/login', [AuthController::class, 'login'])->name('login.post');
Route::post('/logout', [AuthController::class, 'logout'])->name('logout');

Route::middleware('auth')->group(function () {
    Route::view('/dashboard', 'dashboard')->name('dashboard');
    // Ex.: routes dâ€™admin articles protÃ©gÃ©es ici
});
```

```php
// app/Http/Controllers/AuthController.php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

class AuthController extends Controller
{
    public function loginForm()
    {
        return view('auth.login');
    }

    public function login(Request $request)
    {
        $credentials = $request->validate([
            'email'    => ['required','email'],
            'password' => ['required'],
        ]);

        if (Auth::attempt($credentials, remember: true)) {
            $request->session()->regenerate();
            return redirect()->intended(route('dashboard'));
        }

        return back()->withErrors(['email' => 'Identifiants invalides.']);
    }

    public function logout(Request $request)
    {
        Auth::logout();
        $request->session()->invalidate();
        $request->session()->regenerateToken();
        return redirect('/login');
    }
}
```

**Vue de connexion**

```html
<!-- resources/views/auth/login.blade.php -->
<!doctype html>
<html lang="fr">
  <body>
    <h1>Connexion</h1>
    @if ($errors->any())
      <div>{{ $errors->first() }}</div>
    @endif
    <form method="POST" action="{{ route('login.post') }}">
      @csrf
      <label>Email <input type="email" name="email" required></label>
      <label>Mot de passe <input type="password" name="password" required></label>
      <button type="submit">Se connecter</button>
    </form>
  </body>
</html>
```

```html
<!-- resources/views/dashboard.blade.php -->
<h1>Dashboard auteur</h1>
<form method="POST" action="{{ route('logout') }}">@csrf<button>Se dÃ©connecter</button></form>
```

### Ã‰tape 3 â€” Policy `Article` (autorisation)

```bash
php artisan make:policy ArticlePolicy --model=App\\Models\\Article
```

```php
// app/Policies/ArticlePolicy.php
<?php

namespace App\Policies;

use App\Models\Article;
use App\Models\User;

class ArticlePolicy
{
    public function viewAny(?User $user): bool { return true; }

    public function create(User $user): bool { return true; }

    public function update(User $user, Article $article): bool
    {
        return $article->user_id === $user->id;
    }

    public function delete(User $user, Article $article): bool
    {
        return $article->user_id === $user->id;
    }
}
```

```php
// app/Providers/AuthServiceProvider.php
protected $policies = [
    \App\Models\Article::class => \App\Policies\ArticlePolicy::class,
];
```

**Usage dans un contrÃ´leur**

```php
// app/Http/Controllers/ArticleController.php (extrait)
public function edit(Article $article)
{
    $this->authorize('update', $article);
    // ...
}
public function destroy(Article $article)
{
    $this->authorize('delete', $article);
    // ...
}
```

### Ã‰tape 4 â€” Throttle & CORS (API)

**Limiter le dÃ©bit API**

```php
// app/Providers/RouteServiceProvider.php (boot)
use Illuminate\Cache\RateLimiting\Limit;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\RateLimiter;

RateLimiter::for('api', function (Request $request) {
    return Limit::perMinute(60)->by($request->user()?->id ?: $request->ip());
});
```

```php
// routes/api.php
use Illuminate\Support\Facades\Route;

Route::middleware(['throttle:api'])->group(function () {
    Route::get('/articles', /* ... */);
    Route::get('/articles/{id}', /* ... */);
});
```

**Configurer CORS (ouvrir lâ€™API au client Mobile/local)**

```php
// config/cors.php (extraits Ã  ajuster)
'paths' => ['api/*'],
'allowed_origins' => ['http://localhost:3000','http://10.0.2.2:3000','*'], // adapter si besoin
'allowed_methods' => ['*'],
'allowed_headers' => ['*'],
'supports_credentials' => false,
```

### Ã‰tape 5 â€” Format dâ€™erreur JSON uniforme (Handler)

```php
// app/Exceptions/Handler.php (extrait)
use Illuminate\Auth\AuthenticationException;
use Illuminate\Auth\Access\AuthorizationException;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Illuminate\Validation\ValidationException;
use Symfony\Component\HttpKernel\Exception\NotFoundHttpException;

protected function shouldReturnJson($request, \Throwable $e): bool
{
    return $request->is('api/*') || $request->expectsJson();
}

public function render($request, \Throwable $e)
{
    if ($this->shouldReturnJson($request, $e)) {
        $payload = fn(string $code, string $message, $details = null) => [
            'ok' => false,
            'error' => ['code' => $code, 'message' => $message, 'details' => $details],
        ];

        if ($e instanceof ValidationException) {
            return response()->json($payload('VALIDATION_ERROR', 'DonnÃ©es invalides.', $e->errors()), 422);
        }
        if ($e instanceof AuthenticationException) {
            return response()->json($payload('UNAUTHENTICATED', 'Authentification requise.'), 401);
        }
        if ($e instanceof AuthorizationException) {
            return response()->json($payload('FORBIDDEN', 'Action non autorisÃ©e.'), 403);
        }
        if ($e instanceof ModelNotFoundException || $e instanceof NotFoundHttpException) {
            return response()->json($payload('NOT_FOUND', 'Ressource introuvable.'), 404);
        }

        // Fallback
        return response()->json($payload('SERVER_ERROR', 'Erreur interne.'), 500);
    }

    return parent::render($request, $e);
}
```

### Ã‰tape 6 â€” Logs (rotation quotidienne) + journaliser un Ã©vÃ©nement

**.env**

```env
LOG_CHANNEL=daily
LOG_LEVEL=warning
```

*(par dÃ©faut `daily` conserve 14 jours ; ajustable via `config/logging.php`)*

**Exemple de log en contrÃ´leur**

```php
use Illuminate\Support\Facades\Log;

public function update(Request $request, Article $article)
{
    $this->authorize('update', $article);

    $validated = $request->validate([
        'title' => ['required','string','max:180'],
        'content' => ['required','string','min:50'],
    ]);

    $article->update($validated);

    Log::info('Article mis Ã  jour', ['article_id' => $article->id, 'user_id' => $request->user()->id]);

    return redirect()->route('dashboard');
}
```

## ðŸ§¾ RÃ©sumÃ© et points-clÃ©s

* **Session** + middleware `auth` pour protÃ©ger `/dashboard` et lâ€™admin.
* **Policy `Article`** : rÃ¨gles dâ€™accÃ¨s **mÃ©tier** centralisÃ©es (ex. auteur propriÃ©taire).
* **API** plus robuste : **`throttle:api`** + **CORS** configurÃ©.
* **Erreurs JSON** standardisÃ©es via le **`Handler`** (401/403/404/422/500).
* **Logs** en **rotation quotidienne** pour diagnostiquer rapidement.

> Prochaines Ã©tapes (C3.3) : dÃ©tailler chaque brique â€” *Middlewares clÃ©s*, *Policy Article*, *Handler dâ€™exceptions*, *Logs centralisÃ©s* â€” puis livrer le **Dashboard auteur sÃ©curisÃ©** + **format dâ€™erreur JSON** uniforme pour lâ€™API.

```
```
