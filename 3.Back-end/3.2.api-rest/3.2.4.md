---
title: 4. Contrat API
layout: home
nav_order: 4
parent: 3.2. API REST
permalink: /api-rest/contrat-api/
code: 3.2.4
competence: C3
autoformation: "C3.2"
ua: "3.2.U3"
duree_h: 2
objectif: "DÃ©finir un contrat API minimal, documentÃ© et testable (Postman/Insomnia)."
notions_nouvelles: ["Contrat API", "Schema", "Versionnement", "Postman", "Insomnia"]
fil_rouge: "Blog Laravel + App Mobile (doc API partagÃ©e pour intÃ©gration mobile)"
livrable_chapitre: "Collection Postman/Insomnia avec endpoints Articles et tests"
alimentation_prototype: "API documentÃ©e pour Ã©changes clairs avec Ã©quipe mobile N2"
alimentation_miniprojet: "Contrat API figÃ© (v1) garantissant stabilitÃ© des intÃ©grations N3"
---


# ğŸ“˜  3.2.4 - Contrat API minimal + Postman/Insomnia

## ğŸ“’ Glossaire minute
- **Contrat API** : rÃ¨gles **stables** (URLs, paramÃ¨tres, corps, codes/rÃ©ponses) permettant lâ€™intÃ©gration **sans ambiguÃ¯tÃ©**.
- **Schema** : description **formelle** de la forme des donnÃ©es (propriÃ©tÃ©s/typage/requis).
- **Versionnement** : stratÃ©gie pour **Ã©voluer sans casser** (ex. `/api/v1/...`).
- **Postman / Insomnia** : outils pour **documenter**, **tester** et **partager** lâ€™API.

---

## ğŸ¯ Objectifs pÃ©dagogiques
Ã€ la fin du chapitre, vous saurez :
1. DÃ©finir un **contrat minimal** pour `Article` (endpoints, headers, codes, enveloppe JSON, pagination, filtres, erreurs).  
2. Publier une **doc exÃ©cutable** (collection Postman + environnement, ou Insomnia).  
3. Ajouter de petits **tests automatiques** (assertions) cÃ´tÃ© client API.

---

## ğŸ§± PrÃ©-requis
- Endpoints CRUD opÃ©rationnels (chap. **3.2.1**) et pagination/filtres (chap. **3.2.2**).
- Normalisation par **Resources/Collections** (chap. **3.2.3**).

---

## ğŸ“‘ Contrat API â€” **v1 (minimal et stable)**

### 1) En-tÃªtes et conventions
- **Base URL** : `{{baseUrl}}` (ex. `http://localhost:8000`)  
- **Prefix** : `/api` (v1 implicite) â†’ endpoints : `/api/articles...`  
- **Request**  
  - `Accept: application/json`  
  - `Content-Type: application/json` (pour `POST`/`PATCH`)  
- **Response** (enveloppe **uniforme**)  
  - **SuccÃ¨s** : `{ "data": <objet|liste>, "meta": { ... } }`  
  - **Erreur** : `{ "error": { "code": <int>, "message": <string>, "details": { <champ>:[...] } } }`  

### 2) Endpoints (resource: **Article**)
| Verbe & URL                        | 200+ | Body request | Body rÃ©ponse (succÃ¨s)                        |
|---|---:|---|---|
| `GET /api/articles`               | 200 | â€”            | `{ data: [Article], meta: {pagination,...} }` |
| `GET /api/articles/{slug}`        | 200 | â€”            | `{ data: Article, meta: {} }`                |
| `POST /api/articles`              | 201 | `{title, excerpt?, views?, published?}` | `{ data:{id,slug,title}, meta:{} }` (+ `Location`) |
| `PATCH /api/articles/{slug}`      | 200 | champs partiels | `{ data:{id,slug}, meta:{} }`              |
| `DELETE /api/articles/{slug}`     | 204 | â€”            | *(no body)*                                   |

**Codes dâ€™erreur usuels** : `400/401/403/404/409/422/429/500`.

### 3) ModÃ¨les de donnÃ©es (schÃ©mas simples)

**Article (lecture)**
```json
{
  "id": 7,
  "title": "NouveautÃ©s Laravel",
  "slug": "nouveautes-laravel",
  "excerpt": "Tour rapide",
  "views": 210,
  "published": true,
  "createdAt": "2025-08-26T12:30:10Z"
}
````

**Article (crÃ©ation / mise Ã  jour)**

```json
{
  "title": "Titre requis",
  "excerpt": "Optionnel",
  "views": 0,
  "published": true
}
```

### 4) Pagination & filtres (liste)

* Query params :

  * `page` (â‰¥1), `per_page` (1..100, dÃ©faut **10**)
  * `q` (recherche simple dans `title`)
  * `sort` âˆˆ `created_desc | created_asc | views_desc | views_asc`
* `meta.pagination` :

```json
{
  "page": 1, "per_page": 10, "total": 37, "total_pages": 4
}
```

### 5) Format dâ€™erreur (uniforme)

```json
{
  "error": {
    "code": 422,
    "message": "Validation error",
    "details": { "title": ["The title field is required."] }
  }
}
```

> â„¹ï¸ Les **messages** sont destinÃ©s aux dÃ©veloppeurs. Les textes finaux cÃ´tÃ© **UI** peuvent Ãªtre traduits/retouchÃ©s.

---

## ğŸ§© SpÃ©cification OpenAPI (extrait minimal)

`openapi.yaml`

```yaml
openapi: 3.0.3
info:
  title: Solicode Blog API
  version: "1.0.0"
servers:
  - url: "{{baseUrl}}"
paths:
  /api/articles:
    get:
      summary: List articles
      parameters:
        - in: query; name: page; schema: {type: integer, minimum: 1}
        - in: query; name: per_page; schema: {type: integer, minimum: 1, maximum: 100}
        - in: query; name: q; schema: {type: string}
        - in: query; name: sort; schema: {type: string, enum: [created_desc,created_asc,views_desc,views_asc]}
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [data, meta]
                properties:
                  data:
                    type: array
                    items: {$ref: "#/components/schemas/Article"}
                  meta:
                    type: object
                    properties:
                      pagination:
                        $ref: "#/components/schemas/Pagination"
  /api/articles/{slug}:
    get:
      summary: Get article by slug
      parameters:
        - in: path; name: slug; required: true; schema: {type: string}
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  data: {$ref: "#/components/schemas/Article"}
components:
  schemas:
    Article:
      type: object
      required: [id, title, slug, views, published]
      properties:
        id: {type: integer}
        title: {type: string}
        slug: {type: string}
        excerpt: {type: string, nullable: true}
        views: {type: integer, minimum: 0}
        published: {type: boolean}
        createdAt: {type: string, format: date-time, nullable: true}
    Pagination:
      type: object
      required: [page, per_page, total, total_pages]
      properties:
        page: {type: integer}
        per_page: {type: integer}
        total: {type: integer}
        total_pages: {type: integer}
```

---

## ğŸ“¦ Collection **Postman** (v2.1) â€” prÃªte Ã  importer

`postman_collection.json`

```json
{
  "info": { "name": "SoliBlog v1 (Articles)", "_postman_id": "auto", "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json" },
  "item": [
    {
      "name": "List Articles",
      "request": {
        "method": "GET",
        "header": [{ "key": "Accept", "value": "application/json" }],
        "url": { "raw": "{{baseUrl}}/api/articles?page=1&per_page=10", "host": ["{{baseUrl}}"], "path": ["api","articles"], "query": [{"key":"page","value":"1"},{"key":"per_page","value":"10"}] }
      },
      "event": [{
        "listen": "test",
        "script": {
          "exec": [
            "pm.test('Status 200', () => pm.response.code === 200);",
            "const json = pm.response.json();",
            "pm.expect(json).to.have.property('data');",
            "pm.expect(json).to.have.property('meta');"
          ],
          "type": "text/javascript"
        }
      }]
    },
    {
      "name": "Show Article",
      "request": {
        "method": "GET",
        "header": [{ "key": "Accept", "value": "application/json" }],
        "url": { "raw": "{{baseUrl}}/api/articles/{{slug}}", "host": ["{{baseUrl}}"], "path": ["api","articles","{{slug}}"] }
      }
    },
    {
      "name": "Create Article",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Accept", "value": "application/json" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"title\": \"NouveautÃ©s Laravel\",\n  \"excerpt\": \"Tour rapide\",\n  \"published\": true\n}"
        },
        "url": { "raw": "{{baseUrl}}/api/articles", "host": ["{{baseUrl}}"], "path": ["api","articles"] }
      },
      "event": [{
        "listen": "test",
        "script": {
          "exec": [
            "pm.test('201 Created', () => pm.response.code === 201);",
            "pm.test('Location header set', () => pm.response.headers.has('Location'));"
          ],
          "type": "text/javascript"
        }
      }]
    }
  ],
  "variable": [{ "key": "baseUrl", "value": "http://localhost:8000" }, { "key": "slug", "value": "intro-laravel" }]
}
```

> ğŸ’¡ CrÃ©ez un **Environment** Postman `Local` avec la variable `baseUrl = http://localhost:8000`.

---

## ğŸ¦‰ **Insomnia** â€” export minimal (YAML)

`insomnia.yaml`

```yaml
_type: export
__export_format: 4
resources:
  - _id: wrk_soli_blog
    _type: workspace
    name: SoliBlog v1
  - _id: env_local
    _type: environment
    parentId: wrk_soli_blog
    name: Local
    data:
      baseUrl: http://localhost:8000
  - _id: req_list_articles
    _type: request
    parentId: wrk_soli_blog
    name: List Articles
    method: GET
    url: "{{ baseUrl }}/api/articles?page=1&per_page=10"
    headers:
      - name: Accept
        value: application/json
  - _id: req_show_article
    _type: request
    parentId: wrk_soli_blog
    name: Show Article
    method: GET
    url: "{{ baseUrl }}/api/articles/{{ slug }}"
    headers:
      - name: Accept
        value: application/json
```

---

## ğŸ§ª Exercice guidÃ© (livrable N1)

> **But** : complÃ©ter la collection Postman par **pagination + filtres + erreurs**.
>
> **Exigences**
>
> 1. Ajouter une requÃªte `GET /api/articles?q=laravel&sort=views_desc&page=2&per_page=5` + tests : `200`, `data` array, `meta.pagination.total_pages â‰¥ 1`.
> 2. Ajouter un cas **404** (`GET /api/articles/inconnu`) testant `error.code === 404`.
> 3. Ajouter un cas **422** (`POST /api/articles {}`) testant prÃ©sence `error.details.title`.
> 4. Exporter la collection et la dÃ©poser dans `docs/api/postman/`.

---

## âœ… CritÃ¨res de rÃ©ussite

* La **doc exÃ©cutable** (Postman/Insomnia) fonctionne **sans modifications** cÃ´tÃ© lecteur.
* Chaque endpoint renvoie un **code** adaptÃ© et lâ€™**enveloppe** attendue.
* Les **tests** Postman passent (status, structure JSON, headers clÃ©s).
* Le **contrat** est **cohÃ©rent** avec les chapitres 3.2.1â€“3.2.3.

---

## âš ï¸ Erreurs frÃ©quentes

* Oublier `Accept: application/json` â†’ rÃ©ponses HTML inattendues.
* MÃ©langer **schÃ©mas** entre `POST` (entrÃ©e) et `GET` (sortie).
* Casser lâ€™enveloppe `{data/meta}` sur un des endpoints â†’ inconsistances cÃ´tÃ© Mobile.
* Ne pas fournir de **`Location`** aprÃ¨s `POST` (201).

---

## ğŸ§¾ RÃ©sumÃ©

Vous avez figÃ© un **contrat v1** simple (endpoints/headers/codes/enveloppe/pagination) et livrÃ© une **doc exÃ©cutable** (Postman/Insomnia) avec quelques **tests**. Ce socle rend lâ€™intÃ©gration **Mobile** fluide et prÃ©pare lâ€™**unification des erreurs** (chap. C3.3) et lâ€™extension future (**v2**).

