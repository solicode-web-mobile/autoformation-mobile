---
title: 4. Contrat API
layout: home
nav_order: 4
parent: 3.2. API REST
permalink: /api-rest/contrat-api/
code: 3.2.4
competence: C3
autoformation: "C3.2"
ua: "3.2.U3"
duree_h: 2
objectif: "Définir un contrat API minimal, documenté et testable (Postman/Insomnia)."
notions_nouvelles: ["Contrat API", "Schema", "Versionnement", "Postman", "Insomnia"]
fil_rouge: "Blog Laravel + App Mobile (doc API partagée pour intégration mobile)"
livrable_chapitre: "Collection Postman/Insomnia avec endpoints Articles et tests"
alimentation_prototype: "API documentée pour échanges clairs avec équipe mobile N2"
alimentation_miniprojet: "Contrat API figé (v1) garantissant stabilité des intégrations N3"
---


# 📘  3.2.4 - Contrat API minimal + Postman/Insomnia

## 📒 Glossaire minute
- **Contrat API** : règles **stables** (URLs, paramètres, corps, codes/réponses) permettant l’intégration **sans ambiguïté**.
- **Schema** : description **formelle** de la forme des données (propriétés/typage/requis).
- **Versionnement** : stratégie pour **évoluer sans casser** (ex. `/api/v1/...`).
- **Postman / Insomnia** : outils pour **documenter**, **tester** et **partager** l’API.

---

## 🎯 Objectifs pédagogiques
À la fin du chapitre, vous saurez :
1. Définir un **contrat minimal** pour `Article` (endpoints, headers, codes, enveloppe JSON, pagination, filtres, erreurs).  
2. Publier une **doc exécutable** (collection Postman + environnement, ou Insomnia).  
3. Ajouter de petits **tests automatiques** (assertions) côté client API.

---

## 🧱 Pré-requis
- Endpoints CRUD opérationnels (chap. **3.2.1**) et pagination/filtres (chap. **3.2.2**).
- Normalisation par **Resources/Collections** (chap. **3.2.3**).

---

## 📑 Contrat API — **v1 (minimal et stable)**

### 1) En-têtes et conventions
- **Base URL** : `{{baseUrl}}` (ex. `http://localhost:8000`)  
- **Prefix** : `/api` (v1 implicite) → endpoints : `/api/articles...`  
- **Request**  
  - `Accept: application/json`  
  - `Content-Type: application/json` (pour `POST`/`PATCH`)  
- **Response** (enveloppe **uniforme**)  
  - **Succès** : `{ "data": <objet|liste>, "meta": { ... } }`  
  - **Erreur** : `{ "error": { "code": <int>, "message": <string>, "details": { <champ>:[...] } } }`  

### 2) Endpoints (resource: **Article**)
| Verbe & URL                        | 200+ | Body request | Body réponse (succès)                        |
|---|---:|---|---|
| `GET /api/articles`               | 200 | —            | `{ data: [Article], meta: {pagination,...} }` |
| `GET /api/articles/{slug}`        | 200 | —            | `{ data: Article, meta: {} }`                |
| `POST /api/articles`              | 201 | `{title, excerpt?, views?, published?}` | `{ data:{id,slug,title}, meta:{} }` (+ `Location`) |
| `PATCH /api/articles/{slug}`      | 200 | champs partiels | `{ data:{id,slug}, meta:{} }`              |
| `DELETE /api/articles/{slug}`     | 204 | —            | *(no body)*                                   |

**Codes d’erreur usuels** : `400/401/403/404/409/422/429/500`.

### 3) Modèles de données (schémas simples)

**Article (lecture)**
```json
{
  "id": 7,
  "title": "Nouveautés Laravel",
  "slug": "nouveautes-laravel",
  "excerpt": "Tour rapide",
  "views": 210,
  "published": true,
  "createdAt": "2025-08-26T12:30:10Z"
}
````

**Article (création / mise à jour)**

```json
{
  "title": "Titre requis",
  "excerpt": "Optionnel",
  "views": 0,
  "published": true
}
```

### 4) Pagination & filtres (liste)

* Query params :

  * `page` (≥1), `per_page` (1..100, défaut **10**)
  * `q` (recherche simple dans `title`)
  * `sort` ∈ `created_desc | created_asc | views_desc | views_asc`
* `meta.pagination` :

```json
{
  "page": 1, "per_page": 10, "total": 37, "total_pages": 4
}
```

### 5) Format d’erreur (uniforme)

```json
{
  "error": {
    "code": 422,
    "message": "Validation error",
    "details": { "title": ["The title field is required."] }
  }
}
```

> ℹ️ Les **messages** sont destinés aux développeurs. Les textes finaux côté **UI** peuvent être traduits/retouchés.

---

## 🧩 Spécification OpenAPI (extrait minimal)

`openapi.yaml`

```yaml
openapi: 3.0.3
info:
  title: Solicode Blog API
  version: "1.0.0"
servers:
  - url: "{{baseUrl}}"
paths:
  /api/articles:
    get:
      summary: List articles
      parameters:
        - in: query; name: page; schema: {type: integer, minimum: 1}
        - in: query; name: per_page; schema: {type: integer, minimum: 1, maximum: 100}
        - in: query; name: q; schema: {type: string}
        - in: query; name: sort; schema: {type: string, enum: [created_desc,created_asc,views_desc,views_asc]}
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [data, meta]
                properties:
                  data:
                    type: array
                    items: {$ref: "#/components/schemas/Article"}
                  meta:
                    type: object
                    properties:
                      pagination:
                        $ref: "#/components/schemas/Pagination"
  /api/articles/{slug}:
    get:
      summary: Get article by slug
      parameters:
        - in: path; name: slug; required: true; schema: {type: string}
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  data: {$ref: "#/components/schemas/Article"}
components:
  schemas:
    Article:
      type: object
      required: [id, title, slug, views, published]
      properties:
        id: {type: integer}
        title: {type: string}
        slug: {type: string}
        excerpt: {type: string, nullable: true}
        views: {type: integer, minimum: 0}
        published: {type: boolean}
        createdAt: {type: string, format: date-time, nullable: true}
    Pagination:
      type: object
      required: [page, per_page, total, total_pages]
      properties:
        page: {type: integer}
        per_page: {type: integer}
        total: {type: integer}
        total_pages: {type: integer}
```

---

## 📦 Collection **Postman** (v2.1) — prête à importer

`postman_collection.json`

```json
{
  "info": { "name": "SoliBlog v1 (Articles)", "_postman_id": "auto", "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json" },
  "item": [
    {
      "name": "List Articles",
      "request": {
        "method": "GET",
        "header": [{ "key": "Accept", "value": "application/json" }],
        "url": { "raw": "{{baseUrl}}/api/articles?page=1&per_page=10", "host": ["{{baseUrl}}"], "path": ["api","articles"], "query": [{"key":"page","value":"1"},{"key":"per_page","value":"10"}] }
      },
      "event": [{
        "listen": "test",
        "script": {
          "exec": [
            "pm.test('Status 200', () => pm.response.code === 200);",
            "const json = pm.response.json();",
            "pm.expect(json).to.have.property('data');",
            "pm.expect(json).to.have.property('meta');"
          ],
          "type": "text/javascript"
        }
      }]
    },
    {
      "name": "Show Article",
      "request": {
        "method": "GET",
        "header": [{ "key": "Accept", "value": "application/json" }],
        "url": { "raw": "{{baseUrl}}/api/articles/{{slug}}", "host": ["{{baseUrl}}"], "path": ["api","articles","{{slug}}"] }
      }
    },
    {
      "name": "Create Article",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Accept", "value": "application/json" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"title\": \"Nouveautés Laravel\",\n  \"excerpt\": \"Tour rapide\",\n  \"published\": true\n}"
        },
        "url": { "raw": "{{baseUrl}}/api/articles", "host": ["{{baseUrl}}"], "path": ["api","articles"] }
      },
      "event": [{
        "listen": "test",
        "script": {
          "exec": [
            "pm.test('201 Created', () => pm.response.code === 201);",
            "pm.test('Location header set', () => pm.response.headers.has('Location'));"
          ],
          "type": "text/javascript"
        }
      }]
    }
  ],
  "variable": [{ "key": "baseUrl", "value": "http://localhost:8000" }, { "key": "slug", "value": "intro-laravel" }]
}
```

> 💡 Créez un **Environment** Postman `Local` avec la variable `baseUrl = http://localhost:8000`.

---

## 🦉 **Insomnia** — export minimal (YAML)

`insomnia.yaml`

```yaml
_type: export
__export_format: 4
resources:
  - _id: wrk_soli_blog
    _type: workspace
    name: SoliBlog v1
  - _id: env_local
    _type: environment
    parentId: wrk_soli_blog
    name: Local
    data:
      baseUrl: http://localhost:8000
  - _id: req_list_articles
    _type: request
    parentId: wrk_soli_blog
    name: List Articles
    method: GET
    url: "{{ baseUrl }}/api/articles?page=1&per_page=10"
    headers:
      - name: Accept
        value: application/json
  - _id: req_show_article
    _type: request
    parentId: wrk_soli_blog
    name: Show Article
    method: GET
    url: "{{ baseUrl }}/api/articles/{{ slug }}"
    headers:
      - name: Accept
        value: application/json
```

---

## 🧪 Exercice guidé (livrable N1)

> **But** : compléter la collection Postman par **pagination + filtres + erreurs**.
>
> **Exigences**
>
> 1. Ajouter une requête `GET /api/articles?q=laravel&sort=views_desc&page=2&per_page=5` + tests : `200`, `data` array, `meta.pagination.total_pages ≥ 1`.
> 2. Ajouter un cas **404** (`GET /api/articles/inconnu`) testant `error.code === 404`.
> 3. Ajouter un cas **422** (`POST /api/articles {}`) testant présence `error.details.title`.
> 4. Exporter la collection et la déposer dans `docs/api/postman/`.

---

## ✅ Critères de réussite

* La **doc exécutable** (Postman/Insomnia) fonctionne **sans modifications** côté lecteur.
* Chaque endpoint renvoie un **code** adapté et l’**enveloppe** attendue.
* Les **tests** Postman passent (status, structure JSON, headers clés).
* Le **contrat** est **cohérent** avec les chapitres 3.2.1–3.2.3.

---

## ⚠️ Erreurs fréquentes

* Oublier `Accept: application/json` → réponses HTML inattendues.
* Mélanger **schémas** entre `POST` (entrée) et `GET` (sortie).
* Casser l’enveloppe `{data/meta}` sur un des endpoints → inconsistances côté Mobile.
* Ne pas fournir de **`Location`** après `POST` (201).

---

## 🧾 Résumé

Vous avez figé un **contrat v1** simple (endpoints/headers/codes/enveloppe/pagination) et livré une **doc exécutable** (Postman/Insomnia) avec quelques **tests**. Ce socle rend l’intégration **Mobile** fluide et prépare l’**unification des erreurs** (chap. C3.3) et l’extension future (**v2**).

