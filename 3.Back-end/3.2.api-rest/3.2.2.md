---
title: 2. Pagination & filtres
layout: home
nav_order: 2
parent: 3.2. API REST
permalink: /api-rest/pagination-filtres/
code: 3.2.2
competence: C3
autoformation: "C3.2"
ua: "3.2.U1"
duree_h: 2
objectif: "Impl√©menter pagination, filtres et tri s√©curis√©s dans un endpoint JSON."
notions_nouvelles: ["Query string", "Pagination", "Filtre texte", "Filtre tag JSON", "Tri multi-champs", "Whitelist"]
fil_rouge: "Blog Laravel + App Mobile (liste filtr√©e des articles)"
livrable_chapitre: "Route GET `/api/articles` avec `ArticleIndexRequest` et pagination filtr√©e"
alimentation_prototype: "Liste d‚Äôarticles pagin√©e/tri√©e pour application mobile N2"
alimentation_miniprojet: "M√©canismes complets de recherche/tri pour API N3"
---


# üìò  3.2.2 - Pagination & filtres

## üìí Glossaire minute
- **Query string** : param√®tres d‚ÄôURL (`?q=php&tag=laravel&sort=-created_at`).
- **Pagination** : d√©coupage des r√©sultats en pages (`paginate(n)`).
- **Filtre `q`** : recherche texte (ex. `title`/`excerpt`/`content`).
- **Filtre `tag`** : filtrage par **tag** (colonne JSON `tags` ‚Üí `whereJsonContains`).
- **`sort`** : tri multi-champs avec `-` pour **desc** (ex. `-created_at,title`).
- **Whitelist** : liste **autoris√©e** de champs triables (s√©curit√©).

---

## üéØ Objectif p√©dagogique
Fournir une route **GET `/api/articles`** pagin√©e et filtrable :
- `q` (recherche), `tag` (1 ou plusieurs), `sort` (tri multi-champs),
- `per_page` (taille de page), `page` (num√©ro de page),
- **r√©ponse JSON** stable pr√™te √† √™tre normalis√©e en 3.2.3 avec `ResourceCollection`.

---

## ‚úÖ Pr√©-requis
- Mod√®le **Article** et table `articles` OK (3.1.5),
- Colonne `tags` de type **JSON** (cast√©e en `array` dans le mod√®le),
- Endpoint `/api/articles` cr√©√© en 3.2.1 (version simple).

---

## üß≠ √âtapes guid√©es

### 1) Route API
`routes/api.php`
```php
use Illuminate\Support\Facades\Route;
use App\Http\Controllers\Api\ArticleController;

Route::get('/articles', [ArticleController::class, 'index']);
````

### 2) FormRequest pour valider les param√®tres

```bash
php artisan make:request ArticleIndexRequest
```

`app/Http/Requests/ArticleIndexRequest.php`

```php
<?php

namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;

class ArticleIndexRequest extends FormRequest
{
    public function authorize(): bool { return true; }

    /** Champs triables autoris√©s */
    public const ALLOWED_SORTS = ['id','title','created_at'];

    public function rules(): array
    {
        $safe = implode('|', array_map('preg_quote', self::ALLOWED_SORTS));
        $regex = "/^(-?($safe))(,-?($safe))*$/";

        return [
            'q'         => ['nullable','string','min:1','max:100'],
            'tag'       => ['nullable','string'], // "php" ou "php,laravel"
            'sort'      => ['nullable',"regex:$regex"],
            'per_page'  => ['nullable','integer','min:1','max:50'],
            'page'      => ['nullable','integer','min:1'],
        ];
    }
}
```

### 3) Contr√¥leur API : filtres + tri + pagination

```bash
php artisan make:controller Api/ArticleController
```

`app/Http/Controllers/Api/ArticleController.php`

```php
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use App\Http\Requests\ArticleIndexRequest;
use App\Models\Article;
use Illuminate\Http\JsonResponse;

class ArticleController extends Controller
{
    public function index(ArticleIndexRequest $request): JsonResponse
    {
        $q        = (string) $request->query('q', '');
        $tagParam = (string) $request->query('tag', '');
        $sort     = (string) $request->query('sort', '-id');
        $perPage  = (int) $request->query('per_page', 10);

        $query = Article::query();

        // 1) Recherche texte (q) sur title/excerpt/content
        if ($q !== '') {
            $query->where(function ($sub) use ($q) {
                $like = '%' . str_replace('%', '\\%', $q) . '%';
                $sub->where('title', 'like', $like)
                    ->orWhere('excerpt', 'like', $like)
                    ->orWhere('content', 'like', $like);
            });
        }

        // 2) Filtre tag (1 ou plusieurs, s√©par√©s par des virgules) - ANY match
        if ($tagParam !== '') {
            $tags = array_values(array_filter(array_map('trim', explode(',', $tagParam))));
            $query->where(function ($sub) use ($tags) {
                foreach ($tags as $t) {
                    $sub->orWhereJsonContains('tags', $t);
                }
            });
        }

        // 3) Tri multi-champs (ex: "-created_at,title")
        $sorts = array_values(array_filter(array_map('trim', explode(',', $sort))));
        foreach ($sorts as $s) {
            $direction = str_starts_with($s, '-') ? 'desc' : 'asc';
            $column    = ltrim($s, '-');
            if (in_array($column, ArticleIndexRequest::ALLOWED_SORTS, true)) {
                $query->orderBy($column, $direction);
            }
        }

        // 4) Pagination (cap √† 50 par page)
        $perPage = max(1, min(50, $perPage));
        $paginator = $query->paginate($perPage)->appends($request->query());

        // R√©ponse JSON standard de Laravel Paginator (data + links + meta)
        return response()->json($paginator);
    }
}
```

> ‚ÑπÔ∏è Par d√©faut, `paginate()` renvoie un objet avec `data`, `links`, `meta` que nous **normaliserons** proprement au chapitre **3.2.3**.

---

## üîç Exemples d‚Äôappels

* **Recherche texte** :
  `GET /api/articles?q=laravel`
* **Filtrer par tag** (au moins un des tags) :
  `GET /api/articles?tag=php,backend`
* **Tri multiple** (date desc puis titre asc) :
  `GET /api/articles?sort=-created_at,title`
* **Pagination personnalis√©e** :
  `GET /api/articles?per_page=5&page=2`
* **Combiner** :
  `GET /api/articles?q=tutoriel&tag=laravel&sort=-created_at&per_page=8`

---

## üß™ Structure de r√©ponse (extrait)

```json
{
  "data": [
    { "id": 12, "title": "Intro Laravel", "slug": "intro-laravel", "excerpt": "...", "tags": ["php","laravel"] }
  ],
  "links": {
    "first": "http://localhost/api/articles?page=1",
    "last": "http://localhost/api/articles?page=4",
    "prev": null,
    "next": "http://localhost/api/articles?page=2"
  },
  "meta": {
    "current_page": 1,
    "from": 1,
    "last_page": 4,
    "path": "http://localhost/api/articles",
    "per_page": 10,
    "to": 10,
    "total": 40
  }
}
```

---

## üõ† Variantes & options (N1+)

* **Match ALL tags** : remplacez les `orWhereJsonContains` par une **boucle** de `whereJsonContains` (ET logique).
* **Tri par d√©faut** : forcer `-id` si aucun tri valide n‚Äôest fourni.
* **Fulltext** : si besoin de recherche plus pertinente, ajoutez un **index FULLTEXT** (`title`, `excerpt`) et utilisez `whereFullText`.
* **Limiter les colonnes** : `select(['id','title','slug','excerpt','tags','created_at'])` pour des r√©ponses plus l√©g√®res.

---

## üß© Int√©gration fil rouge

* Cette route sera **consomm√©e par l‚Äôapp Mobile** (liste d‚Äôarticles, recherche, filtres).
* Au chapitre **3.2.3**, on encapsule la sortie via **`ArticleResource`** et **`ArticleCollection`** pour un **format homog√®ne** (attributs/links/meta contr√¥l√©s).

---

## üßæ R√©sum√©

* **Validation** des query params via **FormRequest**.
* **Filtres** : `q` (LIKE multi-champs), `tag` (JSON ANY), **tri** multi-champs avec **whitelist**.
* **Pagination** s√ªre (`per_page ‚â§ 50`) et **structure JSON** standard.

**Livrable attendu** :

* Route `GET /api/articles` pagin√©e + filtr√©e,
* `ArticleIndexRequest` et `ArticleController@index` op√©rationnels,
* Tests manuels via navigateur, Postman ou `curl`.

