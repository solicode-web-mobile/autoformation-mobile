---
title: 8. Fichiers & JSON
layout: home
nav_order: 8
parent: 3.0. Rappel PHP & POO
permalink: /php-poo/json/
code: 3.0.8
competence: C3
autoformation: "C3.0"
ua: "3.0.U8"
duree_h: 1.5
objectif: "Lire/√©crire des fichiers JSON de fa√ßon s√ªre (options d‚Äôencodage, exceptions, verrouillage d‚Äô√©criture)."
notions_nouvelles: ["UTF-8", "JSON_THROW_ON_ERROR", "json_encode options", "LOCK_EX", "loadJson/saveJson"]
fil_rouge: "Cr√©ation et lecture de `storage/seeds/articles.seed.json`"
livrable_chapitre: "`json_io.php` (saveJson/loadJson) + seed g√©n√©r√© et relu"
alimentation_prototype: "Dataset propre pour l‚ÄôUI (N2)"
alimentation_miniprojet: "Fichier seed standardis√© pour seeders/tests Laravel (N3)"
---


# üìò  3.0.8 - Fichiers & JSON

## üìí Glossaire minute
- **UTF-8** : encodage texte recommand√© (√©viter le **BOM**).
- **`JSON_THROW_ON_ERROR`** : option pour faire **lever une exception** (`JsonException`) si l‚Äôencodage/d√©codage √©choue.
- **Options utiles `json_encode`** :  
  `JSON_PRETTY_PRINT`, `JSON_UNESCAPED_UNICODE`, `JSON_UNESCAPED_SLASHES`, `JSON_INVALID_UTF8_SUBSTITUTE`.
- **√âcriture s√ªre** : `mkdir(..., recursive:true)`, `file_put_contents(..., LOCK_EX)` pour **verrouiller** le fichier √† l‚Äô√©criture.
- **I/O** : entr√©es/sorties (lecture/√©criture) de fichiers.

---

## üéØ Objectif p√©dagogique
Savoir **lire** et **√©crire** des fichiers **texte/JSON** de fa√ßon **robuste** :
- centraliser la logique dans `loadJson()` / `saveJson()`,
- manipuler les options d‚Äôencodage,
- g√©rer les erreurs avec **exceptions** appropri√©es,
- pr√©parer le **seed** `storage/seeds/articles.seed.json` utilis√© ensuite dans Laravel.

---

## üß† D√©finition th√©orique (avec mini-exemples)

### 1) Lire/√©crire un fichier texte
```php
<?php
declare(strict_types=1);

$path = 'storage/demo.txt';

$ok = @file_put_contents($path, "Bonjour\n", LOCK_EX);
if ($ok === false) { throw new RuntimeException("√âcriture impossible: $path"); }

$txt = @file_get_contents($path);
if ($txt === false) { throw new RuntimeException("Lecture impossible: $path"); }

echo $txt; // Bonjour
````

### 2) D√©coder/Encoder du JSON (avec exceptions)

```php
<?php
declare(strict_types=1);

$data = ['title' => 'Hello JSON', 'tags' => ['php','json']];

$json = json_encode(
  $data,
  JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES | JSON_INVALID_UTF8_SUBSTITUTE
);
// $json est une cha√Æne (ou false si erreur SANS JSON_THROW_ON_ERROR)

$again = json_decode($json, true, 512, JSON_THROW_ON_ERROR); // tableau associatif
```

> Astuce : **toujours** pr√©ciser `true` pour obtenir un **tableau associatif**, et activer `JSON_THROW_ON_ERROR` c√¥t√© `json_decode`.

### 3) Sch√©ma de fonctions r√©utilisables

```php
<?php
declare(strict_types=1);

/** @return array<mixed> */
function loadJson(string $path): array {
  $raw = @file_get_contents($path);
  if ($raw === false) {
    throw new RuntimeException("Fichier introuvable ou illisible: $path");
  }
  try {
    /** @var array<mixed> $data */
    $data = json_decode($raw, true, 512, JSON_THROW_ON_ERROR);
    return $data;
  } catch (JsonException $e) {
    throw new RuntimeException("JSON invalide dans $path", previous: $e);
  }
}

/** @param array<mixed> $data */
function saveJson(string $path, array $data): void {
  $dir = dirname($path);
  if (!is_dir($dir)) { mkdir($dir, 0777, true); }

  try {
    $json = json_encode(
      $data,
      JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES | JSON_INVALID_UTF8_SUBSTITUTE
    );
    if ($json === false) {
      throw new RuntimeException("√âchec d'encodage JSON (retour false).");
    }
  } catch (Throwable $e) {
    throw new RuntimeException("Encodage JSON impossible", previous: $e);
  }

  $ok = @file_put_contents($path, $json . PHP_EOL, LOCK_EX);
  if ($ok === false) {
    throw new RuntimeException("√âcriture impossible: $path");
  }
}
```

---

## üîç Exemple fil rouge ‚Äî Seed JSON des articles

Nous allons **cr√©er** puis **relire** `storage/seeds/articles.seed.json`.

**Arborescence :**

```
c3-php/chap-3-0-8/
‚îî‚îÄ‚îÄ json_io.php
```

### `json_io.php`

```php
<?php
declare(strict_types=1);

/** Helpers g√©n√©riques JSON (cf. section th√©orique) */
function loadJson(string $path): array {
  $raw = @file_get_contents($path);
  if ($raw === false) {
    throw new RuntimeException("Fichier introuvable ou illisible: $path");
  }
  try {
    /** @var array $data */
    $data = json_decode($raw, true, 512, JSON_THROW_ON_ERROR);
    return $data;
  } catch (JsonException $e) {
    throw new RuntimeException("JSON invalide dans $path", previous: $e);
  }
}

function saveJson(string $path, array $data): void {
  $dir = dirname($path);
  if (!is_dir($dir)) { mkdir($dir, 0777, true); }

  $json = json_encode(
    $data,
    JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES | JSON_INVALID_UTF8_SUBSTITUTE
  );
  if ($json === false) {
    throw new RuntimeException("√âchec d'encodage JSON (retour false).");
  }

  $ok = @file_put_contents($path, $json . PHP_EOL, LOCK_EX);
  if ($ok === false) {
    throw new RuntimeException("√âcriture impossible: $path");
  }
}

/** G√©n√®re un slug simple */
function slugify(string $value): string {
  $s = strtolower($value);
  $s = preg_replace('/[^a-z0-9]+/i', '-', $s) ?? '';
  return trim($s, '-');
}

/** Donn√©es d‚Äôexemple */
$articles = [
  [
    'id'      => 1,
    'title'   => 'Fichiers & JSON avec PHP',
    'slug'    => slugify('Fichiers & JSON avec PHP'),
    'excerpt' => 'Lire/√©crire des fichiers, encoder/d√©coder du JSON en toute s√©curit√©.',
    'tags'    => ['php','json'],
  ],
  [
    'id'      => 2,
    'title'   => 'Pr√©parer le seed Articles',
    'slug'    => slugify('Pr√©parer le seed Articles'),
    'excerpt' => 'Construire un articles.seed.json r√©utilisable dans Laravel.',
    'tags'    => ['seed','laravel'],
  ],
];

$seedPath = __DIR__ . '/storage/seeds/articles.seed.json';

try {
  // 1) √âcrire le seed
  saveJson($seedPath, $articles);
  echo "[OK] Seed √©crit: $seedPath" . PHP_EOL;

  // 2) Relire et v√©rifier
  $loaded = loadJson($seedPath);
  echo "[OK] Relu: " . count($loaded) . " article(s)." . PHP_EOL;

  // 3) Afficher le premier titre
  echo "Premier titre: " . ($loaded[0]['title'] ?? 'N/A') . PHP_EOL;

  exit(0);
} catch (Throwable $e) {
  // Gestion d‚Äôerreurs coh√©rente avec 3.0.3
  fwrite(STDERR, "[ERR] " . $e->getMessage() . PHP_EOL);
  if ($e->getPrevious()) {
    fwrite(STDERR, "Cause: " . get_class($e->getPrevious()) . " ‚Äî " . $e->getPrevious()->getMessage() . PHP_EOL);
  }
  exit(1);
}
```

### Ex√©cution

```bash
php c3-php/chap-3-0-8/json_io.php
# => [OK] Seed √©crit ...
# => [OK] Relu: 2 article(s).
# => Premier titre: Fichiers & JSON avec PHP
```

---

## üõ† Challenge (N1+)

* **Atomic write** : √©crivez d‚Äôabord dans un fichier temporaire (`$path . '.tmp'`), puis `rename()` vers la cible.
* **Validation** : avant l‚Äôenregistrement, **validez** chaque article (`title`, `slug` non vides) et levez `DomainException` si invalide.
* **CLI** : acceptez un **chemin en argument** (`$argv[1]`) et un **nombre d‚Äôarticles** (`$argv[2]`) pour g√©n√©rer dynamiquement le seed.
* **Import/merge** : lisez un `articles.extra.json` et **fusionnez** les tableaux avant de sauvegarder (√©viter les doublons de `slug`).

---

## ‚úÖ Bonnes pratiques

* Centraliser `loadJson()` / `saveJson()` pour **r√©utiliser** partout.
* Toujours **verrouiller** l‚Äô√©criture (`LOCK_EX`) et cr√©er le dossier cible (`mkdir(..., true)`).
* Utiliser `JSON_THROW_ON_ERROR` (d√©codage) et des **options d‚Äôencodage** lisibles (`PRETTY_PRINT`, `UNESCAPED_UNICODE`).
* G√©rer les **exceptions** avec des **messages clairs** (chemin, cause) et des **codes de sortie** en CLI.

---

## üßæ R√©sum√©

* **Lecture** : `file_get_contents` ‚Üí `json_decode(..., JSON_THROW_ON_ERROR)`.
* **√âcriture** : `json_encode(..., options)` ‚Üí `file_put_contents(..., LOCK_EX)`.
* **Robustesse** : exceptions, cr√©ation de dossiers, options d‚Äôencodage.
* **Fil rouge** : un `articles.seed.json` propre, pr√™t pour Laravel (migrations/seeders, API).

**Livrable attendu** : `json_io.php` qui **√©crit** puis **relit** `storage/seeds/articles.seed.json` avec gestion d‚Äôerreurs correcte.
