---
title: 7. Scripts CLI
layout: home
nav_order: 7
parent: 3.0. Rappel PHP & POO
permalink: /cli-argv-getopt-io/
---

# üìò Chapitre 3.0.7 ‚Äî Scripts CLI (`argv`, `getopt`), entr√©e/sortie console

## üìí Glossaire minute
- **CLI** : interface en ligne de commande (ex√©cution via `php script.php ...`).
- **`$argv` / `$argc`** : tableau des **arguments** pass√©s au script / leur **compte**.
- **`getopt`** : parseur d‚Äôoptions **courtes/longues** (`-v`, `--input=...`).
- **STDIN / STDOUT / STDERR** : flux **entr√©e**, **sortie** et **erreur**.
- **Code de sortie** : `0=OK`, `>0=erreur` (ex. `1` erreur g√©n√©rique, `2` usage).

---

## üéØ Objectifs p√©dagogiques
√Ä la fin du chapitre, vous saurez :
1. Lire les **arguments** d‚Äôun script CLI avec **`$argv`** et **`getopt`**.  
2. G√©rer l‚Äô**entr√©e** (fichier ou **STDIN**) et la **sortie** (STDOUT/STDERR) proprement.  
3. Afficher une **aide** (`--help`), valider les options et retourner un **code de sortie** clair.

---

## üß† D√©finition th√©orique (avec mini-exemples)

### 1) Lire les arguments bruts via `$argv`
```php
<?php
// php hello.php Amina
// $argv[0] = 'hello.php', $argv[1] = 'Amina'
echo "Bonjour " . ($argv[1] ?? 'Inconnu') . PHP_EOL;
````

### 2) Parser proprement avec `getopt`

```php
<?php
// php tool.php -v --input=data.json --limit=5
$short = 'v';                         // -v (bool)
$long  = ['input:', 'limit::', 'help', 'dry-run']; 
// 'input:'   => valeur REQUISE
// 'limit::'  => valeur OPTIONNELLE
// bool√©ens   => pr√©sents => true

$opts = getopt($short, $long);

$verbose = array_key_exists('v', $opts);
$input   = $opts['input']  ?? null;
$limit   = isset($opts['limit']) ? (int)$opts['limit'] : null;
$help    = array_key_exists('help', $opts);
$dryRun  = array_key_exists('dry-run', $opts);
```

### 3) STDIN / STDOUT / STDERR, codes de sortie

```php
<?php
fwrite(STDOUT, "OK\n");              // sortie normale
fwrite(STDERR, "Erreur: fichier introuvable\n"); // sortie erreur
exit(1); // 0=succ√®s, 1=erreur (shell: `$?`)
```

---

## üõ†Ô∏è Tutoriel guid√© (pas √† pas)

> Nous allons cr√©er un **outil CLI** `articles:report` capable de :
>
> * lire une liste d‚Äôarticles en **JSON** depuis `--input=chemin` ou `--input=-` (**STDIN**),
> * limiter l‚Äôaffichage (`--limit=3`),
> * imprimer un **mini-rapport** sur **STDOUT**,
> * g√©rer les erreurs sur **STDERR** avec un **code de sortie** non nul.

### 0) Jeu de donn√©es d‚Äôexemple (`articles.seed.json`)

```json
[
  {"id":1,"title":"Intro Laravel","views":120,"published":true,"author":"Amina"},
  {"id":2,"title":"PHP 8 en pratique","views":300,"published":true,"author":"Yassine"},
  {"id":3,"title":"Composer & Autoload","views":90,"published":false,"author":"Amina"},
  {"id":4,"title":"Validation FormRequest","views":210,"published":true,"author":"Sara"}
]
```

### 1) Cr√©ez `bin/articles_report.php`

```php
#!/usr/bin/env php
<?php
declare(strict_types=1);

/**
 * Usage:
 *   php bin/articles_report.php --input=storage/seeds/articles.seed.json [--limit=3] [--dry-run] [-v] [--help]
 *   cat file.json | php bin/articles_report.php --input=-
 */

const EXIT_OK          = 0;
const EXIT_USAGE       = 2;
const EXIT_DATA_ERROR  = 3;

function usage(): void {
    $msg = <<<TXT
Articles Report ‚Äî Options:
  --input=PATH    Chemin du JSON ou '-' pour STDIN (obligatoire)
  --limit[=N]     Limiter le nombre d‚Äôarticles affich√©s (optionnel)
  --dry-run       N‚Äôeffectue pas d‚Äôaction sensible (ici, informatif)
  -v              Mode verbeux
  --help          Affiche cette aide

Exemples:
  php bin/articles_report.php --input=storage/seeds/articles.seed.json --limit=3
  cat data.json | php bin/articles_report.php --input=-
TXT;
    fwrite(STDOUT, $msg . PHP_EOL);
}

function readJsonFrom(string $input): array {
    $json = '';
    if ($input === '-') {
        $json = stream_get_contents(STDIN);
    } else {
        if (!is_file($input)) {
            fwrite(STDERR, "Erreur: fichier introuvable: $input\n");
            exit(EXIT_DATA_ERROR);
        }
        $json = file_get_contents($input);
    }
    $data = json_decode($json, true, 512, JSON_THROW_ON_ERROR);
    if (!is_array($data)) {
        fwrite(STDERR, "Erreur: format JSON inattendu\n");
        exit(EXIT_DATA_ERROR);
    }
    return $data;
}

function normalizeArticle(array $a): array {
    $title = trim((string)($a['title'] ?? 'Sans titre'));
    return [
        'id'        => (int)($a['id'] ?? 0),
        'title'     => $title,
        'views'     => (int)($a['views'] ?? 0),
        'published' => (bool)($a['published'] ?? true),
        'author'    => (string)($a['author'] ?? 'N/A'),
    ];
}

// ---- main ----
$opts = getopt('v', ['input:', 'limit::', 'dry-run', 'help']);

if (array_key_exists('help', $opts)) {
    usage();
    exit(EXIT_OK);
}

$input = $opts['input'] ?? null;
if ($input === null) {
    fwrite(STDERR, "Erreur: --input est requis (chemin ou '-')\n\n");
    usage();
    exit(EXIT_USAGE);
}

$limit   = isset($opts['limit']) ? max(1, (int)$opts['limit']) : null;
$verbose = array_key_exists('v', $opts);
$dryRun  = array_key_exists('dry-run', $opts);

if ($verbose) {
    fwrite(STDOUT, "[v] Lecture depuis " . ($input === '-' ? 'STDIN' : $input) . PHP_EOL);
}

try {
    $items = array_map('normalizeArticle', readJsonFrom($input));
} catch (Throwable $e) {
    fwrite(STDERR, "Erreur JSON: " . $e->getMessage() . PHP_EOL);
    exit(EXIT_DATA_ERROR);
}

// Ne garder que les publi√©s
$published = array_values(array_filter($items, fn($a) => $a['published']));

// trier par vues desc
usort($published, fn($a, $b) => $b['views'] <=> $a['views']);

// limiter
if ($limit !== null) {
    $published = array_slice($published, 0, $limit);
}

// rapport
$total  = count($items);
$countP = count($published);
$views  = array_reduce($published, fn($acc, $a) => $acc + $a['views'], 0);

if ($dryRun) {
    fwrite(STDOUT, "[dry-run] Aucun effet de bord.\n");
}

fwrite(STDOUT, "Articles publi√©s (top".($limit? " $limit": "")."):\n");
foreach ($published as $a) {
    fwrite(STDOUT, "- {$a['title']} ({$a['views']} vues) ‚Äî {$a['author']}\n");
}
fwrite(STDOUT, "R√©sum√©: total=$total, publi√©s=$countP, vues_sum=$views\n");

exit(EXIT_OK);
```

> üí° Sous Linux/Mac, vous pouvez rendre le script ex√©cutable :
> `chmod +x bin/articles_report.php` puis `./bin/articles_report.php --input=...`
> Sur Windows, utilisez `php bin/articles_report.php ...`.

### 2) Essayez les commandes

```bash
# Aide
php bin/articles_report.php --help

# Lecture depuis un fichier
php bin/articles_report.php --input=storage/seeds/articles.seed.json --limit=3

# Lecture depuis STDIN
type storage/seeds/articles.seed.json | php bin/articles_report.php --input=-

# Mode verbeux + dry-run
php bin/articles_report.php --input=... -v --dry-run
```

---

## üß™ Exercice guid√© (livrable N1)

> **But** : cr√©er `bin/seed_generator.php` qui **lit** un CSV depuis `--input=chemin` (ou `-`), le convertit en **JSON normalis√©** et l‚Äô√©crit sur **STDOUT** (redirection possible `> storage/seeds/articles.seed.json`).

**Exigences**

1. Options : `--input=PATH|-`, `--published-only` (ne garder que les lignes publi√©es), `--limit[=N]`, `--help`.
2. Colonnes CSV attendues : `title,excerpt,views,published,author`.
3. Normaliser : `views=int`, `published=bool`, champs manquants ‚Üí valeurs par d√©faut.
4. En cas d‚Äôerreur, √©crire sur **STDERR** + **exit code** non nul.
5. Fournir 2‚Äì3 lignes CSV de test + un exemple d‚Äôappel.

### (Corrig√© indicatif ‚Äî extrait)

```php
<?php
declare(strict_types=1);

$opts = getopt('', ['input:', 'published-only', 'limit::', 'help']);
if (isset($opts['help'])) { /* print usage */ exit(0); }
$input = $opts['input'] ?? null;
if (!$input) { fwrite(STDERR, "Erreur: --input requis\n"); exit(2); }

$fh = ($input === '-') ? STDIN : @fopen($input, 'r');
if (!$fh) { fwrite(STDERR, "Erreur: ouverture input\n"); exit(3); }

$rows = [];
$header = fgetcsv($fh);
while (($line = fgetcsv($fh)) !== false) {
    $rows[] = array_combine($header, $line);
}
if ($fh !== STDIN) fclose($fh);

// normalisation
$items = array_map(function(array $r): array {
    return [
        'title'     => trim((string)($r['title'] ?? 'Sans titre')),
        'excerpt'   => ($r['excerpt'] ?? null) !== '' ? (string)$r['excerpt'] : null,
        'views'     => (int)($r['views'] ?? 0),
        'published' => in_array(strtolower((string)($r['published'] ?? 'true')), ['1','true','yes','y','on'], true),
        'author'    => (string)($r['author'] ?? 'N/A'),
    ];
}, $rows);

if (isset($opts['published-only'])) {
    $items = array_values(array_filter($items, fn($a) => $a['published']));
}
if (isset($opts['limit'])) {
    $items = array_slice($items, 0, max(1, (int)$opts['limit']));
}

echo json_encode($items, JSON_PRETTY_PRINT|JSON_UNESCAPED_UNICODE) . PHP_EOL;
exit(0);
```

**Exemple d‚Äôappel**

```bash
# CSV de test (Windows: utilisez `type` √† la place de `cat`)
cat <<CSV > /tmp/articles.csv
title,excerpt,views,published,author
Intro Laravel,,120,true,Amina
PHP 8 en pratique,Tour des nouveaut√©s,300,true,Yassine
Composer & Autoload,,90,false,Amina
CSV

php bin/seed_generator.php --input=/tmp/articles.csv --published-only --limit=2 > storage/seeds/articles.seed.json
```

---

## ‚ö†Ô∏è Erreurs fr√©quentes

* Oublier `--input` ou accepter silencieusement une valeur vide ‚Üí toujours **valider** et **afficher `--help`**.
* Confondre **STDOUT** et **STDERR** ‚Üí les **messages d‚Äôerreur** vont sur **STDERR**, les **donn√©es** sur **STDOUT**.
* Ne pas g√©rer les **codes de sortie** ‚Üí impossible d‚Äôautomatiser correctement dans des scripts.
* Lire de gros fichiers en **m√©moire** sans streaming ‚Üí privil√©giez `fopen/fgets` si n√©cessaire.

---

## üßæ R√©sum√©

* **`getopt`** simplifie le parsing d‚Äôoptions CLI (avec aide, valeurs obligatoires/optionnelles).
* **STDIN/STDOUT/STDERR** + **exit codes** = outils **scriptables** et **fiables**.
* Base indispensable pour les chapitres **3.0.8 (fichiers/JSON)** et **3.0.9 (Composer + scripts)**.

---

## üîú Suite

Passez √† **3.0.8 ‚Äî Fichiers & JSON** pour s√©rialiser vos donn√©es en **`articles.seed.json`** puis connectez-le √† Laravel dans **C3.1**.

