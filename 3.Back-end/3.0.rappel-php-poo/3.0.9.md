---
title: 9. Composer
layout: home
nav_order: 9
parent: 3.0. Rappel PHP & POO
permalink: /php-poo/composer/
code: 3.0.9
competence: C3
autoformation: "C3.0"
ua: "3.0.U3"
duree_h: 1.5
objectif: "Initialiser Composer, configurer lâ€™autoload PSR-4 et crÃ©er des scripts exÃ©cutables (`start`, `seed`)."
notions_nouvelles: ["Composer", "Autoload", "PSR-4", "Scripts Composer"]
fil_rouge: "Scripts pour gÃ©nÃ©rer `storage/articles.seed.json` (consommÃ© par Laravel + Mobile)"
livrable_chapitre: "`composer.json` (autoload + scripts), `cli/seed_articles.php`, `cli/app.php`"
alimentation_prototype: "ExÃ©cution standardisÃ©e (`composer run`) pour alimenter lâ€™UI (N2)"
alimentation_miniprojet: "Pipeline reproductible de gÃ©nÃ©ration de donnÃ©es (N3)"
---


# ğŸ“˜  3.0.9 - Composer

## ğŸ“’ Glossaire minute

* **Composer** : gestionnaire de dÃ©pendances PHP (et de lâ€™autoload).
* **Autoload** : chargement automatique des classes sans `require` manuel.
* **PSR-4** : standard de **mappage Namespace â†’ dossier** (ex. `App\` â†’ `src/`).
* **Scripts Composer** : alias de commandes (exÃ©cutent du PHP ou des binaires) via `composer run <script>`.

## ğŸ¯ Objectif pÃ©dagogique

Initialiser un projet Composer, configurer lâ€™**autoload PSR-4** vers `src/`, et crÃ©er deux **scripts** utiles :

* `"start"` : lance un petit script CLI.
* `"seed"` : gÃ©nÃ¨re `storage/articles.seed.json` (fil rouge).

## ğŸ§  DÃ©finition (rapide mais claire)

Composer centralise la configuration du projet dans `composer.json`.
Deux blocs clÃ©s :

* `"autoload": { "psr-4": { "App\\": "src/" } }` â†’ toute classe dans `src/` avec namespace `App\...` est autoloadÃ©e.
* `"scripts"` â†’ petites commandes Â« raccourcis Â» dÃ©clenchÃ©es par `composer run <nom>`.

AprÃ¨s modification de lâ€™autoload, exÃ©cuter **`composer dump-autoload`** pour rÃ©gÃ©nÃ©rer `vendor/autoload.php`.

---

## ğŸ” Exemple fil rouge

On prÃ©pare un **gÃ©nÃ©rateur de seed JSON** dâ€™articles. Le Mobile consommera plus tard lâ€™API du blog ; cÃ´tÃ© Laravel on rÃ©utilisera ce seed pour les seeders.

---

## ğŸ›  Tutoriel pratique

> **Travail Ã  faire** : crÃ©er un mini-projet CLI avec Composer, autoload PSR-4 et deux scripts (`start`, `seed`).
> **Structure cible** :

```
blog-tools/
â”œâ”€â”€ composer.json
â”œâ”€â”€ cli/
â”‚   â”œâ”€â”€ app.php
â”‚   â””â”€â”€ seed_articles.php
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ Support/Str.php
â”‚   â””â”€â”€ Seed/ArticleFactory.php
â””â”€â”€ storage/
    â””â”€â”€ (sera rempli par le script)
```

### Ã‰tape 1 â€” Initialiser Composer

Dans un dossier vide :

```bash
mkdir blog-tools && cd blog-tools
composer init
# âœ Renseigner minimalement :
# Package name: solicode/cli-tools
# Description: Scripts CLI pour le fil rouge (seed JSON)
# Author: (laisser vide ou votre nom)
# Minimum Stability: stable (par dÃ©faut)
# Define your dependencies: none pour lâ€™instant
```

> Vous pouvez aussi remplacer toute lâ€™Ã©tape par la **crÃ©ation directe** du `composer.json` ci-dessous.

### Ã‰tape 2 â€” CrÃ©er `composer.json` (version prÃªte Ã  lâ€™emploi)

```json
{
  "name": "solicode/cli-tools",
  "description": "Scripts CLI pour le fil rouge (seed JSON Articles)",
  "type": "project",
  "require": {
    "php": "^8.2"
  },
  "autoload": {
    "psr-4": {
      "App\\": "src/"
    }
  },
  "scripts": {
    "start": "php cli/app.php",
    "seed": "php cli/seed_articles.php --count=10 --out=storage/articles.seed.json"
  }
}
```

> AprÃ¨s crÃ©ation/modification de lâ€™autoload, exÃ©cuter :
>
> ```bash
> composer dump-autoload
> ```

### Ã‰tape 3 â€” Ajouter une utilitaire de chaÃ®ne (`src/Support/Str.php`)

```php
<?php
namespace App\Support;

final class Str
{
    public static function slug(string $text): string
    {
        $text = strtolower(trim($text));
        // Remplace tout ce qui n'est pas lettre/chiffre par '-'
        $text = preg_replace('/[^\p{L}\p{Nd}]+/u', '-', $text);
        return trim($text, '-');
    }

    public static function excerpt(string $content, int $max = 180): string
    {
        $clean = trim(preg_replace('/\s+/', ' ', strip_tags($content)));
        return mb_strlen($clean) <= $max ? $clean : mb_substr($clean, 0, $max - 1).'â€¦';
    }
}
```

### Ã‰tape 4 â€” Fabrique dâ€™articles (`src/Seed/ArticleFactory.php`)

```php
<?php
namespace App\Seed;

use App\Support\Str;

final class ArticleFactory
{
    /** @var string[] */
    private array $authors = ['Amine', 'Sara', 'Youssef', 'Nadia'];
    /** @var string[] */
    private array $topics  = ['PHP', 'Laravel', 'Mobile', 'UX', 'MySQL'];

    /**
     * @return array<int, array<string, mixed>>
     */
    public function make(int $count): array
    {
        $titles = [
            'Bonnes pratiques PHP',
            'DÃ©couvrir Eloquent',
            'API REST lisible',
            'Pagination & filtres',
            'Exceptions utiles'
        ];

        $used = [];
        $rows = [];

        for ($i = 1; $i <= $count; $i++) {
            $title = $titles[($i - 1) % count($titles)]." #$i";
            $slug  = Str::slug($title);

            // Garantir lâ€™unicitÃ© du slug
            $base = $slug; $n = 2;
            while (isset($used[$slug])) {
                $slug = $base.'-'.$n++;
            }
            $used[$slug] = true;

            $content = "Contenu dâ€™exemple pour Â« $title Â». ".
                       "Cet article illustre la gÃ©nÃ©ration de seed JSON cÃ´tÃ© CLI.";

            // 0..3 tags au hasard
            $tags = array_values(array_unique(array_filter(array_map(function () {
                return (rand(0, 1) ? $this->topics[array_rand($this->topics)] : null);
            }, range(1, 3)))));

            $rows[] = [
                'title'        => $title,
                'slug'         => $slug,
                'excerpt'      => Str::excerpt($content, 180),
                'content'      => $content,
                'author'       => $this->authors[array_rand($this->authors)],
                'published_at' => date('c', time() - rand(0, 60 * 60 * 24 * 30)), // â‰¤ 30j
                'tags'         => $tags
            ];
        }

        return $rows;
    }
}
```

### Ã‰tape 5 â€” Script `start` basique (`cli/app.php`)

```php
<?php
require __DIR__ . '/../vendor/autoload.php';

echo "ğŸ‘‹ Hello from Composer scripts! Autoload PSR-4 opÃ©rationnel.\n";
```

ExÃ©cuter :

```bash
composer run start
```

### Ã‰tape 6 â€” GÃ©nÃ©rateur de seed (`cli/seed_articles.php`)

```php
<?php
require __DIR__ . '/../vendor/autoload.php';

use App\Seed\ArticleFactory;

$options = getopt('', ['count::', 'out::']);
$count = isset($options['count']) ? (int)$options['count'] : 10;
$out   = $options['out'] ?? 'storage/articles.seed.json';

// GÃ©nÃ©rer
$factory  = new ArticleFactory();
$articles = $factory->make($count);

// CrÃ©er le dossier si nÃ©cessaire
$dir = dirname($out);
if (!is_dir($dir)) {
    if (!mkdir($dir, 0777, true) && !is_dir($dir)) {
        fwrite(STDERR, "Erreur: impossible de crÃ©er le dossier $dir\n");
        exit(1);
    }
}

// Ã‰crire JSON joli
$json = json_encode($articles, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
if ($json === false) {
    fwrite(STDERR, "Erreur JSON: " . json_last_error_msg() . "\n");
    exit(1);
}
file_put_contents($out, $json);

echo "âœ… Seed gÃ©nÃ©rÃ© : $out (" . count($articles) . " articles)\n";
```

Tester :

```bash
composer dump-autoload
composer run seed
# ou bien, avec options :
# composer run seed -- --count=15 --out=storage/articles.seed.json
```

**Extrait attendu (`storage/articles.seed.json`)** :

```json
[
  {
    "title": "Bonnes pratiques PHP #1",
    "slug": "bonnes-pratiques-php-1",
    "excerpt": "Contenu dâ€™exemple pour â€¦",
    "content": "Contenu dâ€™exemple pour Â« Bonnes pratiques PHP #1 Â» â€¦",
    "author": "Sara",
    "published_at": "2025-08-01T12:34:56+00:00",
    "tags": ["Laravel","MySQL"]
  }
]
```

> ğŸ’¡ Ce fichier sera **rÃ©utilisÃ©** dans C3.1/C3.2 pour les **seeders/migrations** et dans lâ€™**API**.

---

## âœ… Exercice

1. Ajoutez un script `"clean"` qui supprime le fichier de seed :

```json
"clean": "php -r \"@unlink('storage/articles.seed.json'); echo 'OK\\n';\""
```

2. Modifiez `ArticleFactory` pour garantir **au moins un** tag par article.
3. Ajoutez un paramÃ¨tre `--topic=Laravel` Ã  `seed_articles.php` pour biaiser les titres vers un thÃ¨me donnÃ©.

**CritÃ¨res de rÃ©ussite** :

* `composer run start` affiche le message.
* `composer run seed` gÃ©nÃ¨re un JSON valide.
* `composer run clean` supprime proprement le seed.

---

## ğŸ§¾ RÃ©sumÃ© & points-clÃ©s

* **Composer** gÃ¨re **autoload** + **scripts** via `composer.json`.
* **PSR-4** : mappez `App\` â†’ `src/` pour charger vos classes sans `require`.
* AprÃ¨s tout changement dâ€™autoload : **`composer dump-autoload`**.
* Les **scripts** standardisent lâ€™exÃ©cution (`composer run seed`) et sâ€™intÃ¨grent au fil rouge (gÃ©nÃ©ration de `articles.seed.json`).
