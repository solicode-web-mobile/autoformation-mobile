---
title: 9. Composer
layout: home
nav_order: 9
parent: 3.0. Rappel PHP & POO
permalink: /php-poo/composer/
code: 3.0.9
competence: C3
autoformation: "C3.0"
ua: "3.0.U3"
duree_h: 1.5
objectif: "Initialiser Composer, configurer l’autoload PSR-4 et créer des scripts exécutables (`start`, `seed`)."
notions_nouvelles: ["Composer", "Autoload", "PSR-4", "Scripts Composer"]
fil_rouge: "Scripts pour générer `storage/articles.seed.json` (consommé par Laravel + Mobile)"
livrable_chapitre: "`composer.json` (autoload + scripts), `cli/seed_articles.php`, `cli/app.php`"
alimentation_prototype: "Exécution standardisée (`composer run`) pour alimenter l’UI (N2)"
alimentation_miniprojet: "Pipeline reproductible de génération de données (N3)"
---


# 📘  3.0.9 - Composer

## 📒 Glossaire minute

* **Composer** : gestionnaire de dépendances PHP (et de l’autoload).
* **Autoload** : chargement automatique des classes sans `require` manuel.
* **PSR-4** : standard de **mappage Namespace → dossier** (ex. `App\` → `src/`).
* **Scripts Composer** : alias de commandes (exécutent du PHP ou des binaires) via `composer run <script>`.

## 🎯 Objectif pédagogique

Initialiser un projet Composer, configurer l’**autoload PSR-4** vers `src/`, et créer deux **scripts** utiles :

* `"start"` : lance un petit script CLI.
* `"seed"` : génère `storage/articles.seed.json` (fil rouge).

## 🧠 Définition (rapide mais claire)

Composer centralise la configuration du projet dans `composer.json`.
Deux blocs clés :

* `"autoload": { "psr-4": { "App\\": "src/" } }` → toute classe dans `src/` avec namespace `App\...` est autoloadée.
* `"scripts"` → petites commandes « raccourcis » déclenchées par `composer run <nom>`.

Après modification de l’autoload, exécuter **`composer dump-autoload`** pour régénérer `vendor/autoload.php`.

---

## 🔍 Exemple fil rouge

On prépare un **générateur de seed JSON** d’articles. Le Mobile consommera plus tard l’API du blog ; côté Laravel on réutilisera ce seed pour les seeders.

---

## 🛠 Tutoriel pratique

> **Travail à faire** : créer un mini-projet CLI avec Composer, autoload PSR-4 et deux scripts (`start`, `seed`).
> **Structure cible** :

```
blog-tools/
├── composer.json
├── cli/
│   ├── app.php
│   └── seed_articles.php
├── src/
│   ├── Support/Str.php
│   └── Seed/ArticleFactory.php
└── storage/
    └── (sera rempli par le script)
```

### Étape 1 — Initialiser Composer

Dans un dossier vide :

```bash
mkdir blog-tools && cd blog-tools
composer init
# ➜ Renseigner minimalement :
# Package name: solicode/cli-tools
# Description: Scripts CLI pour le fil rouge (seed JSON)
# Author: (laisser vide ou votre nom)
# Minimum Stability: stable (par défaut)
# Define your dependencies: none pour l’instant
```

> Vous pouvez aussi remplacer toute l’étape par la **création directe** du `composer.json` ci-dessous.

### Étape 2 — Créer `composer.json` (version prête à l’emploi)

```json
{
  "name": "solicode/cli-tools",
  "description": "Scripts CLI pour le fil rouge (seed JSON Articles)",
  "type": "project",
  "require": {
    "php": "^8.2"
  },
  "autoload": {
    "psr-4": {
      "App\\": "src/"
    }
  },
  "scripts": {
    "start": "php cli/app.php",
    "seed": "php cli/seed_articles.php --count=10 --out=storage/articles.seed.json"
  }
}
```

> Après création/modification de l’autoload, exécuter :
>
> ```bash
> composer dump-autoload
> ```

### Étape 3 — Ajouter une utilitaire de chaîne (`src/Support/Str.php`)

```php
<?php
namespace App\Support;

final class Str
{
    public static function slug(string $text): string
    {
        $text = strtolower(trim($text));
        // Remplace tout ce qui n'est pas lettre/chiffre par '-'
        $text = preg_replace('/[^\p{L}\p{Nd}]+/u', '-', $text);
        return trim($text, '-');
    }

    public static function excerpt(string $content, int $max = 180): string
    {
        $clean = trim(preg_replace('/\s+/', ' ', strip_tags($content)));
        return mb_strlen($clean) <= $max ? $clean : mb_substr($clean, 0, $max - 1).'…';
    }
}
```

### Étape 4 — Fabrique d’articles (`src/Seed/ArticleFactory.php`)

```php
<?php
namespace App\Seed;

use App\Support\Str;

final class ArticleFactory
{
    /** @var string[] */
    private array $authors = ['Amine', 'Sara', 'Youssef', 'Nadia'];
    /** @var string[] */
    private array $topics  = ['PHP', 'Laravel', 'Mobile', 'UX', 'MySQL'];

    /**
     * @return array<int, array<string, mixed>>
     */
    public function make(int $count): array
    {
        $titles = [
            'Bonnes pratiques PHP',
            'Découvrir Eloquent',
            'API REST lisible',
            'Pagination & filtres',
            'Exceptions utiles'
        ];

        $used = [];
        $rows = [];

        for ($i = 1; $i <= $count; $i++) {
            $title = $titles[($i - 1) % count($titles)]." #$i";
            $slug  = Str::slug($title);

            // Garantir l’unicité du slug
            $base = $slug; $n = 2;
            while (isset($used[$slug])) {
                $slug = $base.'-'.$n++;
            }
            $used[$slug] = true;

            $content = "Contenu d’exemple pour « $title ». ".
                       "Cet article illustre la génération de seed JSON côté CLI.";

            // 0..3 tags au hasard
            $tags = array_values(array_unique(array_filter(array_map(function () {
                return (rand(0, 1) ? $this->topics[array_rand($this->topics)] : null);
            }, range(1, 3)))));

            $rows[] = [
                'title'        => $title,
                'slug'         => $slug,
                'excerpt'      => Str::excerpt($content, 180),
                'content'      => $content,
                'author'       => $this->authors[array_rand($this->authors)],
                'published_at' => date('c', time() - rand(0, 60 * 60 * 24 * 30)), // ≤ 30j
                'tags'         => $tags
            ];
        }

        return $rows;
    }
}
```

### Étape 5 — Script `start` basique (`cli/app.php`)

```php
<?php
require __DIR__ . '/../vendor/autoload.php';

echo "👋 Hello from Composer scripts! Autoload PSR-4 opérationnel.\n";
```

Exécuter :

```bash
composer run start
```

### Étape 6 — Générateur de seed (`cli/seed_articles.php`)

```php
<?php
require __DIR__ . '/../vendor/autoload.php';

use App\Seed\ArticleFactory;

$options = getopt('', ['count::', 'out::']);
$count = isset($options['count']) ? (int)$options['count'] : 10;
$out   = $options['out'] ?? 'storage/articles.seed.json';

// Générer
$factory  = new ArticleFactory();
$articles = $factory->make($count);

// Créer le dossier si nécessaire
$dir = dirname($out);
if (!is_dir($dir)) {
    if (!mkdir($dir, 0777, true) && !is_dir($dir)) {
        fwrite(STDERR, "Erreur: impossible de créer le dossier $dir\n");
        exit(1);
    }
}

// Écrire JSON joli
$json = json_encode($articles, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
if ($json === false) {
    fwrite(STDERR, "Erreur JSON: " . json_last_error_msg() . "\n");
    exit(1);
}
file_put_contents($out, $json);

echo "✅ Seed généré : $out (" . count($articles) . " articles)\n";
```

Tester :

```bash
composer dump-autoload
composer run seed
# ou bien, avec options :
# composer run seed -- --count=15 --out=storage/articles.seed.json
```

**Extrait attendu (`storage/articles.seed.json`)** :

```json
[
  {
    "title": "Bonnes pratiques PHP #1",
    "slug": "bonnes-pratiques-php-1",
    "excerpt": "Contenu d’exemple pour …",
    "content": "Contenu d’exemple pour « Bonnes pratiques PHP #1 » …",
    "author": "Sara",
    "published_at": "2025-08-01T12:34:56+00:00",
    "tags": ["Laravel","MySQL"]
  }
]
```

> 💡 Ce fichier sera **réutilisé** dans C3.1/C3.2 pour les **seeders/migrations** et dans l’**API**.

---

## ✅ Exercice

1. Ajoutez un script `"clean"` qui supprime le fichier de seed :

```json
"clean": "php -r \"@unlink('storage/articles.seed.json'); echo 'OK\\n';\""
```

2. Modifiez `ArticleFactory` pour garantir **au moins un** tag par article.
3. Ajoutez un paramètre `--topic=Laravel` à `seed_articles.php` pour biaiser les titres vers un thème donné.

**Critères de réussite** :

* `composer run start` affiche le message.
* `composer run seed` génère un JSON valide.
* `composer run clean` supprime proprement le seed.

---

## 🧾 Résumé & points-clés

* **Composer** gère **autoload** + **scripts** via `composer.json`.
* **PSR-4** : mappez `App\` → `src/` pour charger vos classes sans `require`.
* Après tout changement d’autoload : **`composer dump-autoload`**.
* Les **scripts** standardisent l’exécution (`composer run seed`) et s’intègrent au fil rouge (génération de `articles.seed.json`).
