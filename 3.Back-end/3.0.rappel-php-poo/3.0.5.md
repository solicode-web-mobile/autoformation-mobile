---
title: 5. Encapsulation
layout: home
nav_order: 5
parent: 3.0. Rappel PHP & POO
permalink: /php-poo//encapsulation-visibilite/
---

# ğŸ“˜  3.0.5 - Encapsulation & visibilitÃ©

## ğŸ“’ Glossaire minute
- **Encapsulation** : protÃ©ger lâ€™Ã©tat interne dâ€™une classe via une **API publique minimale** (getters/mÃ©thodes mÃ©tier), et effectuer la **validation** Ã  lâ€™entrÃ©e.  
- **VisibilitÃ©** :
  - `public` : accessible partout,
  - `protected` : accessible dans la classe **et** ses **sous-classes**,
  - `private` : accessible **uniquement** dans la classe.  
- **`readonly` (PHP â‰¥ 8.1)** : propriÃ©tÃ© **assignable une seule fois** (souvent au constructeur) â†’ **immuable** ensuite.  
- **`static`** : membre partagÃ© par **toutes les instances** de la classe. Ã€ utiliser **avec parcimonie** (Ã©tat global).

---

## ğŸ¯ Objectif pÃ©dagogique
Savoir **concevoir des classes robustes** :
- choisir la **bonne visibilitÃ©** pour chaque membre,
- garantir les invariants via **encapsulation**,
- utiliser `readonly` pour lâ€™**immutabilitÃ©** des identifiants,
- employer `static` Ã  bon escient (compteurs, usines, utilitaires).

---

## ğŸ§  DÃ©finition thÃ©orique (avec mini-exemples)

### 1) Encapsulation & visibilitÃ©
```php
<?php
declare(strict_types=1);

class User {
  private string $name;          // cachÃ© au monde extÃ©rieur
  protected array $roles = [];   // visible par les sous-classes
  public function __construct(string $name) { $this->setName($name); }

  public function name(): string { return $this->name; }

  public function setName(string $name): void {
    $name = trim($name);
    if ($name === '') throw new InvalidArgumentException("Nom requis.");
    $this->name = $name;
  }

  public function addRole(string $role): void {
    if ($role === '') throw new InvalidArgumentException("Role vide.");
    $this->roles[] = $role;
  }

  public function roles(): array { return $this->roles; }
}

$u = new User('Amina');
$u->addRole('author');
// $u->name = 'X';         // âŒ Erreur : propriÃ©tÃ© privÃ©e
// echo $u->roles[0];      // âŒ Erreur : propriÃ©tÃ© protÃ©gÃ©e
echo $u->name();           // âœ… OK via API publique
````

### 2) `readonly` : immutabilitÃ© des identifiants

```php
class ArticleId {
  public function __construct(public readonly int $value) {
    if ($value <= 0) throw new InvalidArgumentException("Id > 0 requis.");
  }
}

$id = new ArticleId(10);
// $id->value = 12; // âŒ Fatal Error: Cannot modify readonly property
```

### 3) `static` : membres partagÃ©s & usines

```php
class Counter {
  private static int $count = 0;       // partagÃ© par toutes les instances
  public function __construct() { self::$count++; }
  public static function count(): int { return self::$count; } // mÃ©thode de classe
}

new Counter(); new Counter();
echo Counter::count(); // 2
```

> âš ï¸ **Anti-pattern** : abuser dâ€™un **Ã©tat `static` mutable** complique les tests et introduit des effets de bord. PrÃ©fÃ©rez des **services injectÃ©s**. Gardez `static` pour : **constantes**, **utilitaires purs**, **compteurs simples**, ou **usines** (`from...()`).

### 4) `self::` vs `static::` (Late Static Bindings)

```php
class Base {
  public static function who(): string { return 'Base'; }
  public static function make(): static { return new static(); } // LSB
  public function type(): string { return static::who(); }       // LSB
}

class Child extends Base {
  public static function who(): string { return 'Child'; }
}

echo (new Child())->type();            // "Child"
var_dump(Child::make() instanceof Child); // true
```

---

## ğŸ” Exemple fil rouge (classe `Article` robuste)

On encapsule lâ€™Ã©tat dâ€™un article (titre, slug, tags), avec :

* `id` **readonly**,
* titre **privÃ©** et validÃ© via `setTitle()`,
* `slug` dÃ©rivÃ© du titre,
* `static` **compteur** + **usine** `fromTitle()`.

```php
<?php
declare(strict_types=1);

class Article {
  public readonly int $id;          // immuable aprÃ¨s construction
  private string $title;            // encapsulÃ©
  private string $slug;             // dÃ©rivÃ©
  private array $tags = [];         // encapsulÃ©

  private static int $count = 0;    // partagÃ©

  public function __construct(int $id, string $title, array $tags = []) {
    if ($id <= 0) throw new InvalidArgumentException("id > 0 requis.");
    $this->id = $id;
    $this->setTitle($title);
    $this->tags = $tags;
    self::$count++;
  }

  /** Usine avec LSB : retournera la sous-classe correcte si appelÃ©e depuis elle */
  public static function fromTitle(int $id, string $title): static {
    return new static($id, $title);
  }

  /** Getters (API publique minimale) */
  public function title(): string { return $this->title; }
  public function slug(): string { return $this->slug; }
  public function tags(): array { return $this->tags; }

  /** Setter encapsulant validation + mise Ã  jour du slug */
  public function setTitle(string $title): void {
    $title = trim($title);
    if ($title === '') throw new InvalidArgumentException("Titre requis.");
    $this->title = $title;
    $this->slug  = static::slugify($title);
  }

  public function addTag(string $tag): void {
    $t = trim($tag);
    if ($t === '') throw new InvalidArgumentException("Tag vide.");
    $this->tags[] = $t;
  }

  public static function count(): int { return self::$count; }

  /** ProtÃ©gÃ© : surcharge possible cÃ´tÃ© sous-classe */
  protected static function slugify(string $value): string {
    $s = strtolower($value);
    $s = preg_replace('/[^a-z0-9]+/i', '-', $s) ?? '';
    return trim($s, '-');
  }
}

/** Sous-classe : spÃ©cialisation via `protected` et LSB */
class FeaturedArticle extends Article {
  protected static function slugify(string $value): string {
    return 'featured-' . parent::slugify($value);
  }
}

// DÃ©mo
$a = Article::fromTitle(1, 'Encapsulation & visibilitÃ© en PHP');
$b = FeaturedArticle::fromTitle(2, 'Lire moins, comprendre plus');
$b->addTag('best');

echo $a->slug() . PHP_EOL; // "encapsulation-visibilite-en-php"
echo $b->slug() . PHP_EOL; // "featured-lire-moins-comprendre-plus"
echo Article::count() . PHP_EOL; // 2
```

---

## ğŸ›  Tutoriel pratique

**Arborescence :**

```
c3-php/chap-3-0-5/
â””â”€â”€ encapsulation.php
```

### Ã‰tape 1 â€” ImplÃ©menter `encapsulation.php`

* Copiez le code de lâ€™**exemple fil rouge** ci-dessus.
* Ajoutez un test : essayez de modifier `$a->id` aprÃ¨s construction â†’ **erreur `readonly`** attendue.

### Ã‰tape 2 â€” ExÃ©cuter

```bash
php c3-php/chap-3-0-5/encapsulation.php
```

### Ã‰tape 3 â€” Mini-adaptation fil rouge

* Ajoutez une mÃ©thode publique `toArray(): array` dans `Article` pour prÃ©parer lâ€™**export JSON** (id, title, slug, tags).
* CrÃ©ez un petit script qui **gÃ©nÃ¨re** un tableau de 3 articles via `fromTitle()` et **lâ€™affiche** avec `print_r()` (prÃ©paration au chapitre JSON).

### Ã‰tape 4 â€” Challenge (N1+)

* Ajoutez une **contrainte dâ€™unicitÃ©** du `slug` via un dÃ©pÃ´t en mÃ©moire :
  `ArticleRepository::save(Article $a)` lÃ¨ve `DomainException` si le `slug` existe dÃ©jÃ .
* Remplacez `self::$count` par une **statistique** maintenue dans le dÃ©pÃ´t (pour Ã©viter lâ€™Ã©tat `static` global).

---

## âœ… Bonnes pratiques

* **Par dÃ©faut, mettez `private`** aux propriÃ©tÃ©s ; exposez une **API claire**.
* Faites la **validation** dans les **constructeurs** et **mutateurs** (setters/mÃ©thodes mÃ©tier).
* Utilisez **`readonly`** pour les identifiants et valeurs immuables.
* Limitez `static` (prÃ©fÃ©rez **constantes** et **mÃ©thodes pures**).
* Pour lâ€™hÃ©ritage, **prÃ©fÃ©rez la composition** ; si hÃ©ritage, exploitez `protected` et LSB avec parcimonie.

---

## ğŸ§¾ RÃ©sumÃ©

* `public`/`protected`/`private` contrÃ´lent lâ€™**accÃ¨s** ; lâ€™**encapsulation** protÃ¨ge vos invariants.
* `readonly` **verrouille** lâ€™Ã©tat aprÃ¨s initialisation.
* `static` = **Ã©tat partagÃ©** : utile mais dÃ©licat (tests/effets de bord).
* LSB (`static::`) permet des **usines** qui respectent les sous-classes.

**Livrable attendu** : `encapsulation.php` fonctionnel, dÃ©montrant

* encapsulation + visibilitÃ©,
* propriÃ©tÃ© `readonly`,
* compteur/usine `static`,
* (option) surcharge `slugify()` en sous-classe,
* export `toArray()` prÃªt pour le JSON.

