---
title: 5. Encapsulation
layout: home
nav_order: 5
parent: 3.0. Rappel PHP & POO
permalink: /php-poo/encapsulation/
code: 3.0.5
competence: C3
autoformation: "C3.0"
ua: "3.0.U2"
duree_h: 1.5
objectif: "Prot√©ger l‚Äô√©tat interne via visibilit√©, `readonly`, API minimale et usage mesur√© de `static`."
notions_nouvelles: ["Encapsulation", "Visibilit√© (public/protected/private)", "readonly", "static", "Late Static Bindings"]
fil_rouge: "Article robuste (titre/slug/tags) et invariants garantis"
livrable_chapitre: "`encapsulation.php` (id readonly, setter validant, slug d√©riv√©, compteur static)"
alimentation_prototype: "Mod√®les fiables pour affichages coh√©rents (N2)"
alimentation_miniprojet: "Invariants m√©tiers respect√©s dans seeds/fixtures (N3)"
---


# üìò  3.0.5 - Encapsulation & visibilit√©

## üìí Glossaire minute
- **Encapsulation** : prot√©ger l‚Äô√©tat interne d‚Äôune classe via une **API publique minimale** (getters/m√©thodes m√©tier), et effectuer la **validation** √† l‚Äôentr√©e.  
- **Visibilit√©** :
  - `public` : accessible partout,
  - `protected` : accessible dans la classe **et** ses **sous-classes**,
  - `private` : accessible **uniquement** dans la classe.  
- **`readonly` (PHP ‚â• 8.1)** : propri√©t√© **assignable une seule fois** (souvent au constructeur) ‚Üí **immuable** ensuite.  
- **`static`** : membre partag√© par **toutes les instances** de la classe. √Ä utiliser **avec parcimonie** (√©tat global).

---

## üéØ Objectif p√©dagogique
Savoir **concevoir des classes robustes** :
- choisir la **bonne visibilit√©** pour chaque membre,
- garantir les invariants via **encapsulation**,
- utiliser `readonly` pour l‚Äô**immutabilit√©** des identifiants,
- employer `static` √† bon escient (compteurs, usines, utilitaires).

---

## üß† D√©finition th√©orique (avec mini-exemples)

### 1) Encapsulation & visibilit√©
```php
<?php
declare(strict_types=1);

class User {
  private string $name;          // cach√© au monde ext√©rieur
  protected array $roles = [];   // visible par les sous-classes
  public function __construct(string $name) { $this->setName($name); }

  public function name(): string { return $this->name; }

  public function setName(string $name): void {
    $name = trim($name);
    if ($name === '') throw new InvalidArgumentException("Nom requis.");
    $this->name = $name;
  }

  public function addRole(string $role): void {
    if ($role === '') throw new InvalidArgumentException("Role vide.");
    $this->roles[] = $role;
  }

  public function roles(): array { return $this->roles; }
}

$u = new User('Amina');
$u->addRole('author');
// $u->name = 'X';         // ‚ùå Erreur : propri√©t√© priv√©e
// echo $u->roles[0];      // ‚ùå Erreur : propri√©t√© prot√©g√©e
echo $u->name();           // ‚úÖ OK via API publique
````

### 2) `readonly` : immutabilit√© des identifiants

```php
class ArticleId {
  public function __construct(public readonly int $value) {
    if ($value <= 0) throw new InvalidArgumentException("Id > 0 requis.");
  }
}

$id = new ArticleId(10);
// $id->value = 12; // ‚ùå Fatal Error: Cannot modify readonly property
```

### 3) `static` : membres partag√©s & usines

```php
class Counter {
  private static int $count = 0;       // partag√© par toutes les instances
  public function __construct() { self::$count++; }
  public static function count(): int { return self::$count; } // m√©thode de classe
}

new Counter(); new Counter();
echo Counter::count(); // 2
```

> ‚ö†Ô∏è **Anti-pattern** : abuser d‚Äôun **√©tat `static` mutable** complique les tests et introduit des effets de bord. Pr√©f√©rez des **services inject√©s**. Gardez `static` pour : **constantes**, **utilitaires purs**, **compteurs simples**, ou **usines** (`from...()`).

### 4) `self::` vs `static::` (Late Static Bindings)

```php
class Base {
  public static function who(): string { return 'Base'; }
  public static function make(): static { return new static(); } // LSB
  public function type(): string { return static::who(); }       // LSB
}

class Child extends Base {
  public static function who(): string { return 'Child'; }
}

echo (new Child())->type();            // "Child"
var_dump(Child::make() instanceof Child); // true
```

---

## üîç Exemple fil rouge (classe `Article` robuste)

On encapsule l‚Äô√©tat d‚Äôun article (titre, slug, tags), avec :

* `id` **readonly**,
* titre **priv√©** et valid√© via `setTitle()`,
* `slug` d√©riv√© du titre,
* `static` **compteur** + **usine** `fromTitle()`.

```php
<?php
declare(strict_types=1);

class Article {
  public readonly int $id;          // immuable apr√®s construction
  private string $title;            // encapsul√©
  private string $slug;             // d√©riv√©
  private array $tags = [];         // encapsul√©

  private static int $count = 0;    // partag√©

  public function __construct(int $id, string $title, array $tags = []) {
    if ($id <= 0) throw new InvalidArgumentException("id > 0 requis.");
    $this->id = $id;
    $this->setTitle($title);
    $this->tags = $tags;
    self::$count++;
  }

  /** Usine avec LSB : retournera la sous-classe correcte si appel√©e depuis elle */
  public static function fromTitle(int $id, string $title): static {
    return new static($id, $title);
  }

  /** Getters (API publique minimale) */
  public function title(): string { return $this->title; }
  public function slug(): string { return $this->slug; }
  public function tags(): array { return $this->tags; }

  /** Setter encapsulant validation + mise √† jour du slug */
  public function setTitle(string $title): void {
    $title = trim($title);
    if ($title === '') throw new InvalidArgumentException("Titre requis.");
    $this->title = $title;
    $this->slug  = static::slugify($title);
  }

  public function addTag(string $tag): void {
    $t = trim($tag);
    if ($t === '') throw new InvalidArgumentException("Tag vide.");
    $this->tags[] = $t;
  }

  public static function count(): int { return self::$count; }

  /** Prot√©g√© : surcharge possible c√¥t√© sous-classe */
  protected static function slugify(string $value): string {
    $s = strtolower($value);
    $s = preg_replace('/[^a-z0-9]+/i', '-', $s) ?? '';
    return trim($s, '-');
  }
}

/** Sous-classe : sp√©cialisation via `protected` et LSB */
class FeaturedArticle extends Article {
  protected static function slugify(string $value): string {
    return 'featured-' . parent::slugify($value);
  }
}

// D√©mo
$a = Article::fromTitle(1, 'Encapsulation & visibilit√© en PHP');
$b = FeaturedArticle::fromTitle(2, 'Lire moins, comprendre plus');
$b->addTag('best');

echo $a->slug() . PHP_EOL; // "encapsulation-visibilite-en-php"
echo $b->slug() . PHP_EOL; // "featured-lire-moins-comprendre-plus"
echo Article::count() . PHP_EOL; // 2
```

---

## üõ† Tutoriel pratique

**Arborescence :**

```
c3-php/chap-3-0-5/
‚îî‚îÄ‚îÄ encapsulation.php
```

### √âtape 1 ‚Äî Impl√©menter `encapsulation.php`

* Copiez le code de l‚Äô**exemple fil rouge** ci-dessus.
* Ajoutez un test : essayez de modifier `$a->id` apr√®s construction ‚Üí **erreur `readonly`** attendue.

### √âtape 2 ‚Äî Ex√©cuter

```bash
php c3-php/chap-3-0-5/encapsulation.php
```

### √âtape 3 ‚Äî Mini-adaptation fil rouge

* Ajoutez une m√©thode publique `toArray(): array` dans `Article` pour pr√©parer l‚Äô**export JSON** (id, title, slug, tags).
* Cr√©ez un petit script qui **g√©n√®re** un tableau de 3 articles via `fromTitle()` et **l‚Äôaffiche** avec `print_r()` (pr√©paration au chapitre JSON).

### √âtape 4 ‚Äî Challenge (N1+)

* Ajoutez une **contrainte d‚Äôunicit√©** du `slug` via un d√©p√¥t en m√©moire :
  `ArticleRepository::save(Article $a)` l√®ve `DomainException` si le `slug` existe d√©j√†.
* Remplacez `self::$count` par une **statistique** maintenue dans le d√©p√¥t (pour √©viter l‚Äô√©tat `static` global).

---

## ‚úÖ Bonnes pratiques

* **Par d√©faut, mettez `private`** aux propri√©t√©s ; exposez une **API claire**.
* Faites la **validation** dans les **constructeurs** et **mutateurs** (setters/m√©thodes m√©tier).
* Utilisez **`readonly`** pour les identifiants et valeurs immuables.
* Limitez `static` (pr√©f√©rez **constantes** et **m√©thodes pures**).
* Pour l‚Äôh√©ritage, **pr√©f√©rez la composition** ; si h√©ritage, exploitez `protected` et LSB avec parcimonie.

---

## üßæ R√©sum√©

* `public`/`protected`/`private` contr√¥lent l‚Äô**acc√®s** ; l‚Äô**encapsulation** prot√®ge vos invariants.
* `readonly` **verrouille** l‚Äô√©tat apr√®s initialisation.
* `static` = **√©tat partag√©** : utile mais d√©licat (tests/effets de bord).
* LSB (`static::`) permet des **usines** qui respectent les sous-classes.

**Livrable attendu** : `encapsulation.php` fonctionnel, d√©montrant

* encapsulation + visibilit√©,
* propri√©t√© `readonly`,
* compteur/usine `static`,
* (option) surcharge `slugify()` en sous-classe,
* export `toArray()` pr√™t pour le JSON.

