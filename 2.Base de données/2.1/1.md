````md
---
title: 2.1.1 Cr√©ation de tables avec PK/FK & contraintes
layout: home
nav_order: 1
parent: Autoformation C2.1 ‚Äî Sch√©ma & Eloquent (bases)
permalink: /c2-1/schema-pk-fk-contraintes/
---

# üìò Chapitre 2.1.1 ‚Äî Cr√©ation de tables avec PK/FK et contraintes

## üìí Glossaire minute
- **PK (Primary Key)** : identifiant **unique** d‚Äôune ligne (ex. `id BIGINT UNSIGNED AUTO_INCREMENT`).
- **FK (Foreign Key)** : lien vers la PK d‚Äôune autre table, avec **r√®gle d‚Äôint√©grit√©** (ex. `ON DELETE CASCADE`).
- **Contraintes** : r√®gles au niveau SQL : `NOT NULL`, `UNIQUE`, `CHECK` (selon SGBD), **index**.
- **Pivot** : table de relation **n‚Äìn** (ex. `article_tag` reliant `articles`‚Üî`tags`).
- **InnoDB** : moteur MySQL avec **support des FKs** (requis).

---

## üéØ Objectifs p√©dagogiques
√Ä la fin du chapitre, vous saurez :
1. Cr√©er des tables **dans le bon ordre** avec **PK/FK** (1‚Äìn, n‚Äìn).  
2. Poser des **contraintes** (NOT NULL, UNIQUE, index) et choisir les strat√©gies `ON DELETE` / `ON UPDATE`.  
3. √âcrire des **migrations** Laravel propres et **reversibles**.

---

## üß± Pr√©-requis & outillage
- **MySQL 8+** (InnoDB), **PHP ‚â• 8.2**, **Laravel 11**  
- Projet Laravel initialis√©, DB configur√©e dans `.env`  
- Connaissances de base migrations/seeders (chap. suivants)

---

## üó∫Ô∏è Mod√®le cible (exemple fil rouge *Blog*)
- `users` *(g√©n√©r√©e par Laravel Breeze/Jetstream ou d√©j√† existante)*  
- `articles` (**1‚Äìn** avec `users` via `author_id`)  
- `tags` et pivot `article_tag` (**n‚Äìn**)  
- `comments` (**1‚Äìn** vers `articles` et optionnellement `users`)

---

## üõ†Ô∏è Tutoriel guid√© (pas √† pas)

### 0) G√©n√©rer les migrations
```bash
php artisan make:migration create_articles_table
php artisan make:migration create_tags_table
php artisan make:migration create_article_tag_table
php artisan make:migration create_comments_table
````

> ‚öñÔ∏è **Ordre logique** : tables parentes d‚Äôabord (`users`, `articles`, `tags`), puis **pivot** et tables enfants (`comments`).

---

### 1) Table `articles` (PK, contraintes, FK auteur)

`database/migrations/xxxx_xx_xx_xxxxxx_create_articles_table.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void {
        Schema::create('articles', function (Blueprint $table) {
            $table->id(); // PK BIGINT UNSIGNED AI
            $table->foreignId('author_id')     // FK -> users.id
                  ->constrained('users')
                  ->cascadeOnUpdate()
                  ->restrictOnDelete();       // emp√™che de supprimer un user auteur (au choix)
            $table->string('title');
            $table->string('slug')->unique();  // contrainte UNIQUE
            $table->text('excerpt')->nullable();
            $table->unsignedInteger('views')->default(0);
            $table->boolean('published')->default(true);
            $table->timestamps();

            // Index de consultation (tri/recherche fr√©quents)
            $table->index(['published', 'created_at']);
        });
    }

    public function down(): void {
        Schema::dropIfExists('articles');
    }
};
```

> üîé **Choix `restrictOnDelete()`** : prot√®ge l‚Äôint√©grit√© m√©tier (on ne ‚Äúperd‚Äù pas les auteurs).
> Alternative : `nullOnDelete()` si vous rendez `author_id` **nullable**.

---

### 2) Table `tags` (unique & slug)

`database/migrations/xxxx_xx_xx_xxxxxx_create_tags_table.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void {
        Schema::create('tags', function (Blueprint $table) {
            $table->id();
            $table->string('name')->unique();  // un nom de tag unique
            $table->string('slug')->unique();
            $table->timestamps();
        });
    }

    public function down(): void {
        Schema::dropIfExists('tags');
    }
};
```

---

### 3) Pivot `article_tag` (n‚Äìn avec cl√©s compos√©es)

`database/migrations/xxxx_xx_xx_xxxxxx_create_article_tag_table.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void {
        Schema::create('article_tag', function (Blueprint $table) {
            $table->foreignId('article_id')
                  ->constrained('articles')
                  ->cascadeOnUpdate()
                  ->cascadeOnDelete(); // supprimer lier automatiquement quand un article disparait
            $table->foreignId('tag_id')
                  ->constrained('tags')
                  ->cascadeOnUpdate()
                  ->cascadeOnDelete();

            // Emp√™che les doublons (m√™me article, m√™me tag)
            $table->unique(['article_id', 'tag_id']);

            // Optionnel : PK surrogate si vous pr√©f√©rez
            // $table->id();
        });
    }

    public function down(): void {
        Schema::dropIfExists('article_tag');
    }
};
```

---

### 4) Table `comments` (FK vers `articles` + `users` nullable)

`database/migrations/xxxx_xx_xx_xxxxxx_create_comments_table.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void {
        Schema::create('comments', function (Blueprint $table) {
            $table->id();
            $table->foreignId('article_id')
                  ->constrained('articles')
                  ->cascadeOnUpdate()
                  ->cascadeOnDelete(); // si un article est supprim√©, on supprime ses commentaires
            $table->foreignId('user_id')
                  ->nullable()
                  ->constrained('users')
                  ->nullOnDelete();    // si l'user est supprim√©, on garde le commentaire (anonyme)
            $table->text('body');
            $table->boolean('is_visible')->default(true);
            $table->timestamps();

            $table->index(['article_id', 'created_at']); // listage rapide par article
        });
    }

    public function down(): void {
        Schema::dropIfExists('comments');
    }
};
```

---

### 5) Ex√©cuter / rejouer proprement

```bash
php artisan migrate           # applique les nouvelles migrations
php artisan migrate:status    # v√©rifie l‚Äô√©tat
php artisan migrate:fresh     # (danger) drop + recr√©e toutes les tables
```

> üßπ **Drop avec FKs** : Laravel g√®re l‚Äôordre, mais pour des scripts manuels, vous pouvez entourer de
> `Schema::disableForeignKeyConstraints()` / `Schema::enableForeignKeyConstraints()`.

---

## ‚úÖ Crit√®res de r√©ussite

* Les tables existent avec **PK** correctes (`id` auto-incr√©ment√©es).
* Les **Fks** sont en place avec la **strat√©gie** choisie (`cascade`, `restrict`, `null`).
* Les contraintes **UNIQUE** (ex. `articles.slug`, `tags.name`) et **index** utiles sont cr√©√©s.
* `php artisan migrate` passe **sans erreur** et `migrate:fresh` reconstruit la base.

---

## üß™ Exercice guid√© (livrable N1)

> **But** : ajouter une table `categories` reli√©e √† `articles` (1‚Äìn) et renforcer l‚Äôint√©grit√©.

**Exigences**

1. Table `categories` : `id`, `name` (unique), `slug` (unique), `timestamps`.
2. Ajoutez `category_id` **nullable** √† `articles` avec FK `->constrained()->nullOnDelete()`.
3. Indexez `articles(category_id, published, created_at)` pour acc√©l√©rer la liste par cat√©gorie.
4. √âcrivez la **migration de modification** d‚Äô`articles` (`php artisan make:migration add_category_id_to_articles_table`).
5. V√©rifiez avec `php artisan migrate:fresh --seed` (le seeding viendra au chap. 2.1.2).

---

## ‚ö†Ô∏è Erreurs fr√©quentes

* Cr√©er une FK vers une table **non encore cr√©√©e** ‚Üí erreur `foreign key constraint fails`.
* Oublier `unique()` sur les champs **slug/nom** ‚Üí doublons difficiles √† g√©rer c√¥t√© appli.
* Utiliser `CASCADE` partout sans r√©fl√©chir ‚Üí pertes de donn√©es inattendues.
* Ne pas indexer les colonnes de **tri/filtre** ‚Üí requ√™tes lentes.

---

## üßæ R√©sum√©

* Les **migrations** d√©crivent la **v√©rit√©** du sch√©ma : PK, FK, **contraintes** et **index**.
* Choisir la bonne **politique FK** (`restrict`, `cascade`, `null`) d√©pend du **m√©tier**.
* Un sch√©ma propre **simplifie** Eloquent (chap. 2.1.3‚Äì2.1.4) et rend l‚ÄôAPI plus **fiable** (C3.x).

---

## üîú Suite

Passez √† **2.1.2 ‚Äî Seeders & jeux de donn√©es de test** pour alimenter rapidement la base (et r√©utiliser `articles.seed.json` cr√©√© en C3.0).

```
```
