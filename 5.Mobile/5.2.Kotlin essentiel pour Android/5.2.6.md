---
title: 6. Bonnes pratiques
layout: home
nav_order: 6
parent: 5.2. Kotlin essentiel pour Android
permalink: /kotlin-essentiel/bonnes-pratiques/
code: 5.2.6
competence: C5
autoformation: "C5.2"
ua: "5.2.U3"
duree_h: 1.5
objectif: "Produire un code Android/Compose simple, testable et maintenable (immutabilite, fonctions pures, KISS)."
notions_nouvelles: ["Immutabilite", "Fonction pure", "KISS", "Reducer UiState", "StateFlow/ViewModel (aper√ßu)"]
fil_rouge: "App Mobile Compose + API Blog Laravel"
livrable_chapitre: "UiState + reducers (startLoading/setItems/setError), utilitaires parseCount/greet avec tests, mini-exemple Compose"
alimentation_prototype: "Qualite de code et testabilite du prototype"
alimentation_miniprojet: "Base maintenable et evolutive pour l‚Äôapplication"
---


# üìò 5.2.6 - Bonnes pratiques

## üìí Glossaire minute
- **Immutabilit√©** : donn√©es **non modifiables** apr√®s cr√©ation (`val`, `data class`, listes reconstruites).
- **Fonction pure** : m√™me **entr√©e ‚Üí m√™me sortie**, **sans effet de bord** (pas d‚ÄôI/O, pas d‚Äô√©tat global).
- **KISS** (*Keep It Simple, Stupid*) : aller au **plus simple** qui marche, sans sur-ing√©nierie.

---

## ‚úÖ Objectif
√âcrire un code **pr√©visible, testable et lisible** pour Android/Compose : **√©tats immuables**, **petites fonctions pures**, et solutions **simples** avant l‚Äôarchitecture ‚Äúenterprise‚Äù.

---

## 1) Immutabilit√© d‚Äôabord

### R√®gles
- `val` **par d√©faut** ; `var` **seulement** quand n√©cessaire.
- `data class` pour les **√©tats** ; mise √† jour via **`copy`**.
- Collections **immutables** (`List`, `Set`, `Map`) ; recr√©ez au besoin.

```kotlin
data class UiState(val name: String = "", val count: Int = 0)

fun inc(ui: UiState) = ui.copy(count = ui.count + 1)
fun rename(ui: UiState, raw: String) =
  ui.copy(name = raw.trim())
````

> ‚úÖ Effets : **moins de bugs**, **recompositions Compose** plus claires, **tests** plus faciles.

---

## 2) Petites fonctions **pures**

### R√®gles

* 1 **intention** par fonction (‚â§ 15‚Äì20 lignes).
* Pr√©f√©rez **corps expression** et **early returns**.
* Pas d‚Äôacc√®s r√©seau/DB/UI dans une fonction de **domaine**.

```kotlin
fun humanize(count: Int) =
  if (count == 1) "1 √©l√©ment" else "$count √©l√©ments"

fun parseCount(input: String?) =
  input?.trim()?.toIntOrNull()?.coerceAtLeast(0) ?: 0
```

> Les **effets de bord** (r√©seau, log, navigation) sont orchestr√©s **ailleurs** (ViewModel/Repository).

---

## 3) KISS ‚Äî aller au plus simple

* **Avant** de sortir MVVM + UseCases + DI : commencez par **MVVM l√©ger** (ViewModel + UiState + Repository).
* √âvitez les **abstractions pr√©matur√©es**. Un `Repository` suffit souvent au d√©but.
* Pr√©f√©rez la **composition** (petits composables/fonctions) √† l‚Äô**h√©ritage**.

```kotlin
class MainViewModel(
  private val repo: TodoRepository
) : ViewModel() {

  private val _ui = MutableStateFlow(UiState())
  val ui: StateFlow<UiState> = _ui

  fun onAdd(title: String) = _ui.update { it.copy(todos = it.todos + title) }
}
```

---

## 4) Patterns utiles (Android/Compose)

### A) `UiState` immuable + intents

```kotlin
data class UiState(
  val items: List<String> = emptyList(),
  val loading: Boolean = false,
  val error: String? = null
)

fun startLoading(ui: UiState) = ui.copy(loading = true, error = null)
fun setError(ui: UiState, msg: String) = ui.copy(loading = false, error = msg)
fun setItems(ui: UiState, xs: List<String>) = ui.copy(loading = false, items = xs)
```

### B) R√®gle : **ne muter jamais** une liste partag√©e

```kotlin
// ‚ùå Mauvais : modifie la m√™me instance
ui.items.add("x")

// ‚úÖ Bon : cr√©e une nouvelle liste
val next = ui.copy(items = ui.items + "x")
```

### C) S√©parer **formatage** (pur) et **affichage**

```kotlin
fun greet(name: String) =
  name.trim().takeIf { it.isNotEmpty() }?.let { "Bonjour, $it !" } ?: ""

@Composable
fun Greeting(name: String) { Text(greet(name)) } // UI simple
```

---

## 5) Tests facilit√©s par la puret√©

```kotlin
@Test fun parse_never_negative() {
  assertEquals(0, parseCount("-10"))
  assertEquals(5, parseCount(" 5 "))
}

@Test fun state_copy_is_pure() {
  val s = UiState(count = 0)
  assertEquals(UiState(count = 1), inc(s))
}
```

> Les fonctions **pures** se testent **sans Android** (JVM), vite et souvent.

---

## 6) Coroutines & √©tat (au minimum)

* `viewModelScope.launch { ... }` pour les **effets** (r√©seau/IO).
* Publiez **uniquement** des **UiState** **immuables**.
* En cas d‚Äôerreur : **UiState.Error** (ou champ `error`), **pas d‚Äôexception** qui remonte √† l‚ÄôUI.

```kotlin
sealed interface Result<out T> { data class Ok<T>(val data:T):Result<T>; data class Err(val msg:String):Result<Nothing> }

fun UiState.reduce(r: Result<List<String>>) = when (r) {
  is Result.Ok  -> copy(items = r.data, loading = false, error = null)
  is Result.Err -> copy(loading = false, error = r.msg)
}
```

---

## 7) Anti-patterns & corrections

* ‚ùå **Tout en `var`**, mutation partout ‚Üí ‚úÖ `val` + `data class` + `copy`.
* ‚ùå **Helpers ‚Äúutil‚Äù g√©ants** ‚Üí ‚úÖ petites **extensions** cibl√©es par domaine.
* ‚ùå **Abstraction early** (interfaces partout) ‚Üí ‚úÖ commencez **concret**, factorisez **apr√®s**.
* ‚ùå **Fonctions multi-responsabilit√©s** ‚Üí ‚úÖ scinder, nommer par **verbe clair**.
* ‚ùå **Singletons globaux** pour passer des donn√©es ‚Üí ‚úÖ `ViewModel`, arguments de fonctions, DI **l√©ger** si besoin.

---

## 8) Guide de style rapide

* **Noms** explicites (`parseCount`, `startLoading`), √©vitez `doStuff`.
* **Visibilit√©** minimale (`internal`, `private`) par d√©faut.
* **Fichiers** courts & th√©matiques (`UiState.kt`, `Format.kt`).
* **Commentaires** pour *pourquoi*, pas *quoi* (le code montre *quoi*).

---

## üß™ V√©rifications rapides

* [ ] Les **√©tats** sont des **`data class` immuables** ; mises √† jour via `copy`.
* [ ] Les **fonctions** font **une seule chose** et sont **testables**.
* [ ] L‚ÄôUI **appelle** des fonctions **pures** pour formater, le ViewModel g√®re les **effets**.
* [ ] Pas d‚Äô**abstraction** inutile (KISS) ; code simple qui passe les tests.

---

## üì¶ Livrables attendus

* 1 `UiState` + 3 fonctions pures de **r√©duction** (`startLoading`, `setItems`, `setError`).
* 2 utilitaires pures (`parseCount`, `greet`) avec tests JVM.
* 1 exemple Compose qui **consomme** ces fonctions (sans logique complexe dans l‚ÄôUI).

---

## ‚úÖ DoD ‚Äî Definition of Done

* [ ] `val` privil√©gi√©, **aucune** mutation de collections partag√©es.
* [ ] Fonctions **pures** courtes avec **tests**.
* [ ] **KISS** : MVVM **l√©ger**, pas de couches superflues.
* [ ] UI **dumb**, **ViewModel** orchestre, **Repository** isole I/O.

---

## ‚ö° Cheatsheet

```kotlin
// Immutabilit√©
data class Ui(val items: List<String> = emptyList(), val loading: Boolean = false)
val next = state.copy(items = state.items + "x")

// Pure
fun greet(n: String) = n.trim().takeIf { it.isNotEmpty() }?.let { "Bonjour, $it !" } ?: ""

// KISS MVVM l√©ger
class VM(private val repo: Repo): ViewModel() {
  private val _ui = MutableStateFlow(Ui())
  val ui: StateFlow<Ui> = _ui
  fun load() = viewModelScope.launch {
    _ui.update { it.copy(loading = true) }
    val r = repo.fetch()
    _ui.update { it.copy(loading = false, items = r) }
  }
}
```

