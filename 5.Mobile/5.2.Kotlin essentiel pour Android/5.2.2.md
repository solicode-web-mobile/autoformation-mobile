---
title: 2. Null-safety
layout: home
nav_order: 2
parent: 5.2. Kotlin essentiel pour Android
permalink: /kotlin-essentiel-android/null-safety/
code: 5.2.2
competence: C5
autoformation: "C5.2"
ua: "5.2.U1"
duree_h: 1.5
objectif: "Eviter les NPE avec T?, safe calls, Elvis, let et safe cast dans les flux Android."
notions_nouvelles: ["T?", "?.", "?: (Elvis)", "let", "as?", "toIntOrNull", "requireNotNull", "Platform type"]
fil_rouge: "App Mobile Compose + API Blog Laravel"
livrable_chapitre: "Utilitaires null-safe (parseCount, greet), Intent/Bundle sans !!, tests rapides"
alimentation_prototype: "Securise les entrees UI/Intent et les parsings"
alimentation_miniprojet: "Contrats DTO propres et mapping vers le domaine"
---


# ğŸ“˜ 5.2.2 â€” Null-safety 

## ğŸ“’ Glossaire minute
- **Type nullable** `T?` : peut Ãªtre `null`.  
- **Safe call** `obj?.m()` : nâ€™appelle que si non nul (sinon `null`).  
- **Elvis** `a ?: b` : si `a` est `null`, renvoie `b`.  
- **Scope** `obj?.let { ... }` : exÃ©cute le bloc **seulement** si non nul.  
- **Non-null assertion** `obj!!` : *jure* que non nul â†’ `NPE` si faux (âš ï¸).  
- **Safe cast** `x as? T` : renvoie `null` si le cast Ã©choue.  
- **Platform type** `String!` : issu de Java (peut Ãªtre nul â†’ prudence).

---

## âœ… Objectif
Ã‰crire du code **sÃ»r** et **lisible** sans `NullPointerException` : choisir correctement `T` vs `T?`, chaÃ®ner `?.` + `?:`, utiliser `let`, **Ã©viter `!!`**, et traiter proprement les flux Android (Intent/Bundle, DTO rÃ©seau).

---

## 1) Choisir `T` ou `T?`
- Par dÃ©faut : **non nullable** (`val name: String = "â€¦"`).  
- Nullable **seulement si** la valeur peut vraiment manquer (`val nickname: String?`).

```kotlin
data class User(
  val id: Long,              // requis
  val email: String,         // requis
  val phone: String? = null  // optionnel
)
````

---

## 2) Safe call `?.` + Elvis `?:` (duo gagnant)

```kotlin
val name: String? = intent.getStringExtra("name")

// Longueur ou 0 si null
val len = name?.length ?: 0

// Message si nom non vide, sinon chaÃ®ne vide
val greeting = name?.trim()
  ?.takeIf { it.isNotEmpty() }
  ?.let { "Bonjour, $it !" }
  ?: ""
```

> Astuce : `takeIf` garde la valeur si la condition est vraie (sinon `null`).

---

## 3) `let` pour scoper un non-null

```kotlin
val user: User? = repo.cachedUser()
user?.let { u ->
  // u est non nul ici
  showUserCard(u)
} // sinon, ne fait rien
```

**Pattern early-return (trÃ¨s lisible)**

```kotlin
val token: String = prefs.getString("token", null)
  ?.trim()
  ?.takeIf { it.isNotEmpty() }
  ?: return // ou return@launch dans une coroutine
```

---

## 4) Ã‰viter `!!` (et quoi faire Ã  la place)

**Ã€ Ã©viter**

```kotlin
val ctx = context!!          // âŒ crash si null
val id  = bundle!!.getLong("id")
```

**Alternatives sÃ»res**

```kotlin
val ctx = requireNotNull(context) { "Context requis" }  // throws avec message clair
val id  = bundle?.getLong("id") ?: return               // early-return

// Valider avant usage
val s: String? = maybeString()
if (s != null) {
  use(s) // s est promu non nul ici
}
```

> **RÃ¨gle** : `!!` uniquement si **logiquement impossible** dâ€™Ãªtre null **ET** dÃ©jÃ  vÃ©rifiÃ© (ex. aprÃ¨s `requireNotNull`).

---

## 5) Safe cast `as?` & collections

```kotlin
val any: Any = intent.getSerializableExtra("payload") ?: return
val user = any as? User ?: return  // null si type incompatible

val emails: List<String?> = listOf("a@b", null, "c@d")
val nonNullEmails: List<String> = emails.filterNotNull()

val ints = listOf("1", "x", "2").mapNotNull { it.toIntOrNull() } // [1, 2]
```

---

## 6) Android courants (Intent/Bundle, Compose)

### Intent / Bundle

```kotlin
val id = intent.getStringExtra("id")?.toLongOrNull() ?: 0L
val isDebug = intent.extras?.getBoolean("debug") ?: false
```

### Compose (afficher si non nul)

```kotlin
val greeting: String? = uiState.greeting
greeting?.let { Text(it) }     // ne rend le composable que si non nul
```

### Lecture sÃ»re dâ€™un champ texte

```kotlin
fun parseCount(input: String?): Int =
  input?.trim()?.toIntOrNull()?.takeIf { it >= 0 } ?: 0
```

---

## 7) API/DTO â†’ Domaine : dÃ©cider des nulls

```kotlin
data class TodoDto(val id: Long?, val title: String?, val done: Boolean?)
data class Todo(val id: Long, val title: String, val done: Boolean)

fun TodoDto.toDomain(): Todo = Todo(
  id = id ?: 0L,
  title = title?.takeIf { it.isNotBlank() } ?: "(sans titre)",
  done = done ?: false
)
```

> DÃ©cidez **oÃ¹** tolÃ©rer `null` : souvent **Ã  la frontiÃ¨re** (DTO), puis **nettoyer** en domaine.

---

## 8) Outils utilitaires utiles

```kotlin
// Check & require
val notNull = checkNotNull(possiblyNull) { "invariant brisÃ©" }
val required = requireNotNull(maybeNull) { "argument manquant" }

// Extensions idiomatiques
fun String?.orEmptyTrim() = this?.trim().orEmpty()
fun <T> T?.ifNull(block: () -> Unit): T? = this ?: run { block(); null }
```

---

## ğŸ§ª Exemples rapides (tests)

```kotlin
@Test fun greeting_only_when_name_present() {
  fun greet(name: String?) = name?.trim()?.takeIf { it.isNotEmpty() }?.let { "Bonjour, $it !" }
  assertNull(greet(null))
  assertNull(greet("  "))
  assertEquals("Bonjour, Ada !", greet("Ada"))
}

@Test fun parseCount_never_negative() {
  assertEquals(0, parseCount(null))
  assertEquals(0, parseCount("-5"))
  assertEquals(12, parseCount(" 12 "))
}
```

---

## ğŸ©¹ Erreurs frÃ©quentes & correctifs

* âŒ Tout dÃ©clarer en `T?` â†’ ğŸŒ± **non-nullable par dÃ©faut**, `?` seulement si nÃ©cessaire.
* âŒ EnchaÃ®ner `!!` â†’ utilisez `?: return`, `requireNotNull`, `if (x != null)`.
* âŒ Oublier `toIntOrNull()` / `toLongOrNull()` â†’ Ã©vitez les `NumberFormatException`.
* âŒ Supposer non-null un **platform type** Java â†’ **vÃ©rifier** et annoter cÃ´tÃ© Java si possible.
* âŒ Empiler `let {}` sans besoin â†’ prÃ©fÃ©rez `?.` + `?:` simples.

---

## ğŸ“¦ Livrables attendus

* Petites fonctions utilitaires null-safe (`parseCount`, `greet`, conversions).
* Exemple Intent/Bundle **sans `!!`**.
* Tests unitaires couvrant **cas null / vide / valide**.

---

## âœ… DoD â€” Definition of Done

* [ ] Aucun `!!` injustifiÃ© (au pire 0, sinon 1 avec justification).
* [ ] `?.` + `?:` maÃ®trisÃ©s, `let` utilisÃ© **Ã  bon escient**.
* [ ] EntrÃ©es utilisateur/Intent/DTO traitÃ©es avec `toXxxOrNull()` + valeurs par dÃ©faut.
* [ ] Tests couvrant les chemins `null`.

---

## âš¡ Cheatsheet

```kotlin
// Safe call + Elvis
val textLen = text?.length ?: 0

// Scope only if non-null
user?.let { show(it) }

// Early return si null
val token = prefs.getString("token", null) ?: return

// Safe cast + dÃ©faut
val u = any as? User ?: defaultUser()

// Alternatives Ã  !!
val ctx = requireNotNull(context) { "Context requis" }
val id  = bundle?.getLong("id") ?: return
```
