---
title: 2. Null-safety
layout: home
nav_order: 2
parent: 5.2. Kotlin essentiel pour Android
permalink: /kotlin-essentiel/null-safety/
code: 5.2.2
competence: C5
autoformation: "C5.2"
ua: "5.2.U1"
duree_h: 1.5
objectif: "Eviter les NPE avec T?, safe calls, Elvis, let et safe cast dans les flux Android."
notions_nouvelles: ["T?", "?.", "?: (Elvis)", "let", "as?", "toIntOrNull", "requireNotNull", "Platform type"]
fil_rouge: "App Mobile Compose + API Blog Laravel"
livrable_chapitre: "Utilitaires null-safe (parseCount, greet), Intent/Bundle sans !!, tests rapides"
alimentation_prototype: "Securise les entrees UI/Intent et les parsings"
alimentation_miniprojet: "Contrats DTO propres et mapping vers le domaine"
---


# üìò 5.2.2 ‚Äî Null-safety 


## üìí Glossaire minute

* **`T?`** : type nullable (peut prendre la valeur `null`).
* **Safe call `?.`** : n‚Äôacc√®de qu‚Äôen cas de non-null (sinon renvoie `null`).
* **Elvis `?:`** : valeur de **secours** si l‚Äôexpression de gauche est `null`.
* **`let { ... }`** : ex√©cute un bloc **seulement si** la valeur est non nulle.
* **`takeIf { cond }`** : garde la valeur si `cond` est vraie, sinon `null`.
* **Safe cast `as?`** : cast qui renvoie `null` si le type ne correspond pas.
* **`toIntOrNull()`** : conversion s√ªre vers `Int?` (√©vite les exceptions).
* **`coerceAtLeast(x)`** : impose un minimum (ex. pas de nombres n√©gatifs).
* **`requireNotNull(x)`** : stoppe avec un message si `x` est `null`.
* **`getOrNull(i)`** : r√©cup√®re l‚Äô√©l√©ment d‚Äôune liste, ou `null` si hors bornes.

---

## ‚úÖ Objectif

√âcrire du code **s√ªr et lisible** sans `NullPointerException` : choisir `T` vs `T?`, combiner `?.` + `?:`, utiliser `let`/`takeIf`, convertir sans risque, acc√©der aux listes sans crash, et **√©viter `!!`**.

---

## üß† Rep√®res rapides

* **Par d√©faut non-nullable** : `val name: String = "Ada"`.
* **Nullable si l√©gitime** : `val nickname: String? = null`.
* **Bannir `!!`** : utiliser `?.`, `?:`, `if (x != null)`, `requireNotNull`.

---

## üõ† Atelier guid√© ‚Äî pas √† pas (livrable final)

> Tu vas construire un **ex√©cutable console** : un seul fichier `NullSafetyDemo.kt` avec un `main()` qui d√©montre chaque √©tape.
> **Livrable** : `NullSafetyDemo.kt`
> **Chemin conseill√©** : `app/src/main/java/com/tonpackage/demo/NullSafetyDemo.kt`

### √âtape 1 ‚Äî Squelette du projet (main)

**But.** Pr√©parer l‚Äôex√©cutable et v√©rifier l‚Äôenvironnement.

**Notion cl√© (base).** `main()` est le **point d‚Äôentr√©e** d‚Äôun programme console.

```kotlin
// NullSafetyDemo.kt
// D√©mo ex√©cutable du chapitre 5.2.2 ‚Äî Null-safety

fun main() {
    println("=== DEMO Null-safety ===")
    // Les appels des √©tapes suivantes viendront ici
}
```

*Ex√©cute* (clic droit ‚Üí **Run**) pour v√©rifier la configuration.

---

### √âtape 2 ‚Äî Lecture/normalisation d‚Äôun texte (safe call + Elvis + takeIf + let)

**But.** Produire un message **seulement** si le texte non nul **n‚Äôest pas vide**.

**Notions cl√©s.**

* **`?.` (safe call)** : n‚Äôencha√Æne que si non-null.
* **`?:` (Elvis)** : fournit une **valeur par d√©faut** si `null`.
* **`takeIf`** : garde la valeur si condition vraie.
* **`let`** : cr√©e un **bloc local** avec la valeur non nulle.

```kotlin
fun greet(input: String?): String =
    input
        ?.trim()
        ?.takeIf { it.isNotEmpty() }
        ?.let { "Bonjour, $it !" }
        ?: ""

fun main() {
    println("=== DEMO Null-safety ===")
    println(greet(null))        // ""
    println(greet("  "))        // ""
    println(greet("  Ada "))    // "Bonjour, Ada !"
}
```

---

### √âtape 3 ‚Äî Conversion s√ªre en nombre (toIntOrNull + coerceAtLeast)

**But.** Convertir un texte en entier **sans** exception et **couper** les n√©gatifs √† 0.

**Notions cl√©s.**

* **`toIntOrNull()`** : renvoie `Int?` (pas d‚Äôexception si invalide).
* **`coerceAtLeast(0)`** : garantit un **minimum** (ici, pas de n√©gatif).

```kotlin
fun parseCount(input: String?): Int =
    input
        ?.trim()
        ?.toIntOrNull()
        ?.coerceAtLeast(0)
        ?: 0

fun main() {
    println("=== DEMO Null-safety ===")
    println(greet("  Ada "))    // "Bonjour, Ada !"
    println(parseCount(null))   // 0
    println(parseCount(" -5 ")) // 0
    println(parseCount(" 12 ")) // 12
}
```

---

### √âtape 4 ‚Äî Acc√®s de liste sans risque (getOrNull + Elvis)

**But.** R√©cup√©rer un √©l√©ment de liste **ou** une valeur par d√©faut si hors bornes.

**Notions cl√©s.**

* **`getOrNull(i)`** : √©vite l‚Äôexception *IndexOutOfBounds* ‚Üí renvoie `null`.
* **`?:`** : fournit une valeur de repli si `null`.

```kotlin
fun safeAt(xs: List<Int>, index: Int): Int =
    xs.getOrNull(index) ?: -1

fun main() {
    println("=== DEMO Null-safety ===")
    println(greet("  Ada "))
    println(parseCount(" 12 "))
    println(safeAt(listOf(10, 20), 1))  // 20
    println(safeAt(listOf(10, 20), 9))  // -1
}
```

---

### √âtape 5 ‚Äî Safe cast + composition (as? + toIntOrNull + Elvis)

**But.** Encha√Æner plusieurs protections : cast s√ªr, conversion s√ªre, valeur par d√©faut.

**Notions cl√©s.**

* **`as?`** : cast **sans crash**, renvoie `null` si le type ne correspond pas.
* **Composition** : combiner plusieurs √©tapes null-safe dans **une** fonction.

```kotlin
fun parseAnyToNonNegativeInt(x: Any?): Int =
    (x as? String)?.toIntOrNull()?.coerceAtLeast(0) ?: 0

fun pipeline(name: String?, countText: String?): String =
    "${greet(name)}#${parseCount(countText)}"

fun main() {
    println("=== DEMO Null-safety ===")
    println(greet("  Ada "))
    println(parseCount(" 12 "))
    println(safeAt(listOf(10, 20), 1))
    println(parseAnyToNonNegativeInt("42"))   // 42
    println(parseAnyToNonNegativeInt("x"))    // 0
    println(parseAnyToNonNegativeInt(null))   // 0
    println(pipeline(" Ada ", " 12 "))        // "Bonjour, Ada !#12"
}
```

---

### √âtape 6 ‚Äî Alternatives √† `!!` (lengthOrZero, requireNotNull)

**But.** Montrer **quoi utiliser** au lieu de `!!` pour rester s√ªr et explicite.

**Notions cl√©s.**

* **Pattern de repli** : `?.` + `?:` pour **√©viter les NPE**.
* **Validation d‚Äôentr√©e** : `requireNotNull` pour **√©chouer t√¥t** avec message clair.

```kotlin
// ‚ùå A ne pas faire :
// val len = s!!.length

// ‚úÖ Alternatives s√ªres :
fun lengthOrZero(s: String?): Int = s?.length ?: 0

fun nonNullOrFail(s: String?): String =
    requireNotNull(s) { "Valeur requise non fournie" }

fun main() {
    println("=== DEMO Null-safety ===")
    println(lengthOrZero(null))     // 0
    println(lengthOrZero("Kotlin")) // 6

    // Exemple positif (√©vite un crash intentionnel) :
    println(nonNullOrFail("OK"))    // "OK"
}
```

> **Assemblage final** : ton `main()` doit afficher **toutes** les d√©mos (tu peux regrouper les `println`). Copie la sortie dans `README.md`.

---

## ü©π Erreurs fr√©quentes & correctifs

* ‚ùå Utiliser `!!` par r√©flexe ‚Üí ‚úÖ `?.`, `?:`, `if (x != null)`, `requireNotNull`.
* ‚ùå Oublier `toIntOrNull()` ‚Üí ‚úÖ conversions s√ªres + repli (`?: 0`).
* ‚ùå Empiler des `let {}` inutiles ‚Üí ‚úÖ commencer par `?.` + `?:` simples.
* ‚ùå Tout d√©clarer en nullable ‚Üí ‚úÖ **non-null** par d√©faut, `?` seulement si n√©cessaire.

---

## üì¶ Livrables attendus

* `NullSafetyDemo.kt` avec :

  * `greet(input: String?): String`
  * `parseCount(input: String?): Int`
  * `safeAt(xs: List<Int>, index: Int): Int`
  * `parseAnyToNonNegativeInt(x: Any?): Int`
  * `lengthOrZero(s: String?): Int` et `nonNullOrFail(s: String?): String`
  * un **`main()` unique** qui **affiche** des d√©monstrations pour **chaque** fonction.
* `README.md` (‚â§ 10 lignes) : **comment lancer** + **copie de la sortie attendue**.

---

## ‚úÖ DoD ‚Äî Definition of Done

* [ ] Le projet **compile** et s‚Äôex√©cute via un **unique `main()`**.
* [ ] Chaque fonction demand√©e est **appel√©e** depuis `main()` avec **sorties visibles**.
* [ ] **Z√©ro `!!`** injustifi√© ; idiomes (`?.`, `?:`, `let`, `takeIf`, `toXxxOrNull`) utilis√©s.
* [ ] `README.md` pr√©sent avec commande de lancement et **sorties attendues**.

---

## ‚ö° Cheatsheet

```kotlin
// Safe call + Elvis
val nChars = text?.length ?: 0

// Scope si non nul
maybe?.let { use(it) }

// Filtrage conditionnel
val cleaned = input?.trim()?.takeIf { it.isNotEmpty() } ?: "(vide)"

// Conversions s√ªres
val n = "12".toIntOrNull() ?: 0
val nonNeg = n.coerceAtLeast(0)

// Safe cast
val m = (any as? String)?.length ?: 0

// Liste : acc√®s s√ªr
val x = xs.getOrNull(i) ?: default
```
