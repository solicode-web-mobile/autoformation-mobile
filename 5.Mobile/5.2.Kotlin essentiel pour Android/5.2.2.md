---
title: 2. Null-safety
layout: home
nav_order: 2
parent: 5.2. Kotlin essentiel pour Android
permalink: /kotlin-essentiel-android/null-safety/
code: 5.2.2
competence: C5
autoformation: "C5.2"
ua: "5.2.U1"
duree_h: 1.5
objectif: "Eviter les NPE avec T?, safe calls, Elvis, let et safe cast dans les flux Android."
notions_nouvelles: ["T?", "?.", "?: (Elvis)", "let", "as?", "toIntOrNull", "requireNotNull", "Platform type"]
fil_rouge: "App Mobile Compose + API Blog Laravel"
livrable_chapitre: "Utilitaires null-safe (parseCount, greet), Intent/Bundle sans !!, tests rapides"
alimentation_prototype: "Securise les entrees UI/Intent et les parsings"
alimentation_miniprojet: "Contrats DTO propres et mapping vers le domaine"
---


# 📘 5.2.2 — Null-safety 

## 📒 Glossaire minute
- **Type nullable** `T?` : peut être `null`.  
- **Safe call** `obj?.m()` : n’appelle que si non nul (sinon `null`).  
- **Elvis** `a ?: b` : si `a` est `null`, renvoie `b`.  
- **Scope** `obj?.let { ... }` : exécute le bloc **seulement** si non nul.  
- **Non-null assertion** `obj!!` : *jure* que non nul → `NPE` si faux (⚠️).  
- **Safe cast** `x as? T` : renvoie `null` si le cast échoue.  
- **Platform type** `String!` : issu de Java (peut être nul → prudence).

---

## ✅ Objectif
Écrire du code **sûr** et **lisible** sans `NullPointerException` : choisir correctement `T` vs `T?`, chaîner `?.` + `?:`, utiliser `let`, **éviter `!!`**, et traiter proprement les flux Android (Intent/Bundle, DTO réseau).

---

## 1) Choisir `T` ou `T?`
- Par défaut : **non nullable** (`val name: String = "…"`).  
- Nullable **seulement si** la valeur peut vraiment manquer (`val nickname: String?`).

```kotlin
data class User(
  val id: Long,              // requis
  val email: String,         // requis
  val phone: String? = null  // optionnel
)
````

---

## 2) Safe call `?.` + Elvis `?:` (duo gagnant)

```kotlin
val name: String? = intent.getStringExtra("name")

// Longueur ou 0 si null
val len = name?.length ?: 0

// Message si nom non vide, sinon chaîne vide
val greeting = name?.trim()
  ?.takeIf { it.isNotEmpty() }
  ?.let { "Bonjour, $it !" }
  ?: ""
```

> Astuce : `takeIf` garde la valeur si la condition est vraie (sinon `null`).

---

## 3) `let` pour scoper un non-null

```kotlin
val user: User? = repo.cachedUser()
user?.let { u ->
  // u est non nul ici
  showUserCard(u)
} // sinon, ne fait rien
```

**Pattern early-return (très lisible)**

```kotlin
val token: String = prefs.getString("token", null)
  ?.trim()
  ?.takeIf { it.isNotEmpty() }
  ?: return // ou return@launch dans une coroutine
```

---

## 4) Éviter `!!` (et quoi faire à la place)

**À éviter**

```kotlin
val ctx = context!!          // ❌ crash si null
val id  = bundle!!.getLong("id")
```

**Alternatives sûres**

```kotlin
val ctx = requireNotNull(context) { "Context requis" }  // throws avec message clair
val id  = bundle?.getLong("id") ?: return               // early-return

// Valider avant usage
val s: String? = maybeString()
if (s != null) {
  use(s) // s est promu non nul ici
}
```

> **Règle** : `!!` uniquement si **logiquement impossible** d’être null **ET** déjà vérifié (ex. après `requireNotNull`).

---

## 5) Safe cast `as?` & collections

```kotlin
val any: Any = intent.getSerializableExtra("payload") ?: return
val user = any as? User ?: return  // null si type incompatible

val emails: List<String?> = listOf("a@b", null, "c@d")
val nonNullEmails: List<String> = emails.filterNotNull()

val ints = listOf("1", "x", "2").mapNotNull { it.toIntOrNull() } // [1, 2]
```

---

## 6) Android courants (Intent/Bundle, Compose)

### Intent / Bundle

```kotlin
val id = intent.getStringExtra("id")?.toLongOrNull() ?: 0L
val isDebug = intent.extras?.getBoolean("debug") ?: false
```

### Compose (afficher si non nul)

```kotlin
val greeting: String? = uiState.greeting
greeting?.let { Text(it) }     // ne rend le composable que si non nul
```

### Lecture sûre d’un champ texte

```kotlin
fun parseCount(input: String?): Int =
  input?.trim()?.toIntOrNull()?.takeIf { it >= 0 } ?: 0
```

---

## 7) API/DTO → Domaine : décider des nulls

```kotlin
data class TodoDto(val id: Long?, val title: String?, val done: Boolean?)
data class Todo(val id: Long, val title: String, val done: Boolean)

fun TodoDto.toDomain(): Todo = Todo(
  id = id ?: 0L,
  title = title?.takeIf { it.isNotBlank() } ?: "(sans titre)",
  done = done ?: false
)
```

> Décidez **où** tolérer `null` : souvent **à la frontière** (DTO), puis **nettoyer** en domaine.

---

## 8) Outils utilitaires utiles

```kotlin
// Check & require
val notNull = checkNotNull(possiblyNull) { "invariant brisé" }
val required = requireNotNull(maybeNull) { "argument manquant" }

// Extensions idiomatiques
fun String?.orEmptyTrim() = this?.trim().orEmpty()
fun <T> T?.ifNull(block: () -> Unit): T? = this ?: run { block(); null }
```

---

## 🧪 Exemples rapides (tests)

```kotlin
@Test fun greeting_only_when_name_present() {
  fun greet(name: String?) = name?.trim()?.takeIf { it.isNotEmpty() }?.let { "Bonjour, $it !" }
  assertNull(greet(null))
  assertNull(greet("  "))
  assertEquals("Bonjour, Ada !", greet("Ada"))
}

@Test fun parseCount_never_negative() {
  assertEquals(0, parseCount(null))
  assertEquals(0, parseCount("-5"))
  assertEquals(12, parseCount(" 12 "))
}
```

---

## 🩹 Erreurs fréquentes & correctifs

* ❌ Tout déclarer en `T?` → 🌱 **non-nullable par défaut**, `?` seulement si nécessaire.
* ❌ Enchaîner `!!` → utilisez `?: return`, `requireNotNull`, `if (x != null)`.
* ❌ Oublier `toIntOrNull()` / `toLongOrNull()` → évitez les `NumberFormatException`.
* ❌ Supposer non-null un **platform type** Java → **vérifier** et annoter côté Java si possible.
* ❌ Empiler `let {}` sans besoin → préférez `?.` + `?:` simples.

---

## 📦 Livrables attendus

* Petites fonctions utilitaires null-safe (`parseCount`, `greet`, conversions).
* Exemple Intent/Bundle **sans `!!`**.
* Tests unitaires couvrant **cas null / vide / valide**.

---

## ✅ DoD — Definition of Done

* [ ] Aucun `!!` injustifié (au pire 0, sinon 1 avec justification).
* [ ] `?.` + `?:` maîtrisés, `let` utilisé **à bon escient**.
* [ ] Entrées utilisateur/Intent/DTO traitées avec `toXxxOrNull()` + valeurs par défaut.
* [ ] Tests couvrant les chemins `null`.

---

## ⚡ Cheatsheet

```kotlin
// Safe call + Elvis
val textLen = text?.length ?: 0

// Scope only if non-null
user?.let { show(it) }

// Early return si null
val token = prefs.getString("token", null) ?: return

// Safe cast + défaut
val u = any as? User ?: defaultUser()

// Alternatives à !!
val ctx = requireNotNull(context) { "Context requis" }
val id  = bundle?.getLong("id") ?: return
```
