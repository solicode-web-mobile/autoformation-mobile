---
title: 3. Charger la liste
layout: home
nav_order: 3
parent: 5.4. Consommer une API
permalink: /android-api/get-todos/
code: 5.4.3
competence: C5
autoformation: "C5.4"
ua: "5.4.U2"
duree_h: 1.5
objectif: "Charger GET /todos, exposer un UiState et afficher loading/empty/error/success en Compose."
notions_nouvelles: ["UiState", "Repository", "LazyColumn", "Retry", "Preview"]
fil_rouge: "App Mobile Compose + API Blog Laravel"
livrable_chapitre: "TodosViewModel + Ã©cran Compose avec Retry + Previews (succÃ¨s/vide/erreur)"
alimentation_prototype: "Ã‰cran Liste opÃ©rationnel"
alimentation_miniprojet: "Base navigation + affichage listÃ©"
---


# ðŸ“˜ Chapitre 5.4.3 â€” Charger la liste depuis `/todos`

## ðŸ“’ Glossaire minute
- **UiState** : Ã©tat dâ€™Ã©cran (`Loading`, `Success(data)`, `Error`).
- **Repository** : couche qui appelle lâ€™API et renvoie `Result<T>`.
- **`LazyColumn`** : liste performante pour afficher des Ã©lÃ©ments.
- **Retry** : action utilisateur pour relancer la requÃªte aprÃ¨s Ã©chec.

---

## ðŸŽ¯ Objectif
Charger une **liste** depuis lâ€™endpoint **`GET /todos`**, exposer un **UiState** clair dans le **ViewModel**, et **afficher** les Ã©tats *loading / empty / error / success* en **Compose** avec un **bouton Retry**.

---

## 1) PrÃ©-requis
> Vous disposez dÃ©jÃ  (chap. 5.4.1 & 5.4.2) de :
- `ApiService.getTodos(...)` (fonctions `suspend`)
- `TodoRepository.list(...)` qui retourne `Result<List<Todo>>`
- Un `UiState` (sealed interface) :

```kotlin
sealed interface UiState<out T> {
  object Loading : UiState<Nothing>
  data class Success<T>(val data: T) : UiState<T>
  data class Error(val message: String, val retry: () -> Unit) : UiState<Nothing>
}
````

---

## 2) ViewModel â€” charger la liste

> Le ViewModel dÃ©clenche `load()` et met Ã  jour lâ€™`UiState`.

```kotlin
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.setValue
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import kotlinx.coroutines.launch

class TodosViewModel(
  private val repo: TodoRepository = TodoRepository(NetworkModule.api)
) : ViewModel() {

  var state by mutableStateOf<UiState<List<Todo>>>(UiState.Loading)
    private set

  init { load() } // premiÃ¨re charge

  fun load(userId: Int? = null, completed: Boolean? = null) {
    state = UiState.Loading
    viewModelScope.launch {
      val result = repo.list(userId, completed)
      state = result.fold(
        onSuccess = { list ->
          UiState.Success(list)
        },
        onFailure = { err ->
          UiState.Error(err.message ?: "Erreur rÃ©seau", retry = { load(userId, completed) })
        }
      )
    }
  }
}
```

---

## 3) UI â€” afficher les Ã©tats (loading / empty / error / success)

```kotlin
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp

@Composable
fun TodosScreen(
  state: UiState<List<Todo>>,
  onRetry: () -> Unit,
  modifier: Modifier = Modifier
) {
  when (state) {
    is UiState.Loading -> LoadingView(modifier)
    is UiState.Error -> ErrorView(message = state.message, onRetry = onRetry, modifier = modifier)
    is UiState.Success -> {
      val items = state.data
      if (items.isEmpty()) EmptyView(onRetry = onRetry, modifier = modifier)
      else TodosList(items, modifier)
    }
  }
}

@Composable
private fun LoadingView(modifier: Modifier = Modifier) {
  Box(modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
    CircularProgressIndicator()
  }
}

@Composable
private fun ErrorView(message: String, onRetry: () -> Unit, modifier: Modifier = Modifier) {
  Column(
    modifier.fillMaxSize().padding(24.dp),
    verticalArrangement = Arrangement.spacedBy(12.dp),
    horizontalAlignment = Alignment.CenterHorizontally
  ) {
    Text("Une erreur est survenue", style = MaterialTheme.typography.titleMedium)
    Text(message, style = MaterialTheme.typography.bodyMedium)
    Button(onClick = onRetry) { Text("RÃ©essayer") }
  }
}

@Composable
private fun EmptyView(onRetry: () -> Unit, modifier: Modifier = Modifier) {
  Column(
    modifier.fillMaxSize().padding(24.dp),
    verticalArrangement = Arrangement.spacedBy(12.dp),
    horizontalAlignment = Alignment.CenterHorizontally
  ) {
    Text("Aucune donnÃ©e", style = MaterialTheme.typography.titleMedium)
    Text("Ajoutez un Ã©lÃ©ment ou rÃ©essayez plus tard.")
    OutlinedButton(onClick = onRetry) { Text("Recharger") }
  }
}

@Composable
private fun TodosList(items: List<Todo>, modifier: Modifier = Modifier) {
  LazyColumn(
    modifier = modifier.fillMaxSize().padding(12.dp),
    verticalArrangement = Arrangement.spacedBy(8.dp)
  ) {
    items(items, key = { it.id ?: it.hashCode() }) { todo ->
      TodoRow(todo)
    }
  }
}

@Composable
private fun TodoRow(todo: Todo) {
  Card {
    Row(
      Modifier.padding(12.dp),
      verticalAlignment = Alignment.CenterVertically
    ) {
      Checkbox(checked = todo.completed, onCheckedChange = null) // lecture seule ici
      Spacer(Modifier.width(12.dp))
      Column(Modifier.weight(1f)) {
        Text(
          text = todo.title,
          style = MaterialTheme.typography.titleMedium,
          maxLines = 1,
          overflow = TextOverflow.Ellipsis
        )
        Text(
          text = "User #${todo.userId}  â€¢  id=${todo.id ?: "?"}",
          style = MaterialTheme.typography.bodySmall
        )
      }
    }
  }
}
```

---

## 4) IntÃ©gration ViewModel â†” UI

> On connecte le ViewModel Ã  lâ€™Ã©cran et on passe `onRetry`.

```kotlin
import androidx.compose.runtime.getValue
import androidx.compose.runtime.Composable
import androidx.lifecycle.viewmodel.compose.viewModel

@Composable
fun TodosRoute(vm: TodosViewModel = viewModel()) {
  val current = vm.state
  TodosScreen(
    state = current,
    onRetry = { vm.load() }
  )
}
```

> Lâ€™appel initial est dÃ©jÃ  fait dans `init { load() }`.
> Si vous prÃ©fÃ©rez contrÃ´ler explicitement depuis lâ€™UI :
>
> ```kotlin
> LaunchedEffect(Unit) { vm.load() }
> ```

---

## 5) AperÃ§us (`@Preview`) avec des donnÃ©es factices

> Les `Preview` nâ€™appellent **pas** le rÃ©seau : on fixe un `UiState` manuel.

```kotlin
import android.content.res.Configuration
import androidx.compose.ui.tooling.preview.Preview

private val sample = listOf(
  Todo(id = 1, userId = 10, title = "Lire la doc Retrofit", completed = false),
  Todo(id = 2, userId = 10, title = "Brancher lâ€™API /todos", completed = true),
  Todo(id = 3, userId = 11, title = "PrÃ©parer lâ€™Ã©cran dâ€™Ã©dition", completed = false),
)

@Preview(showBackground = true, widthDp = 360)
@Composable
fun TodosPreview_Success() {
  MaterialTheme {
    TodosScreen(state = UiState.Success(sample), onRetry = {})
  }
}

@Preview(showBackground = true, widthDp = 360, uiMode = Configuration.UI_MODE_NIGHT_YES)
@Composable
fun TodosPreview_Empty_Dark() {
  MaterialTheme {
    TodosScreen(state = UiState.Success(emptyList()), onRetry = {})
  }
}

@Preview(showBackground = true, widthDp = 360)
@Composable
fun TodosPreview_Error() {
  MaterialTheme {
    TodosScreen(state = UiState.Error("Timeout / Offline", onRetry = {}), onRetry = {})
  }
}
```

---

## âœ… Check-list

* [ ] **Loading** visible pendant la requÃªte.
* [ ] **Empty state** si la liste est vide.
* [ ] **Error state** avec **message** clair + **Retry**.
* [ ] **Success** affiche la liste (clÃ© stable pour chaque item).
* [ ] Aucune logique rÃ©seau dans les `Preview`.

---

## ðŸ©¹ DÃ©pannage

* **Liste qui ne sâ€™affiche pas** â†’ vÃ©rifier que `UiState.Success(data)` contient des Ã©lÃ©ments; inspecter le log rÃ©seau (debug).
* **Boucle infinie de load** â†’ ne pas appeler `load()` dans une `@Composable` sans garde (utiliser `init{}` ou `LaunchedEffect(Unit)`).
* **Crash clÃ©s dupliquÃ©es** â†’ fournir une `key` stable (`id`) dans `LazyColumn.items`.
* **UI figÃ©e** â†’ Ã©viter les I/O bloquants dans le thread principal (toujours `suspend` + `viewModelScope.launch`).

---

## ðŸ“¦ Livrable attendu (partiel, GET)

* Un Ã©cran **Compose** qui charge `/todos` et gÃ¨re **loading/empty/error/success**.
* Un **bouton Retry** opÃ©rationnel.
* **AperÃ§us** (succÃ¨s/empty/error) avec donnÃ©es factices.

