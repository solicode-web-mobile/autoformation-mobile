---
title: 5.4. Consommer une API
permalink: /android-api/
layout: home
nav_order: 4
parent: 5. Mobile
has_children: true
---

# üéì Autoformation C5.4 ‚Äî Consommer une API publique (HTTP/JSON + Retrofit)

Dans ce module, vous allez brancher votre app **Compose** sur une **API publique** avec **Retrofit + Coroutines**, afficher les **√©tats UI** (*loading / empty / error*), et rendre l‚Äôexp√©rience robuste (timeouts, d√©connexions, **retry**). Vous pratiquerez aussi les √©critures (**POST/PATCH/DELETE**) avec **mise √† jour optimiste** et rollback en cas d‚Äô√©chec.

## Pourquoi apprendre Retrofit + Coroutines ?
- **Donn√©es r√©elles** : votre UI n‚Äôest plus fig√©e ‚Äî elle vit au rythme du r√©seau.  
- **Robustesse** : gestion **claire** des erreurs, feedback utilisateur (snackbar/toast).  
- **Lisibilit√©** : mapping JSON **typ√©** (Moshi/Gson), `suspend` pour un code fluide.  
- **S√©paration** : API client, **Repository**, et **UiState** bien d√©coup√©s ‚Üí testable.

## Objectifs p√©dagogiques
√Ä la fin du module, vous saurez :
1. Configurer **Retrofit + OkHttp (logging)**, **Moshi/Gson**, `baseUrl` via **`BuildConfig`**.  
2. Charger des listes avec **GET** et afficher **loading / empty / error** + **Retry**.  
3. Impl√©menter **POST/PATCH/DELETE** avec **mise √† jour optimiste** + **rollback**.  
4. Traiter les erreurs r√©seau (timeouts, offline) et exposer un **UiState** clair (sealed).  

## √Ä qui s‚Äôadresse ce module ?
Aux apprenants ayant d√©j√† des bases **Compose/MVVM** (C5.3) et souhaitant **connecter** leur app √† des **donn√©es distantes** sans complexifier l‚Äôarchitecture.

## üîß Pr√©-requis
- Avoir termin√© **C5.1‚ÄìC5.3** (environnement + Compose + MVVM l√©ger).  
- Connaissances Kotlin de base (fonctions/collections, `data class`, null-safety).  
- Connexion Internet ; un √©mulateur ou device Android op√©rationnel.

---

## üì¶ Livrables attendus
- **APK** + **courte vid√©o** (‚â§ 60s) d√©montrant *loading / empty / error / retry*.  
- Petite **collection Postman/Insomnia** (ou `curl`) des endpoints utilis√©s.  
- **README** (setup API, `BuildConfig`, captures) et notes d‚Äôerreurs g√©r√©es.

## ‚úÖ Definition of Done (autoformation)
- [ ] **GET** liste OK avec **UiState** : *Loading*, *Success(data vide / non vide)*, *Error* + **Retry**.  
- [ ] **POST/PATCH/DELETE** : mise √† jour **optimiste** + **rollback** si √©chec.  
- [ ] **Erreurs r√©seau** : offline/timeout ‚Üí messages clairs + action utilisateur.  
- [ ] `baseUrl` en **`BuildConfig`**, **OkHttp logging** actif en *debug* seulement.  
- [ ] Code structur√© : **API service** + **Repository** + **ViewModel (UiState)**.

---

## üìò Unit√©s d‚Äôapprentissage & chapitres

### UA 5.4.U1 ‚Äì HTTP/JSON & outillage r√©seau
- **Chapitre 5.4.1** : Rappels HTTP (GET/POST/PATCH/DELETE), codes, sch√©ma JSON de l‚ÄôAPI choisie  
- **Chapitre 5.4.2** : Retrofit + OkHttp (logging) + Moshi/Gson, `suspend` + Coroutines, `baseUrl` via `BuildConfig`  

### UA 5.4.U2 ‚Äì Lecture (GET) avec √©tats UI
- **Chapitre 5.4.3** : Charger la liste depuis `/todos` (ou √©quivalent)  
- **Chapitre 5.4.4** : Afficher *loading / empty / error* + bouton **Retry**  

### UA 5.4.U3 ‚Äì √âcritures simples & robustesse
- **Chapitre 5.4.5** : **POST** (ajouter), **PATCH** (compl√©ter), **DELETE** (supprimer) ‚Äî *mise √† jour optimiste* + rollback en cas d‚Äô√©chec  
- **Chapitre 5.4.6** : Gestion d‚Äôerreurs r√©seau (d√©connexions, d√©passements de d√©lai), toasts/snackbars, messages clairs  

---

## üß≠ Architecture minimale conseill√©e
- **ApiService (Retrofit)** : endpoints `suspend`.  
- **Repository** : appelle l‚ÄôAPI, **mappe** vers mod√®les UI, renvoie `Result<T>`/`Either`.  
- **ViewModel** : expose un **`UiState` (sealed class / data class)** et des **intents**.  
- **UI Compose** : rend *loading / empty / error / success* + boutons **Retry**/**Undo**.

```kotlin
sealed interface UiState<out T> {
  object Loading : UiState<Nothing>
  data class Success<T>(val data: T) : UiState<T>
  data class Error(val message: String, val retry: () -> Unit) : UiState<Nothing>
}
````

---

## üí° Conseils

* **Timeouts** raisonnables (ex. 10‚Äì15 s) et messages utilisateurs **concrets**.
* **Log r√©seau** en *debug* uniquement (`HttpLoggingInterceptor`).
* Toujours pr√©voir un **chemin offline** : placeholder, *empty state*, **Retry**.
* Tester vos flux avec **erreurs simul√©es** (mode avion, couper r√©seau, fausses URLs).

> Prochaine √©tape : **5.4.1 ‚Äî Rappels HTTP & sch√©ma JSON** puis **5.4.2 ‚Äî Retrofit + OkHttp + Moshi/Gson**.