---
title: 2. Retrofit & Coroutines
layout: home
nav_order: 2
parent: 5.4. Consommer une API
permalink: /android-api/retrofit/
code: 5.4.2
competence: C5
autoformation: "C5.4"
ua: "5.4.U1"
duree_h: 1.5
objectif: "Configurer Retrofit+OkHttp avec converter Moshi/Gson, BASE_URL via BuildConfig et fonctions suspend."
notions_nouvelles: ["Retrofit", "OkHttp", "Interceptor", "Converter (Moshi/Gson)", "BuildConfig.BASE_URL", "suspend", "Response<T>", "Timeouts"]
fil_rouge: "App Mobile Compose + API Blog Laravel"
livrable_chapitre: "NetworkModule (OkHttp+Retrofit), ApiService, TodoRepository avec safeApiCall"
alimentation_prototype: "Appels /todos fonctionnels avec logs debug"
alimentation_miniprojet: "Couche r√©seau pr√™te pour l‚Äôapp"
---


# üìò Chapitre 5.4.2 - Retrofit, OkHttp & Coroutines

## üìí Glossaire minute
- **Retrofit** : client HTTP typ√© pour interfaces Kotlin (`@GET`, `@POST`‚Ä¶).
- **OkHttp** : pile r√©seau bas niveau (timeouts, interceptors, cache).
- **Interceptor** : filtre qui lit/modifie requ√™tes & r√©ponses.
- **Converter** : adapte le JSON ‚Üî objets (`Moshi` ou `Gson`).
- **`suspend` / Coroutines** : I/O non bloquant, facile √† tester.
- **`BuildConfig`** : constantes de build (`BASE_URL`, `DEBUG`).

---

## üéØ Objectif p√©dagogique
Configurer **Retrofit + OkHttp** (logging *debug only*), brancher **Moshi ou Gson**, exposer des fonctions **`suspend`** et **injecter `BASE_URL` via `BuildConfig`**.

---

## 1) D√©pendances Gradle (module `app`)
> Choisissez **Moshi** *ou* **Gson** (une seule famille de converter).

```kts
dependencies {
  // Retrofit + OkHttp
  implementation("com.squareup.retrofit2:retrofit:<latest>")
  implementation("com.squareup.okhttp3:okhttp:<latest>")
  implementation("com.squareup.okhttp3:logging-interceptor:<latest>")

  // Converter ‚Äî option A: Moshi
  implementation("com.squareup.moshi:moshi-kotlin:<latest>")
  implementation("com.squareup.retrofit2:converter-moshi:<latest>")

  // Converter ‚Äî option B: Gson (si vous pr√©f√©rez)
  // implementation("com.google.code.gson:gson:<latest>")
  // implementation("com.squareup.retrofit2:converter-gson:<latest>")

  // Coroutines
  implementation("org.jetbrains.kotlinx:kotlinx-coroutines-android:<latest>")
}
````

---

## 2) `BuildConfig.BASE_URL` (en `build.gradle.kts` du module `app`)

> URL **avec** slash final (ex. `https://api.exemple.com/`).

```kts
android {
  buildTypes {
    debug {
      buildConfigField("String", "BASE_URL", "\"https://staging.exemple.com/\"")
    }
    release {
      isMinifyEnabled = true
      buildConfigField("String", "BASE_URL", "\"https://api.exemple.com/\"")
      proguardFiles(
        getDefaultProguardFile("proguard-android-optimize.txt"),
        "proguard-rules.pro"
      )
    }
  }
}
```

Utilisation c√¥t√© Kotlin : `BuildConfig.BASE_URL` ‚Ä¢ `BuildConfig.DEBUG`

---

## 3) Mod√®les / DTO

> Exemple simple (voir 5.4.1 pour le sch√©ma).

```kotlin
data class Todo(
  val id: Int? = null,
  val userId: Int,
  val title: String,
  val completed: Boolean = false
)

// DTO cr√©ation/patch (bonne pratique)
data class TodoCreate(val userId: Int, val title: String, val completed: Boolean = false)
typealias TodoPatch = Map<String, @JvmSuppressWildcards Any?>
```

---

## 4) Interface Retrofit (fonctions `suspend`)

```kotlin
import retrofit2.http.*
import retrofit2.Response

interface ApiService {
  @GET("todos")
  suspend fun getTodos(
    @Query("userId") userId: Int? = null,
    @Query("completed") completed: Boolean? = null
  ): Response<List<Todo>>

  @GET("todos/{id}")
  suspend fun getTodo(@Path("id") id: Int): Response<Todo>

  @POST("todos")
  suspend fun createTodo(@Body body: TodoCreate): Response<Todo>

  @PATCH("todos/{id}")
  suspend fun patchTodo(@Path("id") id: Int, @Body patch: TodoPatch): Response<Todo>

  @DELETE("todos/{id}")
  suspend fun deleteTodo(@Path("id") id: Int): Response<Unit>
}
```

---

## 5) OkHttpClient (timeouts + logging **debug only** + headers)

```kotlin
import okhttp3.OkHttpClient
import okhttp3.logging.HttpLoggingInterceptor
import java.util.concurrent.TimeUnit

private fun provideOkHttp(): OkHttpClient {
  val logging = HttpLoggingInterceptor().apply {
    level = if (BuildConfig.DEBUG) HttpLoggingInterceptor.Level.BODY
            else HttpLoggingInterceptor.Level.NONE
  }

  return OkHttpClient.Builder()
    .connectTimeout(15, TimeUnit.SECONDS)
    .readTimeout(15, TimeUnit.SECONDS)
    .writeTimeout(15, TimeUnit.SECONDS)
    .addInterceptor { chain ->
      val req = chain.request().newBuilder()
        .addHeader("Accept", "application/json")
        // .addHeader("Authorization", "Bearer ...") // si n√©cessaire
        .build()
      chain.proceed(req)
    }
    .addInterceptor(logging)
    .build()
}
```

---

## 6) Retrofit + Converter (Moshi **ou** Gson)

```kotlin
import retrofit2.Retrofit
import retrofit2.converter.moshi.MoshiConverterFactory
// import retrofit2.converter.gson.GsonConverterFactory

private fun provideRetrofit(client: OkHttpClient): Retrofit {
  return Retrofit.Builder()
    .baseUrl(BuildConfig.BASE_URL) // doit se terminer par "/"
    .client(client)
    // Choix A ‚Äî Moshi :
    .addConverterFactory(MoshiConverterFactory.create())
    // Choix B ‚Äî Gson :
    // .addConverterFactory(GsonConverterFactory.create())
    .build()
}
```

---

## 7) Point d‚Äôacc√®s unique (sans DI) ‚Äî **NetworkModule**

```kotlin
object NetworkModule {
  private val okHttp by lazy { provideOkHttp() }
  private val retrofit by lazy { provideRetrofit(okHttp) }
  val api: ApiService by lazy { retrofit.create(ApiService::class.java) }
}
```

> Avec **Hilt**, vous transformeriez ceci en `@Module @InstallIn(SingletonComponent::class)` avec des `@Provides`.

---

## 8) Appeler l‚ÄôAPI depuis un **Repository** (mapping `Result<T>`)

```kotlin
import retrofit2.Response
import java.io.IOException

class TodoRepository(private val api: ApiService) {

  private suspend fun <T> safeApiCall(block: suspend () -> Response<T>): Result<T> {
    return try {
      val res = block()
      if (res.isSuccessful) {
        val body = res.body()
        if (body != null) Result.success(body)
        else if (res.code() == 204) Result.success(Unit as T) // delete
        else Result.failure(IllegalStateException("R√©ponse vide"))
      } else {
        Result.failure(IllegalStateException("HTTP ${res.code()} ‚Ä¢ ${res.errorBody()?.string() ?: "Erreur"}"))
      }
    } catch (e: IOException) { // timeouts/offline
      Result.failure(e)
    } catch (e: Exception) {
      Result.failure(e)
    }
  }

  suspend fun list(userId: Int? = null, completed: Boolean? = null) =
    safeApiCall { api.getTodos(userId, completed) }

  suspend fun create(dto: TodoCreate) =
    safeApiCall { api.createTodo(dto) }

  suspend fun patch(id: Int, patch: TodoPatch) =
    safeApiCall { api.patchTodo(id, patch) }

  suspend fun delete(id: Int) =
    safeApiCall { api.deleteTodo(id) }
}
```

---

## 9) Int√©gration **Coroutines** dans un ViewModel

```kotlin
import androidx.compose.runtime.*
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import kotlinx.coroutines.launch

sealed interface UiState<out T> {
  object Loading : UiState<Nothing>
  data class Success<T>(val data: T) : UiState<T>
  data class Error(val message: String, val retry: () -> Unit) : UiState<Nothing>
}

class TodoViewModel : ViewModel() {
  private val repo = TodoRepository(NetworkModule.api)
  var state by mutableStateOf<UiState<List<Todo>>>(UiState.Loading)
    private set

  fun load() {
    state = UiState.Loading
    viewModelScope.launch {
      val result = repo.list()
      state = result.fold(
        onSuccess = { UiState.Success(it) },
        onFailure = { UiState.Error(it.message ?: "Erreur r√©seau", ::load) }
      )
    }
  }
}
```

---

## ‚úÖ Check-list

* [ ] `BASE_URL` inject√©e via `BuildConfig` (slash final).
* [ ] **Logging** actif **uniquement** en *debug*.
* [ ] Fonctions Retrofit **`suspend`** et **timeouts** configur√©s.
* [ ] Converter **Moshi** *ou* **Gson** (un seul).
* [ ] Repository retourne `Result<T>` (gestion erreurs claire).

---

## ü©π D√©pannage

* **`IllegalArgumentException: baseUrl must end with '/'`** ‚Üí ajouter le **slash** final.
* **`EOFException / MalformedJsonException`** ‚Üí v√©rifier `Content-Type` et le **converter** choisi.
* **Pas de logs en release** ‚Üí normal (`BuildConfig.DEBUG == false`).
* **`SSLHandshakeException`** ‚Üí tester sur API HTTPS correcte ou activer un proxy de debug (ex. Charles) c√¥t√© **debug uniquement**.

---

