---
title: 4. LazyColumn
permalink: /android-compose-mvvm/todo-lazycolumn-offline/
layout: home
nav_order: 4
parent: 5.3. Android avec Compose
---

# üìò 5.3.4 - `LazyColumn`

## üìí Glossaire minute
- **`LazyColumn`** : liste **performante** qui ne compose que les items visibles.
- **`key`** : identifiant **stable** par item (`items(key = { it.id })`) pour pr√©server l‚Äô√©tat.
- **State hoisting** : l‚Äô√©cran **poss√®de** la liste, les items sont **stateless** (callbacks).
- **`rememberSaveable`** : **persiste** la liste √† la rotation (via `Saver`).

---

## ‚úÖ Objectif
Construire une **TODO locale** (offline) :
- **Ajouter** une t√¢che (input + bouton),
- **Cocher** comme faite / **d√©cocher**,
- **Supprimer** une t√¢che,
- Afficher un **empty state** quand la liste est vide,
- **Persister** l‚Äô√©tat √† la rotation avec `rememberSaveable`.

---

## 1) Mod√®le & `Saver` pour la persistance

```kotlin
// app/src/main/kotlin/.../todo/TodoModels.kt
@Stable
data class Todo(
  val id: Long,
  val title: String,
  val done: Boolean = false
)

// Saver simple (liste de triples id/title/done)
import androidx.compose.runtime.saveable.Saver
import androidx.compose.runtime.saveable.listSaver

val TodoListSaver: Saver<List<Todo>, Any> = listSaver(
  save = { list -> list.map { listOf(it.id, it.title, it.done) } },
  restore = { saved ->
    saved.map { row ->
      val r = row as List<*>
      Todo(id = r[0] as Long, title = r[1] as String, done = r[2] as Boolean)
    }
  }
)
````

> üí° Alternative : `@Parcelize` sur `Todo` et `rememberSaveable` sans `Saver`.

---

## 2) √âcran h√¥te (liste + formulaire)

```kotlin
// app/src/main/kotlin/.../todo/TodoScreen.kt
package com.acme.todo

import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Delete
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.runtime.saveable.rememberSaveable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.res.stringResource
import androidx.compose.ui.text.input.ImeAction
import androidx.compose.ui.unit.dp
import com.acme.hellocounter.R

@Composable
fun TodoScreen(modifier: Modifier = Modifier) {
  var input by rememberSaveable { mutableStateOf("") }
  var todos by rememberSaveable(stateSaver = TodoListSaver) { mutableStateOf(emptyList<Todo>()) }

  fun add() {
    val t = input.trim()
    if (t.isNotEmpty()) {
      val item = Todo(id = System.currentTimeMillis(), title = t)
      todos = listOf(item) + todos       // ajoute en t√™te
      input = ""
    }
  }
  fun toggle(id: Long) { todos = todos.map { if (it.id == id) it.copy(done = !it.done) else it } }
  fun remove(id: Long) { todos = todos.filterNot { it.id == id } }

  Column(
    modifier = modifier
      .fillMaxSize()
      .padding(16.dp),
    verticalArrangement = Arrangement.spacedBy(16.dp)
  ) {
    // Formulaire d'ajout
    Row(
      verticalAlignment = Alignment.CenterVertically,
      horizontalArrangement = Arrangement.spacedBy(8.dp)
    ) {
      OutlinedTextField(
        value = input,
        onValueChange = { input = it },
        modifier = Modifier.weight(1f),
        label = { Text(stringResource(R.string.todo_label)) },
        placeholder = { Text(stringResource(R.string.todo_ph)) },
        singleLine = true,
        keyboardOptions = KeyboardOptions(imeAction = ImeAction.Done),
        keyboardActions = KeyboardActions(onDone = { add() })
      )
      Button(onClick = { add() }, enabled = input.isNotBlank()) {
        Text(stringResource(R.string.todo_add))
      }
    }

    // Stats mini
    val done = todos.count { it.done }
    Text(
      text = stringResource(R.string.todo_stats, done, todos.size),
      style = MaterialTheme.typography.bodyMedium,
      color = MaterialTheme.colorScheme.onSurfaceVariant
    )

    // Liste
    if (todos.isEmpty()) {
      EmptyState()
    } else {
      LazyColumn(
        modifier = Modifier.fillMaxSize(),
        verticalArrangement = Arrangement.spacedBy(8.dp),
        contentPadding = PaddingValues(bottom = 96.dp)
      ) {
        items(
          items = todos,
          key = { it.id }
        ) { todo ->
          TodoItem(
            todo = todo,
            onToggle = { toggle(todo.id) },
            onDelete = { remove(todo.id) }
          )
        }
      }
    }
  }
}
```

---

## 3) Item **stateless** (checkbox + titre + suppression)

```kotlin
@Composable
fun TodoItem(
  todo: Todo,
  onToggle: () -> Unit,
  onDelete: () -> Unit,
  modifier: Modifier = Modifier
) {
  ElevatedCard(modifier = modifier.fillMaxWidth()) {
    Row(
      modifier = Modifier
        .fillMaxWidth()
        .padding(horizontal = 12.dp, vertical = 8.dp),
      verticalAlignment = Alignment.CenterVertically,
      horizontalArrangement = Arrangement.spacedBy(12.dp)
    ) {
      Checkbox(checked = todo.done, onCheckedChange = { onToggle() })
      Text(
        text = todo.title,
        style = MaterialTheme.typography.bodyLarge,
        color = if (todo.done) MaterialTheme.colorScheme.onSurfaceVariant
                else MaterialTheme.colorScheme.onSurface
      )
      Spacer(Modifier.weight(1f))
      IconButton(
        onClick = onDelete
      ) {
        Icon(Icons.Filled.Delete, contentDescription = stringResource(R.string.cd_delete))
      }
    }
  }
}
```

---

## 4) Empty state (quand la liste est vide)

```kotlin
@Composable
fun EmptyState(modifier: Modifier = Modifier) {
  Column(
    modifier = modifier
      .fillMaxWidth()
      .padding(24.dp),
    horizontalAlignment = Alignment.CenterHorizontally,
    verticalArrangement = Arrangement.spacedBy(8.dp)
  ) {
    Text("Aucune t√¢che", style = MaterialTheme.typography.titleMedium)
    Text("Ajoutez une t√¢che ci-dessus pour commencer.", style = MaterialTheme.typography.bodyMedium, color = MaterialTheme.colorScheme.onSurfaceVariant)
  }
}
```

---

## 5) `strings.xml` (exemples)

```xml
<resources>
    <string name="todo_label">Nouvelle t√¢che</string>
    <string name="todo_ph">Ex. √âcrire l‚Äô√©cran Compose</string>
    <string name="todo_add">Ajouter</string>
    <string name="todo_stats">%1$d/%2$d termin√©es</string>
    <string name="cd_delete">Supprimer la t√¢che</string>
</resources>
```

---

## 6) Pr√©views

```kotlin
@Preview(showBackground = true, widthDp = 360)
@Composable
private fun TodoPreview_Empty() {
  MaterialTheme { TodoScreen() }
}

@Preview(showBackground = true, widthDp = 360)
@Composable
private fun TodoPreview_List() {
  MaterialTheme {
    val sample = listOf(
      Todo(1, "Installer Android Studio", done = true),
      Todo(2, "Cr√©er projet Compose"),
      Todo(3, "√âcrire TODO list (LazyColumn)")
    )
    // Trick pour aper√ßus: conteneur qui affiche une liste fournie
    var ignore by remember { mutableStateOf(false) } // no-op juste pour satisfaire l'aper√ßu
    Column(Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(16.dp)) {
      LazyColumn(verticalArrangement = Arrangement.spacedBy(8.dp)) {
        items(sample, key = { it.id }) {
          TodoItem(it, onToggle = { ignore = !ignore }, onDelete = { ignore = !ignore })
        }
      }
    }
  }
}
```

---

## üß™ V√©rifications rapides

* [ ] Ajout par **Enter** (`ImeAction.Done`) et par **bouton**.
* [ ] **Checkbox** bascule l‚Äô√©tat ; le **texte** change de couleur quand `done = true`.
* [ ] **Supprimer** enl√®ve l‚Äôitem ; la **liste** conserve l‚Äôordre.
* [ ] Liste **persist√©e** √† la rotation (`rememberSaveable` + `Saver`).
* [ ] `LazyColumn` utilise des **keys stables** (`id`).

---

## ü©π D√©pannage

* **Items qui ‚Äúsautent‚Äù** apr√®s modification ‚Üí ajouter `key = { it.id }` dans `items`.
* **√âtat perdu √† la rotation** ‚Üí v√©rifier `rememberSaveable(stateSaver = TodoListSaver)`.
* **IME Done n‚Äôajoute pas** ‚Üí `keyboardActions(onDone = { add() })`.
* **Performances** (liste longue) ‚Üí limiter recompositions (items **stateless**, usage de `copy` immuable).

---

## üì¶ Livrables attendus

* √âcran **TodoScreen** compilant, avec **ajout/compl√©tion/suppression**.
* **Empty state** visible quand la liste est vide.
* `strings.xml` mis √† jour.
* Captures **avant/apr√®s** cocher + suppression.

---

## ‚úÖ DoD ‚Äî Definition of Done

* [ ] `LazyColumn` avec **items(key)** + espacement/padding propres.
* [ ] Formulaire d‚Äôajout **ergonomique** (Enter + bouton).
* [ ] T√¢ches **cochables** et **supprimables**.
* [ ] √âtat **persist√©** √† la rotation (ou via ViewModel si vous pr√©f√©rez).

---

## ‚ö° Cheatsheet

```kotlin
// Liste persist√©e
var todos by rememberSaveable(stateSaver = TodoListSaver) { mutableStateOf(emptyList<Todo>()) }

// LazyColumn
LazyColumn(contentPadding = PaddingValues(16.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {
  items(todos, key = { it.id }) { todo -> TodoItem(todo, onToggle = { ... }, onDelete = { ... }) }
}

// Ajout rapide
if (input.isNotBlank()) todos = listOf(Todo(now(), input.trim())) + todos
```
