---
title: 5. D√©ployer un mini-site
permalink: /deploiement/deployer-mini-site/
layout: home
nav_order: 5
parent: 7.4. Apache
---

# üìò Chapitre 7.4.5 ‚Äî D√©ployer un mini-site (statique + PHP)

## üìí Glossaire minute
- **DocumentRoot** : r√©pertoire **public** servi par Apache (ex. `.../public`).
- **Vhost** : bloc de config par **site** (nom, racine, logs, SSL).
- **PHP-FPM** : moteur PHP via FastCGI (pr√©f√©r√© √† `mod_php`).
- **Front controller** : `index.php` capte toutes les URLs ‚Äúpropres‚Äù.
- **OpCache** : cache de bytecode PHP (fort gain de perfs).
- **644/755** : droits fichiers/dossiers recommand√©s (Linux).

---

## üéØ Objectifs
- Cr√©er l‚Äô**arborescence** d‚Äôun mini-site (HTML/CSS + PHP).
- Configurer un **vhost** Apache propre (logs d√©di√©s, s√©curit√© de base).
- Relier **Apache ‚Üî PHP-FPM** et **v√©rifier** avec `curl`.
- Poser les **fondations** pour HTTPS et r√©√©critures (aper√ßu).

## ‚úÖ Pr√©-requis
- Apache **install√©** et **actif** (cf. 7.4.1) ; arborescence & outils (cf. 7.4.2/7.4.3/7.4.4).
- **PHP-FPM** install√© (ex. `php8.2-fpm`) et en marche.
- Acc√®s sudo (Linux) et ports **80/443** libres.

---

## 1) Pr√©parer l‚Äôarborescence du site

```bash
sudo mkdir -p /var/www/mini/public/{assets,uploads}
sudo tee /var/www/mini/public/index.html >/dev/null <<'HTML'
<!doctype html><html lang="fr"><meta charset="utf-8">
<title>Mini-site ‚Äî statique</title>
<link rel="stylesheet" href="/assets/style.css">
<h1>üéâ Hello, Apache (statique) !</h1>
<p>Cette page est servie telle quelle par Apache.</p>
<p>Essayez <a href="/index.php">/index.php</a> pour la version PHP.</p>
HTML

sudo tee /var/www/mini/public/assets/style.css >/dev/null <<'CSS'
body{font:16px/1.4 system-ui,Segoe UI,Roboto,Arial;color:#222;margin:2rem}
h1{font-size:1.8rem}
CSS

sudo tee /var/www/mini/public/index.php >/dev/null <<'PHP'
<?php
header('Content-Type: text/html; charset=utf-8');
echo "<h1>üß© Hello, PHP via FPM !</h1>";
echo "<p>Heure serveur : ".date('Y-m-d H:i:s')."</p>";
PHP
````

**Droits (Linux)**

```bash
sudo chown -R www-data:www-data /var/www/mini
find /var/www/mini -type d -exec sudo chmod 755 {} \;
find /var/www/mini -type f -exec sudo chmod 644 {} \;
# Uploads : √©criture (si n√©cessaire) sans ex√©cution PHP
sudo chmod 775 /var/www/mini/public/uploads
```

> üîê Emp√™chez l‚Äôex√©cution PHP dans `uploads/` (rappel en ¬ß3).

---

## 2) Vhost Apache ‚Äî HTTP (Debian/Ubuntu)

`/etc/apache2/sites-available/mini.local.conf`

```apache
<VirtualHost *:80>
  ServerName mini.local
  DocumentRoot /var/www/mini/public

  <Directory /var/www/mini/public>
    Options -Indexes -MultiViews
    AllowOverride All
    Require all granted
  </Directory>

  # PHP via FPM (adapter la version du socket)
  <FilesMatch "\.php$">
    SetHandler "proxy:unix:/run/php/php8.2-fpm.sock|fcgi://localhost/"
  </FilesMatch>

  # Bloquer l'ex√©cution PHP dans uploads/
  <Directory "/var/www/mini/public/uploads">
    <FilesMatch "\.php$">
      Require all denied
    </FilesMatch>
  </Directory>

  DirectoryIndex index.php index.html

  ErrorLog  ${APACHE_LOG_DIR}/mini_error.log
  CustomLog ${APACHE_LOG_DIR}/mini_access.log combined
</VirtualHost>
```

**Activer & recharger**

```bash
sudo a2enmod proxy proxy_fcgi setenvif rewrite headers
sudo a2ensite mini.local.conf
sudo apachectl -t && sudo systemctl reload apache2
```

---

## 3) Vhost Apache ‚Äî HTTP (RHEL/CentOS/Alma)

`/etc/httpd/conf.d/mini.local.conf`

```apache
<VirtualHost *:80>
  ServerName mini.local
  DocumentRoot /var/www/mini/public

  <Directory /var/www/mini/public>
    Options -Indexes -MultiViews
    AllowOverride All
    Require all granted
  </Directory>

  # PHP via FPM (socket par d√©faut sur RHEL)
  <FilesMatch "\.php$">
    SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost/"
  </FilesMatch>

  <Directory "/var/www/mini/public/uploads">
    <FilesMatch "\.php$">
      Require all denied
    </FilesMatch>
  </Directory>

  DirectoryIndex index.php index.html

  ErrorLog  /var/log/httpd/mini_error.log
  CustomLog /var/log/httpd/mini_access.log combined
</VirtualHost>
```

**V√©rifier & recharger**

```bash
sudo httpd -t && sudo systemctl reload httpd
```

---

## 4) Tests rapides (sans DNS)

```bash
# Tester le vhost en local en for√ßant Host:
curl -I -H "Host: mini.local" http://127.0.0.1/
curl -I -H "Host: mini.local" http://127.0.0.1/index.php
# Vous devez voir 200 OK et "Content-Type: text/html; charset=utf-8" pour index.php
```

> Option : ajoutez `127.0.0.1 mini.local` dans votre **/etc/hosts** (Linux/macOS) ou `C:\Windows\System32\drivers\etc\hosts` (Windows) pour tester via navigateur.

---

## 5) (Option) Front controller & URLs ‚Äúpropres‚Äù

`.htaccess` dans `/var/www/mini/public` :

```apache
RewriteEngine On
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ index.php [QSA,L]
```

> V√©rifiez avec : `curl -I -H "Host: mini.local" http://127.0.0.1/quelque/chose`

---

## 6) (Option) HTTPS en 2 commandes (Debian/Ubuntu)

```bash
sudo apt install -y certbot python3-certbot-apache
sudo certbot --apache -d mini.votre-domaine.tld
# ‚Üí cr√©e le :443, installe la cha√Æne, redirection HTTP‚ÜíHTTPS
```

> Pr√©requis : **DNS** du domaine pointant vers votre serveur et ports 80/443 ouverts.

---

## 7) Journalisation & sant√©

```bash
# Logs
tail -f /var/log/apache2/mini_access.log /var/log/apache2/mini_error.log   # Debian
tail -f /var/log/httpd/mini_access.log /var/log/httpd/mini_error.log       # RHEL

# Sant√© conf & services
apachectl -t           # ou: httpd -t
systemctl status apache2 php8.2-fpm    # Debian
systemctl status httpd php-fpm         # RHEL
```

---

## 8) Variante Windows (XAMPP) ‚Äî rapide

* Copier le site dans `C:\xampp\htdocs\mini\public\` (acc√®s via `http://localhost/mini/`).
* Fichiers : `index.html`, `assets\style.css`, `index.php`.
* Logs : `C:\xampp\apache\logs\` ; PHP d√©j√† int√©gr√© (FPM non requis).
* D√©sactiver l‚Äôindexation dans `httpd.conf` ou via `.htaccess` (`Options -Indexes`).

---

## üß© D√©pannage express

* **`502 Bad Gateway`** : PHP-FPM down ou mauvais **socket** ‚Üí `systemctl status php*-fpm`, corriger `<FilesMatch>`/chemin.
* **`403 Forbidden`** : droits Unix/DACL, ou `Require all denied` dans un `<Directory>`.
* **`404` alors que le fichier existe** : mauvais `DocumentRoot`/chemin, ou r√©√©criture front controller incorrecte.
* **T√©l√©versements ex√©cutables** : bloc `<Directory uploads>` manquant ‚Üí ajouter l‚Äôinterdiction de `.php`.
* **Page blanche PHP** : activer logs PHP/FPM, v√©rifier `error_log`, `display_errors` (en d√©veloppement seulement).

---

## üîß Cheatsheet

```bash
# Activer modules indispensables (Debian)
a2enmod proxy proxy_fcgi rewrite headers && systemctl reload apache2

# Lier .php √† FPM (Debian)
<FilesMatch "\.php$">SetHandler "proxy:unix:/run/php/php8.2-fpm.sock|fcgi://localhost/"</FilesMatch>

# Tests
curl -I -H "Host: mini.local" http://127.0.0.1/
curl -I -H "Host: mini.local" http://127.0.0.1/index.php
```

---

## üß™ Exercices (avec attentes)

1. **Cr√©er** le mini-site (HTML/CSS + `index.php`) et le servir via un **vhost** d√©di√©.
2. **Prouver** que PHP passe par **FPM** (arr√™ter FPM ‚áí `502`, red√©marrer ‚áí OK).
3. **Interdire** PHP dans `uploads/` et **d√©montrer** le 403 via un `test.php` plac√© dedans.
4. **Ajouter** les URLs ‚Äúpropres‚Äù (front controller) et v√©rifier via `curl -I` qu‚Äôune URL non-fichier retourne **200** (ou 404 applicatif).
5. *(Option)* **Activer** HTTPS (Let‚Äôs Encrypt) et forcer la **redirection** HTTP‚ÜíHTTPS.

## üì¶ Livrables attendus

* Fichiers du **vhost** + `.htaccess` (si utilis√©).
* Captures/sorties `apachectl/httpd -t`, `ss -ltnp` (80/443), `curl -I`.
* Extraits de **logs** (acc√®s/erreurs) montrant les requ√™tes de test.
* Note **s√©curit√©** (uploads non ex√©cutables, `Options -Indexes`).

## ‚úÖ Check-list (DoD)

* [ ] Vhost **actif**, `apachectl/httpd -t` **OK**, logs d√©di√©s.
* [ ] **Statique** servi par Apache, **PHP** via **FPM** (test√©).
* [ ] **Uploads** non ex√©cutables, **listing** d√©sactiv√©, `DirectoryIndex` d√©fini.
* [ ] (Option) URLs ‚Äúpropres‚Äù fonctionnelles, HTTPS op√©rationnel.
