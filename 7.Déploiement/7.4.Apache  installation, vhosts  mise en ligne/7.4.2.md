---
title: 2. Arborescence de conf, test de sant√©
permalink: /deploiement/arborescence-conf-test-sante/
layout: home
nav_order: 2
parent: 7.4. Apache
---

# üìò Chapitre 7.4.2 ‚Äî Arborescence de conf, test de sant√©

## üìí Glossaire minute
- **VirtualHost (vhost)** : bloc de config pour un site/domaine (logs, DocumentRoot, SSL‚Ä¶).  
- **Include/IncludeOptional** : *import* de fichiers/dossiers de conf.  
- **a2en*** : outils Debian/Ubuntu pour **activer** sites/mods/confs via liens symboliques.  
- **`apachectl -t` / `httpd -t`** : **lint** de la conf (erreurs de syntaxe).  
- **`-S` (DUMP_VHOSTS)** : affichage des **vhosts** r√©solus (nom/port/fichier).  
- **`-M`** : modules charg√©s.

---

## üéØ Objectifs
- Comprendre l‚Äô**arborescence** de configuration (Debian/Ubuntu vs RHEL/Alma).  
- Cr√©er un **vhost** propre et l‚Äô**activer** sans perturber le reste.  
- Ex√©cuter un **test de sant√©** : syntaxe, vhosts, ports, requ√™te HTTP/HTTPS.

---

## 1) Arborescence ‚Äî Debian/Ubuntu (`/etc/apache2/`)
```text
/etc/apache2/
‚îú‚îÄ‚îÄ apache2.conf                # conf principale (inclut le reste)
‚îú‚îÄ‚îÄ ports.conf                  # ports d‚Äô√©coute (80/443)
‚îú‚îÄ‚îÄ sites-available/            # vhosts "disponibles"
‚îÇ   ‚îú‚îÄ‚îÄ 000-default.conf
‚îÇ   ‚îî‚îÄ‚îÄ site.tld.conf
‚îú‚îÄ‚îÄ sites-enabled/              # vhosts "actifs" (symlinks)
‚îÇ   ‚îî‚îÄ‚îÄ site.tld.conf -> ../sites-available/site.tld.conf
‚îú‚îÄ‚îÄ mods-available/             # d√©finitions de modules (*.load/*.conf)
‚îú‚îÄ‚îÄ mods-enabled/               # modules "actifs" (symlinks)
‚îú‚îÄ‚îÄ conf-available/             # confs g√©n√©riques (ex: security.conf)
‚îî‚îÄ‚îÄ conf-enabled/               # confs "actives" (symlinks)
````

**Commandes utiles (Debian/Ubuntu)**

```bash
a2ensite site.tld.conf      # activer un vhost
a2dissite site.tld.conf     # d√©sactiver
a2enmod rewrite headers ssl # activer des modules
a2dismod autoindex status   # d√©sactiver
a2enconf security           # activer une conf g√©n√©rique
apachectl -t && systemctl reload apache2
```

---

## 2) Arborescence ‚Äî RHEL/CentOS/Alma (`/etc/httpd/`)

```text
/etc/httpd/
‚îú‚îÄ‚îÄ conf/httpd.conf          # conf principale
‚îú‚îÄ‚îÄ conf.d/                  # "drop-ins" (vhosts, modules, status...)
‚îÇ   ‚îî‚îÄ‚îÄ site.tld.conf
‚îî‚îÄ‚îÄ conf.modules.d/          # chargement des modules (*.conf)
```

**Commandes utiles (RHEL)**

```bash
httpd -t && systemctl reload httpd
```

> üéõÔ∏è **Principe** (toutes distros) : **un fichier par vhost**, logs d√©di√©s, pas de m√©lange dans la conf globale.

---

## 3) Vhost **HTTP** minimal (non-SSL)

`/etc/apache2/sites-available/site.tld.conf` (Debian) ou `/etc/httpd/conf.d/site.tld.conf` (RHEL)

```apache
<VirtualHost *:80>
  ServerName site.tld
  ServerAlias www.site.tld
  DocumentRoot /var/www/site/public

  <Directory /var/www/site/public>
    AllowOverride All            # autoriser .htaccess si besoin (rewrite)
    Require all granted
  </Directory>

  ErrorLog  ${APACHE_LOG_DIR}/site_error.log
  CustomLog ${APACHE_LOG_DIR}/site_access.log combined
</VirtualHost>
```

**Activer & recharger (Debian)**

```bash
sudo a2ensite site.tld.conf
sudo apachectl -t && sudo systemctl reload apache2
```

---

## 4) Vhost **HTTPS** (aper√ßu, cf. 7.3.2)

```apache
<VirtualHost *:443>
  ServerName site.tld
  DocumentRoot /var/www/site/public

  SSLEngine on
  SSLCertificateFile    /etc/letsencrypt/live/site.tld/fullchain.pem
  SSLCertificateKeyFile /etc/letsencrypt/live/site.tld/privkey.pem

  Protocols h2 http/1.1
  Header always set Strict-Transport-Security "max-age=15552000; includeSubDomains"
  ErrorLog  ${APACHE_LOG_DIR}/site_ssl_error.log
  CustomLog ${APACHE_LOG_DIR}/site_ssl_access.log combined
</VirtualHost>
```

---

## 5) Tests de **sant√©** (checklist CLI)

### 5.1 Syntaxe & chargements

```bash
# Syntaxe globale
apachectl -t
# Modules charg√©s
apachectl -M | sort | head
# Vhosts r√©solus
apachectl -S
```

> Si `apachectl` indisponible (RHEL) ‚Üí `httpd -t/-M/-S`.

### 5.2 √âcoute & ports

```bash
sudo ss -ltnp '( sport = :80 or sport = :443 )'
```

### 5.3 Requ√™te **sans DNS** (tester le bon vhost)

```bash
# Forcer l'en-t√™te Host (utile avant propagation DNS)
curl -I -H 'Host: site.tld' http://127.0.0.1/
```

### 5.4 Health endpoint simple (optionnel)

Ajouter un fichier `/var/www/site/public/health.txt` (contenu `ok`) :

```bash
curl -fsS -H 'Host: site.tld' http://127.0.0.1/health.txt
# code 200 attendu et corps "ok"
```

### 5.5 Mod\_status (local uniquement, optionnel)

```apache
# a2enmod status (Debian) puis dans un drop-in local :
<Location /server-status>
  SetHandler server-status
  Require local
</Location>
```

```bash
curl -sI http://127.0.0.1/server-status
```

---

## 6) Ports & inclusions ‚Äî o√π les r√©gler ?

* **Debian** : ports dans `ports.conf` (ex. `Listen 80`, `Listen 443`).
* **RHEL** : `Listen` g√©n√©ralement dans `conf/httpd.conf` (ou drop-in).
* **Includes** : v√©rifier que la conf principale **inclut** vos dossiers :

  * Debian `apache2.conf` contient :

    * `IncludeOptional sites-enabled/*.conf`
    * `IncludeOptional conf-enabled/*.conf`
  * RHEL `httpd.conf` contient :

    * `IncludeOptional conf.d/*.conf`
    * `IncludeOptional conf.modules.d/*.conf`

> Si un vhost n‚Äôest **pas pris en compte**, v√©rifier **l‚Äôordre** des `Include` et la **pr√©sence** du fichier dans le dossier *enabled* (Debian).

---

## 7) D√©pannage express

* **`apachectl -t` ERROR** ‚Üí ligne/chemin erron√© : ouvrir le fichier indiqu√©, corriger **puis** `reload`.
* **Vhost non match√©** ‚Üí `apachectl -S` : v√©rifier `ServerName`, port, **ordre** de vhosts par d√©faut.
* **404 sur URL ‚Äúpropres‚Äù** ‚Üí `mod_rewrite` non charg√© ou `AllowOverride All` manquant.
* **443 KO** ‚Üí module `ssl` non actif, certs invalides, pare-feu ferm√©.
* **Conflit de ports** ‚Üí autre service √©coute 80/443 (cf. 7.4.1 **netstat/ss**).

---

## üîß Cheatsheet

```bash
# Debian/Ubuntu
a2ensite site.tld.conf && apachectl -t && systemctl reload apache2
a2enmod rewrite headers ssl && systemctl reload apache2
apachectl -S   # voir le mapping des vhosts
curl -I -H 'Host: site.tld' http://127.0.0.1/

# RHEL
httpd -t && systemctl reload httpd
httpd -S
```

---

## üß™ Exercices (avec attentes)

1. **Cr√©er** un vhost `site.tld` (DocumentRoot `.../public`, logs d√©di√©s), **activer** et **tester** avec `curl -H 'Host: site.tld'`.
2. **Lister** les vhosts avec `apachectl -S`, **identifier** le vhost par d√©faut et **expliquer** son r√¥le.
3. **Activer** `rewrite` et prouver qu‚Äôune URL ‚Äúpropre‚Äù (fichier inexistant) tombe bien sur `index.php`.
4. **Ajouter** un **healthcheck** (fichier `health.txt`) et √©crire la commande de v√©rification (`curl -fsS`).

## üì¶ Livrables attendus

* Fichier de **vhost** + sortie `apachectl -t/-S`.
* Journal d‚Äôactivation (`a2ensite`, `reload`) + test `curl -H 'Host: ‚Ä¶'`.
* Capture du test **healthcheck** (200 + contenu).

## ‚úÖ Check-list (DoD)

* [ ] Arborescence comprise (sites/mods/confs **available** vs **enabled**).
* [ ] Vhost **actif**, syntaxe **OK**, ports **ouverts**.
* [ ] Test de sant√© **r√©ussi** (curl local avec **Host**).
* [ ] Logs d√©di√©s par vhost, `apachectl -S` refl√®te la config attendue.
