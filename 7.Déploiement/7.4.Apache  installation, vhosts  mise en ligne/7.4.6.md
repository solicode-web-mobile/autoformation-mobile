---
title: 6. Bonnes pratiques
permalink: /deploiement/bonnes-pratiques-sauvegarde-logs-https/
layout: home
nav_order: 6
parent: 7.4. Apache
---

# üìò Chapitre 7.4.6 ‚Äî Bonnes pratiques (sauvegarde conf, logs, HTTPS ‚Äì aper√ßu)

## üìí Glossaire minute
- **Conf as code** : configuration versionn√©e (**Git**), test√©e, d√©ploy√©e de fa√ßon reproductible.  
- **Snapshot** : archive **tar**/rsync des dossiers critiques (conf, vhosts, certs).  
- **Rotation** : archivage/compression p√©riodique des logs (**logrotate**).  
- **Centralisation** : envoi des logs vers un collecteur (rsyslog/Filebeat/ELK).  
- **Hygi√®ne HTTPS** : TLS **1.2/1.3**, redirection HTTP‚ÜíHTTPS, **HSTS**, renouvellement auto.  
- **Runbook** : proc√©dure pas-√†-pas (mise √† jour, incident, restauration).  

---

## üéØ Objectifs
- Mettre en place une **sauvegarde** et un **versionnement** fiables de la conf Apache.  
- Normaliser la **journali¬≠sation** (logs par vhost), la **rotation** et, si possible, la **centralisation**.  
- Assurer une posture **HTTPS** saine (certificats, redirections, en-t√™tes).  
- Formaliser des **proc√©dures d‚Äôexploitation** (tests, d√©ploiement, rollback, DR).

## ‚úÖ Pr√©-requis
- 7.4.1 ‚Üí installation/service ‚Ä¢ 7.4.2 ‚Üí arborescence/tests ‚Ä¢ 7.4.3/7.4.4/7.4.5 ‚Üí vhosts & s√©curit√©.

---

## 1) Sauvegarde & versionnement **de la configuration**
### 1.1 Dossiers √† prot√©ger
- **Debian/Ubuntu** : `/etc/apache2/`, `/var/www/`, `/etc/letsencrypt/` (si Let‚Äôs Encrypt)  
- **RHEL/Alma** : `/etc/httpd/`, `/var/www/`, `/etc/letsencrypt/`

### 1.2 Snapshot rapide (scriptable)
```bash
# Variables
STAMP=$(date +%F-%H%M)
sudo tar -cpzf /var/backups/apache-$STAMP.tgz \
  /etc/apache2 /var/www /etc/letsencrypt 2>/dev/null   # Debian
# (RHEL : remplacez /etc/apache2 par /etc/httpd)
````

### 1.3 ‚ÄúConf as code‚Äù (Git local lisible)

```bash
# Cr√©er un miroir lisible de /etc/apache2
sudo mkdir -p /opt/config/apache && sudo rsync -a --delete /etc/apache2/ /opt/config/apache/
cd /opt/config/apache && git init
git add . && git commit -m "Snapshot initial"
# Apr√®s chaque changement :
sudo rsync -a --delete /etc/apache2/ /opt/config/apache/
git add . && git commit -m "MAJ vhosts + headers s√©curit√©"
```

> Stockez le repo **hors** de /etc pour √©viter les confusions et permettre CI/CD (Ansible, etc.).

### 1.4 Restauration express

```bash
# Restaurer un snapshot tar
sudo tar -xvpzf /var/backups/apache-YYYY-MM-DD-HHMM.tgz -C /
sudo apachectl -t && sudo systemctl reload apache2
```

---

## 2) Logs : **s√©parer, faire tourner, centraliser**

### 2.1 Un log par vhost (rappel)

```apache
ErrorLog  ${APACHE_LOG_DIR}/site_error.log
CustomLog ${APACHE_LOG_DIR}/site_access.log combined
```

### 2.2 Rotation (exemple p√©dagogique ‚Äì Debian)

```conf
# /etc/logrotate.d/apache2 (extrait)
 /var/log/apache2/*.log {
   weekly
   rotate 12
   compress
   delaycompress
   missingok
   notifempty
   sharedscripts
   postrotate
     /usr/sbin/apachectl -k graceful > /dev/null 2>/dev/null || true
   endscript
 }
```

> Testez sans ex√©cuter : `sudo logrotate -d /etc/logrotate.d/apache2`.

### 2.3 Centralisation (aper√ßu rsyslog)

```conf
# /etc/rsyslog.d/60-apache.conf
input(type="imfile" File="/var/log/apache2/*.log" Tag="apache:" Severity="info")
*.* action(type="omfwd" Target="10.10.10.10" Port="514" Protocol="tcp")
```

> Alternative : Filebeat/Logstash/ELK si disponible. Pensez **PII** : anonymisation IP si n√©cessaire.

---

## 3) Hygi√®ne **HTTPS** (rappel & ‚Äúquick wins‚Äù)

### 3.1 Redirection HTTP‚ÜíHTTPS

```apache
<VirtualHost *:80>
  ServerName site.tld
  Redirect permanent / https://site.tld/
</VirtualHost>
```

### 3.2 TLS 1.2/1.3 uniquement + HSTS (si pr√™t)

```apache
# Dans le vhost :443
Protocols h2 http/1.1
Header always set Strict-Transport-Security "max-age=15552000; includeSubDomains"
```

> Activez HSTS **progressivement** (quelques jours ‚Üí quelques mois) pour √©viter les blocages.

### 3.3 Certificats & renouvellement

```bash
# V√©rifier la cha√Æne et la date d‚Äôexpiration
openssl s_client -connect site.tld:443 -servername site.tld -showcerts </dev/null | head
# Let‚Äôs Encrypt (Debian/Ubuntu) : tester le renouvellement
sudo certbot renew --dry-run
```

* Surveillez l‚Äôexpiration (alerte 15/7/3 jours avant).
* Servez la **full chain** (`fullchain.pem`).
* Tenez l‚Äôhorloge **NTP** √† l‚Äôheure.

---

## 4) Proc√©dures **d‚Äôexploitation** (Runbooks)

### 4.1 D√©ploiement d‚Äôun changement de conf

1. **Pr√©parer** (branche Git, review)
2. `apachectl -t` (**lint**)
3. **Reload** (sans coupure) : `systemctl reload apache2`
4. **Test sant√©** : `curl -fsS -H "Host: site.tld" http://127.0.0.1/health.txt`
5. **V√©rifier les logs** (error/access)
6. **Tag Git** + note de change

### 4.2 Rollback

* `git revert`/re-d√©ployer la version pr√©c√©dente
* Restaurer le **snapshot** si n√©cessaire
* `apachectl -t` puis **reload**

### 4.3 Mode **maintenance** (option simple)

```apache
# Dans le vhost
RewriteEngine On
RewriteCond %{ENV:MAINTENANCE} =1 [OR]
RewriteCond "/var/www/site/public/maintenance_on" -f
RewriteRule ^ /maintenance.html [R=302,L]
```

> Cr√©ez/supprimez le fichier `maintenance_on` pour activer/d√©sactiver.

---

## 5) S√©curit√© & hygi√®ne continue (r√©cap)

* **Modules** : activer le **minimum** utile (`headers`, `rewrite`, `proxy_fcgi`, `ssl`).
* **R√©pertoires** : `Options -Indexes -MultiViews`, `AllowOverride` ma√Ætris√©, **uploads** non ex√©cutables.
* **Expositions** : bloquer `.env`, `.git`, `*.bak/*.zip/*.sql`.
* **Pare-feu** : n‚Äôexposer que **80/443** ; pas de FPM/DB ouverts en WAN.
* **Monitoring** : sondes `curl -f` r√©guli√®res sur `/health.txt`, alerte si `!= 200`.
* **Mises √† jour** : paquets Apache/PHP/OS √† jour (notes de version, test pr√©-prod).

---

## üîß Cheatsheet

```bash
# Sauvegarde rapide
STAMP=$(date +%F-%H%M); sudo tar -cpzf /var/backups/apache-$STAMP.tgz /etc/apache2 /var/www /etc/letsencrypt

# Lint + reload
apachectl -t && sudo systemctl reload apache2

# Logs : top erreurs
grep " 5[0-9][0-9] " /var/log/apache2/site_access.log | tail

# HTTPS : v√©rifs rapides
curl -I -L https://site.tld
sudo certbot renew --dry-run
```

---

## üß™ Exercices (avec attentes)

1. **√âcrire un script** `backup_apache.sh` qui produit un tar horodat√© (conf/vhosts/certs) + log de succ√®s/√©chec.
2. **Mettre en Git** la conf Apache (miroir en `/opt/config/apache`), r√©aliser **2 commits** (ajout d‚Äôun header + d‚Äôune redirection), **tagger** la version.
3. **Configurer** un **healthcheck** (`health.txt`) et une **t√¢che cron** qui alerte (mail/log) si le `curl -fsS` √©choue.
4. **Activer** la redirection HTTP‚ÜíHTTPS et **HSTS**, prouver les en-t√™tes via `curl -I`.
5. **Tester** la rotation : forcer un `logrotate -f` et montrer la cr√©ation d‚Äôun `.gz`.

## üì¶ Livrables attendus

* Script de **sauvegarde** + capture de l‚Äôarchive cr√©√©e.
* Repo **Git** (captures des commits/tags) + diff des vhosts.
* Sorties **curl** (en-t√™tes HTTPS/HSTS) + preuve du **healthcheck**.
* Fichier de **logrotate** (ou extrait) + sortie de test.

## ‚úÖ Check-list (DoD)

* [ ] Conf **sauv√©e** (snapshot r√©cent) **et** **versionn√©e** (Git).
* [ ] Logs **s√©par√©s** par vhost, **rotation** active/test√©e, (option) **centralis√©s**.
* [ ] HTTPS propre : redirection, TLS 1.2/1.3, **HSTS** d√©ploy√© avec prudence, renouvellement **test√©**.
* [ ] Runbooks **√©crits** (d√©ploiement, rollback, maintenance) et **ex√©cutables** en 10 minutes.
