---
title: 3. Vhost
permalink: /deploiement/vhost-documentroot-logs/
layout: home
nav_order: 3
parent: 7.4. Apache
code: 7.4.3
competence: C7
autoformation: "C7.4"
ua: "7.4.U2"
duree_h: 1.5
objectif: "Cr√©er un vhost propre (ServerName/Alias, DocumentRoot, <Directory>) avec logs d√©di√©s, et le tester m√™me sans DNS."
notions_nouvelles: ["Name-based vhost", "Directory/AllowOverride/DirectoryIndex", "LogFormat combined/vhost_combined", "curl avec en-t√™te Host", "Multiples vhosts sur une IP"]
fil_rouge: "S√©parer les sites et journaliser finement par vhost"
livrable_chapitre: "Vhost final + tests curl -H 'Host: ‚Ä¶' + extraits de logs acc√®s/erreurs"
alimentation_prototype: "Observabilit√© par site (fichiers de logs distincts)"
alimentation_miniprojet: "Base pour troubleshooting rapide par domaine"
---


# üìò Chapitre 7.4.3 ‚Äî Vhost (DocumentRoot, logs)

## üìí Glossaire minute
- **Name-based vhost** : plusieurs sites **sur la m√™me IP/port**, distingu√©s par `Host:` (SNI pour HTTPS).  
- **DocumentRoot** : dossier **racine web** du site (souvent `.../public`).  
- **Directory** : bloc d‚Äôautorisations/Options pour un r√©pertoire.  
- **ErrorLog / CustomLog** : fichiers **erreurs** / **acc√®s** (par vhost recommand√©).  
- **LogFormat** : gabarit des lignes d‚Äôacc√®s (ex. `combined`, `vhost_combined`).  
- **ServerName / ServerAlias** : nom principal / alias (ex. `www`).

---

## üéØ Objectifs
- Cr√©er un **vhost propre** : `ServerName`, `DocumentRoot`, **logs d√©di√©s**.  
- Activer/charger le vhost et **tester** m√™me sans DNS (en-t√™te `Host`).  
- Appliquer des **r√®gles** utiles : `Options -Indexes`, `AllowOverride`, `DirectoryIndex`.  
- Savoir **lire** les logs et **troubleshooter** les erreurs courantes (403/404/500).

## ‚úÖ Pr√©-requis
- 7.4.1 (installation/service), 7.4.2 (arborescence, tests sant√©), 7.3.4 (s√©curit√© de base).

---

## 1) Vhost **HTTP** minimal avec DocumentRoot & logs

### Debian/Ubuntu ‚Äî `/etc/apache2/sites-available/site.tld.conf`
```apache
<VirtualHost *:80>
  ServerName site.tld
  ServerAlias www.site.tld
  DocumentRoot /var/www/site/public

  <Directory /var/www/site/public>
    Options -Indexes                 # pas de listing de r√©pertoire
    AllowOverride All                # autoriser .htaccess (rewrite)
    Require all granted
  </Directory>

  DirectoryIndex index.php index.html

  # Logs d√©di√©s au vhost
  ErrorLog  ${APACHE_LOG_DIR}/site_error.log
  CustomLog ${APACHE_LOG_DIR}/site_access.log combined
</VirtualHost>
````

**Activer & recharger**

```bash
sudo a2ensite site.tld.conf
sudo apachectl -t && sudo systemctl reload apache2
```

### RHEL/Alma ‚Äî `/etc/httpd/conf.d/site.tld.conf`

```apache
<VirtualHost *:80>
  ServerName site.tld
  ServerAlias www.site.tld
  DocumentRoot /var/www/site/public

  <Directory /var/www/site/public>
    Options -Indexes
    AllowOverride All
    Require all granted
  </Directory>

  DirectoryIndex index.php index.html

  ErrorLog  /var/log/httpd/site_error.log
  CustomLog /var/log/httpd/site_access.log combined
</VirtualHost>
```

---

## 2) **Tester** sans attendre la propagation DNS

```bash
# Tester le bon vhost en local (header Host)
curl -I -H "Host: site.tld" http://127.0.0.1/
# ou depuis un autre h√¥te du LAN, en rempla√ßant l'IP
curl -I -H "Host: site.tld" http://192.168.x.y/
```

> Astuce : on peut ajouter temporairement `site.tld  192.168.x.y` dans le **hosts** local (admin requis).

---

## 3) Choisir un **DocumentRoot** sain

* Pr√©f√©rer un dossier `.../**public**` qui **ne** contient **que** ce qui doit √™tre servi.
* Mettre le **code** applicatif **hors** du `DocumentRoot` si possible.
* Bloquer l‚Äôex√©cution PHP dans `uploads/` (rappel 7.3.4) et interdire `.env`, `.git`, backups :

```apache
# Dans le vhost (renforcer la racine publique)
<Directory "/var/www/site/public">
  <FilesMatch "^(\.env|composer\.(json|lock)|.*\.(bak|zip|sql))$">
    Require all denied
  </FilesMatch>
</Directory>
```

---

## 4) Logs : formats & exemples utiles

### 4.1 Format `combined` (par d√©faut)

```apache
CustomLog ${APACHE_LOG_DIR}/site_access.log combined
```

Contient : IP, date, requ√™te, **code**, octets, `Referer`, `User-Agent`.

### 4.2 Inclure le **vhost** dans chaque ligne

```apache
LogFormat "%v %h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-agent}i\"" vhost_combined
CustomLog ${APACHE_LOG_DIR}/site_access.log vhost_combined
```

### 4.3 S√©parer **HTTP** et **HTTPS**

```apache
ErrorLog  ${APACHE_LOG_DIR}/site_error.log
CustomLog ${APACHE_LOG_DIR}/site_access.log combined
# et pour le vhost :443, utiliser site_ssl_error.log / site_ssl_access.log
```

üîé **Lecture rapide**

```bash
tail -f /var/log/apache2/site_access.log
tail -f /var/log/apache2/site_error.log
```

---

## 5) Plusieurs vhosts sur la **m√™me IP** (name-based)

```apache
# site A
<VirtualHost *:80>
  ServerName a.tld
  DocumentRoot /var/www/a/public
  ErrorLog  ${APACHE_LOG_DIR}/a_error.log
  CustomLog ${APACHE_LOG_DIR}/a_access.log combined
</VirtualHost>

# site B
<VirtualHost *:80>
  ServerName b.tld
  DocumentRoot /var/www/b/public
  ErrorLog  ${APACHE_LOG_DIR}/b_error.log
  CustomLog ${APACHE_LOG_DIR}/b_access.log combined
</VirtualHost>
```

V√©rifier le **mapping** :

```bash
apachectl -S
```

---

## 6) Vhost **HTTPS** (rappel express)

> Voir 7.3.2 pour TLS. On place simplement les chemins de certificats dans le vhost `:443` **avec logs s√©par√©s**.

```apache
<VirtualHost *:443>
  ServerName site.tld
  DocumentRoot /var/www/site/public
  SSLEngine on
  SSLCertificateFile    /etc/letsencrypt/live/site.tld/fullchain.pem
  SSLCertificateKeyFile /etc/letsencrypt/live/site.tld/privkey.pem
  ErrorLog  ${APACHE_LOG_DIR}/site_ssl_error.log
  CustomLog ${APACHE_LOG_DIR}/site_ssl_access.log combined
</VirtualHost>
```

---

## 7) D√©pannage ‚Äî cas fr√©quents

* **`403 Forbidden`** : droits Unix incorrects sur `DocumentRoot`, `Require all denied`, mauvais chemin.
* **`404` sur fichiers existants** : `DocumentRoot` ou `Directory` ne pointent pas o√π il faut ; `Options`/`AllowOverride` manquants pour r√©√©critures.
* **Vhost non pris** : `apachectl -S` ne le montre pas ‚Üí pas activ√© (Debian), faute de syntaxe (`apachectl -t`).
* **Logs vides** : mauvais chemin de fichiers, permissions du dossier **logs**.

---

## üîß Cheatsheet

```bash
# Activer, v√©rifier, recharger (Debian/Ubuntu)
a2ensite site.tld.conf
apachectl -t && systemctl reload apache2
apachectl -S
curl -I -H "Host: site.tld" http://127.0.0.1/

# RHEL
httpd -t && systemctl reload httpd && httpd -S
```

---

## üß™ Exercices (avec attentes)

1. **Cr√©er** un vhost `site.tld` pointant vers `/var/www/site/public` avec `Options -Indexes`, `AllowOverride All`, `DirectoryIndex index.php index.html`.
2. **S√©parer** les logs (acc√®s/erreurs) **HTTP** et **HTTPS** (noms distincts), prouver que les entr√©es apparaissent au bon endroit.
3. **Tester** le vhost via `curl -H "Host: site.tld"` puis provoquer une **404** volontaire et la retrouver dans `site_access.log`.
4. **Ajouter** un `LogFormat` incluant `%v` et v√©rifier qu‚Äôon voit le **nom de vhost** au d√©but des lignes.

## üì¶ Livrables attendus

* Fichier de **vhost** final (+ √©ventuel vhost :443) ; sorties `apachectl -t/-S`.
* Journal de **tests** (`curl -I -H 'Host:‚Ä¶'`) + extraits **logs**.
* Note **s√©curit√©** : preuves `Options -Indexes`, blocage `.env/.git`.

## ‚úÖ Check-list (DoD)

* [ ] `ServerName/ServerAlias` corrects ; **DocumentRoot** sain (`.../public`).
* [ ] Bloc `<Directory>` appliqu√© (`Options -Indexes`, `AllowOverride` adapt√©).
* [ ] **Logs d√©di√©s** par vhost, lisibles et s√©par√©s HTTP/HTTPS.
* [ ] `apachectl -t/-S` OK ; test `curl -H 'Host'` **r√©ussi**.
