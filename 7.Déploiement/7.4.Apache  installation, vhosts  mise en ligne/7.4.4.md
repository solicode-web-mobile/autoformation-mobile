---
title: 4. Droits & rewrite
permalink: /deploiement/droits-permissions-index-alias-rewrite/
layout: home
nav_order: 4
parent: 7.4. Apache
code: 7.4.4
competence: C7
autoformation: "C7.4"
ua: "7.4.U2"
duree_h: 1.5
objectif: "Durcir un site (permissions s√ªres, pas de listing), publier via Alias en s√©curit√©, activer mod_rewrite (front controller, canonical, HTTPS)."
notions_nouvelles: ["Permissions 644/755", "Uploads non ex√©cutables (FilesMatch)", "Options -Indexes/-MultiViews", "Alias/Directory s√©curis√©", "mod_rewrite (front controller, redirect 301, HTTPS, canonical)"]
fil_rouge: "R√©duire la surface d‚Äôattaque et fiabiliser les URLs"
livrable_chapitre: "Extraits vhost/.htaccess + preuves 403 sur .env/.git + tests de redirections (curl -IL)"
alimentation_prototype: "Param√©trage s√©curit√© minimal reproductible"
alimentation_miniprojet: "R√®gles de r√©√©criture et de protection pr√™tes pour l‚Äôapp"
---

# üìò Chapitre 7.4.4 ‚Äî Droits/permissions, index, alias, **mod_rewrite**

## üìí Glossaire minute
- **UID/GID** : propri√©taire **utilisateur/groupe** des fichiers (ex. `www-data:www-data`).
- **Permissions** : `rwx` (lecture/√©criture/ex√©cution) sur **fichiers** et **dossiers**.
- **DirectoryIndex** : fichiers index par d√©faut (ex. `index.php`, `index.html`).
- **Alias/ScriptAlias** : publier un **r√©pertoire** en dehors du `DocumentRoot`.
- **`mod_rewrite`** : r√©√©crit/redirige les URLs via des **r√®gles** (regex).
- **AllowOverride** : autorise (ou non) **.htaccess** √† modifier la conf.

---

## üéØ Objectifs
- R√©gler des **droits** s√ªrs (ex√©cution PHP interdite dans `uploads/`, pas de `777`).
- G√©rer l‚Äô**indexation** (d√©sactiver listing, d√©finir `DirectoryIndex`).
- Publier du contenu via **Alias** en gardant des **barri√®res** de s√©curit√©.
- √âcrire des r√®gles **mod_rewrite** classiques : *front controller*, canonical, redirections.

## ‚úÖ Pr√©-requis
- 7.4.1 (installation/service), 7.4.2 (arborescence/tests), 7.4.3 (vhost & logs).
- 7.3.4 (s√©curit√© de base), 7.3.3 (PHP/FPM).

---

## 1) Droits & permissions (Linux)

### 1.1 R√®gles simples
- **Fichiers** : `0644` (lecture pour tous, √©criture propri√©taire).  
- **Dossiers** : `0755` (ex√©cution = travers√©e de dossier).  
- **Jamais** `777`.  
- Propri√©t√© : selon vos pratiques, souvent `www-data:www-data` **ou** `deploy:www-data` (groupe web lecteur).

```bash
# Exemples
sudo chown -R www-data:www-data /var/www/site
find /var/www/site -type d -exec chmod 755 {} \;
find /var/www/site -type f -exec chmod 644 {} \;
````

### 1.2 R√©pertoire d‚Äôuploads (√©criture sans ex√©cution PHP)

* Cr√©ez un dossier **s√©par√©** pour les m√©dias : `/var/www/site/public/uploads`

```apache
# Vhost : interdire l'ex√©cution PHP dans uploads/
<Directory "/var/www/site/public/uploads">
  <FilesMatch "\.php$">
    Require all denied
  </FilesMatch>
</Directory>
```

* Permissions d‚Äô√©criture **uniquement** sur `uploads/` si l‚Äôapp en a besoin :

```bash
sudo chgrp -R www-data /var/www/site/public/uploads
sudo chmod -R 775 /var/www/site/public/uploads
```

> üß© Astuce : s√©parer **code** (en lecture seule) et **contenu** (uploads) √©vite des compromissions √©tendues.

### 1.3 Windows (XAMPP)

* Utiliser les **ACL NTFS** : accorder **Modify** au compte du service Apache **uniquement** sur `uploads\`.
  `icacls "C:\xampp\htdocs\site\uploads" /grant "Users:(OI)(CI)M"`

---

## 2) Index, listing & ordre de fichiers

### 2.1 D√©sactiver le **listing** de r√©pertoire

```apache
<Directory /var/www/site/public>
  Options -Indexes
</Directory>
```

### 2.2 D√©finir l‚Äô**index**

```apache
DirectoryIndex index.php index.html
```

### 2.3 √âviter **MultiViews** (peut ‚Äúdeviner‚Äù des fichiers)

```apache
<Directory /var/www/site/public>
  Options -Indexes -MultiViews
</Directory>
```

---

## 3) **Alias** & publication hors DocumentRoot

### 3.1 Alias simple (statique)

```apache
# /assets/ pointera vers /var/www/assets-public/
Alias /assets/ /var/www/assets-public/

<Directory /var/www/assets-public/>
  Options -Indexes
  Require all granted
</Directory>
```

### 3.2 ScriptAlias (CGI) ‚Äî √©viter si possible

```apache
# Example historique (d√©conseill√© en p√©dagogie moderne)
# ScriptAlias /cgi-bin/ /usr/lib/cgi-bin/
```

### 3.3 S√©curiser l‚Äôalias

* **Jamais** d‚Äôalias vers un dossier **√©criture + ex√©cution**.
* Prot√©ger les **dotfiles** et archives :

```apache
<Directory "/var/www/assets-public">
  <FilesMatch "^(\.git|\.env|.*\.(bak|zip|sql))$">
    Require all denied
  </FilesMatch>
</Directory>
```

> üß™ Testez : `curl -I http://site.tld/assets/` (200) et `curl -I http://site.tld/assets/.git/` (403/404).

---

## 4) **mod\_rewrite** ‚Äî activer & motifs courants

### 4.1 Activer le module (Debian/Ubuntu)

```bash
sudo a2enmod rewrite && sudo systemctl reload apache2
```

> üí° **Performance & contr√¥le** : privil√©giez des r√®gles **dans le vhost**. Utilisez `.htaccess` **seulement si n√©cessaire** et `AllowOverride Limit FileInfo Options`.

```apache
<Directory /var/www/site/public>
  AllowOverride FileInfo
</Directory>
```

### 4.2 **Front controller** (routes ‚Äúpropres‚Äù)

* **Dans le vhost** (recommand√©) ou **.htaccess** :

```apache
# Vhost : bloc Directory
<Directory /var/www/site/public>
  Options -Indexes
  AllowOverride All
  Require all granted
</Directory>

# .htaccess (dans /public)
RewriteEngine On
# Si la ressource n'existe pas comme fichier/r√©pertoire ‚Üí index.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ index.php [QSA,L]
```

### 4.3 **Canonical** : forcer sans `www` (ou l‚Äôinverse)

```apache
RewriteEngine On
RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
RewriteRule ^ https://%1%{REQUEST_URI} [R=301,L]
```

### 4.4 Forcer **HTTPS** (peut aussi se faire via vhost :80 avec `Redirect`)

```apache
RewriteEngine On
RewriteCond %{HTTPS} !=on
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
```

### 4.5 Redirections propres

```apache
# /old ‚Üí /new permanent
Redirect 301 /old /new
# ou via mod_rewrite
RewriteRule ^old$ /new [R=301,L]
```

---

## 5) Tests & validation

```bash
# Valider la conf
apachectl -t

# Voir si .htaccess est pris en compte (r√©√©critures actives)
curl -I http://site.tld/une-url-qui-nexiste-pas
# attendu : 200 avec le HTML de index.php (si front-controller) OU 404 applicatif

# Tester canonical & HTTPS
curl -I http://www.site.tld/chemin   # ‚Üí 301 vers https://site.tld/chemin
curl -I http://site.tld/chemin       # ‚Üí 301 vers https://site.tld/chemin
```

---

## 6) D√©pannage ‚Äî cas typiques

* **Boucles 301/302** : r√®gle canonical + reverse proxy / HTTPS mal d√©tect√© ‚Üí v√©rifier `X-Forwarded-Proto` (si proxy) et conditions `RewriteCond`.
* **404 sur routes ‚Äúpropres‚Äù** : `mod_rewrite` non charg√©, `AllowOverride All` absent, conditions `!-f/-d` incorrectes.
* **403** inattendu : droits Unix sur `DocumentRoot`, `Require all denied` ou correspondance d‚Äôun `FilesMatch` trop large.
* **PHP ex√©cut√© dans uploads/** : r√®gle `FilesMatch "\.php$"` manquante ‚Üí **ajouter bloc** d√©di√© (section 1.2).
* **Alias non pris** : oublier le bloc `<Directory>` avec `Require all granted`.

---

## üîß Cheatsheet

```apache
# S√©curit√© de base
Options -Indexes -MultiViews
ServerTokens Prod
ServerSignature Off

# DirectoryIndex
DirectoryIndex index.php index.html

# Alias s√©curis√©
Alias /assets/ /var/www/assets-public/
<Directory /var/www/assets-public/>
  Options -Indexes
  Require all granted
</Directory>

# Front controller (htaccess)
RewriteEngine On
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ index.php [QSA,L]
```

---

## üß™ Exercices (avec attentes)

1. **Durcir** `/public` : `Options -Indexes -MultiViews`, `DirectoryIndex` d√©fini, blocage `.env/.git`.
2. **Configurer** un **Alias** `/assets/` vers un dossier hors `DocumentRoot` ; prouver l‚Äôacc√®s aux images et le **403** sur `.git`.
3. **Mettre** en place le **front controller** : une URL ‚Äúpropre‚Äù non-fichier doit aboutir √† `index.php`.
4. **Redirection** : impl√©menter canonical (sans `www`) et forcer **HTTPS** ; tester avec `curl -IL` et commenter le chemin des `Location:`.

## üì¶ Livrables attendus

* Extraits **vhost** (+ √©ventuel `.htaccess`) et sorties `apachectl -t`.
* Journal de **tests** (`curl -I/-IL`), captures montrant 301 attendus et 200 final.
* Preuves **s√©curit√©** (403 sur `.env`/`.git`, pas d‚Äôex√©cution PHP dans `uploads/`).

## ‚úÖ Check-list (DoD)

* [ ] Permissions saines (644/755), uploads **√©criture sans ex√©cution**.
* [ ] **Listing** d√©sactiv√©, `DirectoryIndex` correct, `MultiViews` off.
* [ ] **Alias** fonctionnel et s√©curis√© (dotfiles & archives bloqu√©s).
* [ ] **mod\_rewrite** actif ; front controller + canonical/HTTPS test√©s sans boucle.
