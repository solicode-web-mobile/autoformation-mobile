---
title: 6. Tra√ßage client‚Üíserveur
layout: home
nav_order: 6
parent: Autoformation C7.3 ‚Äî Serveur Web : principes & HTTP
permalink: /deploiement/c7-3/tracage/
code: 7.3.6
competence: C7
autoformation: "C7.3"
ua: "7.3.U6"
duree_h: 2
objectif: "Tracer une requ√™te du client √† l‚Äôapplication et identifier l‚Äô√©tage lent ou en panne."
notions_nouvelles: ["TTFB", "Request ID", "Hop r√©seau", "Handshake TLS", "Upstream (PHP-FPM, DB)"]
fil_rouge: "Diagnostic complet requ√™te blog/API jusqu‚Äô√† la base"
livrable_chapitre: "Captures DevTools + sortie curl -w + logs avec Request ID"
alimentation_prototype: "Corr√©lation simple client‚ÜíApache‚ÜíPHP"
alimentation_miniprojet: "Runbook diagnostic bout-√†-bout en production"
---



# üìò Chapitre 7.3.6 ‚Äî **Tra√ßage** client ‚Üí serveur

## üìí Glossaire minute
- **TTFB** (*Time To First Byte*) : d√©lai avant le **1er octet** de r√©ponse.
- **Trace/Request ID** : identifiant unique d‚Äôune requ√™te pour **corr√©lation** des logs.
- **Hop** : saut r√©seau (routeur) visible en `traceroute/tracepath`.
- **Handshake TLS** : n√©gociation chiffr√©e avant l‚ÄôHTTP (impacte la latence).
- **Upstream** : service **en amont** (ex. PHP-FPM, DB) derri√®re le serveur web.

---

## üéØ Objectifs
- Suivre **pas √† pas** une requ√™te : Navigateur ‚Üí DNS ‚Üí R√©seau ‚Üí TLS ‚Üí HTTP ‚Üí Apache ‚Üí PHP-FPM ‚Üí App ‚Üí DB.
- Mesurer **o√π** se situe le temps (DNS, connect, TLS, app) et **corr√©ler** avec les logs serveur.
- Mettre en place un **Request ID** bout-√†-bout pour faciliter le diagnostic.

## ‚úÖ Pr√©-requis
- C7.2 (diagnostic r√©seau) ‚Ä¢ C7.3.1 (HTTP) ‚Ä¢ C7.3.2 (TLS) ‚Ä¢ C7.3.3 (PHP/FPM) ‚Ä¢ C7.3.5 (logs).

---

## 1) Vue d‚Äôensemble ‚Äî chemin d‚Äôune requ√™te

```mermaid
sequenceDiagram
  participant U as Navigateur
  participant DNS as R√©solveur DNS
  participant I as Internet/Routeurs
  participant W as Web (Apache:80/443)
  participant F as PHP-FPM
  participant APP as Application
  participant DB as Base de donn√©es/Cache

  U->>DNS: R√©solution A/AAAA
  DNS-->>U: IP du site
  U->>W: TCP SYN (80/443) via I
  U->>W: (si 443) Handshake TLS
  U->>W: Requ√™te HTTP
  W->>F: proxy_fcgi (si .php/front controller)
  F->>APP: ex√©cution PHP
  APP->>DB: requ√™tes SQL/Cache
  DB-->>APP: r√©sultats
  APP-->>F: corps de r√©ponse
  F-->>W: 200/3xx/4xx/5xx
  W-->>U: R√©ponse + TTFB
````

---

## 2) √âtapes de tra√ßage (du **client** vers le **serveur**)

### 2.1 Navigateur (DevTools)

* Ouvrir **Network** (Chrome/Firefox) ‚Üí cocher **Disable cache**, **Preserve log**.
* Observer : **Status**, **Size**, **Timing** (DNS, Connect, SSL, TTFB, Content).
* Tester l‚ÄôURL **HTTP** puis **HTTPS** (redirection ? `301/302` en boucle ?).

### 2.2 DNS

```bash
dig +short www.exemple.tld     # ou: nslookup
# Bypasser DNS c√¥t√© client pour un test cibl√© :
curl --resolve www.exemple.tld:443:203.0.113.10 https://www.exemple.tld/ -I -v
```

> Si `--resolve` marche et pas l‚Äôacc√®s normal ‚Üí **probl√®me DNS** (enregistrements, propagation, cache).

### 2.3 Connectivit√© & chemin

```bash
ping -c 3 203.0.113.10           # atteignable ?
tracepath 203.0.113.10           # chemin & PMTU (Linux)
tracert -d 203.0.113.10          # Windows
```

> Perte/latence √©lev√©es t√¥t dans le trac√© ‚Üí suspecter **FAI/LAN/NAT**.

### 2.4 TLS (si HTTPS)

```bash
curl -I -v https://www.exemple.tld/
openssl s_client -connect www.exemple.tld:443 -servername www.exemple.tld -showcerts </dev/null
```

> V√©rifier : **nom** (SAN), **cha√Æne compl√®te**, **dates**, **TLS 1.2/1.3**.

### 2.5 HTTP (statuts, en-t√™tes, TTFB)

```bash
# Phases de temps (DNS ‚Üí connect ‚Üí TLS ‚Üí TTFB ‚Üí total)
curl -w 'namelookup:%{time_namelookup} connect:%{time_connect} tls:%{time_appconnect} starttransfer:%{time_starttransfer} total:%{time_total}\n' \
     -I -s -o /dev/null https://www.exemple.tld/
```

> `starttransfer` haut mais `connect/tls` bas ‚Üí **application lente**.

### 2.6 Serveur web (ports & vhost)

```bash
sudo ss -ltnp '( sport = :80 or sport = :443 )'   # √©coute Apache ?
apachectl -t && systemctl reload apache2          # conf OK ?
tail -f /var/log/apache2/site_access.log
tail -f /var/log/apache2/site_error.log
```

### 2.7 Cha√Æne PHP-FPM ‚Üí App

```bash
systemctl status php8.2-fpm
journalctl -u php8.2-fpm -e
# Lancer une requ√™te et suivre error.log (PHP) en parall√®le
```

### 2.8 Amont (DB/Cache)

* V√©rifier **latences** DB, connexions satur√©es, verrous.
* Tester localement depuis le serveur : `mysql -h ‚Ä¶`, `psql ‚Ä¶`, `redis-cli PING`.

---

## 3) Mettre un **Request ID** bout-√†-bout (corr√©lation)

### 3.1 G√©n√©rer & propager c√¥t√© Apache

```bash
# Activer un ID unique (Apache)
sudo a2enmod unique_id headers && sudo systemctl reload apache2

# Dans le vhost (extrait)
Header set X-Request-ID %{UNIQUE_ID}e

# LogFormat avec l‚ÄôID
LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-agent}i\" \"%{UNIQUE_ID}e\"" combined_id
CustomLog ${APACHE_LOG_DIR}/site_access.log combined_id
```

### 3.2 C√¥t√© application

* R√©cup√©rer `X-Request-ID` (ou en g√©n√©rer un si absent) et le **logguer**.
* R√©percuter l‚ÄôID vers l‚Äôupstream (ex. DB traces) si pertinent.

### 3.3 C√¥t√© client

```bash
curl -H "X-Request-ID: demo-123" -I https://www.exemple.tld/
# Chercher "demo-123" dans les logs pour suivre **pr√©cis√©ment** la requ√™te.
```

---

## 4) Observation r√©seau (optionnel, local au serveur)

```bash
# Voir les paquets HTTP (port 80) sans d√©coder TLS
sudo tcpdump -nn -s0 -A host 203.0.113.5 and port 80

# V√©rifier le 3-way handshake/RTT (80/443)
sudo tcpdump -nn tcp port 443
```

> √Ä utiliser **temporairement** et avec prudence (confidentialit√©, volum√©trie).

---

## 5) Pannes typiques & indices

| Sympt√¥me               | Indices                                  | Piste de cause               | Action                                |
| ---------------------- | ---------------------------------------- | ---------------------------- | ------------------------------------- |
| **Timeout avant TTFB** | `curl -v` bloque apr√®s `> GET`           | PHP-FPM satur√© / deadlock DB | V√©rifier **FPM** (proc, logs), **DB** |
| **`502 Bad Gateway`**  | `error.log`/journal FPM                  | Socket FPM faux / FPM down   | Corriger socket, red√©marrer FPM       |
| **Boucle `301/302`**   | `curl -IL` montre plusieurs redirections | R√©√©critures/conf HTTPS       | Corriger r√®gles/`ServerName`          |
| **`404` inattendus**   | access.log 404 + `.htaccess`             | Rewrite manquant             | Activer `mod_rewrite`, r√®gles         |
| **`495/525` TLS**      | `openssl s_client` erreurs               | Cert/cha√Æne, SNI             | Refaire cert/`fullchain`, vhost       |
| **Lent partout**       | `connect/tls` hauts                      | R√©seau (perte/MTU/FAI)       | `tracepath`, MTU, FAI                 |

---

## 6) Runbook ‚Äú10 minutes chrono‚Äù

1. **URL** exacte + heure (timezone).
2. **DevTools** : status + **Timing**.
3. `curl -I -v` + **mesures** (`-w` temps).
4. **DNS** (`dig`) ou `--resolve`.
5. **Trace r√©seau** (`tracepath`/`tracert`).
6. **TLS** (`openssl s_client`).
7. **Ports** (`ss -ltnp`).
8. **Logs** Apache (access+error) **avec Request ID**.
9. **FPM & app** (journaux, saturation).
10. **DB/cache** (latences, connexions).

---

## üß™ Exercices (avec attentes)

1. **Mesurer** les phases avec `curl -w` (DNS, connect, TLS, TTFB, total) pour une page donn√©e et **interpr√©ter** o√π part le temps.
2. **Activer** `X-Request-ID` c√¥t√© Apache, **d√©clencher** une requ√™te avec un ID connu et **trouver** la ligne correspondante dans `access.log` et `error.log`.
3. **Simuler** une panne FPM (stop service) ‚Üí observer **502** c√¥t√© client, relever les indices c√¥t√© `error.log` et `journalctl`.
4. **Boucle de redirection** : cr√©er une r√®gle fautive, capturer `curl -IL` (plusieurs `Location:`), puis **corriger**.

## üì¶ Livrables attendus

* Capture **DevTools Timing** + sortie `curl -w` annot√©e.
* Extraits de **logs** (access/error) montrant l‚ÄôID de requ√™te bout-√†-bout.
* Mini-rapport d‚Äôincident (sympt√¥me ‚Üí hypoth√®ses ‚Üí preuves ‚Üí fix).

## ‚úÖ Check-list (DoD)

* [ ] Je sais **mesurer** DNS/connect/TLS/TTFB et en d√©duire l‚Äô√©tage en cause.
* [ ] Un **Request ID** est visible c√¥t√© client **et** dans les logs serveur.
* [ ] Je corr√®le access/error/FPM pour expliquer un **502/404/301**.
* [ ] Je peux d√©rouler le **runbook 10 min** pour isoler une panne.
