---
title: 3. Statique vs PHP-FPM
layout: home
nav_order: 3
parent: Autoformation C7.3 ‚Äî Serveur Web : principes & HTTP
permalink: /deploiement/c7-3/php-fpm/
code: 7.3.3
competence: C7
autoformation: "C7.3"
ua: "7.3.U3"
duree_h: 1.5
objectif: "Servir les fichiers statiques via Apache et ex√©cuter PHP via FPM avec front controller."
notions_nouvelles: ["Statique vs dynamique", "PHP-FPM", "mod_php", "Front controller", "Opcode cache"]
fil_rouge: "Blog Laravel servi via Apache + PHP-FPM"
livrable_chapitre: "Vhost Apache + .htaccess front controller, test uploads interdits"
alimentation_prototype: "Vhost minimal (public/, PHP, cache headers)"
alimentation_miniprojet: "Perf : opcache, cache headers, separation statique"
---



# üìò Chapitre 7.3.3 ‚Äî **Statique vs dynamique** (PHP/FPM ‚Äî aper√ßu)

## üìí Glossaire minute
- **Statique** : fichiers servis **tels quels** par le serveur (HTML, CSS, JS, images).  
- **Dynamique** : page **g√©n√©r√©e** √† la demande (ex. PHP) via un **moteur** (PHP-FPM).  
- **PHP-FPM** : *FastCGI Process Manager* ‚Äî g√®re des **workers** PHP pour traiter les requ√™tes.  
- **mod_php** : ancien module Apache qui charge le moteur PHP **dans** Apache (d√©conseill√© ‚Üí pr√©f√©rer FPM).  
- **Front controller** : `index.php` unique qui route toutes les URLs (frameworks).  
- **Opcode cache (opcache)** : met en cache le **bytecode** PHP (acc√©l√®re fortement).  

---

## üéØ Objectifs
- Distinguer **statique** vs **dynamique** et choisir le bon **chemin de traitement**.  
- Comprendre le r√¥le de **PHP-FPM** et la cha√Æne **Apache ‚Üí FPM ‚Üí App**.  
- D√©ployer un **vhost** minimal qui sert **assets** statiques + **PHP** via FPM.  
- Appliquer des **r√®gles** simples de perf et de s√©curit√© (cache, r√©√©criture, uploads).

## ‚úÖ Pr√©-requis
- C7.2 (LAN/IP/DNS) ‚Ä¢ C7.3.1 (HTTP/MIME) ‚Ä¢ Bases Apache (C7.4 compl√©tera).

---

## 1) Quand **statique**, quand **dynamique** ?

| Type | Exemples | Avantages | Points d‚Äôattention |
|---|---|---|---|
| **Statique** | HTML, CSS, JS, images, PDF | Tr√®s **rapide**, **cacheable**, faible charge CPU | Bien r√©gler **Cache-Control**, versions d‚Äôassets (hash) |
| **Dynamique** | PHP (blog, API, CMS), pages avec DB | **Personnalisation**, logique m√©tier | Co√ªt CPU/DB, penser **opcache**, limiter I/O |

> R√®gle d‚Äôor : **laissez Apache servir tout ce qui est statique** directement, et ne passez par PHP-FPM **que** pour les `.php` (ou routes front controller).

---

## 2) Cha√Æne de traitement (vue d‚Äôensemble)

```mermaid
sequenceDiagram
  participant U as Navigateur
  participant A as Apache (vhost)
  participant F as PHP-FPM (pool)
  participant APP as Application PHP
  participant DB as Base de donn√©es/Cache

  U->>A: GET /style.css
  A-->>U: 200 (statique)

  U->>A: GET /article/42
  A->>F: FastCGI /index.php (proxy_fcgi)
  F->>APP: Ex√©cution du code PHP
  APP->>DB: SELECT ...
  DB-->>APP: R√©sultats
  APP-->>F: HTML/JSON
  F-->>A: R√©ponse PHP
  A-->>U: 200 (dynamique)
````

---

## 3) Apache + PHP-FPM ‚Äî **vhost** minimal (Debian/Ubuntu)

> Modules requis : `proxy`, `proxy_fcgi`, `setenvif`, `rewrite`, `headers`.
> Service PHP : `php8.x-fpm` (socket ex. `/run/php/php8.2-fpm.sock`).

```apache
<VirtualHost *:80>
  ServerName site.local
  DocumentRoot /var/www/site/public

  # 1) Statique directement (Apache sert les fichiers)
  <Directory /var/www/site/public>
    AllowOverride All
    Require all granted
    # Cache long pour assets versionn√©s (ex: .css/.js/.png/.jpg/.webp)
    <FilesMatch "\.(css|js|png|jpg|jpeg|gif|svg|webp|ico|woff2?)$">
      Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
  </Directory>

  # 2) PHP via FPM (FastCGI) ‚Äî ne matcher que .php
  <FilesMatch "\.php$">
    SetHandler "proxy:unix:/run/php/php8.2-fpm.sock|fcgi://localhost/"
  </FilesMatch>

  # 3) Index par d√©faut
  DirectoryIndex index.php index.html

  # 4) Logs
  ErrorLog ${APACHE_LOG_DIR}/site_error.log
  CustomLog ${APACHE_LOG_DIR}/site_access.log combined
</VirtualHost>
```

### R√©√©criture type **front controller** (si framework/CMS)

`.htaccess` dans `/var/www/site/public` :

```apache
RewriteEngine On
# Si la ressource demand√©e n‚Äôest pas un fichier/r√©pertoire r√©el ‚Üí index.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ index.php [QSA,L]
```

---

## 4) PHP-FPM ‚Äî **principes rapides**

* **Pool** = groupe de workers PHP (fichier ex. `/etc/php/8.2/fpm/pool.d/www.conf`).
* **Socket** Unix (`/run/php/php8.2-fpm.sock`) ou TCP (`127.0.0.1:9000`).
* **pm = dynamic** (par d√©faut) : `pm.max_children` = nb max de processus ‚Üí **capacit√©**.
* **opcache** : activer pour de **gros gains** (chargements plus rapides).

üêß **Contr√¥les**

```bash
systemctl status php8.2-fpm
journalctl -u php8.2-fpm -e
# Erreurs PHP (selon config) :
tail -f /var/log/php8.2-fpm.log
```

---

## 5) S√©curit√© minimum c√¥t√© Apache/PHP

* **Ne jamais ex√©cuter** PHP dans `uploads/` :
  Apache (dans le vhost) :

  ```apache
  <Directory "/var/www/site/public/uploads">
    <FilesMatch "\.php$">
      Require all denied
      # ou: SetHandler None
    </FilesMatch>
  </Directory>
  ```
* **Permissions** : `www-data:www-data`, **644** fichiers / **755** dossiers.
* **ExposeHeaders** : √©viter d‚Äôexposer versions (`ServerTokens Prod` c√¥t√© Apache).
* **Limites** PHP (ini) : `upload_max_filesize`, `post_max_size`, `max_execution_time`.

---

## 6) Performance ‚Äî *quick wins*

* **opcache.enable=1** (PHP) ; **HTTP/2** activ√© ; **Keep-Alive** par d√©faut.
* **Cache-Control** long sur assets versionn√©s ; **no-cache** raisonnable sur HTML dynamiques.
* **Gzip/Brotli** (selon modules) pour HTML/JSON/CSS/JS.
* D√©livrer images **WebP/AVIF** si possible.
* **S√©parer** statique lourd (CDN) si besoin.

---

## 7) Diagnostic ‚Äî cas fr√©quents

* **502 Bad Gateway** : PHP-FPM **down** ou socket chemin faux ‚Üí `systemctl status php8.2-fpm`, v√©rifier `FilesMatch`.
* **404** alors que la route existe : r√®gle **rewrite** manquante ‚Üí voir `.htaccess`/`AllowOverride`.
* **T√©l√©versements √©chouent** : limites PHP (`post_max_size`, `upload_max_filesize`).
* **Lent** : opcache inactif, requ√™tes DB lentes ‚Üí profiler ou logs de requ√™tes.

---

## 8) Mini index PHP (test)

`/var/www/site/public/index.php`

```php
<?php
phpinfo(); // TEMPORAIRE pour tester FPM (√† supprimer ensuite)
```

> Tester : `curl -I http://site.local` (200) puis via navigateur pour voir **phpinfo()**.

---

## üß™ Exercices (avec attentes)

1. **Installer/activer** PHP-FPM et configurer le **vhost** ci-dessus (DocumentRoot `public/`, `FilesMatch` PHP).
2. Ajouter la **r√©√©criture** front controller (`.htaccess`), v√©rifier qu‚Äôune URL ‚Äúpropre‚Äù non fichier **arrive** sur `index.php`.
3. **D√©sactiver** l‚Äôex√©cution PHP dans `uploads/` et **prouver** qu‚Äôun `test.php` y est **interdit** (403).
4. Mettre des **headers cache** longs pour `*.css|*.js|*.png` et **v√©rifier** avec `curl -I`.
5. Activer **opcache**, red√©marrer FPM, expliquer le **b√©n√©fice** mesur√© (temps de 1er/2·µâ hit).

## üì¶ Livrables attendus

* Fichier **vhost** Apache + `.htaccess` (front controller).
* Captures de **tests** (`curl -I`, navigateur) et logs pertinents.
* Note **s√©curit√© & perf** (uploads non ex√©cutables, opcache, cache headers).

## ‚úÖ Check-list (DoD)

* [ ] Statique servi par **Apache** directement ; PHP via **FPM** seulement.
* [ ] Vhost **fonctionnel** (DocumentRoot `public/`, `FilesMatch` FPM, logs d√©di√©s).
* [ ] **Uploads** non ex√©cutables ; permissions saines (644/755).
* [ ] **Cache** assets correct, **opcache** activ√© ; URLs ‚Äúpropres‚Äù OK.

