---
title: 4. Services & ports
layout: home
nav_order: 4
parent: 7.3. Serveur Web
permalink: /deploiement/c7-3/services-ports-securite/
code: 7.3.4
competence: C7
autoformation: "C7.3"
ua: "7.3.U2"
duree_h: 1.5
objectif: "Piloter les services web (Apache, PHP-FPM), v√©rifier l‚Äôouverture des ports 80/443, appliquer un durcissement minimal (indexes, modules, headers, permissions) et documenter une proc√©dure de relance."
notions_nouvelles: ["service/systemctl", "binding", "ss (test d‚Äô√©coute)", "Options -Indexes", "ServerTokens/ServerSignature", "Headers s√©curit√© (HSTS, X-Frame-Options, X-Content-Type-Options)"]
fil_rouge: "Disponibilit√© HTTP/HTTPS et hygi√®ne de base pour blog/API"
livrable_chapitre: "Extrait vhost s√©curis√© (Options -Indexes + headers), captures `ss`/`curl -I`, proc√©dure de relance"
alimentation_prototype: "Serveur op√©rationnel (80/443) + vhost minimal ; v√©rif rapide `apachectl -t` puis `reload`"
alimentation_miniprojet: "Proc√©dure standard d√©marrage/relance et s√©curit√© minimale (droits, modules) pour exploitation"
---




# üìò Chapitre 7.3.4 ‚Äî Processus, service, port, s√©curit√© de base

## üìí Glossaire minute
- **Processus** : programme en cours d‚Äôex√©cution (ex. `apache2`, `php-fpm`).
- **Service (daemon)** : processus lanc√© en arri√®re-plan et **g√©r√©** par l‚ÄôOS (ex. `systemd`).
- **Port** : point d‚Äô√©coute r√©seau (HTTP **80**, HTTPS **443**).
- **Binding** : action d‚Äôun service qui ‚Äú√©coute‚Äù sur une IP:port (`0.0.0.0:80`, `::`:443).
- **Hardening** : mesures pour **r√©duire la surface d‚Äôattaque** (droits, modules, headers, pare-feu).
- **Principes minimaux** : *moindre privil√®ge*, *s√©paration des r√¥les*, *surface minimale*.

---

## üéØ Objectifs
- V√©rifier et piloter les **services** web (Apache, PHP-FPM).
- Contr√¥ler les **ports** ouverts et diagnostiquer un service **injoignable**.
- Mettre en place une **s√©curit√© de base** (droits, modules, index, headers).
- Documenter une **proc√©dure de d√©marrage/relance** + v√©rifications.

## ‚úÖ Pr√©-requis
- C7.3.1 (HTTP/codes/headers), C7.3.2 (TLS/HTTPS), C7.3.3 (Statique vs PHP-FPM).
- C7.2.6 (tests de port, pare-feu).

---

## 1) Processus & services ‚Äî piloter le serveur web

### 1.1 Apache (Debian/Ubuntu)
```bash
systemctl status apache2           # √©tat du service
sudo systemctl start apache2       # d√©marrer
sudo systemctl stop apache2        # arr√™ter
sudo systemctl restart apache2     # red√©marrer (interruption br√®ve)
sudo systemctl reload apache2      # recharger conf (sans couper)
sudo systemctl enable apache2      # activer au boot
sudo apachectl -t                  # valider la configuration
journalctl -u apache2 -e           # logs du service
````

### 1.2 PHP-FPM (adapter la version)

```bash
systemctl status php8.2-fpm
sudo systemctl restart php8.2-fpm
journalctl -u php8.2-fpm -e
```

### 1.3 RHEL/CentOS/Alma (Apache = `httpd`)

```bash
systemctl status httpd
sudo systemctl restart httpd
sudo httpd -t
journalctl -u httpd -e
```

> üîé **Bon r√©flexe** : apr√®s chaque modification de conf ‚Üí `apachectl/httpd -t` **puis** `reload`.

---

## 2) Ports & √©coute ‚Äî v√©rifier l‚Äôouverture

### 2.1 Contr√¥le local (Linux)

```bash
# Qui √©coute sur 80/443 ?
sudo ss -ltnp '( sport = :80 or sport = :443 )'
# Ouver¬≠ture sur IPv6 aussi ?
sudo ss -ltnp | grep -E '(:80|:443).*users'
```

### 2.2 Test depuis un client

```bash
curl -I http://SITE:80
curl -I https://SITE:443
# Windows
Test-NetConnection SITE -Port 80
```

**Interpr√©tation rapide**

* Pas d‚Äô√©coute locale ‚Üí service down / mauvaise conf vhost.
* √âcoute OK, mais client KO ‚Üí **pare-feu/NAT** (voir C7.2.6) ou DNS.

---

## 3) S√©curit√© de base ‚Äî **hardening minimal** Apache

### 3.1 Enlever l‚Äôindexation & limiter les infos serveur

Dans le vhost **ou** `apache2.conf` :

```apache
# Pas de listing de r√©pertoire
<Directory /var/www/site/public>
  Options -Indexes
</Directory>

# Masquer versions (dans conf globale Apache)
ServerTokens Prod
ServerSignature Off
```

### 3.2 Activer uniquement les modules n√©cessaires

```bash
# Debian/Ubuntu
apache2ctl -M                 # lister
sudo a2dismod status autoindex cgi cgid negotiation proxy_ftp
sudo a2enmod headers rewrite proxy proxy_fcgi http2 ssl
sudo systemctl reload apache2
```

> **Principe** : moins de modules = **moins** de surface d‚Äôattaque.

### 3.3 Isoler les ex√©cutions PHP

* Servir **PHP via FPM** seulement (cf. 7.3.3).
* Interdire PHP dans `uploads/` :

```apache
<Directory "/var/www/site/public/uploads">
  <FilesMatch "\.php$">
    Require all denied
  </FilesMatch>
</Directory>
```

### 3.4 R√©pertoires & permissions (Linux)

```bash
# Propri√©t√© et droits recommand√©s (lecture/exec pour www-data)
sudo chown -R www-data:www-data /var/www/site
find /var/www/site -type d -exec chmod 755 {} \;
find /var/www/site -type f -exec chmod 644 {} \;
```

> **Jamais** de `777`. S√©parer **code** (lecture) et **contenu mutable** (√©criture restreinte).

### 3.5 En-t√™tes utiles (s√©curit√© basique)

Dans le vhost :

```apache
# Emp√™cher le sniff MIME
Header always set X-Content-Type-Options "nosniff"
# Limiter l‚Äôinclusion en iframe (selon besoin)
Header always set X-Frame-Options "SAMEORIGIN"
# HSTS (si HTTPS stable; voir 7.3.2)
Header always set Strict-Transport-Security "max-age=15552000; includeSubDomains"
```

### 3.6 Nettoyage d‚Äôexpositions involontaires

* Ne pas exposer `.git/`, `.env`, `composer.json`, backups (`.zip`, `.bak`).
* D√©placer ces fichiers **hors** du `DocumentRoot` ou bloquer :

```apache
<Directory "/var/www/site/public">
  <FilesMatch "^(\.env|composer\.(json|lock)|.*\.(bak|sql|zip))$">
    Require all denied
  </FilesMatch>
</Directory>
```

---

## 4) Gestion des logs & rotation

* **access.log** / **error.log** par **vhost** (facilite le diagnostic).
* Rotation journali√®re/hebdo via **logrotate** (par d√©faut sur Debian/Ubuntu).
* Exemple de lecture cibl√©e :

```bash
tail -f /var/log/apache2/site_access.log
tail -f /var/log/apache2/site_error.log
grep -i " 404 " /var/log/apache2/site_access.log | tail
```

---

## 5) Pare-feu ‚Äî ouverture minimale

* Ouvrir **80** (HTTP) et **443** (HTTPS) c√¥t√© serveur.

```bash
# UFW (Debian/Ubuntu)
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw status

# firewalld (RHEL)
sudo firewall-cmd --add-service=http --permanent
sudo firewall-cmd --add-service=https --permanent
sudo firewall-cmd --reload
```

> √âviter d‚Äôexposer **autres ports** (PHP-FPM `:9000`, DB) sur Internet.

---

## 6) Proc√©dure standard ‚Äî d√©ployer & v√©rifier (üß© DoR ‚Üí DoD)

1. **Validation conf** : `apachectl -t` (**OK**).
2. **Reload** : `systemctl reload apache2`.
3. **√âcoute** : `ss -ltnp` (80/443 visibles).
4. **Reachability** : `curl -I http://‚Ä¶` / `https://‚Ä¶` (200/301).
5. **S√©curit√© base** :

   * `Options -Indexes` actif,
   * **headers** de s√©curit√© pr√©sents,
   * pas d‚Äôacc√®s √† `.env/.git`.
6. **Logs** : pas d‚Äôerreurs bloquantes dans `error.log`.

---

## 7) D√©pannage ‚Äî cas fr√©quents & correctifs

* **`apachectl -t` ERROR** ‚Üí faute de syntaxe / chemin de cert faux ‚Üí corriger et **reload**.
* **√âcoute sur 80 mais pas 443** ‚Üí module `ssl` non charg√© / vhost :443 absent.
* **`403 Forbidden`** inattendu ‚Üí droits Unix incorrects ou `Require all denied` dans un `<Directory>`.
* **`404` sur URL ‚Äúpropres‚Äù** ‚Üí r√©√©criture manquante (`mod_rewrite`, `.htaccess`, `AllowOverride All`).
* **`502 Bad Gateway`** c√¥t√© PHP ‚Üí FPM down ou mauvais `FilesMatch`/socket.
* **Directory listing** visible ‚Üí oublier `Options -Indexes`.

---

## üîß Cheatsheet (r√©cap express)

```bash
# Sant√© & relance
apachectl -t && sudo systemctl reload apache2
systemctl status apache2 php8.2-fpm

# Ports
sudo ss -ltnp '( sport = :80 or sport = :443 )'

# Tests
curl -I http://site.local
curl -I https://site.local

# S√©curit√©
# - Indexes off / ServerTokens Prod / ServerSignature Off
# - Headers: X-Content-Type-Options, X-Frame-Options, HSTS
# - Interdire PHP dans uploads/, masquer .env/.git
```

---

## üß™ Exercices (avec attentes)

1. **Durcir** un vhost existant : d√©sactiver **listing**, ajouter **headers**, v√©rifier avec `curl -I` et capture DevTools.
2. **Prouver** la non-exposition de `.env` & `.git` (test HTTP ‚Üí 403/404), expliquer la r√®gle appliqu√©e.
3. **D√©ployer** (reload) puis **v√©rifier** : `apachectl -t`, `ss -ltnp`, `curl -I`, logs d√©di√©s.
4. **Incident simul√©** : casser le chemin du socket FPM ‚Üí obtenir **502**, diagnostiquer et corriger.

## üì¶ Livrables attendus

* Extrait **vhost** final (s√©curit√© de base incluse) + sorties `curl -I`.
* Journal de **d√©ploiement & v√©rifications** (commandes + r√©sultats).
* Mini-rapport **incident & fix** (502/403/404) avec cause et correctif.

## ‚úÖ Check-list (DoD)

* [ ] Services **actifs** et d√©marrent au boot (`apache2`, `php-fpm`).
* [ ] Ports **80/443** **ouverts** et test√©s local/distant.
* [ ] **Listing d√©sactiv√©**, **headers** de s√©curit√© en place, fichiers sensibles **inaccessibles**.
* [ ] **Logs** par vhost et **rotation** op√©rationnelle ; proc√©dure de relance **document√©e**.
