---
title: 5. Logs & rotation
layout: home
nav_order: 5
parent: 7.3. Serveur Web
permalink: /http-principes/logs/
code: 7.3.5
competence: C7
autoformation: "C7.3"
ua: "7.3.U3"
duree_h: 1.5
objectif: "Lire, filtrer et corrÃ©ler les logs Apache avec rotation logrotate."
notions_nouvelles: ["access.log", "error.log", "LogFormat", "LogLevel", "Rotation", "GoAccess"]
fil_rouge: "Suivi des requÃªtes et erreurs sur blog/app"
livrable_chapitre: "Extraits vhost + commandes awk/grep + fichier logrotate"
alimentation_prototype: "Suivi codes et statuts pour debug rapide"
alimentation_miniprojet: "Logs sÃ©parÃ©s avec rotation pour exploitation"
---


# ðŸ“˜ Chapitre 7.3.5 â€” **Logs** dâ€™accÃ¨s/erreurs, rotation & lecture

## ðŸ“’ Glossaire minute
- **access.log** : journal des **requÃªtes** (qui, quoi, quand, statut, octets, UA).  
- **error.log** : journal des **Ã©vÃ©nements/erreurs** (niveau : error/warn/infoâ€¦).  
- **LogFormat/CustomLog** : format & destination des logs **dâ€™accÃ¨s**.  
- **ErrorLog/LogLevel** : fichier & niveau des logs **erreurs**.  
- **Rotation** : archivage rÃ©gulier des logs (`logrotate`) + **compression**.  
- **GoAccess** : analyseur temps rÃ©el/HTML (optionnel).

---

## ðŸŽ¯ Objectifs
- Savoir **oÃ¹** sont les logs, **comment ils sont formatÃ©s** et **comment les lire**.  
- Filtrer/compter **404/5xx**, IPs et URLs les plus actives.  
- Comprendre et **configurer la rotation** (taille/rythme).  
- CorrÃ©ler **access.log** et **error.log** pour diagnostiquer une panne.

## âœ… PrÃ©-requis
- C7.3.1 (codes HTTP, en-tÃªtes), C7.3.4 (processus/ports/sÃ©curitÃ©).  
- Confort ligne de commande (`grep`, `awk`, `tail`).

---

## 1) OÃ¹ sont les logs ? (Linux)

| Distro | AccÃ¨s | Erreurs |
|---|---|---|
| Debian/Ubuntu (Apache) | `/var/log/apache2/access.log` | `/var/log/apache2/error.log` |
| RHEL/CentOS/Alma (httpd) | `/var/log/httpd/access_log` | `/var/log/httpd/error_log` |

> Par **vhost**, vous pouvez dÃ©finir des fichiers dÃ©diÃ©s (recommandÃ©).

**Dans un vhost :**
```apache
ErrorLog  ${APACHE_LOG_DIR}/site_error.log
CustomLog ${APACHE_LOG_DIR}/site_access.log combined
````

---

## 2) Formats de log (Apache)

### 2.1 **Combined Log Format** (accÃ¨s)

DÃ©faut courant `combined` :

```
%h %l %u %t "%r" %>s %b "%{Referer}i" "%{User-agent}i"
```

Exemple :

```
203.0.113.5 - - [10/Oct/2025:13:55:36 +0100] "GET /img/logo.png HTTP/1.1" 200 5321 "https://site.tld/" "Mozilla/5.0 ..."
```

* `%h` IP client Â· `%t` date/heure Â· `%r` requÃªte Â· `%>s` **code** Â· `%b` octets Â· `Referer` Â· `User-Agent`.

### 2.2 **error.log**

Exemple :

```
[Sun Oct 12 14:32:52.123456 2025] [php:error] [pid 1234] [client 203.0.113.5:58310] PHP Fatal error: Uncaught ...
```

* **Niveaux** : `emerg, alert, crit, error, warn, notice, info, debug`.
* Ajuster le **niveau** :

```apache
LogLevel warn            # global
# LogLevel module:level
LogLevel php7:notice rewrite:trace3
```

---

## 3) Lire & filtrer vite (CLI)

### 3.1 Suivre en temps rÃ©el

```bash
tail -f /var/log/apache2/site_access.log
tail -f /var/log/apache2/site_error.log
# (less "follow") : less +F <fichier>
```

### 3.2 Top **codes HTTP**

```bash
awk '{print $9}' site_access.log | sort | uniq -c | sort -nr | head
```

### 3.3 Top **URLs** (chemins)

```bash
awk -F\" '{print $2}' site_access.log | awk '{print $2}' | sort | uniq -c | sort -nr | head
```

### 3.4 Top **IPs**

```bash
awk '{print $1}' site_access.log | sort | uniq -c | sort -nr | head
```

### 3.5 **404** rÃ©currents (fichiers manquants)

```bash
awk '$9 ~ /^404$/{print $7}' site_access.log | sort | uniq -c | sort -nr | head
```

### 3.6 Histogramme **par heure**

```bash
awk -F'[][]' '{split($2,a,":"); print a[1]":"a[2]":00"}' site_access.log \
| sort | uniq -c | sort -nr | head
```

### 3.7 RepÃ©rer une **attaque** (beaucoup de hits / IP)

```bash
awk '{print $1}' site_access.log | sort | uniq -c | sort -nr | head -20
```

> Astuce : combinez `grep` (prÃ©-filtre) + `awk`.
> Ex. : erreurs serveur **5xx** dâ€™aujourdâ€™hui :

```bash
grep " 5[0-9][0-9] " site_access.log | awk '{print $9,$7}' | head
```

---

## 4) **Rotation** (logrotate)

### 4.1 OÃ¹ ?

* Debian/Ubuntu : `/etc/logrotate.d/apache2`
* RHEL : `/etc/logrotate.d/httpd`

### 4.2 Exemple (pÃ©dagogique)

```conf
/var/log/apache2/*.log {
  weekly            # rotation hebdo (ou daily/size 50M)
  rotate 12         # garder 12 archives
  missingok
  notifempty
  compress
  delaycompress
  create 640 root adm
  sharedscripts
  postrotate
    /usr/sbin/apachectl -k graceful > /dev/null 2>/dev/null || true
  endscript
}
```

> **Objectif** : Ã©viter que les logs **gonflent** sans limite, conserver un **historique** compressÃ©.

---

## 5) CorrÃ©lation **access** â†” **error**

### 5.1 500 en hausse dans access.log

1. Lister les **URL 500** :

```bash
awk '$9 ~ /^5[0-9][0-9]$/{print $7}' site_access.log | sort | uniq -c | sort -nr | head
```

2. Chercher Ã  la **mÃªme heure** dans error.log :

```bash
grep "Oct 12 14:" site_error.log | tail -n +1
```

### 5.2 404 massifs (assets manquants)

* VÃ©rifier **DocumentRoot** / chemins dâ€™assets / **rÃ¨gles de rÃ©Ã©criture**.
* Ajouter **Cache-Control** correct pour statique (cf. 7.3.3).

### 5.3 Lenteurs

* Regarder `error.log` (PHP warnings, DB timeouts).
* Activer logs applicatifs (niveau **WARNING/ERROR**) et **opcache**.

---

## 6) GoAccess (optionnel mais pratique)

```bash
sudo apt install goaccess
goaccess /var/log/apache2/site_access.log --log-format=COMBINED -o report.html
# Ouvre report.html dans le navigateur (tableaux, 404, temps, user-agents)
```

---

## 7) Bonnes pratiques

* **Un log par vhost** (access/error) â†’ diagnostic **beaucoup** plus simple.
* **Horloge NTP** correcte â†’ corrÃ©lation fiable.
* **Masquer PII** si besoin (anonymiser IP, obfusquer IDs).
* **Rotation** testÃ©e (`logrotate -d` pour dry-run).
* **Permissions** : journaux lisibles par lâ€™Ã©quipe dâ€™exploitation uniquement.

---

## ðŸ”§ Cheatsheet

```bash
# Top codes
awk '{print $9}' access.log | sort | uniq -c | sort -nr | head
# Top URLs 404
awk '$9==404 {print $7}' access.log | sort | uniq -c | sort -nr | head
# Top IPs
awk '{print $1}' access.log | sort | uniq -c | sort -nr | head
# Suivi temps rÃ©el
tail -f error.log
# Rotation manuelle (forcer)
sudo logrotate -f /etc/logrotate.d/apache2
```

---

## ðŸ§ª Exercices (avec attentes)

1. **Isoler** les 10 **URLs** les plus demandÃ©es et les 10 **clients** les plus actifs.
2. **Lister** les 404 les plus frÃ©quentes et proposer un **correctif** (fichier manquant, rÃ¨gle rewrite, redirection).
3. **DÃ©tecter** un pic de **5xx** (plage horaire) et corrÃ©ler avec **error.log** (extraits).
4. **Configurer** une rotation **hebdomadaire** (12 archives, compression) et **prouver** son exÃ©cution (journal `logrotate`).

## ðŸ“¦ Livrables attendus

* Extraits **vhost** (CustomLog/ErrorLog/LogLevel) + sorties CLI (`awk/grep/tail`).
* Rapport **corrÃ©lation** (symptÃ´me â†’ indices access/error â†’ cause â†’ correctif).
* Fichier de **rotation** commentÃ© + capture `logrotate -d`.

## âœ… Check-list (DoD)

* [ ] Un **fichier de log par vhost** (accÃ¨s/erreurs).
* [ ] Je sais **filtrer** 404/5xx, **top IP/URLs** et **par heure**.
* [ ] La **rotation** est en place (compressÃ©e, testÃ©e).
* [ ] Je corrÃ¨le access/error pour **qualifier** rapidement un incident.
