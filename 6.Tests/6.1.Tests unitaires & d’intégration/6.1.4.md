---
title: 4. Environnement .env.testing
permalink: /tests-laravel/env-testing-refreshdatabase-sqlite/
layout: home
nav_order: 4
parent: 6.1.Tests unitaires & d‚Äôint√©gration
---

# üìò Chapitre 6.1.4 ‚Äî Environnement `.env.testing`, `RefreshDatabase`

## üìí Glossaire minute
- **`.env.testing`** : variables d‚Äôenvironnement **sp√©cifiques aux tests** (charg√©es √† la place de `.env`).
- **`RefreshDatabase`** : r√©initialise la **base** entre les tests (transactions/migrations).
- **`sqlite` in-memory** : base **√©ph√©m√®re** ultra-rapide (`:memory:`), recr√©√©e √† chaque test/process.

---

## üéØ Objectif
Configurer un environnement de test **isol√© et reproductible** :
1) un **`.env.testing`** propre,  
2) la **DB de test** (SQLite fichier ou m√©moire / MySQL),  
3) l‚Äôusage correct de **`RefreshDatabase`** (et variantes).

---

## 1) Cr√©er & remplir **`.env.testing`**
> √Ä la racine du projet (c√¥te-√†-c√¥te avec `.env`).

### Option A ‚Äî **SQLite ‚Äúfichier‚Äù** (simple et stable)
```env
APP_ENV=testing
APP_DEBUG=true
CACHE_DRIVER=array
QUEUE_CONNECTION=sync
SESSION_DRIVER=array
MAIL_MAILER=log

DB_CONNECTION=sqlite
DB_DATABASE=database/database.sqlite
DB_FOREIGN_KEYS=true
````

Cr√©er le fichier DB :

```bash
mkdir -p database && touch database/database.sqlite
```

### Option B ‚Äî **SQLite in-memory** (ultra-rapide)

```env
APP_ENV=testing
APP_DEBUG=true
CACHE_DRIVER=array
QUEUE_CONNECTION=sync
SESSION_DRIVER=array
MAIL_MAILER=log

DB_CONNECTION=sqlite
DB_DATABASE=:memory:
DB_FOREIGN_KEYS=true
```

> ‚ÑπÔ∏è **In-memory** migre **√† chaque test** (ou process parall√®le). Plus rapide mais migrations r√©p√©t√©es.

### Option C ‚Äî **MySQL** (ou MariaDB) d√©di√© test

```env
APP_ENV=testing
APP_DEBUG=true
CACHE_DRIVER=array
QUEUE_CONNECTION=sync
SESSION_DRIVER=array
MAIL_MAILER=log

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=laravel_test
DB_USERNAME=root
DB_PASSWORD=
```

> Cr√©ez manuellement `laravel_test` et donnez les droits √† l‚Äôutilisateur.

---

## 2) Lancer les tests (charge automatique de `.env.testing`)

```bash
php artisan test
# ou
vendor/bin/pest
```

Laravel charge **`.env.testing`** automatiquement (pas besoin de `--env=testing`).

---

## 3) `RefreshDatabase` vs alternatives

| Trait                | Quand l‚Äôutiliser   | Comment √ßa marche                                                                                     |
| -------------------- | ------------------ | ----------------------------------------------------------------------------------------------------- |
| **RefreshDatabase**  | Par d√©faut         | Utilise **transactions** si possible (SQLite fichier/MySQL). Sinon `migrate:fresh` avant chaque test. |
| DatabaseTransactions | Unit tr√®s DB-light | Wrappe chaque test dans une **transaction** (pas de `migrate:fresh`).                                 |
| DatabaseMigrations   | Cas sp√©cifiques    | Lance `migrate` **avant** et **rollback** **apr√®s** chaque test.                                      |

**Recommand√©** : `RefreshDatabase` (rapide, fiable).

---

## 4) Activer `RefreshDatabase` (Pest & PHPUnit)

### Pest ‚Äî par fichier

```php
<?php
use Illuminate\Foundation\Testing\RefreshDatabase;

uses(RefreshDatabase::class);

it('cr√©e un article', function () {
    \App\Models\Article::factory()->create();
    expect(\App\Models\Article::count())->toBe(1);
});
```

### PHPUnit ‚Äî par classe

```php
<?php
use Tests\TestCase;
use Illuminate\Foundation\Testing\RefreshDatabase;

class ArticleTest extends TestCase
{
    use RefreshDatabase;

    public function test_store(): void
    {
        \App\Models\Article::factory()->create();
        $this->assertDatabaseCount('articles', 1);
    }
}
```

---

## 5) **Seeder** pendant les tests (fixtures globales)

### a) Seeder global pour **toute** la suite

`tests/TestCase.php`

```php
<?php
namespace Tests;

use Illuminate\Foundation\Testing\TestCase as BaseTestCase;

abstract class TestCase extends BaseTestCase
{
    protected bool $seed = true; // active le seeding
    protected string $seeder = \Database\Seeders\DatabaseSeeder::class;
}
```

### b) Seeder **√† la demande** dans un test

```php
$this->seed(); // DatabaseSeeder par d√©faut
// ou
$this->seed(\Database\Seeders\RolesSeeder::class);
```

---

## 6) **Parallel Testing** (acc√©l√©rer la suite)

```bash
php artisan test --parallel --processes=4
```

* **SQLite fichier** : Laravel cr√©e `test-1.sqlite`, `test-2.sqlite`, ‚Ä¶
* **SQLite in-memory** : chaque process migre sa DB **en m√©moire**.
* **MySQL** : Laravel suffixe la DB par un **token** de process (config auto).

> En cas d‚Äôerreur de connexion, ajoutez `--recreate-databases`.

---

## 7) Exemples complets

### A) **Pest** + SQLite fichier

```php
<?php // tests/Feature/Api/ArticleIndexTest.php
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Testing\Fluent\AssertableJson;

uses(RefreshDatabase::class);

it('liste les articles JSON', function () {
    \App\Models\Article::factory()->count(3)->create();

    $this->getJson('/api/articles')
        ->assertOk()
        ->assertJson(fn (AssertableJson $json) =>
            $json->has('data', 3)->has('meta.current_page')->etc()
        );
});
```

### B) **PHPUnit** + SQLite in-memory

```php
<?php // tests/Feature/Auth/LoginTest.php
use Tests\TestCase;
use Illuminate\Foundation\Testing\RefreshDatabase;

class LoginTest extends TestCase
{
    use RefreshDatabase;

    public function test_login_json(): void
    {
        $user = \App\Models\User::factory()->create(['password' => bcrypt('secret')]);

        $this->postJson('/api/login', ['email' => $user->email, 'password' => 'secret'])
             ->assertOk()
             ->assertJsonPath('user.id', $user->id);
    }
}
```

---

## ‚úÖ Check-list (DoD)

* [ ] `.env.testing` pr√©sent, **sans** toucher √† `.env`.
* [ ] DB de test d√©di√©e (**SQLite fichier** recommand√©) ou **in-memory** si priorit√© vitesse.
* [ ] `RefreshDatabase` utilis√© sur les tests DB.
* [ ] Seeds contr√¥l√©s (global via `TestCase` ou ponctuels).
* [ ] Suite ex√©cutable en **parall√®le** sans conflits.

---

## ü©π D√©pannage

* **`Database (.../database.sqlite) does not exist`** ‚Üí cr√©ez le fichier : `touch database/database.sqlite`.
* **`No application encryption key`** ‚Üí `php artisan key:generate` (pas indispensable en pur API test).
* **`SQLSTATE[HY000] no such table`** ‚Üí oublie de `RefreshDatabase`/migrations non lanc√©es.
* **Conflits en parall√®le** ‚Üí privil√©giez **SQLite fichier** ou ajoutez `--recreate-databases`.
* **Cl√©s √©trang√®res SQLite** ignor√©es ‚Üí assurez `DB_FOREIGN_KEYS=true`.
* **Tests lents** en in-memory ‚Üí pr√©f√©rez **SQLite fichier** + **parallel** (migrations une fois par process).

---
