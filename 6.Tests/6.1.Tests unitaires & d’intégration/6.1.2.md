---
title: 2. Convention AAA
permalink: /tests-laravel/aaa-assertions/
layout: home
nav_order: 2
parent: 6.1.Tests unitaires & d’intégration
---

# 📘 Chapitre 6.1.2 — Convention **AAA** 

## 📒 Glossaire minute
- **AAA** : *Arrange* (préparer) → *Act* (agir) → *Assert* (vérifier).
- **SUT** (*System Under Test*) : la fonction/service que l’on teste.
- **Assertion** : vérification d’un résultat attendu (`assert*`, `expect()`).
- **Oracles** : valeurs/règles servant de référence (ex. JSON attendu).

---

## 🎯 Objectif
Savoir **structurer** chaque test en trois temps **AAA** et utiliser les **assertions clés** :
`assertTrue`, `assertEquals` et **assertions JSON** pour les réponses HTTP Laravel.

---

## 1) AAA appliqué à un test **unitaire** (fonction pure)

### ✨ Version Pest
```php
<?php // tests/Unit/SluggerTest.php

use Illuminate\Support\Str;

test('slugger transforme un titre en slug', function () {
    // Arrange
    $title = 'Bonjour le Monde !';
    $expected = 'bonjour-le-monde';

    // Act
    $slug = Str::slug($title);

    // Assert
    expect($slug)->toEqual($expected);   // équivalent à assertEquals
    expect(Str::startsWith($slug, 'bonjour'))->toBeTrue(); // assertTrue
});
````

### 🧪 Version PHPUnit

```php
<?php // tests/Unit/SluggerTest.php

use Illuminate\Support\Str;
use Tests\TestCase;

class SluggerTest extends TestCase
{
    public function test_slugger_transforme_un_titre_en_slug(): void
    {
        // Arrange
        $title = 'Bonjour le Monde !';
        $expected = 'bonjour-le-monde';

        // Act
        $slug = Str::slug($title);

        // Assert
        $this->assertEquals($expected, $slug);
        $this->assertTrue(Str::startsWith($slug, 'bonjour'));
    }
}
```

> **Conseil** : Une **action** principale par test. Si plusieurs asserts, qu’ils valident **la même idée** (pas 3 sujets différents).

---

## 2) AAA sur un test **Feature HTTP** (JSON d’API)

### ✨ Pest + assertions JSON Laravel

```php
<?php // tests/Feature/ArticleIndexTest.php

use Illuminate\Testing\Fluent\AssertableJson;

it('retourne la liste paginée des articles au format JSON', function () {
    // Arrange
    $articles = \App\Models\Article::factory()->count(2)->create();

    // Act
    $response = $this->getJson('/api/articles');

    // Assert
    $response->assertStatus(200)
        ->assertJson(fn (AssertableJson $json) =>
            $json->has('data', 2)
                 ->has('meta.current_page')
                 ->where('data.0.id', $articles[0]->id)
                 ->where('data.1.title', $articles[1]->title)
                 ->etc()
        )
        ->assertJsonFragment([
            'id' => $articles[0]->id,
        ]); // vérifie la présence d’un fragment JSON
});
```

### 🧪 PHPUnit équivalent

```php
<?php // tests/Feature/ArticleIndexTest.php

use Illuminate\Testing\Fluent\AssertableJson;
use Tests\TestCase;

class ArticleIndexTest extends TestCase
{
    public function test_retourne_la_liste_paginee_des_articles_en_json(): void
    {
        // Arrange
        $articles = \App\Models\Article::factory()->count(2)->create();

        // Act
        $response = $this->getJson('/api/articles');

        // Assert
        $response->assertStatus(200);
        $response->assertJson(fn (AssertableJson $json) =>
            $json->has('data', 2)
                 ->has('meta.current_page')
                 ->where('data.0.id', $articles[0]->id)
                 ->where('data.1.title', $articles[1]->title)
                 ->etc()
        );
        $response->assertJsonFragment(['id' => $articles[0]->id]);
    }
}
```

> **Rappels utiles** :
>
> * `assertJsonPath('data.0.title', '...')` pour une valeur précise.
> * `assertExactJson([...])` si le **JSON complet** doit correspondre (strict).
> * `assertJsonMissing([...])` pour s’assurer qu’un fragment **n’existe pas**.

---

## 3) **Datasets** (Pest) pour couvrir des cas rapidement

```php
<?php // tests/Unit/PasswordStrengthTest.php

dataset('passwords', [
    ['Abcdef12', true],
    ['short1',   false],
    ['NOLOWER12', false],
]);

test('vérifie la robustesse du mot de passe', function (string $pwd, bool $expected) {
    // Arrange
    $isStrong = fn (string $p) =>
        strlen($p) >= 8
        && preg_match('/[a-z]/', $p)
        && preg_match('/[A-Z]/', $p)
        && preg_match('/\d/', $p);

    // Act
    $result = $isStrong($pwd);

    // Assert
    expect($result)->toBe($expected); // assertTrue/False implicites
})->with('passwords');
```

---

## 4) **Cheatsheet** d’assertions courantes

### ✅ Valeurs / types

* **Pest** : `expect($x)->toBeTrue()`, `toBeFalse()`, `toEqual($y)`, `toBe($y)` (strict), `toBeNull()`, `toContain('a')`.
* **PHPUnit** : `$this->assertTrue($x)`, `assertFalse`, `assertEquals($y, $x)`, `assertSame($y, $x)`, `assertNull($x)`, `assertContains()`.

### ✅ HTTP / JSON (Laravel)

* `assertStatus(200)`, `assertOk()`, `assertCreated()`.
* `assertJson([...])`, `assertExactJson([...])`, `assertJsonFragment([...])`.
* `assertJsonPath('data.0.id', 123)`, `assertJsonMissing([...])`.
* `assertSee('texte')`, `assertViewHas('var')` (pour routes **web**).

---

## 5) Patron AAA (gabarit à copier)

```php
<?php
test('comportement clair à décrire', function () {
    // Arrange
    // ... état / données d’entrée

    // Act
    // ... action sur le SUT (une seule principale)

    // Assert
    // ... assertions ciblées sur CE comportement
});
```

---

## ✅ Check-list (DoD)

* [ ] Chaque test est organisé en **Arrange / Act / Assert** (commentaires ou blocs).
* [ ] Les assertions valident **un seul comportement** par test.
* [ ] Usage correct de `assertTrue`, `assertEquals` et des **assertions JSON**.
* [ ] Noms **explicites** : décrire le **comportement** (pas l’implémentation).

---

## 🩹 Dépannage

* **“No tests executed”** : nom de fichier invalide (`*Test.php`) ou fonction Pest non `test()/it()`.
* **JSON fragile** : préférez `assertJsonFragment`/`assertJsonPath` plutôt que `assertExactJson`.
* **Tests lents** : ce sont probablement des tests **Feature**. Déplacer la logique pure en **Unit**.

---

## 🧪 Exercices

1. Écrire un test **unitaire** AAA pour une fonction `sum(int...$n)` avec `assertEquals`.
2. Écrire un test **Feature** AAA pour `POST /api/articles` avec `assertStatus(201)` et `assertJsonFragment(['title' => '...'])`.
3. Convertir un test PHPUnit existant en **Pest** (mêmes Arrange/Act/Assert).

