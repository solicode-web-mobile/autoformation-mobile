---
title: 6. Factories & seed
layout: home
nav_order: 6
parent: 6.1.Tests unitaires & d‚Äôint√©gration
permalink: /tests-laravel/factories/
code: 6.1.6
competence: C6
autoformation: "C6.1"
ua: "6.1.U2"
duree_h: 1.5
objectif: "G√©n√©rer des donn√©es r√©alistes et li√©es via Model Factories et un seed minimal."
notions_nouvelles: ["HasFactory", "Factory", "state()", "for()/has()/hasAttached()", "Seeder", "Sequence"]
fil_rouge: "Jeu de donn√©es r√©aliste pour l‚ÄôAPI du blog"
livrable_chapitre: "Factories User/Article/Comment (+ √©tats) et DatabaseSeeder minimal"
alimentation_prototype: "Donn√©es de test stables pour l‚ÄôUI et l‚ÄôAPI"
alimentation_miniprojet: "Seeds d√©terministes pour d√©mos/tests"
---


# üìò Chapitre 6.1.6 ‚Äî **Model Factories** & seed minimal

## üìí Glossaire minute
- **`HasFactory`** : trait √† ajouter sur chaque **Model** pour activer `Model::factory()`.
- **Factory** : classe (dans `database/factories/`) qui **g√©n√®re** des attributs r√©alistes (Faker).
- **√âtat** (*state*) : variante nomm√©e d‚Äôune factory (`published()`, `draft()`‚Ä¶).
- **Relations** : `for()` (belongsTo), `has()` (hasMany), `hasAttached()` (belongsToMany).
- **Seeder** : classe qui **remplit** la DB de test/d√©mo.

---

## üéØ Objectif
Savoir :
1) cr√©er des **factories** propres pour vos mod√®les,  
2) g√©n√©rer des **donn√©es li√©es** (utilisateurs ‚Üí articles ‚Üí commentaires),  
3) d√©finir des **√©tats** utiles,  
4) pr√©parer un **seed minimal** pour vos tests/d√©mo.

---

## 1) Activer `HasFactory` sur vos mod√®les

```php
<?php // app/Models/Article.php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Factories\HasFactory;

class Article extends Model
{
    use HasFactory;

    protected $fillable = ['user_id', 'title', 'body', 'published_at'];
    // relations :
    public function user()     { return $this->belongsTo(User::class); }
    public function comments() { return $this->hasMany(Comment::class); }
    public function tags()     { return $this->belongsToMany(Tag::class)->withTimestamps(); }
}
````

> Faites pareil sur `User`, `Comment`, `Tag`.

---

## 2) G√©n√©rer les **factories**

```bash
php artisan make:factory UserFactory --model=User
php artisan make:factory ArticleFactory --model=Article
php artisan make:factory CommentFactory --model=Comment
php artisan make:factory TagFactory --model=Tag
```

### Exemple : `UserFactory`

```php
<?php // database/factories/UserFactory.php
namespace Database\Factories;

use Illuminate\Database\Eloquent\Factories\Factory;
use Illuminate\Support\Str;

class UserFactory extends Factory
{
    public function definition(): array
    {
        return [
            'name' => $this->faker->name(),
            'email' => $this->faker->unique()->safeEmail(),
            'email_verified_at' => now(),
            'password' => bcrypt('password'), // pour tests
            'remember_token' => Str::random(10),
        ];
    }
}
```

### Exemple : `ArticleFactory` (+ √©tats)

```php
<?php // database/factories/ArticleFactory.php
namespace Database\Factories;

use App\Models\User;
use Illuminate\Database\Eloquent\Factories\Factory;

class ArticleFactory extends Factory
{
    public function definition(): array
    {
        return [
            'user_id' => User::factory(), // belongsTo implicite
            'title' => $this->faker->unique()->sentence(4),
            'body'  => $this->faker->paragraphs(3, true),
            'published_at' => null,
        ];
    }

    public function published(): static
    {
        return $this->state(fn () => ['published_at' => now()]);
    }

    public function draft(): static
    {
        return $this->state(fn () => ['published_at' => null]);
    }
}
```

### Exemple : `CommentFactory`

```php
<?php // database/factories/CommentFactory.php
namespace Database\Factories;

use App\Models\Article;
use App\Models\User;
use Illuminate\Database\Eloquent\Factories\Factory;

class CommentFactory extends Factory
{
    public function definition(): array
    {
        return [
            'article_id' => Article::factory(),
            'user_id'    => User::factory(),
            'content'    => $this->faker->sentence(),
        ];
    }
}
```

### Exemple : `TagFactory`

```php
<?php // database/factories/TagFactory.php
namespace Database\Factories;

use Illuminate\Database\Eloquent\Factories\Factory;

class TagFactory extends Factory
{
    public function definition(): array
    {
        return ['name' => $this->faker->unique()->word()];
    }
}
```

---

## 3) Utiliser `factory()` en **tests**

### Cr√©er vs *faker* sans persister

```php
User::factory()->create(); // en DB
User::factory()->make();   // en m√©moire (pas en DB)
```

### Relations rapides

```php
// 1 user + 3 articles rattach√©s
User::factory()
    ->has(\App\Models\Article::factory()->count(3))
    ->create();

// 1 article rattach√© √† un user pr√©cis
$u = User::factory()->create();
Article::factory()->for($u)->create();

// Article avec 2 commentaires
Article::factory()
    ->has(\App\Models\Comment::factory()->count(2))
    ->create();
```

### belongsToMany (tags)

```php
Article::factory()
    ->hasAttached(
        \App\Models\Tag::factory()->count(3),
        ['priority' => 1],      // attributs pivot
        'tags'                  // nom de la relation si ambigu
    )
    ->create();
```

### √âtats (published/draft)

```php
Article::factory()->published()->create();
Article::factory()->draft()->count(2)->create();
```

### S√©quences (alternance d‚Äôattributs)

```php
use Illuminate\Database\Eloquent\Factories\Sequence;

Article::factory()
    ->count(4)
    ->state(new Sequence(
        ['published_at' => now()],
        ['published_at' => null],
    ))
    ->create();
```

### Hooks de factory (post-traitement)

```php
Article::factory()
    ->afterCreating(function ($article) {
        $article->tags()->attach(
            \App\Models\Tag::factory()->count(2)->create()
        );
    })
    ->create();
```

---

## 4) **Seed minimal** (donn√©es de d√©mo)

### `DatabaseSeeder`

```php
<?php // database/seeders/DatabaseSeeder.php
namespace Database\Seeders;

use Illuminate\Database\Seeder;
use App\Models\User;
use App\Models\Article;
use App\Models\Tag;

class DatabaseSeeder extends Seeder
{
    public function run(): void
    {
        $tags = Tag::factory()->count(5)->create();

        User::factory()
            ->count(3)
            ->has(
                Article::factory()
                    ->count(3)
                    ->has(\App\Models\Comment::factory()->count(2))
                    ->afterCreating(fn ($a) => $a->tags()->attach($tags->random(2)))
            )
            ->create();
    }
}
```

### Lancer le seed (local/d√©mo)

```bash
php artisan migrate:fresh --seed
# ou
php artisan db:seed
```

### Seed **pendant les tests** (option)

```php
<?php // tests/TestCase.php
namespace Tests;

use Illuminate\Foundation\Testing\TestCase as BaseTestCase;

abstract class TestCase extends BaseTestCase
{
    protected bool $seed = false; // true pour ensemencer chaque test
    protected string $seeder = \Database\Seeders\DatabaseSeeder::class;
}
```

> Recommand√© : **seeder d√©di√© aux tests** (l√©ger, d√©terministe), ex. `TestsSeeder` avec peu d‚Äôobjets.

---

## 5) Exemples **Feature** avec factories

```php
<?php // tests/Feature/Api/ArticleShowTest.php

use Illuminate\Foundation\Testing\RefreshDatabase;

uses(RefreshDatabase::class);

it('retourne un article publi√©', function () {
    $article = \App\Models\Article::factory()->published()->create();

    $this->getJson("/api/articles/{$article->id}")
         ->assertOk()
         ->assertJsonPath('id', $article->id);
});

it('liste les articles avec commentaires & tags', function () {
    \App\Models\Article::factory()
        ->has(\App\Models\Comment::factory()->count(2))
        ->hasAttached(\App\Models\Tag::factory()->count(2))
        ->count(3)
        ->create();

    $this->getJson('/api/articles')
         ->assertOk()
         ->assertJson(fn ($j) => $j.has('data', 3)->etc());
});
```

---

## 6) Bonnes pratiques

* **Factories = v√©rit√© de test** : pas de donn√©es ‚Äúmagiques‚Äù. Tous les champs requis **remplis**.
* **√âtats nomm√©s** pour √©viter la duplication (`published()`, `admin()`, `premium()`‚Ä¶).
* **Peupler via relations** (`for`, `has`, `hasAttached`) plut√¥t que g√©rer manuellement les IDs.
* **Helpers** : cr√©ez des **m√©thodes** sur les factories (`author()`, `longBody()`) si vous les r√©utilisez.
* **Seeds** de test **petits & d√©terministes** (pas 10k lignes al√©atoires).

---

## ‚úÖ Check-list (DoD)

* [ ] Tous les mod√®les concern√©s utilisent **`HasFactory`**.
* [ ] Factories cr√©√©es et **fonctionnelles** (`create()` / `make()`).
* [ ] **Relations** g√©n√©r√©es par `for` / `has` / `hasAttached`.
* [ ] **√âtats** utiles d√©finis (et test√©s).
* [ ] **Seeder minimal** op√©rationnel (`migrate:fresh --seed`).

---

## ü©π D√©pannage

* **`Class ...Factory not found`** ‚Üí ex√©cuter `composer dump-autoload`; v√©rifier namespace `Database\Factories`.
* **Violation de cl√© √©trang√®re** ‚Üí utilisez `for(Model::factory())` ou cr√©ez d‚Äôabord la ressource parente.
* **`MassAssignmentException`** ‚Üí ajuster `$fillable`/`$guarded` sur le mod√®le ou passer par des relations.
* **Donn√©es non r√©alistes** ‚Üí r√©visez la `definition()` (emails uniques, titres vari√©s).
* **Lents en seed** ‚Üí r√©duisez les `count()` et √©vitez les callbacks lourds dans les factories.

---

## üß™ Exercices

1. Ajouter un √©tat `featured()` sur `ArticleFactory` (`featured = true`) et tester un **filtre** `GET /api/articles?featured=1`.
2. Cr√©er un seeder **TestsSeeder** (3 users, 5 articles, 2 tags/arti) et l‚Äôactiver **seulement** dans `tests/TestCase.php`.
3. √âcrire un test qui cr√©e **1 user** avec **2 articles publi√©s** + **3 commentaires** chacun (en **une** cha√Æne factory).

