---
title: 5. Tests HTTP (web/API) 
layout: home
permalink: /tests-laravel/tests-http/
nav_order: 5
parent: 6.1.Tests unitaires & d’intégration
---

# 📘 Chapitre 6.1.5 — Tests **HTTP**

## 📒 Glossaire minute
- **`get/post/...`** : helpers Laravel pour simuler des requêtes HTTP (web **ou** API).
- **`assertStatus`** : vérifie le **code** HTTP (200, 201, 302, 403, 404, 422…).
- **`assertViewHas` / `assertViewIs`** : vérifient la **vue** et ses **données** (routes web).
- **`assertJson*`** : vérifient le **JSON** retourné (routes API/JSON).

---

## 🎯 Objectif
Écrire des tests **Feature** pour routes **web** et **API** : faire des `GET/POST`, vérifier les **statuts**, le **contenu de vue** et la **structure JSON**.

---

## ✅ Pré-requis
- **`.env.testing`** configuré (voir 6.1.4) + `RefreshDatabase`.
- **Factories** pour créer des modèles rapidement (voir 6.1.6).

---

## 1) Routes **web** : `get()`, `post()`, `assertStatus`, `assertViewHas`

### 🔹 Exemple Pest — page d’accueil (liste d’articles)
```php
<?php // tests/Feature/Web/HomepageTest.php

use App\Models\Article;
use Illuminate\Foundation\Testing\RefreshDatabase;

uses(RefreshDatabase::class);

it('affiche la liste d’articles dans la vue home', function () {
    Article::factory()->count(3)->create();

    $response = $this->get('/');

    $response->assertStatus(200)
             ->assertViewIs('home')
             ->assertViewHas('articles', fn ($c) => count($c) === 3);
});
````

### 🔹 Exemple PHPUnit — création (POST) + redirection

```php
<?php // tests/Feature/Web/ArticleStoreTest.php

use Tests\TestCase;
use Illuminate\Foundation\Testing\RefreshDatabase;
use App\Models\User;

class ArticleStoreTest extends TestCase
{
    use RefreshDatabase;

    public function test_store_redirige_vers_index(): void
    {
        $user = User::factory()->create();
        $payload = ['title' => 'Hello', 'body' => 'World'];

        $response = $this->actingAs($user)->post('/articles', $payload);

        $response->assertStatus(302)                 // redirection
                 ->assertRedirect(route('articles.index'));

        $this->assertDatabaseHas('articles', ['title' => 'Hello']);
    }
}
```

> ℹ️ Si votre route est protégée par des middlewares (auth, CSRF…), utilisez `actingAs($user)` pour l’authentification.
> En cas de problème CSRF en **web**, vous pouvez **temporairement** :
> `use App\Http\Middleware\VerifyCsrfToken; $this->withoutMiddleware(VerifyCsrfToken::class);`

---

## 2) Routes **API** (JSON) : `getJson()`, `postJson()`, `assertJson*`

### 🔹 Liste paginée JSON (Pest)

```php
<?php // tests/Feature/Api/ArticleIndexTest.php

use App\Models\Article;
use Illuminate\Testing\Fluent\AssertableJson;
use Illuminate\Foundation\Testing\RefreshDatabase;

uses(RefreshDatabase::class);

it('retourne une liste paginée en JSON', function () {
    Article::factory()->count(2)->create();

    $this->getJson('/api/articles')
        ->assertOk()
        ->assertJson(fn (AssertableJson $json) =>
            $json->has('data', 2)
                 ->has('meta.current_page')
                 ->whereType('data.0.id', 'integer')
                 ->etc()
        );
});
```

### 🔹 Création JSON + validation (PHPUnit)

```php
<?php // tests/Feature/Api/ArticleStoreJsonTest.php

use Tests\TestCase;
use Illuminate\Foundation\Testing\RefreshDatabase;
use App\Models\User;

class ArticleStoreJsonTest extends TestCase
{
    use RefreshDatabase;

    public function test_store_json_valide(): void
    {
        $u = User::factory()->create();
        $payload = ['title' => 'Nouvel article', 'body' => 'Texte'];

        $this->actingAs($u)
             ->postJson('/api/articles', $payload)
             ->assertCreated()
             ->assertJsonFragment(['title' => 'Nouvel article']);
    }

    public function test_store_json_invalide_422(): void
    {
        $u = User::factory()->create();

        $this->actingAs($u)
             ->postJson('/api/articles', ['title' => ''])  // manque 'body'
             ->assertStatus(422)
             ->assertJsonValidationErrors(['title', 'body']);
    }
}
```

---

## 3) Filtrage, paramètres & headers

### 🔹 Query string & `assertJsonPath`

```php
<?php // tests/Feature/Api/ArticleFilterTest.php

use App\Models\Article;
use Illuminate\Foundation\Testing\RefreshDatabase;

uses(RefreshDatabase::class);

it('filtre par tag', function () {
    Article::factory()->create(['title' => 'PHP', 'tags' => ['php']]);
    Article::factory()->create(['title' => 'JS',  'tags' => ['js']]);

    $this->getJson('/api/articles?tag=php')
         ->assertOk()
         ->assertJsonPath('data.0.title', 'PHP');
});
```

### 🔹 Headers JSON personnalisés

```php
$this->withHeaders(['Accept' => 'application/json'])
     ->get('/api/secure')  // route défensive qui vérifie Accept
     ->assertOk();
```

---

## 4) Web **vs** API : erreurs & assertions

| Cas                     | Web (HTML)                                           | API (JSON)                                                    |
| ----------------------- | ---------------------------------------------------- | ------------------------------------------------------------- |
| **Validation** invalide | `assertSessionHasErrors(['title'])`                  | `assertStatus(422)` + `assertJsonValidationErrors(['title'])` |
| **Redirection**         | `assertRedirect(route('...'))` / `assertStatus(302)` | Souvent **201/200** sans redirect                             |
| **Contenu**             | `assertSee('texte')`, `assertViewHas()`              | `assertJson*`, `assertJsonPath()`, `assertExactJson()`        |
| **Auth/Policies**       | `actingAs($user)` + `assertForbidden()`/`assertOk()` | idem + statuts 401/403                                        |

### 🔹 Exemple Web — validation session

```php
$response = $this->post('/articles', ['title' => '']); // body manquant
$response->assertStatus(302)
         ->assertSessionHasErrors(['title', 'body']);
```

---

## 5) Cheatsheet rapide

```php
// WEB
$this->get('/')->assertOk()->assertViewIs('home');
$this->post('/articles', [/*...*/])->assertRedirect(route('articles.index'));
$this->assertDatabaseHas('articles', ['title' => 'Hello']);

// API JSON
$this->getJson('/api/articles')->assertOk()->assertJsonStructure(['data', 'meta']);
$this->postJson('/api/articles', [/*...*/])->assertCreated()->assertJsonFragment(['title' => 'Hello']);
$this->putJson('/api/articles/1', [/*...*/])->assertOk();
$this->deleteJson('/api/articles/1')->assertNoContent(); // 204

// Divers
$this->withHeaders(['Accept' => 'application/json'])->get('/api/secure');
$this->actingAs($user)->get('/dashboard')->assertOk();
```

---

## ✅ Check-list (DoD)

* [ ] Au moins **1 test web** (`get/post`) avec `assertStatus` **et** `assertViewHas`.
* [ ] Au moins **1 test API** (`getJson/postJson`) avec `assertJson*`.
* [ ] Cas de **validation** : `assertSessionHasErrors` (web) ou `assertJsonValidationErrors` (API).
* [ ] **Factories** utilisées + `RefreshDatabase` actif.

---

## 🩹 Dépannage

* **302 inattendu** → authentifiez-vous (`actingAs`) ou vérifiez vos middlewares.
* **422 en API** → charge utile invalide : vérifiez les **règles** de validation.
* **`assertViewHas` échoue** → le **nom** de variable passé à la vue ne correspond pas (`return view(..., ['articles' => $collection])`).
* **JSON fragile** → préférez `assertJsonPath`/`assertJsonFragment` à `assertExactJson` (trop strict).

---

