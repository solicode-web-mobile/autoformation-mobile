---
title: 5. Tests HTTP (web/API) 
layout: home
permalink: /tests-laravel/tests-http/
nav_order: 5
parent: 6.1.Tests unitaires & dâ€™intÃ©gration
---

# ğŸ“˜ Chapitre 6.1.5 â€” Tests **HTTP**

## ğŸ“’ Glossaire minute
- **`get/post/...`** : helpers Laravel pour simuler des requÃªtes HTTP (web **ou** API).
- **`assertStatus`** : vÃ©rifie le **code** HTTP (200, 201, 302, 403, 404, 422â€¦).
- **`assertViewHas` / `assertViewIs`** : vÃ©rifient la **vue** et ses **donnÃ©es** (routes web).
- **`assertJson*`** : vÃ©rifient le **JSON** retournÃ© (routes API/JSON).

---

## ğŸ¯ Objectif
Ã‰crire des tests **Feature** pour routes **web** et **API** : faire des `GET/POST`, vÃ©rifier les **statuts**, le **contenu de vue** et la **structure JSON**.

---

## âœ… PrÃ©-requis
- **`.env.testing`** configurÃ© (voir 6.1.4) + `RefreshDatabase`.
- **Factories** pour crÃ©er des modÃ¨les rapidement (voir 6.1.6).

---

## 1) Routes **web** : `get()`, `post()`, `assertStatus`, `assertViewHas`

### ğŸ”¹ Exemple Pest â€” page dâ€™accueil (liste dâ€™articles)
```php
<?php // tests/Feature/Web/HomepageTest.php

use App\Models\Article;
use Illuminate\Foundation\Testing\RefreshDatabase;

uses(RefreshDatabase::class);

it('affiche la liste dâ€™articles dans la vue home', function () {
    Article::factory()->count(3)->create();

    $response = $this->get('/');

    $response->assertStatus(200)
             ->assertViewIs('home')
             ->assertViewHas('articles', fn ($c) => count($c) === 3);
});
````

### ğŸ”¹ Exemple PHPUnit â€” crÃ©ation (POST) + redirection

```php
<?php // tests/Feature/Web/ArticleStoreTest.php

use Tests\TestCase;
use Illuminate\Foundation\Testing\RefreshDatabase;
use App\Models\User;

class ArticleStoreTest extends TestCase
{
    use RefreshDatabase;

    public function test_store_redirige_vers_index(): void
    {
        $user = User::factory()->create();
        $payload = ['title' => 'Hello', 'body' => 'World'];

        $response = $this->actingAs($user)->post('/articles', $payload);

        $response->assertStatus(302)                 // redirection
                 ->assertRedirect(route('articles.index'));

        $this->assertDatabaseHas('articles', ['title' => 'Hello']);
    }
}
```

> â„¹ï¸ Si votre route est protÃ©gÃ©e par des middlewares (auth, CSRFâ€¦), utilisez `actingAs($user)` pour lâ€™authentification.
> En cas de problÃ¨me CSRF en **web**, vous pouvez **temporairement** :
> `use App\Http\Middleware\VerifyCsrfToken; $this->withoutMiddleware(VerifyCsrfToken::class);`

---

## 2) Routes **API** (JSON) : `getJson()`, `postJson()`, `assertJson*`

### ğŸ”¹ Liste paginÃ©e JSON (Pest)

```php
<?php // tests/Feature/Api/ArticleIndexTest.php

use App\Models\Article;
use Illuminate\Testing\Fluent\AssertableJson;
use Illuminate\Foundation\Testing\RefreshDatabase;

uses(RefreshDatabase::class);

it('retourne une liste paginÃ©e en JSON', function () {
    Article::factory()->count(2)->create();

    $this->getJson('/api/articles')
        ->assertOk()
        ->assertJson(fn (AssertableJson $json) =>
            $json->has('data', 2)
                 ->has('meta.current_page')
                 ->whereType('data.0.id', 'integer')
                 ->etc()
        );
});
```

### ğŸ”¹ CrÃ©ation JSON + validation (PHPUnit)

```php
<?php // tests/Feature/Api/ArticleStoreJsonTest.php

use Tests\TestCase;
use Illuminate\Foundation\Testing\RefreshDatabase;
use App\Models\User;

class ArticleStoreJsonTest extends TestCase
{
    use RefreshDatabase;

    public function test_store_json_valide(): void
    {
        $u = User::factory()->create();
        $payload = ['title' => 'Nouvel article', 'body' => 'Texte'];

        $this->actingAs($u)
             ->postJson('/api/articles', $payload)
             ->assertCreated()
             ->assertJsonFragment(['title' => 'Nouvel article']);
    }

    public function test_store_json_invalide_422(): void
    {
        $u = User::factory()->create();

        $this->actingAs($u)
             ->postJson('/api/articles', ['title' => ''])  // manque 'body'
             ->assertStatus(422)
             ->assertJsonValidationErrors(['title', 'body']);
    }
}
```

---

## 3) Filtrage, paramÃ¨tres & headers

### ğŸ”¹ Query string & `assertJsonPath`

```php
<?php // tests/Feature/Api/ArticleFilterTest.php

use App\Models\Article;
use Illuminate\Foundation\Testing\RefreshDatabase;

uses(RefreshDatabase::class);

it('filtre par tag', function () {
    Article::factory()->create(['title' => 'PHP', 'tags' => ['php']]);
    Article::factory()->create(['title' => 'JS',  'tags' => ['js']]);

    $this->getJson('/api/articles?tag=php')
         ->assertOk()
         ->assertJsonPath('data.0.title', 'PHP');
});
```

### ğŸ”¹ Headers JSON personnalisÃ©s

```php
$this->withHeaders(['Accept' => 'application/json'])
     ->get('/api/secure')  // route dÃ©fensive qui vÃ©rifie Accept
     ->assertOk();
```

---

## 4) Web **vs** API : erreurs & assertions

| Cas                     | Web (HTML)                                           | API (JSON)                                                    |
| ----------------------- | ---------------------------------------------------- | ------------------------------------------------------------- |
| **Validation** invalide | `assertSessionHasErrors(['title'])`                  | `assertStatus(422)` + `assertJsonValidationErrors(['title'])` |
| **Redirection**         | `assertRedirect(route('...'))` / `assertStatus(302)` | Souvent **201/200** sans redirect                             |
| **Contenu**             | `assertSee('texte')`, `assertViewHas()`              | `assertJson*`, `assertJsonPath()`, `assertExactJson()`        |
| **Auth/Policies**       | `actingAs($user)` + `assertForbidden()`/`assertOk()` | idem + statuts 401/403                                        |

### ğŸ”¹ Exemple Web â€” validation session

```php
$response = $this->post('/articles', ['title' => '']); // body manquant
$response->assertStatus(302)
         ->assertSessionHasErrors(['title', 'body']);
```

---

## 5) Cheatsheet rapide

```php
// WEB
$this->get('/')->assertOk()->assertViewIs('home');
$this->post('/articles', [/*...*/])->assertRedirect(route('articles.index'));
$this->assertDatabaseHas('articles', ['title' => 'Hello']);

// API JSON
$this->getJson('/api/articles')->assertOk()->assertJsonStructure(['data', 'meta']);
$this->postJson('/api/articles', [/*...*/])->assertCreated()->assertJsonFragment(['title' => 'Hello']);
$this->putJson('/api/articles/1', [/*...*/])->assertOk();
$this->deleteJson('/api/articles/1')->assertNoContent(); // 204

// Divers
$this->withHeaders(['Accept' => 'application/json'])->get('/api/secure');
$this->actingAs($user)->get('/dashboard')->assertOk();
```

---

## âœ… Check-list (DoD)

* [ ] Au moins **1 test web** (`get/post`) avec `assertStatus` **et** `assertViewHas`.
* [ ] Au moins **1 test API** (`getJson/postJson`) avec `assertJson*`.
* [ ] Cas de **validation** : `assertSessionHasErrors` (web) ou `assertJsonValidationErrors` (API).
* [ ] **Factories** utilisÃ©es + `RefreshDatabase` actif.

---

## ğŸ©¹ DÃ©pannage

* **302 inattendu** â†’ authentifiez-vous (`actingAs`) ou vÃ©rifiez vos middlewares.
* **422 en API** â†’ charge utile invalide : vÃ©rifiez les **rÃ¨gles** de validation.
* **`assertViewHas` Ã©choue** â†’ le **nom** de variable passÃ© Ã  la vue ne correspond pas (`return view(..., ['articles' => $collection])`).
* **JSON fragile** â†’ prÃ©fÃ©rez `assertJsonPath`/`assertJsonFragment` Ã  `assertExactJson` (trop strict).

---

